{"version":3,"sources":["../../../../js/admin/bundled/notifications/list.js"],"names":["define","defineComponent","withFormHelpers","withDataRequest","withCollapsibleSections","NotificationList","after","self","loading","$","addClass","appendTo","$node","empty","notifications","on","document","onNotificationUpdated","onNotificationDeleted","before","remove","update","event","data","currentIndex","_","each","n","i","id","notification","type","active","splice","push","render","dataRequest","done","response","system","concat","future","d3","F","now","Date","require","find","length","text","node","sortedNotifications","sortBy","startDate","sentDate","getTime","reverse","select","selectAll","chain","groupBy","pairs","p","value","order","call","enter","append","attr","exit","number","pretty","d","datum","removeClass","severity","toUpperCase","title","message","endDate","date","dateTimeString","trigger","section","name","btn","prop","finally"],"mappings":"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","file":"list.js","sourcesContent":["define([\n    'flight/lib/component',\n    'configuration/admin/utils/withFormHelpers',\n    'util/withDataRequest',\n    'util/withCollapsibleSections'\n], function(\n    defineComponent,\n    withFormHelpers,\n    withDataRequest,\n    withCollapsibleSections) {\n    'use strict';\n\n    return defineComponent(NotificationList, withDataRequest, withFormHelpers, withCollapsibleSections);\n\n    function NotificationList() {\n\n        this.after('initialize', function() {\n            var self = this,\n                loading = $('<span>')\n                    .addClass('badge loading')\n                    .appendTo(this.$node.empty().addClass('notificationList'));\n\n            this.notifications = [];\n\n            this.on(document, 'notificationActive', this.onNotificationUpdated);\n            this.on(document, 'notificationUpdated', this.onNotificationUpdated);\n            this.on(document, 'notificationDeleted', this.onNotificationDeleted);\n\n            this.before('render', function() {\n                if (loading) {\n                    loading.remove();\n                    loading = null;\n                }\n            })\n            this.update();\n        });\n\n        this.onNotificationUpdated = function(event, data) {\n            var currentIndex = -1;\n            _.each(this.notifications, function(n, i) {\n                if (n.id === data.notification.id) {\n                    currentIndex = i;\n                }\n            });\n\n            if (data.notification.type !== 'system') {\n                return;\n            }\n\n            if (event.type === 'notificationActive') {\n                data.notification.active = true;\n            }\n\n            if (currentIndex >= 0) {\n                this.notifications.splice(currentIndex, 1, data.notification);\n            } else {\n                this.notifications.push(data.notification);\n            }\n            this.render();\n        };\n\n        this.onNotificationDeleted = function(event, data) {\n            this.update();\n        };\n\n        this.update = function() {\n            var self = this;\n\n            this.dataRequest('notification', 'list')\n                .done(function(response) {\n                    self.notifications = response.system.active.concat(response.system.future);\n                    self.render();\n                });\n        }\n\n        this.render = function(d3, F) {\n            var self = this,\n                now = Date.now();\n\n            if (!d3 || !F) {\n                return require(['d3', 'util/formatters'], function(d3, F) {\n                    self.render(d3, F);\n                })\n            }\n\n            this.$node.find('.none').remove();\n            if (!this.notifications.length) {\n                $('<div>').addClass('none')\n                    .text('No Notications')\n                    .appendTo(this.node);\n            }\n\n            var sortedNotifications = _.sortBy(this.notifications, function(notification) {\n                return notification.startDate || new Date(notification.sentDate).getTime();\n            }).reverse();\n\n            d3.select(this.node)\n                .selectAll('section.collapsible')\n                .data(_.chain(sortedNotifications)\n                      .groupBy(function(n) {\n                          return n.active || n.startDate <= now ? 'Active' : 'Future';\n                      })\n                      .pairs()\n                      .sortBy(function(p) {\n                          return p[0];\n                      })\n                      .value()\n                )\n                .order()\n                .call(function() {\n                    this.enter()\n                        .append('section').attr('class', 'collapsible has-badge-number expanded')\n                        .call(function() {\n                            this.append('h1').attr('class', 'collapsible-header')\n                                .call(function() {\n                                    this.append('span').attr('class', 'badge');\n                                    this.append('strong');\n                                })\n                            this.append('div').append('ol').attr('class', 'nav-list nav');\n                        })\n                    this.exit().remove();\n\n                    this.select('h1 strong').text(function(n) {\n                        return n[0]\n                    })\n\n                    this.select('h1 .badge').text(function(n) {\n                        return F.number.pretty(n[1].length);\n                    })\n\n                    this.select('.nav-list')\n                        .selectAll('li')\n                        .data(function(n) {\n                            return n[1];\n                        })\n                        .call(function() {\n                            this.enter()\n                                .append('li').attr('class', 'highlight-on-hover')\n                                .call(function() {\n                                    this.append('div').attr('class', 'show-on-hover')\n                                        .call(function() {\n                                            this.append('button')\n                                                .attr('class', 'btn btn-default btn-mini')\n                                                .text('Edit');\n                                            this.append('button')\n                                                .attr('class', 'btn btn-danger btn-mini')\n                                                .text('Delete');\n                                        })\n                                    this.append('span').attr('class', 'nav-list-title')\n                                    this.append('span').attr('class', 'nav-list-subtitle')\n                                        .call(function() {\n                                            this.append('span').attr('class', 'title')\n                                            this.append('span').attr('class', 'dates')\n                                        })\n                                })\n                            this.exit().remove();\n\n                            this.each(function() {\n                                var d = d3.select(this).datum();\n                                $(this)\n                                    .removeClass('INFORMATIONAL CRITICAL WARNING')\n                                    .addClass(d.severity.toUpperCase());\n                            });\n\n                            this.select('.nav-list-title').text(function(n) {\n                                return n.title;\n                            })\n\n                            this.select('.nav-list-subtitle .title').text(function(n) {\n                                return n.message;\n                            })\n                            this.select('.nav-list-subtitle .dates').text(function(n) {\n                                if (n.endDate) {\n                                    return F.date.dateTimeString(n.startDate) +\n                                        ' – ' +\n                                        F.date.dateTimeString(n.endDate);\n                                }\n                                return F.date.dateTimeString(n.startDate);\n                            })\n\n                            this.select('.btn-default').on('click', function(n) {\n                                self.trigger('showAdminPlugin', {\n                                    section: 'System Notifications',\n                                    name: 'Create',\n                                    notification: n\n                                });\n                            })\n                            this.select('.btn-danger').on('click', function(n) {\n                                var btn = $(this)\n                                    .addClass('loading').prop('disabled', true);\n                                self.dataRequest('admin', 'systemNotificationDelete', n.id)\n                                    .finally(function() {\n                                        btn.removeClass('loading').prop('disabled', false);\n                                    })\n                            })\n                        })\n                })\n        }\n    }\n});\n"]}