{"version":3,"sources":["../../../js/search/types/typeOpenLumify.js"],"names":["define","defineComponent","withSearch","F","SEARCH_RESULT_HEIGHT","SearchComponent","SearchTypeOpenLumify","savedSearchUrl","attributes","infiniteScrolling","searchType","supportsSorting","after","self","currentFilters","on","event","data","setAsteriskSearchOnEmpty","onQuerySubmit","onQueryUpdated","onClearSearch","onInfiniteScrollRequest","dataRequest","done","configProperties","exactMatch","currentRequest","cancel","trigger","processPropertyFilters","propertyFilters","promise","length","Promise","resolve","then","ontologyProperties","forEach","f","ontologyProperty","byTitle","propertyId","dataType","_","isArray","values","map","v","String","query","value","currentQuery","filters","options","conceptFilter","otherFilters","edgeLabelFilter","sort","sortFields","matchType","triggerUpdatedSavedSearchQuery","parameters","omit","q","filter","url","originalUrl","triggerRequest","offset","result","unknownTotal","verticesLength","elements","totalHits","vertices","edges","success","message","i18n","nextOffset","number","prettyApproximate","error","paging","size","resultPageSize","Math","ceil","select","height","fetchReferencedElements","apply","concat","bind","results","items","total","catch"],"mappings":"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","file":"typeOpenLumify.js","sourcesContent":["define([\n    'flight/lib/component',\n    './withSearch',\n    'util/formatters'\n], function(\n    defineComponent,\n    withSearch,\n    F) {\n    'use strict';\n\n    var SEARCH_RESULT_HEIGHT = 55,\n        SearchComponent = defineComponent(SearchTypeOpenLumify, withSearch);\n\n    SearchComponent.savedSearchUrl = '/vertex/search';\n\n    return SearchComponent;\n\n    function SearchTypeOpenLumify() {\n\n        this.attributes({\n            infiniteScrolling: true,\n            searchType: 'OpenLumify',\n            supportsSorting: true\n        });\n\n        this.after('initialize', function() {\n            var self = this;\n            this.currentFilters = {};\n\n            this.on('filterschange', function(event, data) {\n                data.setAsteriskSearchOnEmpty = true;\n            })\n            this.on('querysubmit', this.onQuerySubmit);\n            this.on('queryupdated', this.onQueryUpdated);\n            this.on('clearSearch', this.onClearSearch);\n            this.on('infiniteScrollRequest', this.onInfiniteScrollRequest);\n\n            this.dataRequest('config', 'properties').done(function(configProperties) {\n                self.exactMatch = (configProperties['search.exactMatch'] === 'true');\n            })\n        });\n\n\n\n        this.onClearSearch = function() {\n            if (this.currentRequest && this.currentRequest.cancel) {\n                this.currentRequest.cancel();\n                this.currentRequest = null;\n            }\n            this.trigger('setCurrentSearchForSaving');\n        };\n\n        this.processPropertyFilters = function() {\n            var propertyFilters = this.currentFilters.propertyFilters,\n                promise = propertyFilters && propertyFilters.length ?\n                    this.dataRequest('ontology', 'properties') :\n                    Promise.resolve();\n\n            return promise.then(function(ontologyProperties) {\n                if (ontologyProperties) {\n                    // Coerce currency properties to strings\n                    propertyFilters.forEach(function(f) {\n                        var ontologyProperty = ontologyProperties.byTitle[f.propertyId];\n                        if (ontologyProperty && ontologyProperty.dataType === 'currency') {\n                            if (_.isArray(f.values)) {\n                                f.values = f.values.map(function(v) {\n                                    return String(v);\n                                });\n                            }\n                        }\n                    })\n                }\n            });\n        };\n\n        this.onQueryUpdated = function(event, data) {\n            var self = this,\n                query = data.value;\n\n            if (query && query !== '*' && this.exactMatch) {\n                query = '\\\"' + query + '\\\"'\n            }\n\n            this.currentQuery = query;\n            this.currentFilters = data.filters;\n            this.processPropertyFilters().done(function() {\n                var options = {\n                    query: query,\n                    conceptFilter: data.filters.conceptFilter,\n                    propertyFilters: data.filters.propertyFilters,\n                    otherFilters: data.filters.otherFilters,\n                    edgeLabelFilter: data.filters.edgeLabelFilter,\n                    sort: data.filters.sortFields,\n                    matchType: data.filters.matchType\n                };\n                self.triggerUpdatedSavedSearchQuery(options);\n            })\n        };\n\n        this.triggerUpdatedSavedSearchQuery = function(options) {\n            var self = this;\n\n            return this.dataRequest('vertex', 'queryForOptions', options)\n                .then(function(query) {\n                    var parameters = _.omit(query.parameters, 'size', 'offset');\n                    if (parameters.q && parameters.filter) {\n                        self.trigger('setCurrentSearchForSaving', {\n                            url: query.originalUrl,\n                            parameters: parameters\n                        });\n                    } else {\n                        self.trigger('setCurrentSearchForSaving');\n                    }\n                });\n        }\n\n        this.onQuerySubmit = function(event, data) {\n            var self = this,\n                query = data.value;\n\n            if (query && query !== '*' && this.exactMatch) {\n                query = '\\\"' + query + '\\\"';\n            }\n\n            this.currentQuery = query;\n            this.currentFilters = data.filters;\n\n            this.processPropertyFilters().then(function() {\n                self.trigger('searchRequestBegan');\n                self.triggerRequest(\n                    query,\n                    self.currentFilters.propertyFilters,\n                    self.currentFilters.matchType,\n                    self.currentFilters.conceptFilter,\n                    self.currentFilters.edgeLabelFilter,\n                    self.currentFilters.otherFilters,\n                    self.currentFilters.sortFields,\n                    { offset: 0 }\n                )\n                    .then(function(result) {\n                        var unknownTotal = false,\n                            verticesLength = result.elements.length;\n\n                        if (!('totalHits' in result)) {\n                            unknownTotal = true;\n                            result.totalHits = verticesLength;\n                        } else if (result.totalHits > verticesLength && verticesLength === 0) {\n                            // totalHits includes deleted items so show no results\n                            // if no vertices returned and hits > 0\n                            result.totalHits = 0;\n                        }\n\n                        switch (self.currentFilters.matchType) {\n                            case 'vertex': result.vertices = result.elements; break;\n                            case 'edge': result.edges = result.elements; break;\n                        }\n\n                        self.trigger('searchRequestCompleted', {\n                            success: true,\n                            result: result,\n                            message: i18n('search.types.openlumify.hits.' +\n                                (\n                                    unknownTotal && result.totalHits >= (result.nextOffset - 1) ? 'unknown' :\n                                    result.totalHits === 0 ? 'none' :\n                                    result.totalHits === 1 ? 'one' :\n                                    'many'\n                                ),\n                                F.number.prettyApproximate(result.totalHits))\n                        });\n                    }, function() {\n                        self.trigger('searchRequestCompleted', { success: false, error: i18n('search.query.invalid') });\n                    })\n                    .done()\n            });\n        };\n\n        this.triggerRequest = function(\n            query,\n            propertyFilters,\n            matchType,\n            conceptFilter,\n            edgeLabelFilter,\n            otherFilters,\n            sortFields,\n            paging\n        ) {\n            if (this.currentRequest && this.currentRequest.cancel) {\n                this.currentRequest.cancel();\n                this.currentRequest = null;\n            }\n\n            if (paging && !paging.size) {\n                var resultPageSize = Math.ceil(this.select('resultsSelector').height() / SEARCH_RESULT_HEIGHT);\n                paging.size = resultPageSize * 2;\n            }\n\n            var self = this,\n                options = {\n                    query: query,\n                    propertyFilters: propertyFilters,\n                    conceptFilter: conceptFilter,\n                    edgeLabelFilter: edgeLabelFilter,\n                    otherFilters: otherFilters,\n                    paging: paging,\n                    sort: sortFields,\n                    matchType: matchType,\n                    fetchReferencedElements: true\n                };\n\n            this.triggerUpdatedSavedSearchQuery(options);\n            this.currentRequest = this.dataRequest.apply(\n                this, ['vertex', 'search'].concat([options])\n            )\n            return this.currentRequest;\n        };\n\n        this.onInfiniteScrollRequest = function(event, data) {\n            var query = this.currentQuery,\n                trigger = this.trigger.bind(this,\n                   this.select('resultsContainerSelector'),\n                   'addInfiniteItems'\n                );\n\n            this.triggerRequest(\n                query,\n                this.currentFilters.propertyFilters,\n                this.currentFilters.matchType,\n                this.currentFilters.conceptFilter,\n                this.currentFilters.edgeLabelFilter,\n                this.currentFilters.otherFilters,\n                this.currentFilters.sortFields,\n                data.paging\n            )\n                .then(function(results) {\n                    trigger({\n                        success: true,\n                        items: results.elements,\n                        total: results.totalHits,\n                        nextOffset: results.nextOffset\n                    });\n                })\n                .catch(function() {\n                    trigger({ success: false });\n                })\n        };\n\n    }\n});\n"]}