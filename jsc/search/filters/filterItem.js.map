{"version":3,"sources":["../../../js/search/filters/filterItem.js"],"names":["define","defineComponent","FieldSelection","template","PREDICATES","HAS","HAS_NOT","CONTAINS","EQUALS","IN","LESS_THAN","GREATER_THAN","BETWEEN","GEO_PREDICATES","DISJOINT","WITHIN","DATA_TYPES","title","dataType","displayName","i18n","FilterItem","defaultAttrs","fieldsSelector","fieldSelector","propertySelectionSelector","currentPropertySelector","removeSelector","predicateSelector","before","select","teardownAllComponents","trigger","removed","after","on","onPropertyChanged","onPropertySelected","onPropertyInvalid","onFilterProperties","onPredicateClick","onRemoveRow","$node","html","attr","property","setCurrentProperty","createFieldSelection","predicateNeedsValues","filter","predicate","isValid","hasPredicateAndProperty","propertyId","propertyFieldRequired","rangeFilter","_","isEmpty","values","length","triggerChange","valid","sortBy","val","isObject","_date","Object","keys","some","geo","first","latitude","longitude","radius","Array","slice","every","v","isUndefined","toggleClass","map","omit","key","test","event","$","target","is","listFilter","data","teardown","$anchor","closest","find","text","attachFields","done","stopPropagation","index","undefined","value","isArray","metadata","splice","self","hasProperty","currentProperty","startsWith","Error","toggle","end","predicateItemsForProperty","each","selected","children","parent","focusField","eq","fieldComponent","isCompoundField","dependentPropertyIris","displayType","possibleValues","Promise","require","then","PropertyFieldItem","node","nodesRendered","reduce","toArray","sum","el","lookupComponent","fieldsToRender","show","add","appendTo","hide","rendered","off","type","i","attachTo","onlySearchable","focus","predicatesForProperty","standardPredicates","concat","displayText","properties","header","creatable","placeholder","rollupCompound","hideCompound","userVisible"],"mappings":"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","file":"filterItem.js","sourcesContent":["define([\n    'flight/lib/component',\n    'util/ontology/propertySelect',\n    './filterItemTpl.hbs'\n], function(\n    defineComponent,\n    FieldSelection,\n    template) {\n    'use strict';\n\n    const PREDICATES = {\n        HAS: 'has',\n        HAS_NOT: 'hasNot',\n        CONTAINS: '~',\n        EQUALS: '=',\n        IN: 'in',\n        LESS_THAN: '<',\n        GREATER_THAN: '>',\n        BETWEEN: 'range'\n    };\n\n    const GEO_PREDICATES = {\n        DISJOINT: 'disjoint',\n        WITHIN: 'within'\n    }\n\n    const DATA_TYPES = [\n        {\n            title: 'dataType:geoLocation',\n            dataType: 'geoLocation',\n            displayName: i18n('ontology.property.data.types.geolocation')\n        }\n    ]\n\n    return defineComponent(FilterItem);\n\n    function FilterItem() {\n\n        this.defaultAttrs({\n            fieldsSelector: '.current-property .fields',\n            fieldSelector: '.configuration',\n            propertySelectionSelector: '.property-selector',\n            currentPropertySelector: '.current-property',\n            removeSelector: '.header button.remove-icon',\n            predicateSelector: '.current-property .header .dropdown .dropdown-menu li a'\n        });\n\n        this.before('teardown', function() {\n            this.select('fieldSelector').teardownAllComponents();\n            this.trigger('filterItemChanged', { removed: true });\n        });\n\n        this.after('initialize', function() {\n            this.on('propertychange', this.onPropertyChanged);\n            this.on('propertyselected', this.onPropertySelected);\n            this.on('propertyinvalid', this.onPropertyInvalid);\n            this.on('filterProperties', this.onFilterProperties);\n            this.on('click', {\n                predicateSelector: this.onPredicateClick,\n                removeSelector: this.onRemoveRow\n            });\n\n            this.$node.html(template({}));\n\n            if (this.attr.property) {\n                this.setCurrentProperty(this.attr);\n            } else {\n                this.createFieldSelection();\n                this.trigger('fieldRendered');\n            }\n        });\n\n        this.predicateNeedsValues = function() {\n            return (this.filter.predicate !== PREDICATES.HAS && this.filter.predicate !== PREDICATES.HAS_NOT);\n        };\n\n        this.isValid = function() {\n            var hasPredicateAndProperty = this.filter.predicate && (this.filter.propertyId || this.filter.dataType);\n            if (hasPredicateAndProperty) {\n                var propertyFieldRequired = this.predicateNeedsValues(),\n                    rangeFilter = this.filter.predicate === PREDICATES.BETWEEN;\n\n                if (rangeFilter) {\n                    return !_.isEmpty(this.filter.values) && this.filter.values.length === 2;\n                }\n                if (propertyFieldRequired) {\n                    return !_.isEmpty(this.filter.values);\n                }\n                return true;\n            }\n            return false;\n        };\n\n        this.triggerChange = function() {\n            let valid = this.isValid();\n            const { values, ...filter } = this.filter;\n\n            if (this.predicateNeedsValues()) {\n\n                if (this.filter.predicate === PREDICATES.BETWEEN) {\n                    filter.values = _.sortBy(this.filter.values, function(val) {\n                        if (_.isObject(val) &&\n                            ('amount' in val) && ('unit' in val) &&\n                            '_date' in val) {\n                            return val._date;\n                        }\n                        return val;\n                    });\n                } else if (Object.keys(GEO_PREDICATES).some(predicate => GEO_PREDICATES[predicate] === this.filter.predicate)) {\n                    var geo = _.first(this.filter.values);\n                    filter.values = geo ? [geo.latitude, geo.longitude, geo.radius] : new Array(3);\n                } else if (this.filter.predicate === PREDICATES.IN) {\n                    filter.values = this.filter.values.slice(0);\n                } else {\n                    filter.values = this.filter.values.slice(0, 1);\n                }\n\n                valid = valid && _.every(filter.values, function(v) {\n                    return !_.isUndefined(v) && !(_.isObject(v) && _.isEmpty(v));\n                });\n            }\n\n            this.$node.toggleClass('invalid', !valid);\n\n            // Omit all underscore keys\n            if (filter.values) {\n                filter.values = filter.values.map(function(val) {\n                    return _.isObject(val) ? _.omit(val, function(val, key) {\n                        return (/^_/).test(key);\n                    }) : val;\n                });\n            }\n\n            this.trigger('filterItemChanged', {\n                valid: valid,\n                filter: filter\n            });\n        };\n\n        this.onFilterProperties = function(event, filter) {\n            if ($(event.target).is(this.$node)) {\n                if (!filter) {\n                    this.listFilter = null;\n                } else {\n                    this.listFilter = filter;\n                }\n\n                this.select('propertySelectionSelector').trigger('filterProperties', this.listFilter);\n            }\n        };\n\n        this.onRemoveRow = function(event, data) {\n            this.teardown();\n        };\n\n        this.onPredicateClick = function(event) {\n            var $anchor = $(event.target);\n            this.filter.predicate = $anchor.data('value');\n            $anchor.closest('.dropdown').find('.dropdown-toggle').text($anchor.text());\n            this.attachFields().done();\n        };\n\n        this.onPropertyChanged = function(event, data) {\n            event.stopPropagation();\n            var index = $(event.target).closest('.configuration').index();\n            if (this.filter.predicate === PREDICATES.BETWEEN) {\n                if (!this.filter.values) {\n                    this.filter.values = [undefined, undefined];\n                }\n                this.filter.values[index] = data.value;\n            } else {\n                if (index !== 0) return;\n                this.filter.values = _.isArray(data.value) ? data.value : [data.value];\n            }\n            this.filter.metadata = data.metadata;\n\n            this.triggerChange();\n        };\n\n        this.onPropertySelected = function(event, data) {\n            this.setCurrentProperty(data);\n        };\n\n        this.onPropertyInvalid = function(event, data) {\n            var index = $(event.target).closest('.configuration').index();\n            if (this.filter.predicate === PREDICATES.BETWEEN) {\n                if (this.filter.values && index < this.filter.values.length) {\n                    this.filter.values.splice(index, 1, undefined);\n                }\n            } else {\n                if (index !== 0) return;\n                this.filter.values = [];\n            }\n            this.triggerChange();\n        };\n\n        this.setCurrentProperty = function(data) {\n            var self = this,\n                property = data.property,\n                hasProperty = !!property;\n\n            this.currentProperty = property;\n            if (data.predicate === 'equal') {\n                data.predicate = '=';\n            }\n            const filter = {\n                predicate: data.predicate,\n                values: data.values || []\n            };\n\n            if (property && property.title.startsWith('dataType:')) {\n                switch (property.dataType) {\n                    case 'geoLocation':\n                        filter.dataType = 'GEO_LOCATION';\n                        break;\n                    default:\n                        throw new Error('Unknown datatype: ' + property.dataType);\n                }\n            } else {\n                filter.propertyId = property && property.title;\n            }\n\n            this.filter = filter;\n\n            this.select('propertySelectionSelector')\n                .toggle(!hasProperty);\n            this.select('currentPropertySelector')\n                .find('label span')\n                    .text(property.displayName)\n                .end()\n                .find('.dropdown-menu')\n                    .html(this.predicateItemsForProperty(property))\n                    .each(function() {\n                        var selected = $(this).find('.selected a');\n                        if (!selected.length) {\n                            selected = $(this).children('li').first().find('a');\n                        }\n                        self.filter.predicate = selected.data('value');\n                        $(this).parent().find('.dropdown-toggle').text(selected.text());\n                    })\n                .end()\n                .toggle(hasProperty);\n\n            if (hasProperty) {\n                var values = this.filter.values;\n                if (property.dataType === 'geoLocation' && values.length > 1) {\n                    this.filter.values = [{\n                        latitude: values[0] || '',\n                        longitude: values[1] || '',\n                        radius: values[2] || ''\n                    }];\n                }\n                this.attachFields();\n            }\n        };\n\n        this.focusField = function() {\n            if (_.isEmpty(this.filter.values) && this.predicateNeedsValues()) {\n                var index = 0;\n                if (!_.isUndefined(this.filter.values[0]) &&\n                    this.filter.predicate === PREDICATES.BETWEEN &&\n                    (this.filter.values.length < 2 || _.isUndefined(this.filter.values[1]))) {\n                    index = 1;\n                }\n                this.select('fieldSelector').eq(index).trigger('focusPropertyField');\n            }\n        };\n\n        this.attachFields = function() {\n            var self = this,\n                fieldComponent,\n                property = this.currentProperty,\n                isCompoundField = property && property.dependentPropertyIris && property.dependentPropertyIris.length;\n\n            if (isCompoundField) {\n                fieldComponent = 'fields/compound/compound';\n            } else if (property.displayType === 'duration') {\n                fieldComponent = 'fields/duration';\n            } else if (property.dataType === 'date') {\n                fieldComponent = 'search/filters/dateField';\n            } else if (property.dataType === 'directory/entity') {\n                fieldComponent = 'search/filters/directoryEntityField';\n            } else {\n                fieldComponent = property.possibleValues ? 'fields/restrictValuesMulti' : 'fields/' + property.dataType;\n            }\n\n            return Promise.require(fieldComponent).then(function(PropertyFieldItem) {\n                var node = self.select('fieldSelector'),\n                    nodesRendered = _.reduce(node.toArray(), function(sum, el) {\n                        return sum + ($(el).lookupComponent(PropertyFieldItem) ? 1 : 0);\n                    }, 0),\n                    fieldsToRender = 1 - nodesRendered;\n\n                if (self.filter.predicate === PREDICATES.BETWEEN) {\n                    fieldsToRender = 2 - nodesRendered;\n                    node.show();\n                    if (node.length < 2) {\n                        node = node.add($('<div class=\"configuration\">').appendTo(self.select('fieldsSelector')));\n                    }\n                } else if (self.predicateNeedsValues()) {\n                    node.eq(0).show();\n                    node.eq(1).hide();\n                    if (self.filter.predicate === PREDICATES.IN) {\n                        self.filter.values = _.isArray(self.filter.values) ? self.filter.values : [self.filter.values];\n                    }\n                } else {\n                    node.hide();\n                }\n\n                if (fieldsToRender > 0) {\n                    self.on('fieldRendered', function rendered(event) {\n                        fieldsToRender--;\n                        if (fieldsToRender === 0) {\n                            self.off(event.type, rendered);\n                            self.focusField();\n                        }\n                    })\n                } else {\n                    self.focusField();\n                }\n                if (isCompoundField) {\n                    throw new Error('Compound properties not supported in filters.');\n                } else {\n                    node.each(function(i, el) {\n                        PropertyFieldItem.attachTo(el, {\n                            onlySearchable: true,\n                            focus: false,\n                            property: property,\n                            value: self.filter.values[i]\n                        });\n                    })\n                }\n\n                self.triggerChange();\n            });\n        };\n        this.predicatesForProperty = function(property) {\n            var standardPredicates = [PREDICATES.HAS, PREDICATES.HAS_NOT];\n\n            if (property.possibleValues) {\n                return [PREDICATES.IN].concat(standardPredicates);\n            }\n\n            if (property.title.startsWith('dataType:')) {\n                switch (property.dataType) {\n                    case 'geoLocation': return [\n                           GEO_PREDICATES.WITHIN,\n                           GEO_PREDICATES.DISJOINT\n                       ].concat(standardPredicates);\n                    default:\n                        throw new Error('Unknown datatype: ' + property.dataType);\n\n                }\n            }\n\n            switch (property.dataType) {\n                case 'string': return [\n                        PREDICATES.CONTAINS,\n                        PREDICATES.EQUALS\n                    ].concat(standardPredicates);\n\n                case 'geoLocation': return [\n                        GEO_PREDICATES.WITHIN,\n                        GEO_PREDICATES.DISJOINT\n                    ].concat(standardPredicates);\n\n                case 'boolean': return [\n                        PREDICATES.EQUALS\n                    ].concat(standardPredicates);\n\n                case 'directory/entity': return [\n                    PREDICATES.EQUALS\n                ].concat(standardPredicates);\n\n                case 'date':\n                case 'currency':\n                case 'double':\n                case 'integer':\n                case 'number': return [\n                        PREDICATES.LESS_THAN,\n                        PREDICATES.GREATER_THAN,\n                        PREDICATES.BETWEEN,\n                        PREDICATES.EQUALS\n                    ].concat(standardPredicates);\n\n                default:\n                    throw new Error('Unknown datatype: ' + property.dataType);\n            }\n        };\n\n        this.predicateItemsForProperty = function(property) {\n            if (!property) return '';\n\n            var self = this;\n\n            return $.map(this.predicatesForProperty(property), function(predicate, i) {\n                var displayText = (\n                        property.displayType &&\n                        i18n(true, 'search.filters.predicates.' + property.dataType + '.' + property.displayType + '.' + predicate, property.displayName)\n                    ) ||\n                    i18n(true, 'search.filters.predicates.' + property.dataType + '.' + predicate, property.displayName) ||\n                    i18n('search.filters.predicates.' + predicate, property.displayName);\n                return $('<li><a></a></li>')\n                    .toggleClass('selected', self.filter.predicate ? self.filter.predicate === predicate : i === 0)\n                    .find('a')\n                        .text(displayText)\n                        .attr('title', displayText)\n                        .data('value', predicate)\n                    .end();\n            });\n        };\n\n        this.createFieldSelection = function() {\n            const properties = [\n                ..._.sortBy(this.attr.properties, 'displayName'),\n                {\n                    title: 'data-types-header',\n                    displayName: i18n('ontology.property.header.data.types'),\n                    header: true\n                },\n                ..._.sortBy(DATA_TYPES, 'displayName'),\n            ];\n\n            FieldSelection.attachTo(this.select('propertySelectionSelector'), {\n                properties,\n                onlySearchable: true,\n                creatable: false,\n                placeholder: i18n('search.filters.add_filter.placeholder'),\n                rollupCompound: false,\n                hideCompound: true,\n                filter: { ...this.attr.listFilter, userVisible: true }\n            });\n        };\n\n\n    }\n});\n"]}