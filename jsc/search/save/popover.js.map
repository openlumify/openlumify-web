{"version":3,"sources":["../../../js/search/save/popover.js"],"names":["define","defineComponent","withPopover","withDataRequest","SCOPES","GLOBAL","SavedSearches","normalizeParameters","params","_","chain","map","value","key","replace","object","queryParametersChanged","param1","param2","isEqual","defaultAttrs","listSelector","saveSelector","nameInputSelector","globalSearchSelector","globalInputSelector","deleteSelector","before","node","config","template","canSaveGlobal","openlumifyData","currentUser","privileges","indexOf","maxHeight","$","window","height","name","update","updatingGlobal","scope","text","i18n","teardownOnTap","canAddOrUpdate","isUndefined","list","item","isGlobal","canDelete","extend","after","on","popover","onClick","onSave","onDelete","onChange","validate","positionDialog","onSetCurrentSearchForSaving","event","data","attr","query","$button","find","getQueryForSaving","type","which","save","$input","$global","noParameters","isEmpty","parameters","prop","url","toggle","$nameInput","$globalInput","val","trim","global","is","nameChanged","queryChanged","id","self","addClass","dataRequest","then","teardown","finally","removeClass","$li","target","closest","index","siblings","length","html","remove","splice","trigger"],"mappings":"AACAA,OAAO,CACH,sBADG,CAEH,2BAFG,CAGH,sBAHG,CAAP,CAIG,SACCC,eADD,CAECC,WAFD,CAGCC,eAHD,CAGkB,CACjB,aAEA,GAAIC,QAAS,CACTC,OAAQ,QADC,CAAb,CAIA,MAAOJ,iBAAgBK,aAAhB,CAA+BJ,WAA/B,CAA4CC,eAA5C,CAAP,CAEA,QAASI,oBAAT,CAA6BC,MAA7B,CAAqC,CACjC,MAAOC,GAAEC,KAAF,CAAQF,MAAR,EACFG,GADE,CACE,SAASC,KAAT,CAAgBC,GAAhB,CAAqB,CACtB,MAAO,CACHA,IAAIC,OAAJ,CAAY,OAAZ,CAAqB,EAArB,CADG,CAEHF,KAFG,CAAP,CAIH,CANE,EAOFG,MAPE,GAQFH,KARE,EAAP,CASH,CAED,QAASI,uBAAT,CAAgCC,MAAhC,CAAwCC,MAAxC,CAAgD,CAC5C,MAAO,CAACT,EAAEU,OAAF,CACJZ,oBAAoBU,MAApB,CADI,CAEJV,oBAAoBW,MAApB,CAFI,CAAR,CAIH,CAED,QAASZ,cAAT,EAAyB,CAErB,KAAKc,YAAL,CAAkB,CACdC,aAAc,MADA,CAEdC,aAAc,cAFA,CAGdC,kBAAmB,kBAHL,CAIdC,qBAAsB,sBAJR,CAKdC,oBAAqB,4BALP,CAMdC,eAAgB,gBANF,CAAlB,EASA,KAAKC,MAAL,CAAY,YAAZ,CAA0B,SAASC,IAAT,CAAeC,MAAf,CAAuB,CAC7CA,OAAOC,QAAP,CAAkB,2BAAlB,CACAD,OAAOE,aAAP,CAAuBC,eAAeC,WAAf,CAA2BC,UAA3B,CAAsCC,OAAtC,CAA8C,oBAA9C,EAAsE,CAAC,CAA9F,CACAN,OAAOO,SAAP,CAAmBC,EAAEC,MAAF,EAAUC,MAAV,GAAqB,CAAxC,CACAV,OAAOW,IAAP,CAAcX,OAAOY,MAAP,EAAiBZ,OAAOY,MAAP,CAAcD,IAA/B,EAAuC,EAArD,CACAX,OAAOa,cAAP,CAAwBb,OAAOY,MAAP,EAAiBZ,OAAOY,MAAP,CAAcE,KAAd,GAAwBvC,OAAOC,MAAxE,CACAwB,OAAOe,IAAP,CAAcC,KAAK,gCAAkChB,OAAOY,MAAP,CAAgB,QAAhB,CAA2B,QAA7D,CAAL,CAAd,CACAZ,OAAOiB,aAAP,CAAuB,IAAvB,CACAjB,OAAOkB,cAAP,CAAwBtC,EAAEuC,WAAF,CAAcnB,OAAOY,MAArB,GAAgC,CAACZ,OAAOa,cAAxC,EACnBb,OAAOa,cAAP,EAAyBb,OAAOE,aADrC,CAEAF,OAAOoB,IAAP,CAAcpB,OAAOoB,IAAP,CAAYtC,GAAZ,CAAgB,SAASuC,IAAT,CAAe,CACzC,GAAIC,UAAWD,KAAKP,KAAL,GAAevC,OAAOC,MAArC,CACI+C,UAAY,IADhB,CAEA,GAAID,QAAJ,CAAc,CACVC,UAAYvB,OAAOE,aAAnB,CACH,CACD,MAAOtB,GAAE4C,MAAF,CAAS,EAAT,CAAaH,IAAb,CAAmB,CACtBC,SAAUA,QADY,CAEtBC,UAAWA,SAFW,CAAnB,CAAP,CAIH,CAVa,CAAd,CAYA,KAAKE,KAAL,CAAW,mBAAX,CAAgC,UAAW,CACvC,KAAKC,EAAL,CAAQ,KAAKC,OAAb,CAAsB,OAAtB,CAA+B,CAC3BnC,aAAc,KAAKoC,OADQ,CAE3BnC,aAAc,KAAKoC,MAFQ,CAG3BhC,eAAgB,KAAKiC,QAHM,CAA/B,EAMA,KAAKJ,EAAL,CAAQ,KAAKC,OAAb,CAAsB,cAAtB,CAAsC,CAClCjC,kBAAmB,KAAKqC,QADU,CAElCnC,oBAAqB,KAAKmC,QAFQ,CAAtC,EAKA,KAAKC,QAAL,GACA,KAAKC,cAAL,GACH,CAdD,EAeH,CArCD,EAuCA,KAAKR,KAAL,CAAW,YAAX,CAAyB,UAAW,CAChC,KAAKC,EAAL,CAAQ,2BAAR,CAAqC,KAAKQ,2BAA1C,EACH,CAFD,EAIA,KAAKA,2BAAL,CAAmC,SAASC,KAAT,CAAgBC,IAAhB,CAAsB,CACrD,KAAKC,IAAL,CAAUC,KAAV,CAAkBF,IAAlB,CACA,KAAKJ,QAAL,GACH,CAHD,CAKA,KAAKD,QAAL,CAAgB,SAASI,KAAT,CAAgB,CAC5B,GAAI,KAAKE,IAAL,CAAUzB,MAAd,CAAsB,CAClB,GAAI2B,SAAU,KAAKZ,OAAL,CAAaa,IAAb,CAAkB,cAAlB,CAAd,CACIF,MAAQ,KAAKG,iBAAL,EADZ,CAGAF,QAAQxB,IAAR,CACK,MAAQuB,MAAT,CACA,QADA,CACW,QAFf,EAIH,CAED,GAAI,KAAKN,QAAL,IAAmBG,MAAMO,IAAN,GAAe,OAAlC,EAA6CP,MAAMQ,KAAN,GAAgB,EAAjE,CAAqE,CACjE,KAAKC,IAAL,GACH,CACJ,CAdD,CAgBA,KAAKZ,QAAL,CAAgB,UAAW,CACvB,GAAIa,QAAS,KAAKlB,OAAL,CAAaa,IAAb,CAAkB,KAAKH,IAAL,CAAU3C,iBAA5B,CAAb,CACI6C,QAAU,KAAKZ,OAAL,CAAaa,IAAb,CAAkB,KAAKH,IAAL,CAAU5C,YAA5B,CADd,CAEIqD,QAAU,KAAKnB,OAAL,CAAaa,IAAb,CAAkB,KAAKH,IAAL,CAAU1C,oBAA5B,CAFd,CAGI2C,MAAQ,KAAKG,iBAAL,EAHZ,CAIIM,aAAenE,EAAEoE,OAAF,CAAUV,MAAMW,UAAhB,CAJnB,CAMAV,QAAQW,IAAR,CAAa,UAAb,CAAyB,CAACZ,MAAM3B,IAAP,EAAeoC,YAAxC,EACAF,OAAOK,IAAP,CAAY,UAAZ,CAAwBH,cAAgB,CAACT,MAAMa,GAA/C,EACAL,QAAQM,MAAR,CAAe,EAAEL,cAAgB,CAACT,MAAMa,GAAzB,CAAf,EAEA,MAAOb,OAAM3B,IAAN,EAAc2B,MAAMa,GAApB,EAA2B,CAACJ,YAAnC,CACH,CAZD,CAcA,KAAKN,iBAAL,CAAyB,UAAW,CAChC,GAAIY,YAAa,KAAK1B,OAAL,CAAaa,IAAb,CAAkB,KAAKH,IAAL,CAAU3C,iBAA5B,CAAjB,CACI4D,aAAe,KAAK3B,OAAL,CAAaa,IAAb,CAAkB,KAAKH,IAAL,CAAUzC,mBAA5B,CADnB,CAEI0C,MAAQ,CACJ3B,KAAM0C,WAAWE,GAAX,GAAiBC,IAAjB,EADF,CAEJC,OAAQH,aAAaI,EAAb,CAAgB,UAAhB,CAFJ,CAGJP,IAAK,KAAKd,IAAL,CAAUC,KAAV,EAAmB,KAAKD,IAAL,CAAUC,KAAV,CAAgBa,GAHpC,CAIJF,WAAY,KAAKZ,IAAL,CAAUC,KAAV,EAAmB,KAAKD,IAAL,CAAUC,KAAV,CAAgBW,UAJ3C,CAFZ,CASA,GAAI,KAAKZ,IAAL,CAAUzB,MAAV,EAAoB0B,MAAMW,UAA9B,CAA0C,CACtC,GAAIU,aAAc,KAAKtB,IAAL,CAAUzB,MAAV,CAAiBD,IAAjB,GAA0B2B,MAAM3B,IAAlD,CACIiD,aAAezE,uBAAuB,KAAKkD,IAAL,CAAUzB,MAAV,CAAiBqC,UAAxC,CAAoDX,MAAMW,UAA1D,CADnB,CAGA,GAAKU,aAAe,CAACC,YAAjB,EAAmC,CAACD,WAAD,EAAgBC,YAAnD,EACA,CAACD,WAAD,EAAgB,CAACC,YADrB,CACoC,CAChCtB,MAAMuB,EAAN,CAAW,KAAKxB,IAAL,CAAUzB,MAAV,CAAiBiD,EAA5B,CACH,CACJ,CAED,MAAOvB,MAAP,CACH,CArBD,CAuBA,KAAKT,MAAL,CAAc,SAASM,KAAT,CAAgB,CAC1B,KAAKS,IAAL,GACH,CAFD,CAIA,KAAKA,IAAL,CAAY,UAAW,CACnB,GAAIkB,MAAO,IAAX,CACIvB,QAAU,KAAKZ,OAAL,CAAaa,IAAb,CAAkB,KAAKH,IAAL,CAAU5C,YAA5B,EAA0CsE,QAA1C,CAAmD,SAAnD,CADd,CAEIzB,MAAQ,KAAKG,iBAAL,EAFZ,CAIA,KAAKuB,WAAL,CAAiB,QAAjB,CAA2B,MAA3B,CAAmC1B,KAAnC,EACK2B,IADL,CACU,UAAW,CACbH,KAAKI,QAAL,GACH,CAHL,EAIKC,OAJL,CAIa,UAAW,CAChB5B,QAAQ6B,WAAR,CAAoB,SAApB,EACH,CANL,EAOH,CAZD,CAcA,KAAKtC,QAAL,CAAgB,SAASK,KAAT,CAAgB,CAC5B,GAAI2B,MAAO,IAAX,CACIO,IAAM7D,EAAE2B,MAAMmC,MAAR,EAAgBC,OAAhB,CAAwB,IAAxB,CADV,CAEIC,MAAQH,IAAIG,KAAJ,EAFZ,CAGIlC,MAAQ,KAAKD,IAAL,CAAUjB,IAAV,CAAeoD,KAAf,CAHZ,CAIIjC,QAAU/B,EAAE2B,MAAMmC,MAAR,EAAgBP,QAAhB,CAAyB,SAAzB,CAJd,CAMAM,IAAIN,QAAJ,CAAa,SAAb,EAEA,KAAKC,WAAL,CAAiB,QAAjB,CAA2B,QAA3B,CAAqC1B,MAAMuB,EAA3C,EACKI,IADL,CACU,UAAW,CACb,GAAII,IAAII,QAAJ,GAAeC,MAAf,GAA0B,CAA9B,CAAiC,CAC7BL,IAAIE,OAAJ,CAAY,IAAZ,EAAkBI,IAAlB,CACInE,EAAE,gDAAF,CADJ,EAGH,CAJD,IAIO6D,KAAIO,MAAJ,GAEPd,KAAKzB,IAAL,CAAUjB,IAAV,CAAeyD,MAAf,CAAsBL,KAAtB,CAA6B,CAA7B,EAEA,GAAIV,KAAKzB,IAAL,CAAUzB,MAAV,EAAoBkD,KAAKzB,IAAL,CAAUzB,MAAV,CAAiBiD,EAAjB,GAAwBvB,MAAMuB,EAAtD,CAA0D,CACtDC,KAAKnC,OAAL,CAAaa,IAAb,CAAkBsB,KAAKzB,IAAL,CAAU3C,iBAA5B,EAA+C6D,GAA/C,CAAmD,EAAnD,EACAO,KAAKnC,OAAL,CAAaa,IAAb,CAAkBsB,KAAKzB,IAAL,CAAU5C,YAA5B,EAA0CsB,IAA1C,CAA+C,QAA/C,EACA+C,KAAKzB,IAAL,CAAUzB,MAAV,CAAmB,IAAnB,CACAkD,KAAK9B,QAAL,GACH,CACJ,CAhBL,EAiBKmC,OAjBL,CAiBa,UAAW,CAChB5B,QAAQ6B,WAAR,CAAoB,SAApB,EACAC,IAAID,WAAJ,CAAgB,SAAhB,EACH,CApBL,EAqBH,CA9BD,CAgCA,KAAKxC,OAAL,CAAe,SAASO,KAAT,CAAgB,CAC3B,GAAIG,OAAQ,KAAKD,IAAL,CAAUjB,IAAV,CAAeZ,EAAE2B,MAAMmC,MAAR,EAAgBC,OAAhB,CAAwB,IAAxB,EAA8BC,KAA9B,EAAf,CAAZ,CAEA,KAAKM,OAAL,CAAa,oBAAb,CAAmC,CAC/BxC,MAAOA,KADwB,CAAnC,EAIA,KAAK4B,QAAL,GACH,CARD,CASH,CACJ,CA/MD","file":"popover.js","sourcesContent":["\ndefine([\n    'flight/lib/component',\n    'util/popovers/withPopover',\n    'util/withDataRequest'\n], function(\n    defineComponent,\n    withPopover,\n    withDataRequest) {\n    'use strict';\n\n    var SCOPES = {\n        GLOBAL: 'Global'\n    };\n\n    return defineComponent(SavedSearches, withPopover, withDataRequest);\n\n    function normalizeParameters(params) {\n        return _.chain(params)\n            .map(function(value, key) {\n                return [\n                    key.replace(/\\[\\]$/, ''),\n                    value\n                ];\n            })\n            .object()\n            .value();\n    }\n\n    function queryParametersChanged(param1, param2) {\n        return !_.isEqual(\n            normalizeParameters(param1),\n            normalizeParameters(param2)\n        );\n    }\n\n    function SavedSearches() {\n\n        this.defaultAttrs({\n            listSelector: 'li a',\n            saveSelector: '.form button',\n            nameInputSelector: '.form input.name',\n            globalSearchSelector: '.form .global-search',\n            globalInputSelector: '.form .global-search input',\n            deleteSelector: 'ul .btn-danger'\n        });\n\n        this.before('initialize', function(node, config) {\n            config.template = '/search/save/template.hbs';\n            config.canSaveGlobal = openlumifyData.currentUser.privileges.indexOf('SEARCH_SAVE_GLOBAL') > -1;\n            config.maxHeight = $(window).height() / 2;\n            config.name = config.update && config.update.name || '';\n            config.updatingGlobal = config.update && config.update.scope === SCOPES.GLOBAL;\n            config.text = i18n('search.savedsearches.button.' + (config.update ? 'update' : 'create'));\n            config.teardownOnTap = true;\n            config.canAddOrUpdate = _.isUndefined(config.update) || !config.updatingGlobal ||\n                (config.updatingGlobal && config.canSaveGlobal);\n            config.list = config.list.map(function(item) {\n                var isGlobal = item.scope === SCOPES.GLOBAL,\n                    canDelete = true;\n                if (isGlobal) {\n                    canDelete = config.canSaveGlobal;\n                }\n                return _.extend({}, item, {\n                    isGlobal: isGlobal,\n                    canDelete: canDelete\n                })\n            });\n\n            this.after('setupWithTemplate', function() {\n                this.on(this.popover, 'click', {\n                    listSelector: this.onClick,\n                    saveSelector: this.onSave,\n                    deleteSelector: this.onDelete\n                });\n\n                this.on(this.popover, 'keyup change', {\n                    nameInputSelector: this.onChange,\n                    globalInputSelector: this.onChange\n                });\n\n                this.validate();\n                this.positionDialog();\n            });\n        });\n\n        this.after('initialize', function() {\n            this.on('setCurrentSearchForSaving', this.onSetCurrentSearchForSaving);\n        });\n\n        this.onSetCurrentSearchForSaving = function(event, data) {\n            this.attr.query = data;\n            this.validate();\n        };\n\n        this.onChange = function(event) {\n            if (this.attr.update) {\n                var $button = this.popover.find('.form button'),\n                    query = this.getQueryForSaving();\n\n                $button.text(\n                    ('id' in query) ?\n                    'Update' : 'Create'\n                );\n            }\n\n            if (this.validate() && event.type === 'keyup' && event.which === 13) {\n                this.save();\n            }\n        };\n\n        this.validate = function() {\n            var $input = this.popover.find(this.attr.nameInputSelector),\n                $button = this.popover.find(this.attr.saveSelector),\n                $global = this.popover.find(this.attr.globalSearchSelector),\n                query = this.getQueryForSaving(),\n                noParameters = _.isEmpty(query.parameters);\n\n            $button.prop('disabled', !query.name || noParameters);\n            $input.prop('disabled', noParameters || !query.url);\n            $global.toggle(!(noParameters || !query.url));\n\n            return query.name && query.url && !noParameters;\n        };\n\n        this.getQueryForSaving = function() {\n            var $nameInput = this.popover.find(this.attr.nameInputSelector),\n                $globalInput = this.popover.find(this.attr.globalInputSelector),\n                query = {\n                    name: $nameInput.val().trim(),\n                    global: $globalInput.is(':checked'),\n                    url: this.attr.query && this.attr.query.url,\n                    parameters: this.attr.query && this.attr.query.parameters\n                };\n\n            if (this.attr.update && query.parameters) {\n                var nameChanged = this.attr.update.name !== query.name,\n                    queryChanged = queryParametersChanged(this.attr.update.parameters, query.parameters);\n\n                if ((nameChanged && !queryChanged) || (!nameChanged && queryChanged) ||\n                   (!nameChanged && !queryChanged)) {\n                    query.id = this.attr.update.id;\n                }\n            }\n\n            return query;\n        };\n\n        this.onSave = function(event) {\n            this.save();\n        };\n\n        this.save = function() {\n            var self = this,\n                $button = this.popover.find(this.attr.saveSelector).addClass('loading'),\n                query = this.getQueryForSaving();\n\n            this.dataRequest('search', 'save', query)\n                .then(function() {\n                    self.teardown();\n                })\n                .finally(function() {\n                    $button.removeClass('loading');\n                })\n        };\n\n        this.onDelete = function(event) {\n            var self = this,\n                $li = $(event.target).closest('li'),\n                index = $li.index(),\n                query = this.attr.list[index],\n                $button = $(event.target).addClass('loading');\n\n            $li.addClass('loading');\n\n            this.dataRequest('search', 'delete', query.id)\n                .then(function() {\n                    if ($li.siblings().length === 0) {\n                        $li.closest('ul').html(\n                            $('<li class=\"empty\">No Saved Searches Found</li>')\n                        );\n                    } else $li.remove();\n\n                    self.attr.list.splice(index, 1);\n\n                    if (self.attr.update && self.attr.update.id === query.id) {\n                        self.popover.find(self.attr.nameInputSelector).val('');\n                        self.popover.find(self.attr.saveSelector).text('Create');\n                        self.attr.update = null;\n                        self.validate();\n                    }\n                })\n                .finally(function() {\n                    $button.removeClass('loading');\n                    $li.removeClass('loading');\n                })\n        };\n\n        this.onClick = function(event) {\n            var query = this.attr.list[$(event.target).closest('li').index()];\n\n            this.trigger('savedQuerySelected', {\n                query: query\n            });\n\n            this.teardown();\n        };\n    }\n});\n"]}