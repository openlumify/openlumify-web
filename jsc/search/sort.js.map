{"version":3,"sources":["../../js/search/sort.js"],"names":["define","defineComponent","FieldSelection","template","ontology","d3","SortByFields","attributes","sorts","restrictToConceptId","propertySelector","listSelector","listItemSelector","removeSelector","after","sortFields","attr","slice","on","onItemClick","onRemoveItemClick","onSetSortFields","onFilterProperties","onPropertySelected","event","stopPropagation","calculateSort","_","debounce","bind","$node","html","attachPropertyField","updateSortFields","filter","$","target","is","searchable","sortable","userVisible","find","trigger","type","data","$li","closest","index","sortField","direction","self","blur","defer","splice","node","teardownComponent","attachTo","properties","list","creatable","onlySearchable","onlySortable","rollupCompound","hideCompound","placeholder","i18n","hasSort","some","sort","field","property","title","push","preventTrigger","$list","select","get","selectAll","call","enter","append","exit","remove","order","each","d","toggleClass","text","byTitle","displayName","toLowerCase","off","axis","cursor","tolerance","containment","ui","sortBy"],"mappings":"gOAAAA,OAAO,CACH,sBADG,CAEH,8BAFG,CAGH,eAHG,CAIH,qDAJG,CAKH,IALG,CAMH,WANG,CAAP,CAOG,SACCC,eADD,CAECC,cAFD,CAGCC,QAHD,CAICC,QAJD,CAKCC,EALD,CAKK,CACJ,aAEA,MAAOJ,iBAAgBK,YAAhB,CAAP,CAEA,QAASA,aAAT,EAAwB,CAEpB,KAAKC,UAAL,CAAgB,CACZC,MAAO,EADK,CAEZC,oBAAqB,EAFT,CAGZC,iBAAkB,kBAHN,CAIZC,aAAc,WAJF,CAKZC,iBAAkB,cALN,CAMZC,eAAgB,2BANJ,CAAhB,EASA,KAAKC,KAAL,CAAW,YAAX,CAAyB,UAAW,CAChC,KAAKC,UAAL,CAAkB,KAAKC,IAAL,CAAUR,KAAV,CAAkB,KAAKQ,IAAL,CAAUR,KAAV,CAAgBS,KAAhB,EAAlB,CAA4C,EAA9D,CACA,KAAKC,EAAL,CAAQ,OAAR,CAAiB,CACbN,iBAAkB,KAAKO,WADV,CAEbN,eAAgB,KAAKO,iBAFR,CAAjB,EAIA,KAAKF,EAAL,CAAQ,eAAR,CAAyB,KAAKG,eAA9B,EACA,KAAKH,EAAL,CAAQ,kBAAR,CAA4B,KAAKI,kBAAjC,EACA,KAAKJ,EAAL,CAAQ,kBAAR,CAA4B,KAAKK,kBAAjC,EACA,KAAKL,EAAL,CAAQ,6JAAR,CAAuK,SAASM,KAAT,CAAgB,CACnLA,MAAMC,eAAN,GACH,CAFD,EAGA,KAAKC,aAAL,CAAqBC,EAAEC,QAAF,CAAW,KAAKF,aAAL,CAAmBG,IAAnB,CAAwB,IAAxB,CAAX,CAA0C,GAA1C,CAArB,CACA,KAAKC,KAAL,CAAWC,IAAX,CAAgB5B,SAAS,EAAT,CAAhB,EAEA,KAAK6B,mBAAL,GACA,KAAKC,gBAAL,CAAsB,IAAtB,EACH,CAjBD,EAmBA,KAAKX,kBAAL,CAA0B,SAASE,KAAT,CAAgBU,MAAhB,CAAwB,CAC9C,GAAIC,EAAEX,MAAMY,MAAR,EAAgBC,EAAhB,CAAmB,kBAAnB,CAAJ,CAA4C,OAE5C,GAAI,CAACH,MAAL,CAAa,CACT,KAAKA,MAAL,CAAc,IAAd,CACH,CAFD,IAEO,CACH,KAAKA,MAAL,aACQ,KAAKA,MAAL,EAAe,EADvB,CAEOA,MAFP,EAGII,WAAY,IAHhB,CAIIC,SAAU,IAJd,CAKIC,YAAa,IALjB,GAOH,CAED,KAAKV,KAAL,CAAWW,IAAX,CAAgB,kBAAhB,EAAoCC,OAApC,CAA4ClB,MAAMmB,IAAlD,CAAwD,KAAKT,MAA7D,EACH,CAhBD,CAkBA,KAAKb,eAAL,CAAuB,SAASG,KAAT,CAAgBoB,IAAhB,CAAsB,CACzC,KAAK7B,UAAL,CAAkB6B,MAAQA,KAAK7B,UAAb,EAA2B,EAA7C,CACA,KAAKkB,gBAAL,GACH,CAHD,CAKA,KAAKd,WAAL,CAAmB,SAASK,KAAT,CAAgB,CAC/B,GAAIqB,KAAMV,EAAEX,MAAMY,MAAR,EAAgBU,OAAhB,CAAwB,IAAxB,CAAV,CACIC,MAAQF,IAAIE,KAAJ,EADZ,CAEIC,UAAY,KAAKjC,UAAL,CAAgBgC,KAAhB,CAFhB,CAGIE,UAAYD,UAAUC,SAH1B,CAKAD,UAAUC,SAAV,CAAsBA,YAAc,WAAd,CAA4B,YAA5B,CAA2C,WAAjE,CACA,KAAKhB,gBAAL,GACH,CARD,CAUA,KAAKb,iBAAL,CAAyB,SAASI,KAAT,CAAgB,CACrCA,MAAMC,eAAN,GACA,GAAIyB,MAAO,IAAX,CACIL,IAAMV,EAAEX,MAAMY,MAAR,EAAgBU,OAAhB,CAAwB,IAAxB,CADV,CAGAtB,MAAMY,MAAN,CAAae,IAAb,GACAxB,EAAEyB,KAAF,CAAQ,UAAW,CACfF,KAAKnC,UAAL,CAAgBsC,MAAhB,CAAuBR,IAAIE,KAAJ,EAAvB,CAAoC,CAApC,EACAG,KAAKjB,gBAAL,GACH,CAHD,EAIH,CAVD,CAYA,KAAKD,mBAAL,CAA2B,UAAW,CAClC,GAAIsB,MAAO,KAAKxB,KAAL,CAAWW,IAAX,CAAgB,kBAAhB,CAAX,CACAa,KAAKC,iBAAL,CAAuBrD,cAAvB,EACAA,eAAesD,QAAf,CAAwBF,IAAxB,CAA8B,CAC1BG,WAAYrD,SAASqD,UAAT,CAAoBC,IADN,CAE1BC,UAAW,KAFe,CAG1BC,eAAgB,IAHU,CAI1BC,aAAc,IAJY,CAK1BC,eAAgB,KALU,CAM1BC,aAAc,IANY,CAO1BC,YAAaC,KAAK,yBAAL,CAPa,CAQ1B/B,mBAAa,KAAKA,MAAlB,EAA0BM,YAAa,IAAvC,EAR0B,CAA9B,EAUH,CAbD,CAeA,KAAKjB,kBAAL,CAA0B,SAASC,KAAT,CAAgBoB,IAAhB,CAAsB,CAC5CpB,MAAMC,eAAN,GACA,KAAKO,mBAAL,GAEA,GAAIkC,SAAUvC,EAAEwC,IAAF,CAAO,KAAKpD,UAAZ,CAAwB,SAASqD,IAAT,CAAe,CACjD,MAAOA,MAAKC,KAAL,GAAezB,KAAK0B,QAAL,CAAcC,KAApC,CACH,CAFa,CAAd,CAGA,GAAI,CAACL,OAAL,CAAc,CACV,KAAKnD,UAAL,CAAgByD,IAAhB,CAAqB,CACjBH,MAAOzB,KAAK0B,QAAL,CAAcC,KADJ,CAEjBtB,UAAW,YAFM,CAArB,EAIA,KAAKhB,gBAAL,GACH,CACJ,CAdD,CAgBA,KAAKA,gBAAL,CAAwB,SAASwC,cAAT,CAAyB,CAC7C,GAAIvB,MAAO,IAAX,CACIwB,MAAQ,KAAKC,MAAL,CAAY,cAAZ,CADZ,CAGAtE,GAAGsE,MAAH,CAAUD,MAAME,GAAN,CAAU,CAAV,CAAV,EACKC,SADL,CACe,IADf,EAEKjC,IAFL,CAEU,KAAK7B,UAFf,EAGK+D,IAHL,CAGU,UAAW,CACb,KAAKC,KAAL,GAAaC,MAAb,CAAoB,IAApB,EACKF,IADL,CACU,UAAW,CACb,KAAKE,MAAL,CAAY,KAAZ,EAAmBF,IAAnB,CAAwB,UAAW,CAC/B,KAAKE,MAAL,CAAY,GAAZ,EACA,KAAKA,MAAL,CAAY,MAAZ,EACH,CAHD,EAIA,KAAKA,MAAL,CAAY,QAAZ,EAAsBhE,IAAtB,CAA2B,OAA3B,CAAoC,yBAApC,EAA+De,IAA/D,CAAoE,QAApE,EACH,CAPL,EAQA,KAAKkD,IAAL,GAAYC,MAAZ,GACH,CAbL,EAcKC,KAdL,GAeKC,IAfL,CAeU,SAASC,CAAT,CAAY,CACdlD,EAAE,IAAF,EACKmD,WADL,CACiB,WADjB,CAC8BD,EAAEpC,SAAF,GAAgB,WAD9C,EAEKL,IAFL,CAEU,OAFV,CAEmByC,EAAEhB,KAFrB,EAGH,CAnBL,EAoBKS,IApBL,CAoBU,UAAW,CACb,KAAKH,MAAL,CAAY,MAAZ,EACKY,IADL,CACU,SAASF,CAAT,CAAY,CACd,MAAOjF,UAASqD,UAAT,CAAoB+B,OAApB,CAA4BH,EAAEhB,KAA9B,EAAqCoB,WAA5C,CACH,CAHL,EAIKzE,IAJL,CAIU,OAJV,CAImB,SAASqE,CAAT,CAAY,CACvB,MAAOjF,UAASqD,UAAT,CAAoB+B,OAApB,CAA4BH,EAAEhB,KAA9B,EAAqCoB,WAA5C,CACH,CANL,EAOA,KAAKd,MAAL,CAAY,GAAZ,EAAiB3D,IAAjB,CAAsB,OAAtB,CAA+B,SAASqE,CAAT,CAAY,CACvC,MAAOA,GAAEpC,SAAF,CAAYyC,WAAZ,EAAP,CACH,CAFD,EAGH,CA/BL,EAiCAhB,MAAMiB,GAAN,CAAU,YAAV,EACKpD,QADL,CACc,CACNqD,KAAM,GADA,CAENC,OAAQ,MAFF,CAGNC,UAAW,SAHL,CAINC,YAAa,QAJP,CADd,EAOK7E,EAPL,CAOQ,YAPR,CAOsB,SAASM,KAAT,CAAgBwE,EAAhB,CAAoB,CAClC9C,KAAKxB,aAAL,GACH,CATL,EAWA,GAAI+C,iBAAmB,IAAvB,CAA6B,CACzB,KAAK/B,OAAL,CAAa,mBAAb,CAAkC,CAC9B3B,WAAY,KAAKA,UADa,CAAlC,EAGH,CACJ,CArDD,CAuDA,KAAKW,aAAL,CAAqB,UAAW,CAC5B,GAAIgD,OAAQ,KAAKC,MAAL,CAAY,cAAZ,CAAZ,CACA,KAAK5D,UAAL,CAAkBY,EAAEsE,MAAF,CAAS,KAAKlF,UAAd,CAA0B,SAASsD,KAAT,CAAgB,CACxD,GAAIxB,KAAM6B,MAAMjC,IAAN,CAAW,IAAX,EAAiBP,MAAjB,CAAwB,UAAW,CACzC,MAAOC,GAAE,IAAF,EAAQS,IAAR,CAAa,OAAb,IAA0ByB,MAAMA,KAAvC,CACH,CAFS,CAAV,CAGA,MAAOxB,KAAIE,KAAJ,EAAP,CACH,CALiB,CAAlB,CAMA,KAAKd,gBAAL,GACH,CATD,CAWH,CACJ,CA9LD","file":"sort.js","sourcesContent":["define([\n    'flight/lib/component',\n    'util/ontology/propertySelect',\n    './sortTpl.hbs',\n    'util/requirejs/promise!util/service/ontologyPromise',\n    'd3',\n    'jquery-ui'\n], function(\n    defineComponent,\n    FieldSelection,\n    template,\n    ontology,\n    d3) {\n    'use strict';\n\n    return defineComponent(SortByFields);\n\n    function SortByFields() {\n\n        this.attributes({\n            sorts: [],\n            restrictToConceptId: '',\n            propertySelector: '.property-select',\n            listSelector: 'ul.fields',\n            listItemSelector: 'ul.fields li',\n            removeSelector: 'ul.fields li .remove-sort'\n        });\n\n        this.after('initialize', function() {\n            this.sortFields = this.attr.sorts ? this.attr.sorts.slice() : [];\n            this.on('click', {\n                listItemSelector: this.onItemClick,\n                removeSelector: this.onRemoveItemClick\n            })\n            this.on('setSortFields', this.onSetSortFields);\n            this.on('filterProperties', this.onFilterProperties);\n            this.on('propertyselected', this.onPropertySelected);\n            this.on('drag dragcreate dragstart dropcreate drop dropover dropout resizecreate resizestart resizestop sort sortstart sortend sortupdate sortreceive sortbeforestop', function(event) {\n                event.stopPropagation();\n            });\n            this.calculateSort = _.debounce(this.calculateSort.bind(this), 250);\n            this.$node.html(template({}));\n\n            this.attachPropertyField();\n            this.updateSortFields(true);\n        });\n\n        this.onFilterProperties = function(event, filter) {\n            if ($(event.target).is('.property-select')) return;\n\n            if (!filter) {\n                this.filter = null;\n            } else {\n                this.filter = {\n                    ...(this.filter || {}),\n                    ...filter,\n                    searchable: true,\n                    sortable: true,\n                    userVisible: true\n                };\n            }\n\n            this.$node.find('.property-select').trigger(event.type, this.filter);\n        };\n\n        this.onSetSortFields = function(event, data) {\n            this.sortFields = data && data.sortFields || [];\n            this.updateSortFields();\n        };\n\n        this.onItemClick = function(event) {\n            var $li = $(event.target).closest('li'),\n                index = $li.index(),\n                sortField = this.sortFields[index],\n                direction = sortField.direction;\n\n            sortField.direction = direction === 'ASCENDING' ? 'DESCENDING' : 'ASCENDING';\n            this.updateSortFields();\n        };\n\n        this.onRemoveItemClick = function(event) {\n            event.stopPropagation();\n            var self = this,\n                $li = $(event.target).closest('li');\n\n            event.target.blur();\n            _.defer(function() {\n                self.sortFields.splice($li.index(), 1);\n                self.updateSortFields();\n            })\n        };\n\n        this.attachPropertyField = function() {\n            var node = this.$node.find('.property-select');\n            node.teardownComponent(FieldSelection);\n            FieldSelection.attachTo(node, {\n                properties: ontology.properties.list,\n                creatable: false,\n                onlySearchable: true,\n                onlySortable: true,\n                rollupCompound: false,\n                hideCompound: true,\n                placeholder: i18n('search.sort.placeholder'),\n                filter: { ...this.filter, userVisible: true }\n            });\n        };\n\n        this.onPropertySelected = function(event, data) {\n            event.stopPropagation();\n            this.attachPropertyField();\n\n            var hasSort = _.some(this.sortFields, function(sort) {\n                return sort.field === data.property.title;\n            });\n            if (!hasSort) {\n                this.sortFields.push({\n                    field: data.property.title,\n                    direction: 'DESCENDING'\n                });\n                this.updateSortFields();\n            }\n        };\n\n        this.updateSortFields = function(preventTrigger) {\n            var self = this,\n                $list = this.select('listSelector');\n\n            d3.select($list.get(0))\n                .selectAll('li')\n                .data(this.sortFields)\n                .call(function() {\n                    this.enter().append('li')\n                        .call(function() {\n                            this.append('div').call(function() {\n                                this.append('a');\n                                this.append('span');\n                            })\n                            this.append('button').attr('class', 'remove-sort remove-icon').html('&times');\n                        })\n                    this.exit().remove();\n                })\n                .order()\n                .each(function(d) {\n                    $(this)\n                        .toggleClass('ascending', d.direction === 'ASCENDING')\n                        .data('field', d.field);\n                })\n                .call(function() {\n                    this.select('span')\n                        .text(function(d) {\n                            return ontology.properties.byTitle[d.field].displayName;\n                        })\n                        .attr('title', function(d) {\n                            return ontology.properties.byTitle[d.field].displayName;\n                        })\n                    this.select('a').attr('title', function(d) {\n                        return d.direction.toLowerCase();\n                    });\n                })\n\n            $list.off('sortupdate')\n                .sortable({\n                    axis: 'y',\n                    cursor: 'move',\n                    tolerance: 'pointer',\n                    containment: 'parent'\n                })\n                .on('sortupdate', function(event, ui) {\n                    self.calculateSort();\n                });\n\n            if (preventTrigger !== true) {\n                this.trigger('sortFieldsUpdated', {\n                    sortFields: this.sortFields\n                })\n            }\n        };\n\n        this.calculateSort = function() {\n            var $list = this.select('listSelector');\n            this.sortFields = _.sortBy(this.sortFields, function(field) {\n                var $li = $list.find('li').filter(function() {\n                    return $(this).data('field') === field.field;\n                })\n                return $li.index();\n            })\n            this.updateSortFields();\n        }\n\n    }\n});\n"]}