define([],function(){var SecondsBeforeTimeout=30;var Key='inactivityLogoutDate';var ConfigKey='auth.token.expiration_minutes';var SecondsToMillis=1000;var MinutesToMillis=SecondsToMillis*60;var UserInitiatedLogoutHint=-1;var MinumumWarning=5*SecondsToMillis;var warnAboutWriting=_.once(function(error){console.warn('Unable to write to localStorage,\ninactivity timeout and logout might happen if multiple windows\nare open and inactive.');});return withSessionTimeout;function withSessionTimeout(){this.after('initialize',function(){var _this=this;this.worker.postMessage({type:'userActivityExtend',init:true});this.on(document,'willLogout',function(){if(!_this.sessionTimeoutWillLogout){_this.sessionTimeoutWillLogout=true;_this.sessionTimeoutUpdateExpiration(UserInitiatedLogoutHint);}});this.on('applicationReady',_.once(function(){Promise.all([Promise.require('util/sessionExpirationOverlay'),_this.dataRequestPromise.then(function(dr){return dr('config','properties');}).then(function(props){return parseFloat(props[ConfigKey],10);})]).spread(function(overlay,minutes){_this.Overlay=overlay;if(minutes){_this.defaultExpiration=minutes*60*1000;_this.sessionTimeoutListeners();_this.sessionTimeoutPushUserActivityExtend({schedule:false});}});}));});this.sessionTimeoutLogout=function(){var _ref=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},_ref$userInitiatedLog=_ref.userInitiatedLogout,userInitiatedLogout=_ref$userInitiatedLog===undefined?false:_ref$userInitiatedLog;if(!this.sessionTimeoutWillLogout){this.sessionTimeoutWillLogout=true;require(['util/offlineOverlay'],function(Offline){if(!$(document).lookupComponent(Offline)){var message=userInitiatedLogout?null:i18n('openlumify.session.expired');$(document).trigger('logout',{message:message});}});}};this.sessionTimeoutActivityHeartBeatFailed=function(){this.sessionTimeoutLogout();};this.sessionTimeoutUpdateExpiration=function(millis){this.ignoreStorageUpdates=true;try{if(millis){localStorage.setItem(Key,String(millis));}else{localStorage.removeItem(Key);}}catch(error){warnAboutWriting(error);}this.ignoreStorageUpdates=false;};this.sessionTimeoutGetExpiration=function(){var millis=localStorage.getItem(Key);if(millis){return parseInt(millis,10);}};this.sessionTimeoutPushUserActivityExtend=function(){var _ref2=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},_ref2$schedule=_ref2.schedule,schedule=_ref2$schedule===undefined?true:_ref2$schedule;if(!this.sessionTimeoutWillLogout){this.sessionTimeoutUpdateExpiration(Date.now()+this.defaultExpiration);this.sessionTimeoutWait();this.worker.postMessage({type:'userActivityExtend',defaultExpiration:this.defaultExpiration,schedule:schedule});}};this.sessionTimeoutWait=function(){var _this2=this;this.warningUser=false;this.Overlay.teardownAll();if(this.inactiveLogoutTimer){clearTimeout(this.inactiveLogoutTimer);}var expirationMillis=this.sessionTimeoutGetExpiration();if(expirationMillis){if(expirationMillis===UserInitiatedLogoutHint){this.sessionTimeoutLogout({userInitiatedLogout:true});}else{var expiration=expirationMillis-Date.now();var defaultWarningDurationMillis=SecondsBeforeTimeout*SecondsToMillis;var warn=expiration-defaultWarningDurationMillis;if(expiration<MinumumWarning){this.sessionTimeoutLogout();}else{this.inactiveLogoutTimer=setTimeout(function(){_this2.warningUser=true;clearTimeout(_this2.inactiveLogoutTimer);var warningDuration=Math.min(expirationMillis-Date.now(),defaultWarningDurationMillis);if(warningDuration<MinumumWarning){_this2.sessionTimeoutLogout();}else{_this2.Overlay.attachTo(document);_this2.inactiveLogoutTimer=setTimeout(function(){_this2.sessionTimeoutLogout();},warningDuration);}},Math.max(0,warn));}}}};this.sessionTimeoutListeners=function(){var _this3=this;var throttledActivity=_.throttle(this.sessionTimeoutPushUserActivityExtend.bind(this),1000,{leading:false});this.on(window,'mousedown mouseup keydown keyup',function(event){if(_this3.warningUser){var eventFinished=event.type==='mouseup'||event.type==='keyup';var isButton=$(event.target).is('.session-continue');if(eventFinished&&isButton){_this3.sessionTimeoutPushUserActivityExtend();}}else{throttledActivity();}});this.on(window,'storage',this.onSessionTimeoutStorageEvent);};this.onSessionTimeoutStorageEvent=function(event){var _this4=this;var key=event.originalEvent.key;if(key===Key&&!this.ignoreStorageUpdates&&!this.sessionTimeoutWillLogout){_.defer(function(){_this4.sessionTimeoutWait();});}};}});
//# sourceMappingURL=withSessionTimeout.js.map
