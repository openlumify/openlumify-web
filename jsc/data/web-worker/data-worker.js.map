{"version":3,"sources":["../../../js/data/web-worker/data-worker.js"],"names":["importScripts","BASE_URL","self","needsInitialSetup","publicData","ajaxFilters","pre","post","pluginsLoaded","_resolve","_isFinished","promise","Promise","r","isFinished","resolve","timer","todo","setupInProgress","onmessage","event","setupAll","JSON","parse","data","push","require","_","onMessageHandler","setupComplete","forEach","openlumifyEnvironment","environment","setupConsole","setupWebsocket","resolveStore","storePromise","f","setupRequireJs","documentExtensionPoints","setupRedux","then","_store","store","getStore","state","getState","dispatchMain","e","console","error","noop","log","info","debug","warn","group","groupCollapsed","groupEnd","type","logType","messages","Array","prototype","slice","call","arguments","map","arg","stringify","isFirefox","navigator","userAgent","indexOf","supportedInWorker","WebSocket","MozWebSocket","window","cacheBreaker","atmosphere","util","getAbsoluteURL","atmosphereConfiguration","url","closeSocket","socket","close","pushSocketMessage","message","all","fulfill","reject","__socketOpened","__socketPromiseFulfill","__socketPromiseReject","done","results","websocketUtils","pushDataToSocket","socketSourceGuid","callback","File","Blob","FormData","baseUrl","urlArgs","prod","load","asyncRequireJSLoader","webWorkerResources","src","catch","processMainMessage","handler","registry","documentExtensionPoint","isFunction","lastPost","MAX_SEND_RATE_MILLIS","postMessageQueue","drainTimeout","now","Date","duration","clearTimeout","Error","setTimeout","drainMessageQueue","postMessage","length","jsonString","ajaxPostfilter","xmlHttpRequest","json","options","apply","ajaxPrefilter","method","parameters","filters","setWorkspaceHeader","setCsrfHeader","setSourceGuidHeader","setGraphTracing","invoke","hasWorkspaceParam","workspaceId","currentWorkspaceId","setRequestHeader","eligibleForProtection","test","user","currentUser","token","csrfToken","isUpdate","guid","graphTraceEnable","context","moduleName","xhr","XMLHttpRequest","open","responseType","onload","status","blob","response","blobURL","URL","createObjectURL","revokeObjectURL","completeLoad","onError","onerror","send"],"mappings":"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","file":"data-worker.js","sourcesContent":["/*global self:true*/\n/*global onmessage:true*/\n/*global console:true*/\n/*global publicData:true*/\n/*global store:false*/\n/*global BASE_URL:true*/\n/*global importScripts:false*/\n\n/*eslint strict:0*/\nthis.importScripts('../../../libs/babel-polyfill/dist/polyfill.min.js');\n\nvar BASE_URL = '../../..',\n    self = this,\n    needsInitialSetup = true,\n    publicData = {},\n    ajaxFilters = { pre: [], post: [] },\n    pluginsLoaded = (function() {\n        var _resolve, _isFinished = false;\n        return {\n            promise: new Promise(r => {_resolve = r}),\n            isFinished() { return _isFinished; },\n            resolve() { _isFinished = true; _resolve() }\n        }\n    })();\n\nvar timer, todo = [], setupInProgress = true;\nonmessage = function(event) {\n    if (needsInitialSetup) {\n        todo = [];\n        needsInitialSetup = false;\n        setupInProgress = true;\n        setupAll(JSON.parse(event.data));\n        return;\n    }\n\n    if (setupInProgress) {\n        todo.push(event);\n        return;\n    }\n\n    require([\n        'underscore',\n        'util/promise'\n    ], function(_, Promise) {\n        onMessageHandler(event);\n    })\n};\n\nfunction setupComplete() {\n    setupInProgress = false;\n    todo.forEach(event => onmessage(event));\n}\n\nfunction setupAll(data) {\n    self.openlumifyEnvironment = data.environment;\n    setupConsole();\n    setupWebsocket(data);\n    var resolveStore;\n    publicData.storePromise = new Promise(f => {resolveStore = f});\n    setupRequireJs(data, () => {\n        pluginsLoaded.resolve();\n        documentExtensionPoints();\n        setupRedux(data).then(resolveStore);\n        setupComplete();\n    });\n}\n\nfunction setupRedux(data) {\n    return new Promise(resolve => {\n        require(['data/web-worker/store'], function(_store) {\n            try {\n                const store = _store.getStore();\n                const state = store.getState();\n                dispatchMain('reduxStoreInit', { state });\n                resolve(store);\n            } catch(e) {\n                console.error(e)\n                throw e;\n            }\n        });\n    })\n}\n\nfunction setupConsole() {\n    var noop = function() {};\n\n    if (typeof console === 'undefined') {\n        console = {\n            log: log('log'),\n            info: log('info'),\n            debug: log('debug'),\n            error: log('error'),\n            warn: log('warn'),\n            group: noop,\n            groupCollapsed: noop,\n            groupEnd: noop\n        };\n    }\n    function log(type) {\n        return function() {\n            dispatchMain('brokenWorkerConsole', {\n                logType: type,\n                messages: Array.prototype.slice.call(arguments, 0).map(function(arg) {\n                    return JSON.stringify(arg);\n                })\n            });\n        }\n    }\n}\n\nfunction setupWebsocket(data) {\n    var isFirefox = navigator && navigator.userAgent && ~navigator.userAgent.indexOf('Firefox'),\n        supportedInWorker = !!(this.WebSocket || this.MozWebSocket) && !isFirefox;\n\n    if (supportedInWorker) {\n        self.window = self;\n        importScripts(BASE_URL + '/libs/atmosphere.js/lib/atmosphere.js?' + data.cacheBreaker);\n        atmosphere.util.getAbsoluteURL = function() {\n            return publicData.atmosphereConfiguration.url;\n        }\n        self.closeSocket = function() {\n            if (publicData.socket) {\n                publicData.socket.close();\n            }\n        }\n        self.pushSocketMessage = function(message) {\n            Promise.all([\n                Promise.require('util/websocket'),\n                new Promise(function(fulfill, reject) {\n                    if (atmosphere.util.__socketOpened) {\n                        fulfill(publicData.socket);\n                    }\n                    atmosphere.util.__socketPromiseFulfill = fulfill;\n                    atmosphere.util.__socketPromiseReject = reject;\n                })\n            ]).done(function(results) {\n                var websocketUtils = results[0],\n                    socket = results[1];\n\n                websocketUtils.pushDataToSocket(socket, publicData.socketSourceGuid, message);\n            });\n        }\n    } else {\n        dispatchMain('websocketNotSupportedInWorker');\n        self.closeSocket = function() {\n            dispatchMain('websocketLegacyClose');\n        }\n        self.pushSocketMessage = function(message) {\n            dispatchMain('websocketFromWorker', { message: message });\n        }\n    }\n}\n\nfunction setupRequireJs(data, callback) {\n    if (typeof File === 'undefined') {\n        self.File = Blob;\n    }\n    if (typeof FormData === 'undefined') {\n        importScripts('./util/formDataPolyfill.js?' + data.cacheBreaker);\n    }\n    importScripts(BASE_URL + '/jsc/require.config.js?' + data.cacheBreaker);\n    require.baseUrl = BASE_URL + '/jsc/';\n    require.urlArgs = data.cacheBreaker;\n    importScripts(BASE_URL + '/libs/requirejs/require.js?' + data.cacheBreaker);\n    if (openlumifyEnvironment.prod) {\n        require.load = asyncRequireJSLoader\n    }\n\n    Promise.all(\n        data.webWorkerResources.map(src => {\n            return new Promise(function(done, error) {\n                require([src], done, error)\n            })\n        })\n    ).then(callback).catch(error => {\n        console.error(error);\n        throw error;\n    })\n}\n\nfunction onMessageHandler(event) {\n    var data = event.data;\n    processMainMessage(data);\n}\n\nfunction processMainMessage(data) {\n    if (data.type) {\n        require(['data/web-worker/handlers/' + data.type], function(handler) {\n            handler(data);\n        });\n    } else console.warn('Unhandled message to worker', event);\n}\n\nfunction documentExtensionPoints() {\n    require(['configuration/plugins/registry'], function(registry) {\n        /**\n         * Extension to register new listeners for websocket messages. Must be registered in JavaScript file registered with `app.registerWebWorkerJavaScript` in web app plugin.\n         *\n         * @param {string} name The message name to listen for. Matches the\n         * `type` parameter in message json\n         * @param {function} handler The function to invoke when messages\n         * arrive. Accepts one parameter: `data`\n         */\n        registry.documentExtensionPoint('org.openlumify.websocket.message',\n            'Add custom websocket message handlers',\n            function(e) {\n                return ('name' in e) && _.isFunction(e.handler)\n            },\n            'http://docs.openlumify.org/extension-points/front-end/websocket'\n        );\n    })\n}\n\nvar lastPost = 0,\n    MAX_SEND_RATE_MILLIS = 500,\n    postMessageQueue = [],\n    drainTimeout;\nfunction dispatchMain(type, message) {\n    var now = Date.now(),\n        duration = now - lastPost;\n\n    if (drainTimeout) {\n        clearTimeout(drainTimeout);\n    }\n\n    if (!type) {\n        throw new Error('dispatchMain requires type argument');\n    }\n    message = message || {};\n    message.type = type;\n\n    postMessageQueue.push(message);\n\n    if (type === 'rebroadcastEvent' && duration < MAX_SEND_RATE_MILLIS) {\n        drainTimeout = setTimeout(drainMessageQueue, MAX_SEND_RATE_MILLIS - duration);\n        return;\n    }\n\n    drainMessageQueue();\n}\n\nfunction drainMessageQueue() {\n    try {\n        postMessage(postMessageQueue);\n        postMessageQueue.length = 0;\n        lastPost = Date.now();\n    } catch(e) {\n        var jsonString = JSON.stringify(postMessageQueue);\n        postMessage({\n            type: 'brokenWorkerConsole',\n            logType: 'error',\n            messages: ['error posting', e.message, jsonString]\n        });\n    }\n}\n\nfunction ajaxPostfilter(xmlHttpRequest, json, options) {\n    ajaxFilters.post.forEach(f => f.apply(null, arguments))\n}\n\nfunction ajaxPrefilter(xmlHttpRequest, method, url, parameters) {\n    if (publicData) {\n        var filters = [\n                setWorkspaceHeader,\n                setCsrfHeader,\n                setSourceGuidHeader,\n                setGraphTracing\n                // TODO: set timezone\n            ], invoke = function(f) {\n                f();\n            };\n\n        filters.forEach(invoke);\n    }\n\n    function setWorkspaceHeader() {\n        var hasWorkspaceParam = typeof (parameters && parameters.workspaceId) !== 'undefined';\n        if (publicData.currentWorkspaceId && !hasWorkspaceParam) {\n            xmlHttpRequest.setRequestHeader('OpenLumify-Workspace-Id', publicData.currentWorkspaceId);\n        }\n    }\n    function setCsrfHeader() {\n        var eligibleForProtection = !(/get/i).test(method),\n            user = publicData.currentUser,\n            token = user && user.csrfToken;\n\n        if (eligibleForProtection && token) {\n            xmlHttpRequest.setRequestHeader('OpenLumify-CSRF-Token', token);\n        }\n    }\n    function setSourceGuidHeader() {\n        var isUpdate = !(/get/i).test(method),\n            guid = publicData.socketSourceGuid;\n\n        if (isUpdate && guid) {\n            xmlHttpRequest.setRequestHeader('OpenLumify-Source-Guid', guid);\n        }\n    }\n    function setGraphTracing() {\n        if (publicData.graphTraceEnable) {\n            xmlHttpRequest.setRequestHeader('graphTraceEnable', 'true');\n        }\n    }\n\n    ajaxFilters.pre.forEach(f => f.apply(null, arguments))\n}\n\nfunction asyncRequireJSLoader(context, moduleName, url) {\n    var xhr = new XMLHttpRequest();\n    xhr.open('GET', url, true);\n    xhr.responseType = 'blob';\n    xhr.onload = function(e) {\n        if (this.status === 200) {\n            var blob = new Blob([this.response], { type: 'text/javascript' });\n            var blobURL = URL.createObjectURL(blob);\n            importScripts(blobURL);\n            URL.revokeObjectURL(blobURL);\n            context.completeLoad(moduleName);\n        } else {\n            context.onError(new Error('Require for ' + moduleName + ' failed at ' + url));\n        }\n    };\n    xhr.onerror = function() {\n        context.onError(new Error('Require for ' + moduleName + ' failed at ' + url));\n    }\n    xhr.send();\n}\n"]}