{"version":3,"sources":["../../../../js/data/web-worker/services/workspace.js"],"names":["define","ajax","storeHelper","workspaceActions","elementSelectors","productSelectors","queue","getStore","api","diff","workspaceId","workspaces","getState","workspace","currentId","getOrCreate","get","Promise","reject","catch","all","then","_","findWhere","sharedToUser","create","allLoaded","resolve","sort","Object","values","byId","result","dispatch","setAll","sortBy","w","title","toLowerCase","tap","update","deleteWorkspace","current","histogramValues","property","store","state","elements","element","productId","product","selected","products","Error","getExtendedData","extendedData","getElementIdsInProduct","unsubscribe","fulfill","observe","nextState","prevState","vertices","edges","getElements","check","elementsState","ret","compact","keys","map","id","length","previous","newElements","getOntology","require","o","ontology","spread","ontologyConcepts","concepts","ontologyRelationships","relationships","ontologyProperties","properties","foundOntologyProperties","foundYPropertiesByConcept","chain","concat","v","isEdge","conceptProperty","name","conceptPropertyIri","label","value","filter","p","ontologyProperty","byTitle","matched","dataType","userVisible","found","find","f","indexOf","push","where","ontologyByType","parentTypeField","concept","eligibleYTypes","split","foundYProperties","i","parentConcept","forEach","prop","yValues","each","base","conceptIri","propertyIri","flatten","isDateOnlyProperty","some","byDataType","date","displayType","Date","getTimezoneOffset","save","changes","arguments","publicData","currentWorkspaceId","allChanges","extend","userUpdates","userDeletes","data","JSON","stringify","saved","publish","publishData","undo","undoData","options"],"mappings":"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","file":"workspace.js","sourcesContent":["/**\n * Routes for workspace (case)\n *\n * @module services/workspace\n * @see module:dataRequest\n */\ndefine([\n    '../util/ajax',\n    '../store',\n    '../store/workspace/actions-impl',\n    '../store/element/selectors',\n    '../store/product/selectors',\n    '../util/queue'\n], function(ajax, storeHelper, workspaceActions, elementSelectors, productSelectors, queue) {\n    'use strict';\n\n    const { getStore } = storeHelper;\n\n    /**\n     * @alias module:services/workspace\n     */\n    var api = {\n\n        /**\n         * Get the current sandboxed unpublished changes in workspace\n         *\n         * @param {string} [workspaceId]\n         */\n        diff: function(workspaceId) {\n            var workspaces = getStore().getState().workspace;\n            return ajax('GET', '/workspace/diff', {\n                workspaceId: workspaceId || workspaces.currentId\n            });\n        },\n\n        getOrCreate: function() {\n            var workspaces = getStore().getState().workspace;\n            return (workspaces.currentId ? api.get() : Promise.reject())\n                .catch(function() {\n                    return api.all()\n                        .then(function(workspaces) {\n                            var workspace = _.findWhere(workspaces, { sharedToUser: false });\n                            if (workspace) {\n                                return api.get(workspace.workspaceId);\n                            }\n                            return api.create();\n                        });\n                });\n        },\n\n        all: function() {\n            var workspaces = getStore().getState().workspace;\n            if (workspaces.allLoaded) {\n                return Promise.resolve(sort(Object.values(workspaces.byId)));\n            } else {\n                return ajax('GET', '/workspace/all')\n                    .then(function(result) {\n                        getStore().dispatch(workspaceActions.setAll({ workspaces: result.workspaces }));\n                        return sort(result.workspaces);\n                    })\n            }\n\n            function sort(workspaces) {\n                return _.sortBy(workspaces, function(w) {\n                    return w.title.toLowerCase();\n                });\n            }\n        },\n\n        get: function(workspaceId) {\n            var workspaces = getStore().getState().workspace;\n            return ajax('GET', '/workspace', {\n                workspaceId: workspaceId || workspaces.currentId\n            }).tap(workspace => {\n                getStore().dispatch(workspaceActions.update({ workspace }))\n            });\n        },\n\n        'delete': function(workspaceId) {\n            return ajax('DELETE', '/workspace', {\n                workspaceId: workspaceId\n            })\n                .tap(() => {\n                    getStore().dispatch(workspaceActions.deleteWorkspace({ workspaceId }))\n                })\n        },\n\n        current: function(workspaceId) {\n            var workspaces = getStore().getState().workspace;\n            return Promise.resolve(workspaces.byId[workspaceId || workspaces.currentId]);\n        },\n\n        histogramValues: function(property) {\n            const store = getStore();\n            const state = store.getState();\n            const workspaceId = state.workspace.currentId;\n            const elements = state.element[workspaceId];\n            const productId = state.product.workspaces[workspaceId].selected;\n            const product = productId && state.product.workspaces[workspaceId].products[productId];\n\n            if (!product) {\n                throw new Error('No Product to calculate timeline')\n            }\n\n            const getExtendedData = () => {\n                if (product.extendedData) {\n                    return Promise.resolve(productSelectors.getElementIdsInProduct(state));\n                }\n                let unsubscribe = () => {};\n                return new Promise(function(fulfill) {\n                    unsubscribe = store.observe((nextState, prevState) => {\n                        if (!prevState || prevState.product.workspaces !== nextState.product.workspaces) {\n                            const product = productId && nextState.product.workspaces[workspaceId].products[productId];\n                            if (product.extendedData && product.extendedData.vertices && product.extendedData.edges) {\n                                fulfill(productSelectors.getElementIdsInProduct(nextState));\n                            }\n                        }\n                    })\n                }).tap(unsubscribe);\n            }\n            const getElements = ({ vertices, edges }) => {\n                const check = (elementsState) => {\n                    const ret = {\n                        vertices: _.compact(Object.keys(vertices).map(id => elementsState.vertices[id])),\n                        edges: _.compact(Object.keys(edges).map(id => elementsState.edges[id]))\n                    }\n                    if (ret.vertices.length === Object.keys(vertices).length\n                        && ret.edges.length === Object.keys(edges).length) {\n                        return ret;\n                    }\n                }\n                const result = check(elements);\n                if (result) {\n                    return result;\n                } else {\n                    let unsubscribe = () => {};\n                    return new Promise(function(fulfill) {\n                        var previous = state.element[state.workspace.currentId];\n                        unsubscribe = store.observe(elementSelectors.getElements, (newElements) => {\n                            let result = check(elements);\n                            if (result) {\n                                fulfill(result);\n                            }\n                        })\n                    }).tap(unsubscribe);\n                }\n            }\n            const getOntology = () => Promise.require('data/web-worker/services/ontology').then(o => o.ontology());\n\n            return Promise.all([\n                getExtendedData().then(getElements),\n                (property.title === 'ALL_DATES' ? getOntology() : Promise.resolve())\n            ])\n                    .spread(function({ vertices, edges }, ontology) {\n                        var ontologyConcepts = ontology && ontology.concepts,\n                            ontologyRelationships = ontology && ontology.relationships,\n                            ontologyProperties = ontology && ontology.properties,\n                            foundOntologyProperties = [],\n                            foundYPropertiesByConcept = {},\n                            values = _.chain(vertices.concat(edges))\n                                .compact()\n                                .map(function(v) {\n                                    var isEdge = ('label' in v && 'inVertexId' in v && 'outVertexId' in v),\n                                        conceptProperty = !isEdge && _.findWhere(v.properties, { name: 'http://openlumify.org#conceptType'}),\n                                        conceptPropertyIri = isEdge ? v.label : (\n                                            conceptProperty && conceptProperty.value || 'http://www.w3.org/2002/07/owl#Thing'\n                                        ),\n                                        properties = ontologyProperties ?\n                                            _.filter(v.properties, function(p) {\n                                                var ontologyProperty = ontologyProperties.byTitle[p.name],\n                                                    matched = ontologyProperty && ontologyProperty.dataType === property.dataType && ontologyProperty.userVisible !== false;\n\n                                                if (matched) {\n                                                    var found = _.find(foundOntologyProperties, function(f) {\n                                                        return f.property.title === ontologyProperty.title;\n                                                    });\n                                                    if (found) {\n                                                        if (conceptPropertyIri &&\n                                                            found.concepts.indexOf(conceptPropertyIri) === -1) {\n                                                            found.concepts.push(conceptPropertyIri);\n                                                        }\n                                                    } else {\n                                                        foundOntologyProperties.push({\n                                                            property: ontologyProperty,\n                                                            concepts: conceptPropertyIri ? [conceptPropertyIri] : []\n                                                        });\n                                                    }\n                                                }\n\n                                                return matched;\n                                            }) :\n                                            _.where(v.properties, { name: property.title }),\n                                        ontologyByType = isEdge ?\n                                            ontologyRelationships && ontologyRelationships.byTitle :\n                                            ontologyConcepts && ontologyConcepts.byId,\n                                        parentTypeField = isEdge ? 'parentIri' : 'parentConcept',\n                                        concept = ontologyByType[conceptPropertyIri],\n                                        eligibleYTypes = 'double integer currency number'.split(' '),\n                                        foundYProperties = conceptPropertyIri && foundYPropertiesByConcept[conceptPropertyIri];\n\n                                    if (conceptPropertyIri && !foundYProperties) {\n                                        foundYProperties = [];\n                                        while (concept) {\n                                            for (var i = 0; i < concept.properties.length; i++) {\n                                                var p = ontologyProperties.byTitle[concept.properties[i]];\n                                                if (p && p.userVisible !== false && ~eligibleYTypes.indexOf(p.dataType)) {\n                                                    foundYProperties.push(p);\n                                                }\n                                            }\n                                            concept = concept.parentConcept && ontologyByType[concept[parentTypeField]];\n                                        }\n\n                                        v.properties.forEach(function(prop) {\n                                            if (!_.findWhere(foundYProperties, { title: prop.name })) {\n                                                var p = ontologyProperties.byTitle[prop.name];\n                                                if (p && p.userVisible !== false && ~eligibleYTypes.indexOf(p.dataType)) {\n                                                    foundYProperties.push(p);\n                                                }\n                                            }\n                                        });\n\n                                        foundYPropertiesByConcept[conceptPropertyIri] = foundYProperties;\n                                    }\n\n                                    var yValues = {};\n                                    if (foundYProperties && foundYProperties.length) {\n                                        _.each(v.properties, function(p) {\n                                            _.each(foundYProperties, function(prop) {\n                                                if (p.name === prop.title) {\n                                                    if (!yValues[p.name]) yValues[p.name] = [];\n                                                    yValues[p.name].push(p.value);\n                                                }\n                                            })\n                                        })\n                                    }\n\n                                    return _.map(properties, function(p) {\n                                        var ontologyProperty = ontologyProperties && ontologyProperties.byTitle[p.name],\n                                            base = {\n                                                conceptIri: conceptPropertyIri,\n                                                propertyIri: ontologyProperty && ontologyProperty.title,\n                                                value: p.value,\n                                                yValues: yValues\n                                            };\n\n                                        base[isEdge ? 'edgeId' : 'vertexId'] = v.id;\n                                        return base;\n                                    })\n                                })\n                                .flatten(true)\n                                .compact()\n                                .sortBy('value')\n                                .value();\n\n                        _.each(values, function(v) {\n                            var isDateOnlyProperty = _.some(ontologyProperties.byDataType.date, {\n                                    title: v.propertyIri,\n                                    displayType: 'dateOnly'\n                                });\n\n                            if (isDateOnlyProperty) {\n                               v.value += (new Date(v.value).getTimezoneOffset() * 60000);\n                            }\n                        });\n\n                        return { values: values, foundOntologyProperties: foundOntologyProperties };\n                    })\n        },\n\n        save: queue(function(workspaceId, changes) {\n            if (arguments.length === 1) {\n                changes = workspaceId;\n                workspaceId = publicData.currentWorkspaceId;\n            }\n\n            var allChanges = _.extend({}, {\n                userUpdates: [],\n                userDeletes: []\n            }, changes || {});\n\n            return ajax('POST', '/workspace/update', {\n                workspaceId: workspaceId,\n                data: JSON.stringify(allChanges)\n            }).then(function(workspace) {\n                getStore().dispatch(workspaceActions.update({ workspace }))\n                return { saved: true, workspace };\n            });\n        }),\n\n        publish: function(changes) {\n            return ajax('POST', '/workspace/publish', {\n                publishData: JSON.stringify(changes)\n            });\n        },\n\n        undo: function(changes) {\n            return ajax('POST', '/workspace/undo', {\n                undoData: JSON.stringify(changes)\n            });\n        },\n\n        create: function(options) {\n            return ajax('POST', '/workspace/create', options)\n                .tap(workspace => {\n                    getStore().dispatch(workspaceActions.update({ workspace }))\n                })\n        }\n    };\n\n    return api;\n})\n"]}