{"version":3,"sources":["../../../../js/data/web-worker/services/storeHelper.js"],"names":["define","store","ajax","elementActions","propertyUrl","elementType","property","name","indexElementProperties","element","propertiesByName","properties","_","groupBy","registerStoreListenerAndFireVerticesUpdated","updateElement","workspaceId","arguments","length","getStore","getState","workspace","currentId","dispatch","putSearchResults","elements","isEmpty","indexSearchResultsProperties","results","referencedElements","forEach","createStoreAccessorOrDownloader","type","options","key","resultKey","state","returnSingular","isArray","elementIds","toRequest","reject","id","Promise","resolve","then","result","update","existing","pick","Object","values","concat","ret","vertexPropertyUrl","edgePropertyUrl","redux","previousElements","previousElementsWorkspaceId","subscribe","newElements","workspaceChanged","updated","deleted","each","el","push","dispatchMain","eventName","data","fire","vertexIds","edgeId"],"mappings":"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","file":"storeHelper.js","sourcesContent":["\ndefine([\n    '../store',\n    '../util/ajax',\n    '../store/element/actions-impl'\n], function(store, ajax, elementActions) {\n    'use strict';\n\n    function propertyUrl(elementType, property) {\n        return '/' + elementType + '/' +\n            (property.name === 'http://openlumify.org/comment#entry' ? 'comment' : 'property');\n    }\n\n    function indexElementProperties(element) {\n        if (element) {\n            element.propertiesByName = element.properties ? _.groupBy(element.properties, 'name') : {};\n        }\n    }\n\n    registerStoreListenerAndFireVerticesUpdated();\n\n    return {\n        updateElement(workspaceId, element) {\n            if (arguments.length === 1) {\n                element = workspaceId;\n                workspaceId = store.getStore().getState().workspace.currentId;\n            }\n            store.getStore().dispatch(\n                elementActions.updateElement(workspaceId, element)\n            );\n        },\n\n        putSearchResults(elements) {\n            if (!_.isEmpty(elements)) {\n                store.getStore().dispatch(elementActions.putSearchResults(elements))\n            }\n        },\n\n        indexSearchResultsProperties(results) {\n            const { elements = [], referencedElements = [] } = results;\n            if (elements) {\n                elements.forEach(indexElementProperties)\n            }\n            if (referencedElements) {\n                referencedElements.forEach(indexElementProperties)\n            }\n            return results;\n        },\n\n        indexElementProperties,\n\n        createStoreAccessorOrDownloader: (type) => (options) => {\n            const key = type + 'Ids';\n            const resultKey = type === 'vertex' ? 'vertices' : 'edges';\n            const state = store.getStore().getState();\n            const workspaceId = state.workspace.currentId;\n            const elements = state.element[workspaceId];\n            const returnSingular = !_.isArray(options[key]);\n            const elementIds = returnSingular ? [options[key]] : options[key];\n\n            var toRequest = elementIds;\n            if (elements) {\n                toRequest = _.reject(toRequest, id => id in elements[resultKey]);\n            }\n\n            return (\n                toRequest.length ?\n                ajax('POST', `/${type}/multiple`, { [key]: toRequest }) :\n                Promise.resolve({[resultKey]:[]})\n            ).then(function(result) {\n                const results = result[resultKey];\n\n                if (results.length) {\n                    store.getStore().dispatch(elementActions.update({ [resultKey]: results, workspaceId }));\n                }\n\n                if (elements) {\n                    const existing = _.pick(elements[resultKey], elementIds)\n                    return Object.values(existing).concat(results)\n                }\n                return results;\n            }).then(function(ret) {\n                return returnSingular && ret.length ? ret[0] : ret;\n            })\n        },\n\n        vertexPropertyUrl: function(property) {\n            return propertyUrl('vertex', property);\n        },\n\n        edgePropertyUrl: function(property) {\n            return propertyUrl('edge', property);\n        }\n    };\n\n    function registerStoreListenerAndFireVerticesUpdated() {\n        const redux = store.getStore();\n        var previousElements, previousElementsWorkspaceId;\n        redux.subscribe(function() {\n            const state = redux.getState();\n            const workspaceId = state.workspace.currentId;\n            const newElements = state.element[workspaceId];\n            const workspaceChanged = workspaceId !== previousElementsWorkspaceId;\n\n            if (previousElements && !workspaceChanged && newElements !== previousElements) {\n                ['vertices', 'edges'].forEach(function(type) {\n                    const updated = [];\n                    const deleted = [];\n                    _.each(newElements[type], (el, id) => {\n                        if (id in previousElements[type] && el !== previousElements[type][id]) {\n                            if (el === null) {\n                                deleted.push(id);\n                            } else {\n                                updated.push(el);\n                            }\n                        }\n                    })\n\n                    if (updated.length) {\n                        dispatchMain('rebroadcastEvent', {\n                            eventName: `${type}Updated`,\n                            data: {\n                                [type]: updated\n                            }\n                        })\n                    }\n                    if (deleted.length) {\n                        let fire = (data) => {\n                            dispatchMain('rebroadcastEvent', { eventName: `${type}Deleted`, data })\n                        }\n                        if (type === 'vertices') {\n                            fire({ vertexIds: deleted });\n                        } else {\n                            deleted.forEach(id => fire({ edgeId: id }));\n                        }\n                    }\n                })\n            }\n            previousElements = newElements;\n            previousElementsWorkspaceId = workspaceId;\n        });\n    }\n});\n"]}