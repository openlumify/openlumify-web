{"version":3,"sources":["../../../../js/data/web-worker/services/user.js"],"names":["define","ajax","store","userActions","api","me","options","then","user","_","extend","privilegesHelper","indexBy","privileges","get","userName","preference","name","value","getStore","dispatch","putUserPreference","getUserNames","cachedNames","userIds","notCached","reject","userId","publicData","currentUser","id","length","search","users","usersById","map","displayName","Promise","resolve","data","returnSingular","query","q","online","isArray","unique","response","logout"],"mappings":"AAMAA,OAAO,CAAC,cAAD,CAAiB,UAAjB,CAA6B,4BAA7B,CAAP,CAAmE,SAASC,IAAT,CAAeC,KAAf,CAAsBC,WAAtB,CAAmC,CAClG,aAKA,GAAIC,KAAM,CAKNC,GAAI,YAASC,OAAT,CAAkB,CAClB,MAAOL,MAAK,KAAL,CAAY,UAAZ,EACFM,IADE,CACG,SAASC,IAAT,CAAe,CACjB,MAAOC,GAAEC,MAAF,CAASF,IAAT,CAAe,CAClBG,iBAAkBF,EAAEG,OAAF,CAAUJ,KAAKK,UAAL,EAAmB,EAA7B,CADA,CAAf,CAAP,CAGH,CALE,CAAP,CAMH,CAZK,CAkBNC,IAAK,aAASC,QAAT,CAAmB,CACpB,MAAOd,MAAK,KAAL,CAAY,OAAZ,CAAqB,CACxB,YAAac,QADW,CAArB,CAAP,CAGH,CAtBK,CA6BNC,WAAY,oBAASC,IAAT,CAAeC,KAAf,CAAsB,CAC9BhB,MAAMiB,QAAN,GAAiBC,QAAjB,CAA0BjB,YAAYkB,iBAAZ,CAA8B,CAAEJ,SAAF,CAAQC,WAAR,CAA9B,CAA1B,EACA,MAAOjB,MAAK,MAAL,CAAa,sBAAb,CAAqC,CACxCgB,KAAMA,IADkC,CAExCC,MAAOA,KAFiC,CAArC,CAAP,CAIH,CAnCK,CA0CNI,aAAe,UAAW,CACtB,GAAIC,aAAc,EAAlB,CACA,MAAO,SAASD,aAAT,CAAsBE,OAAtB,CAA+B,CAClC,GAAIC,WAAYhB,EAAEiB,MAAF,CAASF,OAAT,CAAkB,SAASG,MAAT,CAAiB,CAC/C,MAAOA,UAAUJ,YAAV,EACHK,WAAWC,WAAX,CAAuBC,EAAvB,GAA8BH,MADlC,CAGH,CAJe,CAAhB,CAMA,GAAIF,UAAUM,MAAd,CAAsB,CAClB,MAAO3B,KAAI4B,MAAJ,CAAW,CAAER,QAASC,SAAX,CAAX,EACFlB,IADE,CACG,SAAS0B,KAAT,CAAgB,CAClB,GAAIC,WAAYzB,EAAEG,OAAF,CAAUqB,KAAV,CAAiB,IAAjB,CAAhB,CACA,MAAOT,SAAQW,GAAR,CAAY,SAASR,MAAT,CAAiB,CAChC,MAAOJ,aAAYI,MAAZ,IACHJ,YAAYI,MAAZ,EAAsB,CAACO,UAAUP,MAAV,GAAqBC,WAAWC,WAAjC,EAA8CO,WADjE,CAAP,CAGH,CAJM,CAAP,CAKH,CARE,CAAP,CASH,CAVD,IAUO,CACH,MAAOC,SAAQC,OAAR,CACHd,QAAQW,GAAR,CAAY,SAASR,MAAT,CAAiB,CACzB,MAAOJ,aAAYI,MAAZ,GAAuBC,WAAWC,WAAX,CAAuBO,WAArD,CACH,CAFD,CADG,CAAP,CAKH,CACJ,CAxBD,CAyBH,CA3Ba,EA1CR,CA6ENJ,OAAQ,gBAAS1B,OAAT,CAAkB,CACtB,GAAIiC,MAAO,EAAX,CACIC,eAAiB,KADrB,CAGA,GAAIlC,QAAQmC,KAAZ,CAAmB,CACfF,KAAKG,CAAL,CAASpC,QAAQmC,KAAjB,CACH,CACD,GAAInC,QAAQqC,MAAZ,CAAoB,CAChBJ,KAAKI,MAAL,CAAcrC,QAAQqC,MAAtB,CACH,CACD,GAAIrC,QAAQkB,OAAZ,CAAqB,CACjB,GAAI,CAACf,EAAEmC,OAAF,CAAUtC,QAAQkB,OAAlB,CAAL,CAAiC,CAC7BgB,eAAiB,IAAjB,CACAD,KAAKf,OAAL,CAAe,CAAClB,QAAQkB,OAAT,CAAf,CACH,CAHD,IAGO,CACHe,KAAKf,OAAL,CAAef,EAAEoC,MAAF,CAASvC,QAAQkB,OAAjB,CAAf,CACH,CACJ,CACD,MAAOvB,MACFsC,KAAKf,OAAL,EAAgBe,KAAKf,OAAL,CAAaO,MAAb,CAAsB,CAAvC,CAA4C,MAA5C,CAAqD,KADlD,CAEH,WAFG,CAEUQ,IAFV,EAGFhC,IAHE,CAGG,SAASuC,QAAT,CAAmB,CACrB,GAAIb,OAAQa,SAASb,KAArB,CACA,MAAOO,gBAAiBP,MAAM,CAAN,CAAjB,CAA4BA,KAAnC,CACH,CANE,CAAP,CAOH,CAtGK,CA2GNc,OAAQ,gBAASzC,OAAT,CAAkB,CACtB,MAAOL,MAAK,MAAL,CAAa,SAAb,CAAP,CACH,CA7GK,CAAV,CAiHA,MAAOG,IAAP,CACH,CAxHD","file":"user.js","sourcesContent":["/**\n * Services for users\n *\n * @module services/user\n * @see module:dataRequest\n */\ndefine(['../util/ajax', '../store', '../store/user/actions-impl'], function(ajax, store, userActions) {\n    'use strict';\n\n    /**\n     * @alias module:services/user\n     */\n    var api = {\n\n        /**\n         * Get the current user\n         */\n        me: function(options) {\n            return ajax('GET', '/user/me')\n                .then(function(user) {\n                    return _.extend(user, {\n                        privilegesHelper: _.indexBy(user.privileges || [])\n                    });\n                })\n        },\n\n        /**\n         * Get user info\n         * @param {string} userName\n         */\n        get: function(userName) {\n            return ajax('GET', '/user', {\n                'user-name': userName\n            });\n        },\n\n        /**\n         * Set user preference\n         * @param {string} name\n         * @param {object} value\n         */\n        preference: function(name, value) {\n            store.getStore().dispatch(userActions.putUserPreference({ name, value }))\n            return ajax('POST', '/user/ui-preferences', {\n                name: name,\n                value: value\n            });\n        },\n\n        /**\n         * Get user names for ids\n         * @function\n         * @param {Array.<string>} userIds\n         */\n        getUserNames: (function() {\n            var cachedNames = {};\n            return function getUserNames(userIds) {\n                var notCached = _.reject(userIds, function(userId) {\n                    return userId in cachedNames || (\n                        publicData.currentUser.id === userId\n                    );\n                });\n\n                if (notCached.length) {\n                    return api.search({ userIds: notCached })\n                        .then(function(users) {\n                            var usersById = _.indexBy(users, 'id');\n                            return userIds.map(function(userId) {\n                                return cachedNames[userId] || (\n                                    cachedNames[userId] = (usersById[userId] || publicData.currentUser).displayName\n                                );\n                            });\n                        });\n                } else {\n                    return Promise.resolve(\n                        userIds.map(function(userId) {\n                            return cachedNames[userId] || publicData.currentUser.displayName;\n                        })\n                    );\n                }\n            };\n        })(),\n\n        /**\n         * Search for user\n         * @param {object} options\n         * @param {object} [options.query]\n         * @param {Array.<string>} [options.userIds]\n         */\n        search: function(options) {\n            var data = {},\n                returnSingular = false;\n\n            if (options.query) {\n                data.q = options.query;\n            }\n            if (options.online) {\n                data.online = options.online;\n            }\n            if (options.userIds) {\n                if (!_.isArray(options.userIds)) {\n                    returnSingular = true;\n                    data.userIds = [options.userIds];\n                } else {\n                    data.userIds = _.unique(options.userIds);\n                }\n            }\n            return ajax(\n                (data.userIds && data.userIds.length > 2) ? 'POST' : 'GET',\n                '/user/all', data)\n                .then(function(response) {\n                    var users = response.users;\n                    return returnSingular ? users[0] : users;\n                })\n        },\n\n        /**\n         * Logout\n         */\n        logout: function(options) {\n            return ajax('POST', '/logout');\n        }\n\n    };\n\n    return api;\n});\n"]}