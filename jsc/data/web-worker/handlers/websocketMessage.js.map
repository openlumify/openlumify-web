{"version":3,"sources":["../../../../js/data/web-worker/handlers/websocketMessage.js"],"names":["define","require","registry","store","NOOP","socketHandlers","workspaceChange","data","json","actions","getStore","dispatch","update","workspace","workspaceDelete","deleteWorkspace","workspaceId","ontologyChange","workProductPreviewChange","id","md5","previewChanged","productId","workProductChange","changedOnServer","workProductDelete","remove","workProductAncillaryChange","elementActions","productActions","ancillaryChange","get","invalidate","userAccessChange","user","putUser","userWorkspaceChange","publish","objectType","publishType","propertyChange","verticesDeleted","deleteElements","vertexIds","edgeDeletion","edgeIds","edgeId","textUpdated","graphVertexId","publicData","currentWorkspaceId","dispatchMain","eventName","vertexId","longRunningProcessDeleted","processId","longRunningProcessChange","process","entityImageUpdated","notification","systemNotificationUpdated","systemNotificationEnded","callHandlersForName","name","extensions","_","where","extensionsForPoint","length","forEach","e","handler","body","responseBody","JSON","parse","isBatchMessage","filtered","reject","messageFromUs","console","groupCollapsed","groupEnd","debug","type","warn","isObject","sourceGuid","socketSourceGuid","isArray"],"mappings":"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","file":"websocketMessage.js","sourcesContent":["define([\n    'require',\n    'configuration/plugins/registry',\n    '../store'\n], function(require, registry, store) {\n    'use strict';\n\n    var NOOP = function() {},\n        socketHandlers = {\n            workspaceChange: function(data, json) {\n                require(['../store/workspace/actions-impl'], function(actions) {\n                    store.getStore().dispatch(actions.update({ workspace: data }))\n                });\n            },\n            workspaceDelete: function(data) {\n                require(['../store/workspace/actions-impl'], function(actions) {\n                    store.getStore().dispatch(actions.deleteWorkspace({ workspaceId: data.workspaceId }));\n                });\n            },\n            ontologyChange: function(data) {\n                require(['../store/ontology/actions-impl'], function(actions) {\n                    store.getStore().dispatch(actions.ontologyChange(data));\n                });\n            },\n            workProductPreviewChange: function(data) {\n                const { id, workspaceId, md5 } = data;\n                require(['../store/product/actions-impl'], function(actions) {\n                    store.getStore().dispatch(actions.previewChanged({ productId: id, workspaceId, md5 }));\n                })\n            },\n            workProductChange: function(data) {\n                const { id, workspaceId} = data;\n                require(['../store/product/actions-impl'], function(actions) {\n                    store.getStore().dispatch(actions.changedOnServer({ productId: id, workspaceId }));\n                })\n            },\n            workProductDelete: function(data) {\n                require(['../store/product/actions-impl'], function(actions) {\n                    store.getStore().dispatch(actions.remove(data.id))\n                })\n            },\n            workProductAncillaryChange: function({ workspaceId, productId, id }) {\n                require([\n                    '../store/element/actions-impl',\n                    '../store/product/actions-impl'\n                ], function(elementActions, productActions) {\n                    const dispatch = store.getStore().dispatch;\n\n                    dispatch(elementActions.ancillaryChange({ workspaceId, id }))\n                    dispatch(productActions.get({ productId, invalidate: true }))\n                });\n            },\n            userAccessChange: function(user) {\n                require(['../store/user/actions-impl'], function(actions) {\n                    store.getStore().dispatch(actions.putUser({ user }));\n                })\n            },\n            userWorkspaceChange: NOOP,\n            publish: function(data) {\n                // Property undo already publishes propertyChange\n                if (data.objectType !== 'property' || data.publishType !== 'undo') {\n                    socketHandlers.propertyChange(data);\n                }\n            },\n            propertyChange: function(data) {\n                require(['../store/element/actions-impl'], function(actions) {\n                    store.getStore().dispatch(actions.propertyChange(data));\n                });\n            },\n            verticesDeleted: function(data) {\n                require(['../store/element/actions-impl'], function(actions) {\n                    store.getStore().dispatch(actions.deleteElements({ vertexIds: data.vertexIds }));\n                });\n            },\n            edgeDeletion: function(data) {\n                require(['../store/element/actions-impl'], function(actions) {\n                    store.getStore().dispatch(actions.deleteElements({ edgeIds: [data.edgeId] }));\n                });\n            },\n            textUpdated: function(data) {\n                if (data.graphVertexId &&\n                    (!data.workspaceId ||\n                     data.workspaceId === publicData.currentWorkspaceId)) {\n\n                    dispatchMain('rebroadcastEvent', {\n                        eventName: 'textUpdated',\n                        data: {\n                            vertexId: data.graphVertexId\n                        }\n                    })\n                }\n            },\n            longRunningProcessDeleted: function(data) {\n                dispatchMain('rebroadcastEvent', {\n                    eventName: 'longRunningProcessDeleted',\n                    data: {\n                        processId: data.processId\n                    }\n                });\n            },\n            longRunningProcessChange: function(process) {\n                dispatchMain('rebroadcastEvent', {\n                    eventName: 'longRunningProcessChanged',\n                    data: {\n                        process: process\n                    }\n                });\n            },\n            entityImageUpdated: function(data) {\n                if (data && data.graphVertexId) {\n                    socketHandlers.propertyChange(data);\n                }\n            },\n            notification: function(data) {\n                dispatchMain('rebroadcastEvent', {\n                    eventName: 'notificationActive',\n                    data: data\n                });\n            },\n            systemNotificationUpdated: function(data) {\n                dispatchMain('rebroadcastEvent', {\n                    eventName: 'notificationUpdated',\n                    data: data\n                });\n            },\n            systemNotificationEnded: function(data) {\n                dispatchMain('rebroadcastEvent', {\n                    eventName: 'notificationDeleted',\n                    data: data\n                });\n            }\n        },\n        callHandlersForName = function(name, data) {\n            var extensions = _.where(\n                registry.extensionsForPoint('org.openlumify.websocket.message'),\n                { name: name }\n            );\n            if (extensions.length) {\n                extensions.forEach(function(e) {\n                    e.handler(data);\n                });\n\n                return true;\n            }\n        };\n\n    return function(data) {\n        var body = data.responseBody,\n            json = JSON.parse(body);\n\n        if (isBatchMessage(json)) {\n            var filtered = _.reject(json.data, messageFromUs);\n            if (filtered.length) {\n                console.groupCollapsed('Socket Batch (' + filtered.length + ')');\n                filtered.forEach(process);\n                console.groupEnd();\n            }\n        } else if (!messageFromUs(json)) {\n            process(json);\n        }\n    }\n\n    function process(json) {\n        console.debug('%cSocket: %s %O', 'color:#999;font-style:italics', json.type, json.data || json)\n        if (json.type in socketHandlers) {\n            socketHandlers[json.type]('data' in json ? json.data : json, json);\n            callHandlersForName(json.type, json.data);\n        } else if (!callHandlersForName(json.type, json.data)) {\n            console.warn('Unhandled socket message type:' + json.type, 'message:', json);\n        }\n    }\n\n    function messageFromUs(json) {\n        const { data } = json;\n        if (!_.isObject(data)) {\n            return false;\n        }\n\n        const { sourceGuid } = data;\n        if (!sourceGuid) {\n            return false;\n        }\n\n        return sourceGuid === publicData.socketSourceGuid;\n    }\n\n    function isBatchMessage(json) {\n        return json.type === 'batch' && _.isArray(json.data);\n    }\n});\n"]}