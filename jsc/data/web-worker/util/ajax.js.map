{"version":3,"sources":["../../../../js/data/web-worker/util/ajax.js"],"names":["define","Promise","cancelPreviousByHash","RequestFailed","prototype","Object","create","Error","ajax","json","status","statusText","paramPair","key","value","encodeURIComponent","isFile","params","FormData","File","Blob","_","isArray","toFileUpload","formData","forEach","file","append","name","toQueryString","str","map","partial","test","join","isObject","JSON","stringify","slice","length","method","url","parameters","cancelHash","debugOptions","isJson","methodRegex","toUpperCase","matches","match","finished","r","XMLHttpRequest","promise","fulfill","reject","onCancel","progressHandler","resolvedUrl","BASE_URL","abort","onload","upload","removeEventListener","e","text","responseText","parse","ajaxPostfilter","errorJson","onerror","open","addEventListener","event","lengthComputable","complete","loaded","total","updateProgress","setRequestHeader","console","warn","error","invalidValues","delay","ajaxPrefilter","call","send"],"mappings":"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","file":"ajax.js","sourcesContent":["\n/*global File:false*/\ndefine(['util/promise', './cancel'], function(Promise, cancelPreviousByHash) {\n    'use strict';\n\n    RequestFailed.prototype = Object.create(Error.prototype);\n\n    return ajax;\n\n    function RequestFailed({json, status = '', statusText = ''}) {\n        this.json = json;\n        this.status = status;\n        this.statusText = statusText;\n    }\n\n    function paramPair(key, value) {\n        return key + '=' + encodeURIComponent(value);\n    }\n\n    function isFile(params) {\n        return params && (\n            params instanceof FormData ||\n            (params instanceof File) ||\n            (params instanceof Blob) ||\n            _.isArray(params)\n        )\n    }\n\n    function toFileUpload(params) {\n        if (params instanceof FormData) {\n            return params;\n        }\n        var formData = new FormData();\n        if (!_.isArray(params)) {\n            params = [params];\n        }\n        params.forEach(function(file) {\n            formData.append(file.name, file);\n        });\n\n        return formData;\n    }\n\n    function toQueryString(params) {\n        var str = '', key;\n        for (key in params) {\n            if (typeof params[key] !== 'undefined') {\n\n                // TODO: support fixing nested arrays\n                if (_.isArray(params[key])) {\n                    str += _.map(params[key], _.partial(paramPair, !(/\\[\\]$/).test(key) ? key + '[]' : key)).join('&') + '&';\n                } else if (_.isObject(params[key])) {\n                    str += paramPair(key, JSON.stringify(params[key])) + '&';\n                } else {\n                    str += paramPair(key, params[key]) + '&';\n                }\n            }\n        }\n        return str.slice(0, str.length - 1);\n    }\n\n    function ajax(method, url, parameters, { cancelHash } = {}, debugOptions) {\n        var isJson = true,\n            methodRegex = /^(.*)->HTML$/;\n        method = method.toUpperCase();\n\n        var matches = method.match(methodRegex);\n        if (matches && matches.length === 2) {\n            isJson = false;\n            method = matches[1];\n        }\n\n        var finished = false,\n            r = new XMLHttpRequest(),\n            promise = new Promise(function(fulfill, reject, onCancel) {\n                var progressHandler,\n                    params = isFile(parameters) ? toFileUpload(parameters) : toQueryString(parameters),\n                    resolvedUrl = BASE_URL + url + ((/GET|DELETE/.test(method) && parameters) ?\n                        ('?' + params) : ''),\n                    formData;\n\n                onCancel(function() {\n                    r.abort();\n                });\n\n                r.onload = function() {\n                    finished = true;\n                    try {\n                        r.upload.removeEventListener('progress', progressHandler);\n                    } catch(e) {}\n\n                    if (r.status === 200) {\n                        var text = r.responseText;\n                        if (isJson) {\n                            try {\n                                var json = JSON.parse(text);\n                                if (typeof ajaxPostfilter !== 'undefined') {\n                                    ajaxPostfilter(r, json, {\n                                        method: method,\n                                        url: url,\n                                        parameters: parameters\n                                    });\n                                }\n                                fulfill(json);\n                            } catch(e) {\n                                reject(e);\n                            }\n                        } else {\n                            fulfill(text)\n                        }\n                    } else {\n                        if (r.responseText && (/^\\s*{/).test(r.responseText)) {\n                            try {\n                                var errorJson = JSON.parse(r.responseText);\n                                reject(new RequestFailed({ json: errorJson }));\n                                return;\n                            } catch(e) { /*eslint no-empty:0 */ }\n                        }\n                        const { status, statusText } = r;\n                        reject(new RequestFailed({ status, statusText }))\n                    }\n                };\n                r.onerror = function() {\n                    finished = true;\n                    try {\n                        r.upload.removeEventListener('progress', progressHandler);\n                    } catch(e) {}\n                    reject(new Error('Network Error'));\n                };\n                r.open(method, resolvedUrl, true);\n\n                // using try/catch here because I could not get feature detection to work in IE11\n                try {\n                    r.upload.addEventListener('progress', (progressHandler = function(event) {\n                        if (event.lengthComputable) {\n                            var complete = (event.loaded / event.total || 0);\n                            if (complete < 1.0) {\n                                fulfill.updateProgress(complete);\n                            }\n                        }\n                    }), false);\n                } catch(e) {}\n\n                if (method === 'POST' && parameters) {\n                    formData = params;\n                    if (!(params instanceof FormData)) {\n                        r.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');\n                    }\n                }\n\n                if (debugOptions) {\n                    console.warn('Request Debugging is set for ' + url)\n                    if (debugOptions.error) {\n                        r.setRequestHeader('OpenLumify-Request-Error', debugOptions.error);\n                    }\n                    if (debugOptions.errorJson) {\n                        if (!debugOptions.errorJson.invalidValues) {\n                            debugOptions.errorJson.invalidValues = [];\n                        }\n                        r.setRequestHeader('OpenLumify-Request-Error-Json', JSON.stringify(debugOptions.errorJson));\n                    }\n                    if (debugOptions.delay) {\n                        r.setRequestHeader('OpenLumify-Request-Delay-Millis', debugOptions.delay);\n                    }\n                }\n\n                if (typeof ajaxPrefilter !== 'undefined') {\n                    ajaxPrefilter.call(null, r, method, url, parameters);\n                }\n\n                r.send(formData);\n            });\n\n        if (cancelHash) {\n            cancelPreviousByHash(promise, cancelHash);\n        }\n\n        return promise;\n    }\n})\n"]}