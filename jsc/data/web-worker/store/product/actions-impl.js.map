{"version":3,"sources":["../../../../../js/data/web-worker/store/product/actions-impl.js"],"names":["define","actions","ajax","elementActions","elementSelectors","workspaceActions","selectionActions","selectors","registry","protectFromMain","api","get","productId","invalidate","includeExtended","dispatch","getState","state","workspaceId","workspace","currentId","products","product","workspaces","request","options","params","includeVertices","includeEdges","extendedData","then","update","vertices","edges","vertexIds","Object","keys","edgeIds","includeAncillary","_","any","ancillary","previewChanged","md5","type","payload","changedOnServer","getSelectedId","setInteracting","interactingIds","updatePreview","dataUrl","preview","previewMD5","updateLocalData","key","value","localData","omit","updateData","data","oldValue","catch","e","updateExtendedData","undoable","updateViewport","pan","zoom","viewport","selectAll","filter","id","set","selection","list","initial","handler","initialProductId","initialWorkspaceId","delay","Promise","try","setCurrent","workspaceProduct","loaded","loading","types","select","create","title","kind","getProducts","delete","remove","updateTitle","selected","nextProduct","first","pushSocketMessage"],"mappings":"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","file":"actions-impl.js","sourcesContent":["define([\n    '../actions',\n    '../../util/ajax',\n    '../element/actions-impl',\n    '../element/selectors',\n    '../workspace/actions-impl',\n    '../selection/actions-impl',\n    './selectors',\n    'configuration/plugins/registry'\n], function(actions, ajax, elementActions, elementSelectors, workspaceActions, selectionActions, selectors, registry) {\n    actions.protectFromMain();\n\n    const api = {\n        get: ({productId, invalidate, includeExtended = true }) => (dispatch, getState) => {\n            const state = getState();\n            const workspaceId = state.workspace.currentId;\n            const { products } = state.product.workspaces[workspaceId];\n            const product = products[productId];\n            let request;\n\n            const options = { productId, includeExtended };\n            if (includeExtended) {\n                options.params = {\n                    includeVertices: true,\n                    includeEdges: true\n                }\n            }\n\n            if (!invalidate && product) {\n                if (!product.extendedData && includeExtended) {\n                    request = ajax('GET', '/product', options);\n                }\n            } else if (invalidate || !product) {\n                request = ajax('GET', '/product', options);\n            }\n\n            if (request) {\n                request.then(function(product) {\n                    dispatch(api.update(product));\n\n                    if (includeExtended) {\n                        const { vertices, edges } = product.extendedData;\n                        const vertexIds = Object.keys(vertices);\n                        const edgeIds = Object.keys(edges);\n                        const includeAncillary = _.any(vertices, ({ancillary}) => ancillary === true)\n\n                        dispatch(elementActions.get({ workspaceId, vertexIds, edgeIds, includeAncillary }));\n                    }\n                })\n            }\n        },\n\n        previewChanged: ({ productId, workspaceId, md5 }) => (dispatch, getState) => dispatch({\n            type: 'PRODUCT_PREVIEW_UPDATE',\n            payload: { productId, md5, workspaceId }\n        }),\n\n        changedOnServer: ({ productId, workspaceId }) => (dispatch, getState) => {\n            const state = getState();\n\n            if (state.product.workspaces[workspaceId]) {\n                dispatch(api.get({\n                        productId,\n                        invalidate: true,\n                        includeExtended: selectors.getSelectedId(state) === productId\n                    }));\n            }\n        },\n\n        setInteracting: ({ interactingIds }) => ({\n            type: 'PRODUCT_SET_INTERACTING',\n            payload: { interactingIds }\n        }),\n\n        update: (product) => ({\n            type: 'PRODUCT_UPDATE',\n            payload: {\n                product\n            }\n        }),\n\n        updatePreview: ({ productId, dataUrl }) => (dispatch, getState) => {\n            const state = getState();\n            const workspaceId = state.workspace.currentId;\n            ajax('POST', '/product', { productId, preview: dataUrl })\n                .then(product => {\n                    const { previewMD5: md5 } = product;\n                    dispatch(api.previewChanged({ productId, workspaceId, md5 }));\n                })\n        },\n\n        updateLocalData: ({productId, key, value}) => (dispatch, getState) => {\n            const state = getState();\n            const workspaceId = state.workspace.currentId;\n            const product = state.product.workspaces[workspaceId].products[productId];\n\n            let localData = product.localData || {};\n            if (value === null) {\n                localData = _.omit(localData, key);\n            } else {\n                localData = {\n                    ...localData,\n                    [key]: value\n                }\n            }\n\n            dispatch({type: 'PRODUCT_UPDATE_LOCAL_DATA', payload: { workspaceId, productId, localData }});\n        },\n\n        updateData: ({productId, key, value}) => (dispatch, getState) => {\n            const state = getState();\n            const workspaceId = state.workspace.currentId;\n            const params = {\n                data: {}\n            };\n            params.data[key] = value;\n            const oldValue = state.product.workspaces[workspaceId].products[productId].data[key];\n\n            dispatch({\n                type: 'PRODUCT_UPDATE_DATA',\n                payload: {\n                    workspaceId,\n                    productId,\n                    key,\n                    value\n                }\n            });\n\n            ajax('POST', '/product', {productId, params})\n                .catch((e) => {\n                    dispatch({\n                        type: 'PRODUCT_UPDATE_DATA',\n                        payload: {\n                            workspaceId,\n                            productId,\n                            key,\n                            oldValue\n                        }\n                    });\n                });\n        },\n\n        updateExtendedData: ({ productId, key, value, undoable }) => (dispatch, getState) => {\n            const state = getState();\n            const workspaceId = state.workspace.currentId;\n            const params = {\n                extendedData: {}\n            };\n            params.extendedData[key] = value;\n            const oldValue = state.product.workspaces[workspaceId].products[productId].extendedData[key];\n\n            dispatch({\n                type: 'PRODUCT_UPDATE_EXTENDED_DATA',\n                payload: {\n                    workspaceId,\n                    productId,\n                    key,\n                    value\n                }\n            });\n\n            ajax('POST', '/product', {productId, params})\n                .catch((e) => {\n                    dispatch({\n                        type: 'PRODUCT_UPDATE_EXTENDED_DATA',\n                        payload: {\n                            workspaceId,\n                            productId,\n                            key,\n                            oldValue\n                        }\n                    });\n                });\n        },\n\n        updateViewport: ({ productId, pan, zoom }) => (dispatch, getState) => dispatch({\n            type: 'PRODUCT_UPDATE_VIEWPORT',\n            payload: {\n                productId,\n                viewport: { pan, zoom },\n                workspaceId: getState().workspace.currentId\n            }\n        }),\n\n        selectAll: ({ productId }) => (dispatch, getState) => {\n            const state = getState(),\n                workspaceId = state.workspace.currentId,\n                product = state.product.workspaces[workspaceId].products[productId];\n\n            const vertices = Object.keys(product.extendedData.vertices).filter(id => {\n                return !product.extendedData.vertices[id].ancillary\n            });\n\n            dispatch(selectionActions.set({\n                selection: {\n                    vertices,\n                    edges: Object.keys(product.extendedData.edges)\n                }\n            }));\n        },\n\n        list: (initial) => function handler(dispatch, getState) {\n            const { productId: initialProductId, workspaceId: initialWorkspaceId } = initial;\n\n            let workspaceId = getState().workspace.currentId;\n\n            if (!workspaceId) {\n                _.delay(handler, 250, dispatch, getState);\n                return\n            }\n\n            Promise.try(() => {\n                if (initialWorkspaceId && initialWorkspaceId !== workspaceId) {\n                    return dispatch(workspaceActions.setCurrent({ workspaceId: initialWorkspaceId }))\n                }\n            }).then(() => {\n                const state = getState();\n                const workspaceId = state.workspace.currentId;\n                const workspaceProduct = state.product.workspaces[workspaceId];\n                if (!workspaceProduct || (!workspaceProduct.loaded && !workspaceProduct.loading)) {\n                    dispatch({ type: 'PRODUCT_LIST', payload: { loading: true, loaded: false, workspaceId } });\n                    ajax('GET', '/product/all', {\n                        workspaceId\n                    }).then(({types, products}) => {\n                        dispatch({type: 'PRODUCT_UPDATE_TYPES', payload: { types }});\n                        dispatch({type: 'PRODUCT_LIST', payload: { workspaceId, loading: false, loaded: true, products }});\n                        if (initialProductId) {\n                            dispatch(api.select({ productId: initialProductId }))\n                        }\n                    })\n                }\n            })\n        },\n\n        create: ({title, kind}) => (dispatch, getState) => {\n            const products = selectors.getProducts(getState());\n\n            ajax('POST', '/product', { title, kind })\n                .then(product => {\n                    dispatch(api.update(product));\n                    dispatch(api.select({ productId: product.id }))\n                })\n        },\n\n        delete: ({ productId }) => (dispatch) => {\n            return ajax('DELETE', '/product', { productId })\n                .then(() => dispatch(api.remove(productId)));\n        },\n\n        updateTitle: ({ productId, title }) => (dispatch, getState) => {\n            const state = getState();\n            const workspaceId = state.workspace.currentId;\n            const product = state.product.workspaces[workspaceId].products[productId];\n            const { kind } = product;\n\n            dispatch({\n                type: 'PRODUCT_UPDATE_TITLE',\n                payload: { productId, loading: true, workspaceId }\n            });\n            ajax('POST', '/product', { title, kind, productId })\n                .then(result => {\n                    dispatch({\n                        type: 'PRODUCT_UPDATE_TITLE',\n                        payload: { loading: false, productId, workspaceId, title }\n                    })\n                });\n        },\n\n        remove: (productId) => (dispatch, getState) => {\n            const state = getState();\n            const workspaceId = state.workspace.currentId;\n            const { products, selected } = state.product.workspaces[workspaceId];\n            const product = products[productId];\n            if (product) {\n                dispatch({\n                    type: 'PRODUCT_REMOVE',\n                    payload: { productId, workspaceId }\n                });\n                if (productId === selected) {\n                    dispatch(api.select({ productId: null }));\n                }\n            }\n        },\n\n        select: ({ productId }) => (dispatch, getState) => {\n            const state = getState();\n            const workspaceId = state.workspace.currentId;\n\n            if (!productId) {\n                const nextProduct = _.first(selectors.getProducts(state));\n                if (nextProduct) {\n                    productId = nextProduct.id;\n                }\n            }\n\n            dispatch({\n                type: 'PRODUCT_SELECT',\n                payload: { workspaceId, productId }\n            });\n            pushSocketMessage({ type: 'setActiveProduct', data: { workspaceId, productId } });\n        }\n\n    };\n\n    return api;\n});\n"]}