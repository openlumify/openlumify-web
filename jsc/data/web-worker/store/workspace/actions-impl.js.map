{"version":3,"sources":["../../../../../js/data/web-worker/store/workspace/actions-impl.js"],"names":["define","actions","ajax","require","protectFromMain","sort","_","sortBy","filter","workspaces","w","sharedToUser","title","toLowerCase","api","setCurrent","workspaceId","dispatch","getState","workspace","Promise","try","allLoaded","resolve","Object","values","byId","publicData","currentWorkspaceId","then","result","setAll","list","length","update","getOntology","ontologyActions","get","type","payload","pushSocketMessage","data","f","deleteWorkspace","currentId","undefined","invalidate","state","current","user","currentUserId","id","hasAccess","createdBy","users","some","userId","productActions","productSelectors","selectedProduct","getProduct","extendedData","productId"],"mappings":"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","file":"actions-impl.js","sourcesContent":["define(['../actions', '../../util/ajax', 'require'], function(actions, ajax, require) {\n    actions.protectFromMain();\n\n    const sort = workspaces => _.sortBy(\n        _.filter(workspaces, function(w) {\n            return !w.sharedToUser && ('createdBy' in w);\n        }),\n        w => w.title.toLowerCase()\n    );\n\n    const api = {\n\n        setCurrent: ({ workspaceId }) => (dispatch, getState) => {\n            if (!workspaceId) {\n                var workspaces = getState().workspace;\n                return Promise.try(() => {\n                    if (workspaces.allLoaded) {\n                        return Promise.resolve(sort(Object.values(workspaces.byId)));\n                    } else {\n                        publicData.currentWorkspaceId = null;\n                        return ajax('GET', '/workspace/all')\n                            .then(function(result) {\n                                dispatch(api.setAll({ workspaces: result.workspaces }));\n                                return sort(result.workspaces);\n                            })\n                    }\n                }).then(list => {\n                    if (list.length) {\n                        return list[0].workspaceId\n                    }\n                    return ajax('POST', '/workspace/create').then(workspace => {\n                        dispatch(api.update({ workspace }))\n                        return workspace.workspaceId;\n                    })\n                }).then(workspaceId => {\n                    return new Promise(f => {\n                        require(['../ontology/actions-impl'], ontologyActions => {\n                            const getOntology = ontologyActions.get({ workspaceId })(dispatch, getState)\n                            Promise.resolve(getOntology).then(() => {\n                                dispatch({ type: 'WORKSPACE_SETCURRENT', payload: { workspaceId } })\n                                pushSocketMessage({ type: 'setActiveWorkspace', data: { workspaceId } });\n                                f();\n                            })\n                        })\n                    })\n                })\n            } else {\n                return new Promise(f => {\n                    require(['../ontology/actions-impl'], ontologyActions => {\n                        const getOntology = ontologyActions.get({ workspaceId })(dispatch, getState)\n                        Promise.resolve(getOntology).then(() => {\n                            dispatch({ type: 'WORKSPACE_SETCURRENT', payload: { workspaceId } })\n                            dispatch(api.get({ workspaceId }))\n                            pushSocketMessage({ type: 'setActiveWorkspace', data: { workspaceId } });\n                            f();\n                        })\n                    })\n                })\n            }\n        },\n\n        setAll: ({ workspaces }) => ({\n            type: 'WORKSPACE_SET_ALL',\n            payload: { workspaces }\n        }),\n\n        deleteWorkspace: ({ workspaceId }) => (dispatch, getState) => {\n            const workspaces = getState().workspace;\n            const workspace = workspaces.byId[workspaceId];\n\n            if (workspace) {\n                dispatch({\n                    type: 'WORKSPACE_DELETE',\n                    payload: { workspaceId }\n                })\n\n                const workspaces = getState().workspace;\n                if (workspaces.currentId === workspaceId) {\n                    dispatch(api.setCurrent({ workspaceId: undefined }))\n                }\n            }\n        },\n\n        get: ({ workspaceId, invalidate }) => (dispatch, getState) => {\n            var workspace = getState().workspace.byId[workspaceId];\n            if (!workspace || invalidate) {\n                ajax('GET', '/workspace', { workspaceId })\n                    .then(workspace => dispatch(api.update({ workspace })))\n            }\n        },\n\n        update: ({ workspace }) => (dispatch, getState) => {\n            const state = getState();\n            const { currentId, byId } = state.workspace;\n            const { current } = state.user;\n            const currentUserId = current && current.id;\n            // Sometimes withdrawing access can send a change message after\n            // permission has been removed\n            const hasAccess = currentUserId === workspace.createdBy ||\n                workspace.users.some(({userId}) => userId === currentUserId)\n\n            if (hasAccess) {\n                dispatch({\n                    type: 'WORKSPACE_UPDATE',\n                    payload: { workspace }\n                })\n                if (!currentId || !byId[currentId]) {\n                    dispatch(api.setCurrent({ workspaceId: workspace.workspaceId }))\n                } else {\n                    require([\n                        'data/web-worker/store/product/actions-impl',\n                        'data/web-worker/store/product/selectors'\n                    ], (productActions, productSelectors) => {\n                        const selectedProduct = productSelectors.getProduct(state);\n                        if (selectedProduct && selectedProduct.extendedData) {\n                                dispatch(productActions.get({ productId: selectedProduct.id, invalidate: true }));\n                        }\n                    })\n                }\n            }\n        }\n    }\n\n    return api;\n})\n\n"]}