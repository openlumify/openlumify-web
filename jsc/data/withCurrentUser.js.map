{"version":3,"sources":["../../js/data/withCurrentUser.js"],"names":["define","userActions","withCurrentUser","after","on","setPublicApi","undefined","around","dataRequestCompleted","request","isUserMeRequest","user","result","onlyIfNull","openlumifyData","storePromise","then","store","dispatch","putUser","currentWorkspaceId","isUserPreferencesUpdate","preferences","uiPreferences","currentUser","putUserPreferences","call","isUserPreferenceUpdate","originalRequest","service","method","success"],"mappings":"AAAAA,OAAO,CAAC,oCAAD,CAAP,CAA+C,SAASC,WAAT,CAAsB,CACjE,aAEA,MAAOC,gBAAP,CAEA,QAASA,gBAAT,EAA2B,CAEvB,KAAKC,KAAL,CAAW,YAAX,CAAyB,UAAW,CAChC,KAAKC,EAAL,CAAQ,WAAR,CAAqB,UAAW,CAC5B,KAAKC,YAAL,CAAkB,aAAlB,CAAiCC,SAAjC,EACA,KAAKD,YAAL,CAAkB,kBAAlB,CAAsCC,SAAtC,EACH,CAHD,EAIH,CALD,EAOA,KAAKC,MAAL,CAAY,sBAAZ,CAAoC,SAASC,oBAAT,CAA+BC,OAA/B,CAAwC,CACxE,GAAIC,gBAAgBD,OAAhB,CAAJ,CAA8B,CAC1B,GAAIE,MAAOF,QAAQG,MAAnB,CAEA,KAAKP,YAAL,CAAkB,aAAlB,CAAiCM,IAAjC,CAAuC,CAAEE,WAAY,IAAd,CAAvC,EACAC,eAAeC,YAAf,CAA4BC,IAA5B,CAAiC,sBAASC,OAAMC,QAAN,CAAejB,YAAYkB,OAAZ,CAAoB,CAAER,SAAF,CAApB,CAAf,CAAT,EAAjC,EAEA,GAAIA,KAAKS,kBAAT,CAA6B,CACzB,KAAKf,YAAL,CAAkB,oBAAlB,CAAwCM,KAAKS,kBAA7C,CAAiE,CAAEP,WAAY,IAAd,CAAjE,EACH,CACJ,CATD,IASO,IAAIQ,wBAAwBZ,OAAxB,CAAJ,CAAsC,IAClBa,YADkB,CACFb,QAAQG,MADN,CACjCW,aADiC,CAEzCT,eAAeU,WAAf,CAA2BD,aAA3B,CAA2CD,WAA3C,CACA,KAAKjB,YAAL,CAAkB,aAAlB,CAAiCS,eAAeU,WAAhD,EACAV,eAAeC,YAAf,CAA4BC,IAA5B,CAAiC,sBAASC,OAAMC,QAAN,CAAejB,YAAYwB,kBAAZ,CAA+B,CAAEH,uBAAF,CAA/B,CAAf,CAAT,EAAjC,EACH,CAED,MAAOd,sBAAqBkB,IAArB,CAA0B,IAA1B,CAAgCjB,OAAhC,CAAP,CACH,CAlBD,EAmBH,CAED,QAASY,wBAAT,CAAiCZ,OAAjC,CAA0C,CACtC,MAAOA,UACHA,QAAQG,MADL,EAEHH,QAAQG,MAAR,CAAeW,aAFnB,CAGH,CAED,QAASI,uBAAT,CAAgClB,OAAhC,CAAyC,CACrC,MAAOA,UACHA,QAAQmB,eAAR,CAAwBC,OAAxB,GAAoC,MADjC,EAEHpB,QAAQmB,eAAR,CAAwBE,MAAxB,GAAmC,YAFvC,CAGH,CAED,QAASpB,gBAAT,CAAyBD,OAAzB,CAAkC,CAC9B,MAAOA,UACAA,QAAQsB,OADR,EAEAtB,QAAQmB,eAAR,CAAwBC,OAAxB,GAAoC,MAFpC,EAGApB,QAAQmB,eAAR,CAAwBE,MAAxB,GAAmC,IAHnC,EAIArB,QAAQG,MAJf,CAKH,CACJ,CAtDD","file":"withCurrentUser.js","sourcesContent":["define(['data/web-worker/store/user/actions'], function(userActions) {\n    'use strict';\n\n    return withCurrentUser;\n\n    function withCurrentUser() {\n\n        this.after('initialize', function() {\n            this.on('didLogout', function() {\n                this.setPublicApi('currentUser', undefined);\n                this.setPublicApi('socketSourceGuid', undefined);\n            });\n        });\n\n        this.around('dataRequestCompleted', function(dataRequestCompleted, request) {\n            if (isUserMeRequest(request)) {\n                var user = request.result;\n\n                this.setPublicApi('currentUser', user, { onlyIfNull: true });\n                openlumifyData.storePromise.then(store => store.dispatch(userActions.putUser({ user })));\n\n                if (user.currentWorkspaceId) {\n                    this.setPublicApi('currentWorkspaceId', user.currentWorkspaceId, { onlyIfNull: true });\n                }\n            } else if (isUserPreferencesUpdate(request)) {\n                const { uiPreferences: preferences } = request.result;\n                openlumifyData.currentUser.uiPreferences = preferences;\n                this.setPublicApi('currentUser', openlumifyData.currentUser);\n                openlumifyData.storePromise.then(store => store.dispatch(userActions.putUserPreferences({ preferences })));\n            }\n\n            return dataRequestCompleted.call(this, request);\n        });\n    }\n\n    function isUserPreferencesUpdate(request) {\n        return request &&\n            request.result &&\n            request.result.uiPreferences;\n    }\n\n    function isUserPreferenceUpdate(request) {\n        return request &&\n            request.originalRequest.service === 'user' &&\n            request.originalRequest.method === 'preference';\n    }\n\n    function isUserMeRequest(request) {\n        return request &&\n               request.success &&\n               request.originalRequest.service === 'user' &&\n               request.originalRequest.method === 'me' &&\n               request.result;\n    }\n});\n"]}