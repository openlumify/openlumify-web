var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key];}}}return target;};define([],function(){'use strict';return withWorkspaces;function withWorkspaces(){var workspace,undoManagersPerWorkspace={};this.after('initialize',function(){var _this=this;var self=this;this.fireApplicationReadyOnce=_.once(this.trigger.bind(this,'applicationReady'));this.on('loadCurrentWorkspace',this.onLoadCurrentWorkspace);this.on('switchWorkspace',this.onSwitchWorkspace);this.on('updateWorkspace',this.onUpdateWorkspace);this.on('undo',this.onUndo);this.on('redo',this.onRedo);openlumifyData.storePromise.then(function(store){return store.observe(function(state){return state.workspace;},function(next,prev){var state=store.getState();var oldWorkspace=prev&&prev.currentId&&prev.byId[prev.currentId];var newWorkspace=next&&next.currentId&&next.byId[next.currentId];var changed=newWorkspace&&(!oldWorkspace||oldWorkspace.workspaceId!==newWorkspace.workspaceId);if(changed){workspace=_extends({},newWorkspace);_this.setPublicApi('currentWorkspaceId',workspace.workspaceId);_this.setPublicApi('currentWorkspaceName',workspace.title);_this.setPublicApi('currentWorkspaceEditable',workspace.editable);_this.setPublicApi('currentWorkspaceCommentable',workspace.commentable);_this.trigger('workspaceLoaded',workspace);_this.trigger('selectObjects');_this.fireApplicationReadyOnce();}_.each(next.byId,function(workspace,id){var previousWorkspace=prev.byId[id];var workspaceChanged=!previousWorkspace||previousWorkspace!==workspace;if(workspaceChanged){_this.setPublicApi('currentWorkspaceName',workspace.title);_this.setPublicApi('currentWorkspaceEditable',workspace.editable);_this.setPublicApi('currentWorkspaceCommentable',workspace.commentable);_this.trigger('workspaceUpdated',{workspace:workspace});}});var deletedKeys=prev&&next&&Object.keys(_.omit(prev.byId,Object.keys(next.byId)));if(deletedKeys){deletedKeys.forEach(function(workspaceId){_this.trigger('workspaceDeleted',{workspaceId:workspaceId});});}});});});this.onLoadCurrentWorkspace=function(event){var currentWorkspaceId=this.openlumifyData.currentWorkspaceId;this.trigger('switchWorkspace',{workspaceId:currentWorkspaceId});};this.onSwitchWorkspace=function(event,data){this.setPublicApi('currentWorkspaceId',data.workspaceId);Promise.all([openlumifyData.storePromise,Promise.require('data/web-worker/store/workspace/actions')]).spread(function(store,workspaceActions){store.dispatch(workspaceActions.setCurrent(data.workspaceId));});};this.onUpdateWorkspace=function(event,data){var self=this,triggered=false,buffer=_.delay(function(){triggered=true;self.trigger('workspaceSaving',workspace);},250),result,legacyKeys=['entityUpdates','entityDeletes'],legacy=_.pick(data,legacyKeys);if(legacy.length){data=_.omit(data,legacyKeys);console.warn('updateWorkspace no longer accepts entity changes');}if(!_.isEmpty(data)){this.dataRequestPromise.then(function(dataRequest){dataRequest('workspace','save',data).then(function(data){clearTimeout(buffer);if(data.saved){triggered=true;}}).catch(function(e){console.error(e);}).then(function(){if(triggered){self.trigger('workspaceSaved',result);}});});}};this.onUndo=function(){var _this2=this;Promise.all([openlumifyData.storePromise,Promise.require('data/web-worker/store/undo/actions')]).spread(function(store,actions){var scope=_this2.openlumifyData.currentWorkspaceId;store.dispatch(actions.undoForProduct());});};this.onRedo=function(){var _this3=this;Promise.all([openlumifyData.storePromise,Promise.require('data/web-worker/store/undo/actions')]).spread(function(store,actions){var scope=_this3.openlumifyData.currentWorkspaceId;store.dispatch(actions.redoForProduct());});};}});
//# sourceMappingURL=withWorkspaces.js.map
