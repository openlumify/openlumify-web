{"version":3,"sources":["../../js/notifications/notifications.js"],"names":["define","defineComponent","withDataRequest","d3","NOTIFICATION_HOVER_EXPAND_DELAY_MILLIS","Notifications","attributes","allowSystemDismiss","animated","emptyMessage","showInformational","showUserDismissed","notificationSelector","after","self","window","previouslyDismissed","localStorage","getItem","userDismissed","JSON","parse","stack","markRead","on","document","onPostLocalNotification","onNotificationActive","onNotificationDeleted","onDismissAllNotifications","onMouseOver","immediateUpdate","update","_","debounce","bind","sendMarkRead","Promise","all","dataRequest","done","result","properties","shift","notifications","autoDismissSeconds","local","parseInt","system","user","displayNotifications","active","concat","$container","$","addClass","appendTo","$node","event","data","notification","Error","type","hash","Date","getTime","reject","n","notificationId","id","trigger","count","length","$notification","target","closest","attr","clearTimeout","hoverTimer","setTimeout","off","removeClass","shouldDisplay","filter","severity","collapseDuplicates","forEach","updated","index","i","splice","push","autoDismiss","delay","dismissNotification","sortBy","startDate","sentDate","reverse","setUserDismissed","notificationHash","setItem","stringify","e","allNotifications","options","immediate","animate","isUndefined","collapsedIds","contains","nId","console","warn","toSend","slice","markReadErrorCount","then","catch","error","canDismissNotification","forceAnimation","select","selectAll","call","newOnes","enter","insert","style","append","clicked","clickedButton","is","actionEvent","actionPayload","url","open","defer","classed","test","text","title","message","transition","d","size","duration","exiting","exit","exitingSize","css","Math","max","width","remove","find","i18n","grouped","groupBy","toAdd","toCollapseIds","each","list","validToCollapse","ids","pluck","add","extend","chain","tap","a","value","prefix","sharedPrefix","map","substring","compact","s","toLowerCase","join","sorted","sort","first","last","firstLen","isString","charAt"],"mappings":"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","file":"notifications.js","sourcesContent":["define([\n    'flight/lib/component',\n    'util/withDataRequest',\n    'd3'\n], function(defineComponent, withDataRequest, d3) {\n    'use strict';\n\n    var NOTIFICATION_HOVER_EXPAND_DELAY_MILLIS = 250;\n\n    return defineComponent(Notifications, withDataRequest);\n\n    function Notifications() {\n\n        this.attributes({\n            allowSystemDismiss: true,\n            animated: true,\n            emptyMessage: true,\n            showInformational: true,\n            showUserDismissed: false,\n            notificationSelector: '.notifications .notification'\n        });\n\n        this.after('initialize', function() {\n            var self = this;\n\n            if ('localStorage' in window) {\n                var previouslyDismissed = localStorage.getItem('notificationsDismissed');\n                if (previouslyDismissed) {\n                    this.userDismissed = JSON.parse(previouslyDismissed);\n                }\n            }\n            if (!this.userDismissed) {\n                this.userDismissed = {};\n            }\n            this.stack = [];\n            this.markRead = [];\n\n            this.on(document, 'postLocalNotification', this.onPostLocalNotification);\n            this.on(document, 'notificationActive', this.onNotificationActive);\n            this.on(document, 'notificationDeleted', this.onNotificationDeleted);\n            this.on(document, 'notificationClearAll', this.onDismissAllNotifications);\n\n            this.on('mouseover', {\n                notificationSelector: this.onMouseOver\n            });\n\n            this.immediateUpdate = this.update;\n            this.update = _.debounce(this.update.bind(this), 250);\n            this.sendMarkRead = _.debounce(this.sendMarkRead.bind(this), 3000);\n\n            Promise.all([\n                this.dataRequest('config', 'properties'),\n                this.dataRequest('notification', 'list')\n            ]).done(function(result) {\n                var properties = result.shift(),\n                    notifications = result.shift();\n\n                self.autoDismissSeconds = {\n                    local: parseInt(properties['notifications.local.autoDismissSeconds'] || '-1'),\n                    system: parseInt(properties['notifications.system.autoDismissSeconds'] || '-1'),\n                    user: parseInt(properties['notifications.user.autoDismissSeconds'] || '-1')\n                };\n                self.displayNotifications(notifications.system.active.concat(notifications.user));\n            })\n\n            this.$container = $('<div>')\n                .addClass('notifications')\n                .appendTo(this.$node);\n\n        });\n\n        this.onPostLocalNotification = function(event, data) {\n            var notification = data && data.notification;\n            if (!notification) {\n                throw new Error('Notification must be passed to create local notifications');\n            }\n\n            notification.type = 'local';\n            notification.hash = 'local_' + new Date().getTime();\n            this.displayNotifications([notification]);\n        };\n\n        this.onNotificationActive = function(event, data) {\n            this.displayNotifications([data.notification]);\n        };\n\n        this.onNotificationDeleted = function(event, data) {\n            this.stack = _.reject(this.stack, function(n) {\n                return data.notificationId === n.id;\n            });\n            this.update();\n            this.trigger('notificationCountUpdated', { count: this.stack.length });\n        };\n\n        this.onMouseOver = function(event, data) {\n            var self = this,\n                $notification = $(event.target).closest(this.attr.notificationSelector);\n\n            clearTimeout(self.hoverTimer);\n            self.hoverTimer = setTimeout(function() {\n                $notification.addClass('expanded-notification');\n            }, NOTIFICATION_HOVER_EXPAND_DELAY_MILLIS);\n\n            $notification.off('mouseover', 'mouseleave').on('mouseleave', function() {\n                clearTimeout(self.hoverTimer);\n                $notification.removeClass('expanded-notification');\n            })\n        };\n\n        this.displayNotifications = function(notifications) {\n            var self = this,\n                shouldDisplay = notifications && _.filter(notifications, function(n) {\n                    if (self.attr.showUserDismissed !== true &&\n                        self.userDismissed[n.id] && self.userDismissed[n.id] === n.hash) {\n                        return false;\n                    }\n                    if (n.type === 'user') {\n                        return true;\n                    }\n\n                    return self.attr.showInformational === true || n.severity !== 'INFORMATIONAL';\n                });\n\n            if (shouldDisplay && shouldDisplay.length) {\n                shouldDisplay = collapseDuplicates(shouldDisplay);\n                shouldDisplay.forEach(function(updated) {\n                    var index = -1;\n                    self.stack.forEach(function(n, i) {\n                        if (n.id === updated.id) {\n                            index = i;\n                        }\n                    });\n\n                    if (index >= 0) {\n                        self.stack.splice(index, 1, updated);\n                    } else {\n                        self.stack.push(updated);\n                    }\n\n                    if (self.attr.showUserDismissed !== true) {\n                        var autoDismiss = self.autoDismissSeconds[updated.type];\n                        if (autoDismiss > 0) {\n                            _.delay(function() {\n                                self.dismissNotification([updated], {\n                                    markRead: false,\n                                    userDismissed: true\n                                });\n                            }, autoDismiss * 1000);\n                        }\n                    }\n                })\n\n                if (!self.attr.animated) {\n                    self.stack = _.sortBy(self.stack, function(notification) {\n                        return notification.startDate || new Date(notification.sentDate).getTime();\n                    }).reverse();\n                }\n            }\n\n            this.update();\n            this.trigger('notificationCountUpdated', { count: this.stack.length });\n        };\n\n        this.setUserDismissed = function(notificationId, notificationHash) {\n            this.userDismissed[notificationId] = notificationHash;\n            try {\n                if ('localStorage' in window) {\n                    localStorage.setItem('notificationsDismissed', JSON.stringify(this.userDismissed));\n                }\n            } catch(e) { /*eslint no-empty:0*/ }\n        };\n\n        this.onDismissAllNotifications = function(event, data) {\n            var self = this;\n            this.dataRequest('notification', 'list')\n                .done(function(notifications) {\n                    var allNotifications = notifications.system.active.concat(notifications.user);\n                    var options = {\n                        markRead: true,\n                        userDismissed: false,\n                        immediate: true,\n                        animate: false\n                    }\n                    self.dismissNotification(allNotifications, options);\n                });\n        }\n\n        this.dismissNotification = function(notifications, options) {\n            var self = this,\n                immediate = options && options.immediate,\n                animate = options && options.animate,\n                markRead = options && !_.isUndefined(options.markRead) ? options.markRead : true,\n                userDismissed = options && !_.isUndefined(options.userDismissed) ? options.userDismissed : false;\n\n            notifications.forEach(function(notification) {\n                self.stack = _.reject(self.stack, function(n) {\n                    if (n.collapsedIds) {\n                        return _.contains(n.collapsedIds, notification.id);\n                    }\n                    return n.id === notification.id;\n                });\n\n                if (markRead) {\n                    if (notification.type === 'user') {\n                        if (notification.collapsedIds) {\n                            notification.collapsedIds.forEach(function(nId) {\n                                self.markRead.push(nId);\n                            })\n                        } else {\n                            self.markRead.push(notification.id);\n                        }\n                    } else if (notification.hash) {\n                        self.setUserDismissed(notification.id, notification.hash);\n                    } else {\n                        console.warn('Notification missing hash', notification);\n                    }\n                }\n                if (userDismissed && notification.type === 'user' && notification.hash) {\n                    self.setUserDismissed(notification.id, notification.hash);\n                }\n            });\n\n            if (this.markRead.length > 0) {\n                this.sendMarkRead();\n            }\n\n            if (immediate) {\n                this.immediateUpdate(animate);\n            } else {\n                this.update(animate);\n            }\n        };\n\n        this.sendMarkRead = function() {\n            var self = this,\n                toSend = this.markRead.slice(0);\n\n            if (!this.markReadErrorCount) {\n                this.markReadErrorCount = 0;\n            }\n\n            this.markRead.length = 0;\n            this.dataRequest('notification', 'markRead', toSend)\n                .then(function() {\n                    self.markReadErrorCount = 0;\n                })\n                .catch(function(error) {\n                    self.markRead.splice(self.markRead.length - 1, 0, toSend);\n                    if (++self.markReadErrorCount < 2) {\n                        console.warn('Retrying to mark as read');\n                        self.sendMarkRead();\n                    }\n                })\n                .done();\n        };\n\n        this.canDismissNotification = function(notification) {\n            return this.attr.allowSystemDismiss !== false || notification.type !== 'system';\n        };\n\n        this.update = function(forceAnimation) {\n            var self = this;\n\n            d3.select(this.$container[0])\n                .selectAll('.notification')\n                .data(this.stack || [], function(n) {\n                    return n.id;\n                })\n                .call(function() {\n                    var newOnes = this.enter().insert('li')\n                        .attr('class', 'notification')\n                        .style('opacity', 0)\n                        .style('left', '-50px')\n                        .call(function() {\n                            this.append('h1')\n                            this.append('h2')\n                            this.append('button').style('display', 'none');\n                        })\n\n                    this.on('click', function(clicked) {\n                        var clickedButton = $(d3.event.target).is('button');\n                        if (!clickedButton && clicked.actionEvent) {\n                            if (clicked.actionEvent === 'EXTERNAL_URL' &&\n                                clicked.actionPayload &&\n                                clicked.actionPayload.url) {\n                                window.open(clicked.actionPayload.url);\n                            } else {\n                                _.defer(function() {\n                                    self.trigger(clicked.actionEvent, clicked.actionPayload);\n                                });\n                            }\n                        }\n\n                        if (clickedButton) {\n                            if (self.canDismissNotification(clicked)) {\n                                self.dismissNotification([clicked], {\n                                    immediate: true,\n                                    animate: true\n                                });\n                            }\n                        }\n                    });\n                    this.classed('critical', function(n) {\n                        return (/CRITICAL/i).test(n.severity);\n                    })\n                    this.classed('warning', function(n) {\n                        return (/WARNING/i).test(n.severity);\n                    });\n                    this.classed('informational', function(n) {\n                        return !n.severity || (/INFO/i).test(n.severity);\n                    });\n                    this.classed('canDismiss', function(n) {\n                        return self.canDismissNotification(n);\n                    });\n                    this.select('button').style('display', function(n) {\n                        return self.canDismissNotification(n) ? '' : 'none';\n                    });\n                    this.select('h1').text(function(n) {\n                        return n.title\n                    }).style('cursor', function(n) {\n                        return n.actionPayload ? 'pointer' : 'default';\n                    });\n                    this.select('h2').text(function(n) {\n                        return n.message\n                    }).style('cursor', function(n) {\n                        return n.actionPayload ? 'pointer' : 'default';\n                    });\n\n                    if (forceAnimation || self.attr.animated !== false) {\n                        newOnes = newOnes.transition()\n                            .delay(function(d, i) {\n                                return i / newOnes.size() * 100 + 100;\n                            })\n                            .duration(750)\n                    }\n\n                    newOnes\n                        .style('left', '0px')\n                        .style('opacity', 1)\n\n                    var exiting = this.exit(),\n                        exitingSize = exiting.size();\n\n                    self.$container.css('min-width', Math.max(self.$container.width(), 200) + 'px');\n\n                    if (forceAnimation || self.attr.animated !== false) {\n                        exiting = exiting\n                            .style('left', '0px')\n                            .transition()\n                            .delay(function(d, i) {\n                                if (exitingSize === 1) {\n                                    return 0;\n                                } else {\n                                    return (exitingSize - 1 - i) / exitingSize * 100 + 100;\n                                }\n                            })\n                            .duration(500)\n                            .style('left', '-50px')\n                            .style('opacity', 0)\n                    }\n\n                    exiting.remove()\n                });\n\n            if (this.attr.emptyMessage) {\n                this.$container.find('.empty').remove();\n                if (!this.stack.length) {\n                    $('<li>')\n                        .addClass('empty')\n                        .text(i18n('dashboard.notifications.empty'))\n                        .appendTo(this.$container)\n                }\n            }\n        };\n\n    }\n\n    function collapseDuplicates(notifications) {\n        var grouped = _.groupBy(notifications, 'title'),\n            toAdd = [],\n            toCollapseIds = [];\n\n        _.each(grouped, function(list, title) {\n            var validToCollapse = list.length > 1 && _.all(list, function(n) {\n                return n.type === 'user' && !n.actionEvent && !n.actionPayload;\n            });\n            if (validToCollapse) {\n                var ids = _.pluck(list, 'id'),\n                    add = _.extend({}, list[0], {\n                        collapsedIds: ids,\n                        title: title + ' (' + list.length + ')',\n                        message: message(list)\n                    });\n\n                toAdd.push(add);\n                toCollapseIds = toCollapseIds.concat(ids);\n            }\n        })\n\n        return _.chain(notifications)\n            .reject(function(n) {\n                return _.contains(toCollapseIds, n.id)\n            })\n            .tap(function(list) {\n                toAdd.forEach(function(a) {\n                    list.push(a);\n                })\n            })\n            .value()\n\n        function message(notifications) {\n            var prefix = sharedPrefix(notifications);\n            return (prefix || '') + _.chain(notifications)\n                .map(function(n) {\n                    if (prefix && prefix.length) {\n                        return n.message.substring(prefix.length)\n                    }\n                    return n.message;\n                })\n                .compact()\n                .sortBy(function(s) {\n                    return s.toLowerCase();\n                })\n                .value().join(', ')\n        }\n\n        function sharedPrefix(notifications) {\n            var sorted = _.pluck(notifications, 'message').sort(),\n                first = _.first(sorted),\n                last = _.last(sorted),\n                firstLen = first.length,\n                i = 0;\n                if (_.isString(first) && _.isString(last)) {\n                    while (i < firstLen && first.charAt(i) === last.charAt(i)) {\n                        i++;\n                    }\n                    return first.substring(0, i);\n                }\n        }\n    }\n\n});\n"]}