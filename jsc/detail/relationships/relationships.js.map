{"version":3,"sources":["../../../js/detail/relationships/relationships.js"],"names":["define","defineComponent","withDataRequest","alertTemplate","F","ElementList","d3","MAX_RELATIONS_TO_DISPLAY","Relationships","defaultAttrs","relationshipsHeaderSelector","relationshipsSearchRelatedSelector","relationshipsPagingButtonsSelector","after","$node","empty","on","onToggleRelationships","onSearchRelated","onPageRelationships","data","attr","event","model","update","onVerticesUpdated","matching","_","findWhere","vertices","id","$","target","hasClass","$section","closest","removeClass","requestRelationships","offset","size","$target","trigger","document","vertexIds","edgeLabel","self","$content","children","$badge","find","paging","pick","addClass","dataRequest","then","result","relationships","text","isNumber","totalReferences","number","prettyApproximate","length","html","message","i18n","node","append","teardownComponent","attachTo","items","usageContext","pretty","Math","ceil","appendTo","catch","e","console","error","finally","isNext","previousOffset","total","Promise","all","done","results","config","parseInt","hasEntityLabel","relations","map","edgeLabels","label","relation","displayName","ontologyRelationship","byTitle","select","selectAll","property","call","enter","openlumifyData","isFullscreen","sort","a","b","aIsReference","bIsReference","nameA","nameB","toLowerCase","localeCompare","exit","remove"],"mappings":"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","file":"relationships.js","sourcesContent":["define([\n    'flight/lib/component',\n    'util/withDataRequest',\n    'tpl!util/alert',\n    'util/formatters',\n    'util/element/list',\n    'd3'\n], function(\n    defineComponent,\n    withDataRequest,\n    alertTemplate,\n    F,\n    ElementList,\n    d3) {\n    'use strict';\n\n    var MAX_RELATIONS_TO_DISPLAY;\n\n    return defineComponent(Relationships, withDataRequest);\n\n    function Relationships() {\n\n        this.defaultAttrs({\n            relationshipsHeaderSelector: 'section.collapsible h1',\n            relationshipsSearchRelatedSelector: 'section.collapsible .search-related',\n            relationshipsPagingButtonsSelector: 'section.collapsible .paging button'\n        });\n\n        this.after('initialize', function() {\n            this.$node.empty();\n\n            this.on('click', {\n                relationshipsHeaderSelector: this.onToggleRelationships,\n                relationshipsSearchRelatedSelector: this.onSearchRelated,\n                relationshipsPagingButtonsSelector: this.onPageRelationships\n            });\n\n            this.data = this.attr.data;\n            this.on('updateModel', function(event, data) {\n                this.data = data.model;\n                this.update();\n            });\n\n            this.update();\n        });\n\n        this.onVerticesUpdated = function(event, data) {\n            var matching = _.findWhere(data.vertices, { id: this.data.id });\n\n            if (matching) {\n                this.data = matching;\n                this.update();\n            }\n        };\n\n        this.onToggleRelationships = function(event) {\n            if ($(event.target).hasClass('search-related')) {\n                return;\n            }\n\n            var $section = $(event.target).closest('.collapsible');\n\n            if ($section.hasClass('expanded')) {\n                return $section.removeClass('expanded');\n            }\n\n            this.requestRelationships($section.data({\n                offset: 0,\n                size: MAX_RELATIONS_TO_DISPLAY\n            }));\n        };\n\n        this.onSearchRelated = function(event) {\n            var $target = $(event.target),\n                $section = $target.closest('section');\n\n            this.trigger(document, 'searchByRelatedEntity', {\n                vertexIds: [this.data.id],\n                edgeLabel: $section.data('label')\n            });\n        };\n\n        this.requestRelationships = function($section) {\n            var self = this,\n                $content = $section.children('div'),\n                $badge = $section.find('.badge'),\n                paging = _.pick($section.data(), 'offset', 'size');\n\n            $badge.addClass('loading');\n\n            this.dataRequest('vertex', 'edges', this.data.id, {\n                offset: paging.offset,\n                size: paging.size,\n                edgeLabel: $section.data('label')\n            })\n                .then(function(result) {\n                    var relationships = result.relationships;\n\n                    $badge.text(_.isNumber(result.totalReferences) ?\n                        F.number.prettyApproximate(result.totalReferences) : '');\n                    $section.data('total', result.totalReferences);\n\n                    if (!relationships.length) {\n                        $content.html(alertTemplate({\n                            message: i18n('detail.entity.relationships.none_found')\n                        }));\n                        return;\n                    }\n\n                    var node = $content.empty()\n                        .append('<div>').find('div');\n\n                    node.teardownComponent(ElementList);\n                    ElementList.attachTo(node, {\n                        items: relationships,\n                        usageContext: 'detail/relationships'\n                    });\n\n                    if (result.relationships.length !== result.totalReferences) {\n                        $('<p>')\n                            .addClass('paging')\n                            .text(i18n(\n                                'detail.entity.relationships.paging',\n                                F.number.pretty(paging.offset / paging.size + 1),\n                                F.number.pretty(Math.ceil(result.totalReferences / paging.size))\n                            ))\n                            .append('<button class=\"previous\">')\n                            .append('<button class=\"next\">')\n                            .appendTo($content)\n                    }\n                })\n                .catch(function(e) {\n                    console.error(e);\n                    $content.html(alertTemplate({\n                        error: i18n('detail.entity.relationships.error')\n                    }));\n                })\n                .finally(function() {\n                    $badge.removeClass('loading');\n                    $section.addClass('expanded');\n                })\n        };\n\n        this.onPageRelationships = function(event) {\n            var $target = $(event.target),\n                isNext = $target.hasClass('next'),\n                $section = $target.closest('section'),\n                paging = $section.data(),\n                previousOffset = paging.offset;\n\n            if (isNext) {\n                if (paging.offset + paging.size < paging.total) {\n                    paging.offset += paging.size;\n                }\n            } else {\n                if (paging.offset - paging.size >= 0) {\n                    paging.offset -= paging.size;\n                }\n            }\n\n            if (previousOffset !== paging.offset) {\n                this.requestRelationships($section);\n            }\n        };\n\n        this.update = function() {\n            var self = this;\n\n            Promise.all([\n                this.dataRequest('config', 'properties'),\n                this.dataRequest('ontology', 'relationships')\n            ]).done(function(results) {\n                var config = results[0],\n                    relationships = results[1];\n\n                MAX_RELATIONS_TO_DISPLAY = parseInt(config['vertex.relationships.maxPerSection'], 10);\n\n                var hasEntityLabel = config['ontology.intent.relationship.artifactHasEntity'],\n                    relations = _.map(self.data.edgeLabels, function(label) {\n                        var relation = {\n                                label: label,\n                                displayName: label\n                            },\n                            ontologyRelationship = relationships.byTitle[label];\n\n                        if (label === hasEntityLabel) {\n                            relation.displayName =\n                                self.attr.hasEntityLabel ||\n                                i18n('detail.entity.relationships.has_entity');\n                        } else if (ontologyRelationship) {\n                            relation.displayName = ontologyRelationship.displayName;\n                        }\n\n                        return relation;\n                    });\n\n                d3.select(self.node)\n                    .selectAll('section.collapsible')\n                    .data(relations, _.property('label'))\n                    .call(function() {\n                        this.enter()\n                            .append('section')\n                            .attr('class', 'collapsible')\n                            .call(function() {\n                                this.append('h1')\n                                    .call(function() {\n                                        this.append('strong');\n                                        if (!openlumifyData.isFullscreen) {\n                                            this.append('s')\n                                                .attr('class', 'search-related')\n                                                .attr('title', i18n('detail.entity.relationships.open_in_search'));\n                                        }\n                                        this.append('span').attr('class', 'badge');\n                                    });\n                                this.append('div');\n                            });\n\n                        this\n                            .sort(function(a, b) {\n                                var aIsReference = a.label === hasEntityLabel,\n                                    bIsReference = b.label === hasEntityLabel,\n                                    nameA = a.displayName, nameB = b.displayName;\n\n                                if (aIsReference && !bIsReference) return 1;\n                                if (bIsReference && !aIsReference) return -1;\n\n                                return a.displayName.toLowerCase().localeCompare(b.displayName.toLowerCase());\n                            })\n                            .attr('data-label', _.property('label'))\n                            .select('h1 strong').text(_.property('displayName'));\n                    })\n                    .exit().remove();\n            });\n        };\n    }\n});\n"]}