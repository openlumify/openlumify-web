{"version":3,"sources":["../../../js/detail/headerImage/image.js"],"names":["define","defineComponent","retina","withFileDrop","Privileges","F","withDataRequest","MAX_PREVIEW_FILE_SIZE","ImageView","defaultAttrs","canvasSelector","fileSelector","acceptedTypesRegex","ignoreUpdateModelNotImplemented","after","self","on","onUpdateProgress","onUploadComplete","onUploadError","document","onVerticesUpdated","onUpdateModel","updateImageBackgroundSize","_","throttle","bind","onGraphPaddingUpdated","updateImageBackground","entityUpdateable","attr","data","updateable","canEdit","canEDIT","undefined","isArtifactDisplayType","$node","html","select","click","addClass","value","change","onFileChange","onSetImage","mouseenter","$","mouseleave","removeClass","e","handleFilesDropped","files","event","padding","r","imageNaturalSize","widthViewport","width","heightViewport","height","widthImage","heightImage","ratioViewport","ratioImage","widthCover","heightCover","widthContain","heightContain","hiddenPercent","shouldUseContain","css","Math","min","srcForGlyphIconUrl","url","vertex","imageDetail","concept","displayType","test","src","imageUrl","customImage","imageIsFromConcept","closest","image","Image","onload","naturalWidth","naturalHeight","onerror","backgroundImage","toggleClass","parent","target","hasClass","length","file","type","defer","handleFileDrop","setTimeout","findWhere","vertices","id","oldSrc","previewFile","reader","FileReader","result","size","readAsDataURL","draw","uploadFile","manualAnimation","firstProgressUpdate","dataRequest","progress","complete","trigger","then","catch","xhr","status","response","error","ctx","canvas","getContext","c","w","h","devicePixelRatio","centerX","centerY","radius","beginPath","moveTo","arc","PI","fillStyle","fill","clearRect","cleanup","animateManuallyIfNecessary","startedUpload","Date","now","requestAnimationFrame","success","hasCustomImage","contains","model","edgeLabels"],"mappings":"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","file":"image.js","sourcesContent":["\ndefine([\n    'flight/lib/component',\n    'util/retina',\n    'util/withFileDrop',\n    'util/privileges',\n    'util/vertex/formatters',\n    'util/withDataRequest'\n], function(\n    defineComponent,\n    retina,\n    withFileDrop,\n    Privileges,\n    F,\n    withDataRequest) {\n    'use strict';\n\n    // Limit previews to 1MB since it's a dataUri\n    var MAX_PREVIEW_FILE_SIZE = 1024 * 1024;\n\n    return defineComponent(ImageView, withFileDrop, withDataRequest);\n\n    function ImageView() {\n\n        this.defaultAttrs({\n            canvasSelector: 'canvas',\n            fileSelector: 'input',\n            acceptedTypesRegex: /^image\\/(jpe?g|png)$/i,\n            ignoreUpdateModelNotImplemented: true\n        });\n\n        this.after('initialize', function() {\n            var self = this;\n\n            this.on('fileprogress', this.onUpdateProgress);\n            this.on('filecomplete', this.onUploadComplete);\n            this.on('fileerror', this.onUploadError);\n            this.on(document, 'verticesUpdated', this.onVerticesUpdated);\n            this.on('updateModel', this.onUpdateModel);\n            this.updateImageBackgroundSize = _.throttle(this.updateImageBackgroundSize.bind(this), 100);\n            this.on(document, 'graphPaddingUpdated', this.onGraphPaddingUpdated);\n\n            this.updateImageBackground();\n\n            var entityUpdateable = this.attr.data.updateable;\n            var canEdit = Privileges.canEDIT && (entityUpdateable === undefined || entityUpdateable === true);\n            if (canEdit && !this.isArtifactDisplayType()) {\n                this.$node.html('<input type=\"file\" name=\"file\" /><canvas></canvas>')\n\n                this.select('fileSelector').on({\n                    click: function() {\n                        self.$node.addClass('file-hover'); this.value = null;\n                    },\n                    change: this.onFileChange.bind(this)\n                });\n\n                this.on('setImage', this.onSetImage);\n\n                this.$node.addClass('upload-available');\n                this.$node.on({\n                    mouseenter: function() {\n                        $(this).addClass('file-hover');\n                    },\n                    mouseleave: function() {\n                        $(this).removeClass('file-hover');\n                    }\n                });\n            }\n        });\n\n        this.onSetImage = function(e, data) {\n            this.handleFilesDropped(data.files);\n        };\n\n        this.onGraphPaddingUpdated = function(event, data) {\n            if (data.padding.r && this.imageNaturalSize) {\n                this.updateImageBackgroundSize();\n            }\n        };\n\n        this.updateImageBackgroundSize = function() {\n            if (this.imageNaturalSize &&\n                this.imageNaturalSize[0] > 0 &&\n                this.imageNaturalSize[1] > 0) {\n                var widthViewport = this.$node.width(),\n                    heightViewport = this.$node.height(),\n                    widthImage = this.imageNaturalSize[0],\n                    heightImage = this.imageNaturalSize[1],\n                    ratioViewport = widthViewport / heightViewport,\n                    ratioImage = widthImage / heightImage,\n\n                    widthCover = ratioImage <= ratioViewport ?\n                        widthViewport : heightViewport * ratioImage,\n                    heightCover = ratioImage <= ratioViewport ?\n                        widthViewport / ratioImage : heightViewport,\n\n                    widthContain = ratioImage <= ratioViewport ?\n                        heightViewport * ratioImage : widthViewport,\n                    heightContain = ratioImage <= ratioViewport ?\n                        heightViewport : widthViewport / ratioImage,\n\n                    hiddenPercent = 1 - (ratioImage <= ratioViewport ?\n                        heightViewport / heightCover :\n                        widthViewport / widthCover\n                    ),\n\n                    // Switch to contain if cover will hide > 40%\n                    shouldUseContain =\n                        hiddenPercent > 0.4 ||\n                        widthCover > widthImage ||\n                        heightCover > heightImage;\n\n                this.$node.css('backgroundSize',\n                    shouldUseContain ?\n                            (\n                                Math.min(widthContain, widthImage) + 'px ' +\n                                Math.min(heightContain, heightImage) + 'px'\n                            ) :\n                        'cover'\n                );\n            }\n        };\n\n        this.srcForGlyphIconUrl = function(url) {\n            if (url === F.vertex.imageDetail(this.attr.data)) {\n                return url;\n            }\n            return url || '';\n        };\n\n        this.isArtifactDisplayType = function() {\n            var concept = F.vertex.concept(this.attr.data);\n            if (concept && concept.displayType) {\n                return (/^(video|image)$/).test(concept.displayType);\n            }\n            return false;\n        }\n\n        this.updateImageBackground = function(src) {\n            var self = this,\n                imageUrl = this.srcForGlyphIconUrl(src || F.vertex.imageDetail(this.attr.data)),\n                customImage = !!(src || !F.vertex.imageIsFromConcept(this.attr.data));\n\n            if (this.isArtifactDisplayType()) {\n                customImage = false;\n            }\n\n            if (imageUrl && customImage) {\n                self.$node.closest('.vertex-header').addClass('loading');\n                var image = new Image();\n                image.onload = function() {\n                    self.imageNaturalSize = [image.naturalWidth, image.naturalHeight];\n                    self.updateImageBackgroundSize();\n                    self.$node.closest('.vertex-header').removeClass('loading');\n                }\n                image.onerror = function() {\n                    self.$node.closest('.vertex-header').removeClass('loading');\n                }\n                image.src = imageUrl;\n            }\n\n            this.$node\n                .addClass('accepts-file')\n                .css({ backgroundImage: 'url(\"' + imageUrl + '\")' })\n                .toggleClass('custom-image', customImage)\n                .parent()\n                .toggleClass('custom-entity-image', customImage);\n        };\n\n        this.onFileChange = function(e) {\n            this.handleFilesDropped(e.target.files);\n        };\n\n        this.handleFilesDropped = function(files) {\n            if (this.$node.hasClass('uploading')) {\n                return;\n            }\n            this.$node.removeClass('file-hover');\n            if (files.length === 1) {\n                var file = files[0];\n\n                if (this.attr.acceptedTypesRegex.test(file.type)) {\n                    this.$node.addClass('uploading');\n                    return _.defer(function() {\n                        this.handleFileDrop(file);\n                    }.bind(this));\n                }\n            }\n\n            this.$node.addClass('shake');\n            setTimeout(function() {\n                this.$node.removeClass('shake');\n            }.bind(this), 1000);\n        };\n\n        this.onVerticesUpdated = function(e, data) {\n            var vertex = _.findWhere(data.vertices, { id: this.attr.data.id });\n            if (vertex) {\n                var src = F.vertex.imageDetail(vertex),\n                    oldSrc = F.vertex.imageDetail(this.attr.data);\n\n                this.attr.data = vertex;\n                if (src !== oldSrc) {\n                    this.updateImageBackground(src);\n                }\n            }\n        };\n\n        this.previewFile = function(file) {\n            var self = this,\n                reader = new FileReader();\n\n            reader.onload = function(event) {\n                self.updateImageBackground(event.target.result);\n            };\n\n            if (file.size < MAX_PREVIEW_FILE_SIZE) {\n                reader.readAsDataURL(file);\n            }\n\n            this.draw(0);\n        };\n\n        this.uploadFile = function(file) {\n            var self = this;\n\n            this.manualAnimation = false;\n            this.firstProgressUpdate = true;\n\n            this.dataRequest('vertex', 'uploadImage', this.attr.data.id, file)\n                .progress(function(complete) {\n                    self.trigger('fileprogress', { complete: complete });\n                })\n                .then(function(vertex) {\n                    self.trigger('filecomplete', { vertex: vertex });\n                })\n                .catch(function(xhr) {\n                    self.trigger('fileerror', { status: xhr.status, response: xhr.error });\n                })\n        };\n\n        this.handleFileDrop = function(file) {\n            this.previewFile(file);\n            this.uploadFile(file);\n        };\n\n        this.draw = function(complete) {\n            if (!this.ctx) {\n                this.canvas = this.select('canvasSelector');\n                this.ctx = this.canvas[0].getContext('2d');\n            }\n\n            var c = this.ctx,\n                canvas = this.canvas[0],\n                w = this.canvas.width(),\n                h = this.canvas.height();\n            canvas.width = w * retina.devicePixelRatio;\n            canvas.height = h * retina.devicePixelRatio;\n            this.canvas.css({ width: w, height: h });\n\n            var centerX = canvas.width / 2,\n                centerY = canvas.height / 2,\n                radius = Math.min(canvas.width, canvas.height) / 2 * 0.3;\n\n            c.beginPath();\n            c.moveTo(centerX, centerY);\n            c.arc(centerX, centerY,\n                  radius + 2 * retina.devicePixelRatio, -Math.PI / 2, 2 * Math.PI - (Math.PI / 2), false\n            );\n            c.fillStyle = 'rgba(0,0,0,0.5)';\n            c.fill();\n\n            c.beginPath();\n            c.moveTo(centerX, centerY);\n            c.arc(centerX, centerY,\n                  radius, -Math.PI / 2, 2 * Math.PI * Math.min(1.0, complete) - (Math.PI / 2), false\n            );\n            c.fillStyle = 'rgba(255,255,255,0.8)';\n            c.fill();\n\n            if (complete >= 1.0) {\n                setTimeout(function() {\n                    c.clearRect(0, 0, canvas.width, canvas.height);\n                }, 250);\n            }\n        };\n\n        this.onUploadError = function() {\n            this.updateImageBackground();\n            this.cleanup(false);\n        };\n\n        this.onUploadComplete = function(event, data) {\n            var self = this;\n\n            if (!this.animateManuallyIfNecessary(1.0)) {\n                this.cleanup(true);\n            }\n\n            this.updateImageBackground(this.srcForGlyphIconUrl(F.vertex.imageDetail(data.vertex)));\n        };\n\n        this.onUpdateProgress = function(event, data) {\n            var self = this;\n\n            if (this.animateManuallyIfNecessary(data.complete)) {\n                return;\n            }\n\n            this.draw(data.complete);\n        };\n\n        this.animateManuallyIfNecessary = function(complete) {\n            var self = this;\n\n            if (this.manualAnimation) return true;\n\n            if (this.firstProgressUpdate && complete >= 1.0) {\n                this.manualAnimation = true;\n                var startedUpload = Date.now();\n\n                // Animate manually, fast upload\n                requestAnimationFrame(function draw() {\n                    var now = Date.now(),\n                        complete = (now - startedUpload) / 500;\n                    if (complete <= 1) {\n                        self.draw(complete);\n                        requestAnimationFrame(draw);\n                    } else {\n                        self.cleanup(true);\n                    }\n                });\n                return true;\n            }\n            this.firstProgressUpdate = false;\n\n            return false;\n        };\n\n        this.cleanup = function(success) {\n            if (success) {\n                this.draw(1.0);\n            } else {\n                this.ctx.clearRect(0, 0, this.canvas[0].width, this.canvas[0].height);\n            }\n            this.$node.removeClass('uploading');\n        };\n\n        this.onUpdateModel = function(event, data) {\n           var hasCustomImage = _.contains(data.model.edgeLabels, 'http://openlumify.org/dev#entityHasImageRaw');\n\n           if (hasCustomImage) {\n              this.updateImageBackground(this.srcForGlyphIconUrl(F.vertex.imageDetail(data.model)));\n           } else {\n              this.updateImageBackground();\n           }\n        };\n    }\n});\n"]}