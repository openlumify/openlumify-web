{"version":3,"sources":["../../../js/detail/text/text.js"],"names":["define","defineComponent","F","registry","stylesheet","withDataRequest","Privileges","jqueryWithinScrollable","withCollapsibleSections","withPropertyInfo","withElementScrollingPositionUpdates","dnd","config","colorjs","transcriptEntriesTemplate","alertTemplate","require","sf","STYLE_STATES","NORMAL","HOVER","CONFIG_MAX_SELECTION_PARAGRAPHS","parseInt","TEXT_PROPERTIES","PREVIEW_SELECTORS","audio","video","hasValidOffsets","_","isObject","data","isFinite","startOffset","endOffset","rangeUtils","d3","textStylesheet","documentExtensionPoint","e","isFunction","shouldReplaceTextSectionForVertex","isString","componentPath","Text","descriptionProperty","p","textDescription","metadata","key","name","textPropertySort","textPropertyId","attributes","termsSelector","resolvedSelector","textSelector","avLinkSelector","detailSectionContainerSelector","model","after","scrollNode","off","textExtension","teardown","$node","attr","self","remove","addSheet","loadRule","memoize","bind","color","selector","state","dataRequest","then","concepts","on","document","updateEntityAndArtifactDraggables","trackMouse","handleKeyup","updateEntityAndArtifactDraggablesNoDelay","throttle","around","fn","event","args","rest","arguments","$section","$","target","closest","propertyName","stopPropagation","hasClass","find","is","apply","openText","updateText","onTermClick","onAVLinkClick","onFocusOnSnippet","onEditProperty","onHoverTerm","onCopyText","onDropdownClosed","onTextUpdated","onHoverOver","onHoverLeave","scrollParent","css","evt","root","section","text","property","Promise","all","resolve","onToggleCollapsibleSection","spread","PropertyForm","length","prependTo","teardownAll","attachTo","updatingPromise","textPropertyKey","textPropertyName","$text","className","to","$transcript","focusOffsets","offsets","start","number","offsetValues","end","$container","eq","index","highlightOffsets","get","offset","done","selection","getSelection","isCollapsed","rangeCount","transformSelection","trigger","vertexId","id","formatTimeOffset","time","TimeSpan","$target","type","clearSelection","preventDefault","split","indexOf","mouseDown","isTextSelectable","handleSelectionChange","shiftKey","internalUpdateText","catch","console","error","_d3","_rangeUtils","results","properties","scrollTop","expandedKey","expandedName","textProperties","filter","ontologyProperty","byTitle","isTextProperty","some","userVisible","displayType","select","node","selectAll","call","enter","append","sortBy","order","each","datum","removePrefixedClasses","addClass","d","showPropertyInfo","exit","focus","scrollToSection","expand","propertyKey","options","isExpanded","$info","range","getRangeAt","hasSelection","collapsed","hasOpenForm","reloadText","removeClass","openTextRequest","cancel","extensions","extensionsForPoint","textPromise","warn","Attacher","path","params","vertex","attach","artifactText","html","processArtifactText","innerHTML","scrollToRevealSection","warningText","i18n","test","json","JSON","parse","isEmpty","entries","map","millis","isUndefined","warning","defer","disableSelection","checkIfReloadNeeded","func","setHoverTarget","clearTimeout","hoverLeaveTimeout","setTimeout","hoverOnlyTarget","ref","getElementRefId","currentHoverTarget","refs","parent","classList","contains","r","info","getElementInfoUsingRef","conceptType","concept","byId","push","parentNode","join","element","dataset","refId","fullInfo","parsedInfo","parents","sel","window","$textSection","clicked","parentsUntil","addBack","terms","popover","getOffsets","rangeRelativeToText","cloneRange","selectNodeContents","setEnd","startContainer","mentionStart","toString","mentionEnd","debounce","trim","anchor","anchorNode","focusNode","$anchorText","$focusText","textContainer","maxParagraphs","compact","replace","requireAndCleanupActionBar","missingEDIT","$textOffset","anchorTo","transformed","snippet","sign","nodesFound","getNodesWithinRange","termList","forEach","nodeType","term","Object","values","TextPopover","lookupComponent","previousSelectionSoClickWontTeardown","_termPopover","teardownComponent","validOffsets","keepInView","preferredPosition","artifactId","el","tearDownDropdowns","teardownAllComponents","$anchor","$focus","transcriptTextContainer","isTranscript","offsetsFunction","rangeOffsets","identity","contextHighlight","createSnippetFromRange","undefined","vertexTitle","title","offsetsForText","input","parentSelector","offsetTransform","i","offsetsForTranscript","endIndex","rawOffsets","bitMaskedOffset","partial","compactOffsetValues","words","validWords","withinScrollable","currentlyDragging","classes","loadSelectorForConcept","canEDIT","toggleClass","elements","getElementsFromDataTransfer","originalEvent","dataTransfer","vertexIds","targetInfo","resolvedToVertexId","sourceVertexId","targetVertexId","rawClassName","conceptColor","red","green","blue","definition","template","tpl","object","v","k","toLowerCase","colors","normal","setAlpha","background","addRule","scrollIfWithinPixelsFromBottom","y","top","sectionScrollY","offsetParent","height","outerHeight","fromBottom","animate","scrollToMediaPreview","$detailBody","mediaType","$mediaNode","$scrollParent","openlumifyData","isFullscreen","position","seekTo","transcriptKey","autoPlay","ActionBar"],"mappings":"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","file":"text.js","sourcesContent":["define([\n    'flight/lib/component',\n    'util/vertex/formatters',\n    'configuration/plugins/registry',\n    'util/css-stylesheet',\n    'util/withDataRequest',\n    'util/privileges',\n    'util/jquery.withinScrollable',\n    'util/withCollapsibleSections',\n    'util/popovers/propertyInfo/withPropertyInfo',\n    'util/popovers/withElementScrollingPositionUpdates',\n    'util/dnd',\n    'util/service/propertiesPromise',\n    'colorjs',\n    './transcriptEntries.hbs',\n    'tpl!util/alert',\n    'require',\n    'sf'\n], function(\n    defineComponent,\n    F,\n    registry,\n    stylesheet,\n    withDataRequest,\n    Privileges,\n    jqueryWithinScrollable,\n    withCollapsibleSections,\n    withPropertyInfo,\n    withElementScrollingPositionUpdates,\n    dnd,\n    config,\n    colorjs,\n    transcriptEntriesTemplate,\n    alertTemplate,\n    require,\n    sf) {\n    'use strict';\n\n    const STYLE_STATES = { NORMAL: 0, HOVER: 1 };\n    const CONFIG_MAX_SELECTION_PARAGRAPHS =\n        config['detail.text.popover.maxSelectionParagraphs'] ?\n        parseInt(config['detail.text.popover.maxSelectionParagraphs'], 10) : 5;\n    const TEXT_PROPERTIES = [\n        'http://openlumify.org#videoTranscript',\n        'http://openlumify.org#text'\n    ];\n    const PREVIEW_SELECTORS = {\n        audio: 'div .audio-preview',\n        video: '.org-openlumify-video'\n    };\n\n    const hasValidOffsets = data => {\n        return _.isObject(data) &&\n            _.isFinite(data.startOffset) &&\n            _.isFinite(data.endOffset) &&\n            data.startOffset >= 0 &&\n            data.endOffset > data.startOffset;\n    }\n\n    var rangeUtils, d3, textStylesheet;\n\n    /**\n     * Replaces the content of a collapsible text section in the inspector.\n     *\n     * Only one extension can replace a given text section, the first one will\n     * win.\n     *\n     * @param {string} componentPath The component to render instead of the text\n     * @param {org.openlumify.detail.text~shouldReplaceTextSectionForVertex} shouldReplaceTextSectionForVertex Whether the component should be rendered instead of the default\n     */\n    registry.documentExtensionPoint('org.openlumify.detail.text', 'Replace Extracted Text with custom component', function(e) {\n        return _.isFunction(e.shouldReplaceTextSectionForVertex) && _.isString(e.componentPath);\n    }, 'http://docs.openlumify.org/extension-points/front-end/detailText')\n\n    return defineComponent(\n        Text,\n        withDataRequest,\n        withCollapsibleSections,\n        withPropertyInfo,\n        withElementScrollingPositionUpdates\n    );\n\n    function descriptionProperty(p) {\n        var textDescription = 'http://openlumify.org#textDescription';\n        return p[textDescription] || p.metadata[textDescription] || p.key || p.name;\n    }\n\n    function textPropertySort(p) {\n        if (p.key === '') {\n            return '1' + descriptionProperty(p);\n        }\n        return '0' + descriptionProperty(p);\n    }\n\n    function textPropertyId(p) {\n        return p.name + (p.key || '')\n    }\n\n    function Text() {\n\n        this.attributes({\n            termsSelector: '.jref,.resolved,.resolvable',\n            resolvedSelector: '.resolved',\n            textSelector: '.text',\n            avLinkSelector: '.av-link',\n            detailSectionContainerSelector: '.org-openlumify-layout-body',\n            model: null\n        });\n\n        this.after('teardown', function() {\n            if (this.scrollNode) {\n                this.scrollNode.off('scrollstop scroll');\n            }\n            if (this.textExtension) {\n                this.textExtension.teardown();\n            }\n            this.$node.off('mouseleave', this.attr.termsSelector);\n        });\n\n        this.after('initialize', function() {\n            var self = this;\n            if (textStylesheet) {\n                textStylesheet.remove();\n            }\n            textStylesheet = stylesheet.addSheet();\n\n\n            this.loadRule = _.memoize(this.loadRule.bind(this), function(color, selector, state) {\n                return color + '|' + selector + '|' + state;\n            });\n\n            this.dataRequest('ontology', 'concepts').then(concepts => {\n                this.concepts = concepts;\n            })\n            this.on(document, 'ontologyUpdated', this.updateEntityAndArtifactDraggables);\n\n            this.on('mousedown mouseup click dblclick contextmenu', this.trackMouse);\n            this.on(document, 'keyup', this.handleKeyup);\n\n            this.updateEntityAndArtifactDraggablesNoDelay = this.updateEntityAndArtifactDraggables;\n            this.updateEntityAndArtifactDraggables = _.throttle(this.updateEntityAndArtifactDraggables.bind(this), 250);\n\n            this.around('onToggleCollapsibleSection', function(fn, event) {\n                var args = _.rest(arguments, 1),\n                    $section = $(event.target).closest('.text-section'),\n                    key = $section.attr('data-key'),\n                    propertyName = $section.attr('data-name');\n\n                event.stopPropagation();\n                if ($section.hasClass('expanded') || !$section.find('.text').is(':empty')) {\n                    fn.apply(this, args);\n                } else {\n                    return this.openText(key, propertyName);\n                }\n            });\n\n            this.model = this.attr.model;\n            this.on('updateModel', function(event, data) {\n                this.model = data.model;\n                this.updateText();\n            });\n            this.on('click', {\n                termsSelector: this.onTermClick,\n                avLinkSelector: this.onAVLinkClick\n            });\n            this.on('focusOnSnippet', this.onFocusOnSnippet);\n            this.on('editProperty', this.onEditProperty);\n            this.on('hoverTerm', this.onHoverTerm);\n            this.on('copy cut', {\n                textSelector: this.onCopyText\n            });\n            this.on('dropdownClosed', this.onDropdownClosed);\n            this.on(document, 'textUpdated', this.onTextUpdated);\n\n            this.on('mouseover', { termsSelector: this.onHoverOver });\n            this.$node.on('mouseleave', this.attr.termsSelector, this.onHoverLeave.bind(this));\n\n            this.scrollNode = self.$node.scrollParent()\n                .css('position', 'relative')\n                .on('scrollstop', self.updateEntityAndArtifactDraggables)\n                .on('scroll', self.updateEntityAndArtifactDraggables);\n            this.updateText();\n            this.updateEntityAndArtifactDraggables();\n        });\n\n        this.onEditProperty = function(evt, data) {\n            var self = this,\n                root = $('<div class=\"underneath\">'),\n                section = $(evt.target).closest('.text-section'),\n                text = section.find('.text'),\n                property = data && data.property;\n\n            evt.stopPropagation();\n\n            Promise.all([\n                Promise.require('detail/dropdowns/propertyForm/propForm'),\n                // Wait for expansion\n                section.hasClass('expanded') ? Promise.resolve() : self.onToggleCollapsibleSection(evt)\n            ]).spread(function(PropertyForm) {\n                if (text.length) {\n                    root.prependTo(text);\n                }\n\n                PropertyForm.teardownAll();\n                PropertyForm.attachTo(root, {\n                    data: self.model,\n                    property: property\n                });\n            });\n        };\n\n        this.onFocusOnSnippet = function(event, data) {\n            var self = this;\n            Promise.resolve(this.updatingPromise)\n                .then(function() {\n                    return self.openText(data.textPropertyKey, data.textPropertyName)\n                })\n                .then(function() {\n                    var $text = self.$node.find('.ts-' +\n                            F.className.to(data.textPropertyKey + data.textPropertyName) + ' .text'),\n                        $transcript = $text.find('.av-times'),\n                        focusOffsets = data.offsets;\n\n                    if ($transcript.length) {\n                        var start = F.number.offsetValues(focusOffsets[0]),\n                            end = F.number.offsetValues(focusOffsets[1]),\n                            $container = $transcript.find('dd').eq(start.index);\n\n                        rangeUtils.highlightOffsets($container.get(0), [start.offset, end.offset]);\n                    } else {\n                        rangeUtils.highlightOffsets($text.get(0), focusOffsets);\n                    }\n                })\n                .done();\n        };\n\n        this.onCopyText = function(event) {\n            var selection = getSelection(),\n                target = event.target;\n\n            if (!selection.isCollapsed && selection.rangeCount === 1) {\n\n                var data = this.transformSelection(selection);\n                if (hasValidOffsets(data)) {\n                    this.trigger('copydocumenttext', data);\n                }\n            }\n        };\n\n        this.onTextUpdated = function(event, data) {\n            if (data.vertexId === this.attr.model.id) {\n                this.updateText();\n            }\n        };\n\n        this.formatTimeOffset = function(time) {\n            return sf('{0:h:mm:ss}', new sf.TimeSpan(time));\n        };\n\n        this.trackMouse = function(event) {\n            var $target = $(event.target);\n\n            if ($target.is('.resolved,.resolvable')) {\n                if (event.type === 'mousedown') {\n                    rangeUtils.clearSelection();\n                }\n            }\n\n            if (event.type === 'contextmenu') {\n                event.preventDefault();\n            }\n\n            if (~'mouseup click dblclick contextmenu'.split(' ').indexOf(event.type)) {\n                this.mouseDown = false;\n            } else {\n                this.mouseDown = true;\n            }\n\n            if (isTextSelectable(event) && (event.type === 'mouseup' || event.type === 'dblclick')) {\n                this.handleSelectionChange();\n            }\n        };\n\n        this.handleKeyup = function(event) {\n            if (event.shiftKey && isTextSelectable(event)) {\n                this.handleSelectionChange();\n            }\n        };\n\n        this.updateText = function() {\n            var self = this;\n\n            this.updatingPromise = Promise.resolve(this.internalUpdateText())\n                .then(function() {\n                    self.updateEntityAndArtifactDraggables();\n                })\n                .catch(function(e) {\n                    console.error(e);\n                    throw e;\n                })\n\n            return this.updatingPromise;\n        }\n\n        this.internalUpdateText = function internalUpdateText(_d3, _rangeUtils) {\n            var self = this;\n\n            if (!d3 && _d3) d3 = _d3;\n            if (!rangeUtils && _rangeUtils) rangeUtils = _rangeUtils;\n\n            if (!d3) {\n                return Promise.all([\n                    Promise.require('d3'),\n                    Promise.require('util/range')\n                ]).then(function(results) {\n                    return internalUpdateText.apply(self, results);\n                })\n            }\n\n            return this.dataRequest('ontology', 'properties')\n                .then(function(properties) {\n                    var self = this,\n                        scrollParent = this.$node.scrollParent(),\n                        scrollTop = scrollParent.scrollTop(),\n                        expandedKey = this.$node.find('.text-section.expanded').data('key'),\n                        expandedName = this.$node.find('.text-section.expanded').data('name'),\n                        textProperties = _.filter(this.model.properties, function(p) {\n                            var ontologyProperty = properties.byTitle[p.name];\n                            if (!ontologyProperty) {\n                                return false;\n                            }\n\n                            // support legacy ontologies where text is not set to longText\n                            var isTextProperty = _.some(TEXT_PROPERTIES, function(name) {\n                                return name === p.name;\n                            });\n                            if (isTextProperty) {\n                                return true;\n                            }\n\n                            if (!ontologyProperty.userVisible) {\n                                return false;\n                            }\n                            return ontologyProperty.displayType === 'longText';\n                        });\n\n                    d3.select(self.node)\n                        .selectAll('div.highlightWrap')\n                        .data([1])\n                        .call(function() {\n                            this.enter().append('div');\n                            this.attr('class', 'highlightWrap highlight-underline');\n                        })\n                        .selectAll('section.text-section')\n                        .data(_.sortBy(textProperties, textPropertySort), textPropertyId)\n                        .call(function() {\n                            this.enter()\n                                .append('section')\n                                .attr('class', 'text-section collapsible')\n                                .call(function() {\n                                    this.append('h1').attr('class', 'collapsible-header')\n                                        .call(function() {\n                                            this.append('strong');\n                                            this.append('button').attr('class', 'info');\n                                        });\n                                    this.append('div').attr('class', 'text openlumify-allow-dblclick-selection');\n                                });\n\n                            this.order();\n\n                            this.attr('data-key', function(p) {\n                                    return p.key;\n                                })\n                                .attr('data-name', function(p) {\n                                    return p.name;\n                                })\n                                .each(function() {\n                                    var p = d3.select(this).datum();\n                                    $(this).removePrefixedClasses('ts-').addClass('ts-' + F.className.to(p.key + p.name));\n                                });\n                            this.select('h1 strong').text(descriptionProperty);\n                            this.select('button.info').on('click', function(d) {\n                                d3.event.stopPropagation();\n                                self.showPropertyInfo(this, self.model, d);\n                            });\n\n                            this.exit().remove();\n                        });\n\n                    if (textProperties.length) {\n                        if (this.attr.focus) {\n                            return this.openText(this.attr.focus.textPropertyKey, this.attr.focus.textPropertyName)\n                                .then(function() {\n                                    var $text = self.$node.find('.ts-' +\n                                            F.className.to(self.attr.focus.textPropertyKey + self.attr.focus.textPropertyName) + ' .text'),\n                                        $transcript = $text.find('.av-times'),\n                                        focusOffsets = self.attr.focus.offsets;\n\n                                    if ($transcript.length) {\n                                        var start = F.number.offsetValues(focusOffsets[0]),\n                                            end = F.number.offsetValues(focusOffsets[1]),\n                                            $container = $transcript.find('dd').eq(start.index);\n\n                                        rangeUtils.highlightOffsets($container.get(0), [start.offset, end.offset]);\n                                    } else {\n                                        rangeUtils.highlightOffsets($text.get(0), focusOffsets);\n                                    }\n                                    self.attr.focus = null;\n                                });\n                        } else if ((expandedName && expandedKey) || textProperties.length === 1) {\n                            return this.openText(\n                                expandedKey || textProperties[0].key,\n                                expandedName || textProperties[0].name,\n                                {\n                                    scrollToSection: textProperties.length !== 1\n                                }\n                            ).then(function() {\n                                scrollParent.scrollTop(scrollTop);\n                            });\n                        } else if (textProperties.length > 1) {\n                            return this.openText(textProperties[0].key, textProperties[0].name, {\n                                expand: false\n                            });\n                        }\n                    }\n                }.bind(this));\n        };\n\n        this.openText = function(propertyKey, propertyName, options) {\n            var self = this,\n                expand = !options || options.expand !== false,\n                $section = this.$node.find('.ts-' + F.className.to(propertyKey + propertyName)),\n                isExpanded = $section.is('.expanded'),\n                $info = $section.find('button.info'),\n                selection = getSelection(),\n                range = selection.rangeCount && selection.getRangeAt(0),\n                hasSelection = isExpanded && range && !range.collapsed,\n                hasOpenForm = isExpanded && ($section.find('.underneath').length || $('.detail-text-terms-popover').length);\n\n            if (hasSelection || hasOpenForm) {\n                this.reloadText = this.openText.bind(this, propertyKey, propertyName, options);\n                return Promise.resolve();\n            }\n\n            $section.closest('.texts').find('.loading').removeClass('loading');\n            if (expand && !isExpanded) {\n                $info.addClass('loading');\n            }\n\n            if (this.openTextRequest) {\n                this.openTextRequest.cancel();\n                this.openTextRequest = null;\n            }\n\n            var extensions = _.filter(registry.extensionsForPoint('org.openlumify.detail.text'), function(e) {\n                    /**\n                     * @callback org.openlumify.detail.text~shouldReplaceTextSectionForVertex\n                     * @param {object} model The vertex/edge\n                     * @param {string} propertyName\n                     * @param {string} propertyKey\n                     */\n                    return e.shouldReplaceTextSectionForVertex(self.model, propertyName, propertyKey);\n                }),\n                textPromise;\n\n            if (extensions.length > 1) {\n                console.warn('Multiple extensions wanting to override text', extensions);\n            }\n\n            if (extensions.length) {\n                textPromise = Promise.require('util/component/attacher')\n                    .then(function(Attacher) {\n                        /**\n                         * @typedef org.openlumify.detail.text~Component\n                         * @property {object} model The vertex/edge\n                         * @property {string} propertyName\n                         * @property {string} propertyKey\n                         */\n                        self.textExtension = Attacher()\n                            .node($section.find('.text'))\n                            .path(extensions[0].componentPath)\n                            .params({\n                                vertex: self.model,\n                                model: self.model,\n                                propertyName: propertyName,\n                                propertyKey: propertyKey\n                            })\n                        return self.textExtension.attach();\n                    })\n            } else {\n                this.openTextRequest = this.dataRequest(\n                    'vertex',\n                    'highlighted-text',\n                    this.model.id,\n                    propertyKey,\n                    propertyName\n                );\n\n                textPromise = this.openTextRequest\n                    .catch(function() {\n                        return '';\n                    })\n                    .then(function(artifactText) {\n                        var html = self.processArtifactText(artifactText);\n                        if (expand) {\n                            $section.find('.text')[0].innerHTML = html;\n                        }\n                    });\n            }\n\n            return textPromise\n                .then(function() {\n                    $info.removeClass('loading');\n                    if (expand) {\n                        $section.addClass('expanded');\n\n                        self.updateEntityAndArtifactDraggablesNoDelay();\n                        if (!options || options.scrollToSection !== false) {\n                            self.scrollToRevealSection($section);\n                        }\n                    } else {\n                        $section.removeClass('expanded');\n                    }\n                })\n        };\n\n        this.processArtifactText = function(text) {\n            var self = this,\n                warningText = i18n('detail.text.none_available');\n\n            // Looks like JSON ?\n            if (/^\\s*{/.test(text)) {\n                var json;\n                try {\n                    json = JSON.parse(text);\n                } catch(e) { /*eslint no-empty:0*/ }\n\n                if (json && !_.isEmpty(json.entries)) {\n                    return transcriptEntriesTemplate({\n                        entries: _.map(json.entries, function(e) {\n                            return {\n                                millis: e.start,\n                                time: (_.isUndefined(e.start) ? '' : self.formatTimeOffset(e.start)) +\n                                        ' - ' +\n                                      (_.isUndefined(e.end) ? '' : self.formatTimeOffset(e.end)),\n                                text: e.text\n                            };\n                        })\n                    });\n                } else if (json) {\n                    text = null;\n                    warningText = i18n('detail.transcript.none_available');\n                }\n            }\n\n            return !text ? alertTemplate({ warning: warningText }) : text;\n        };\n\n        this.onDropdownClosed = function(event, data) {\n            var self = this;\n            _.defer(function() {\n                self.disableSelection = false;\n                self.checkIfReloadNeeded();\n            })\n        };\n\n        this.checkIfReloadNeeded = function() {\n            if (this.reloadText) {\n                var func = this.reloadText;\n                this.reloadText = null;\n                func();\n            }\n        };\n\n        this.onHoverOver = function(event) {\n            this.setHoverTarget($(event.target).closest('.text'), event.target);\n        };\n\n        this.onHoverLeave = function(event) {\n            clearTimeout(this.hoverLeaveTimeout);\n            this.hoverLeaveTimeout = setTimeout(() => {\n                this.setHoverTarget($(event.target).closest('.text'));\n            }, 16);\n        };\n\n        this.setHoverTarget = function($text, target, options = {}) {\n            const { hoverOnlyTarget = false } = options;\n\n            if (target) {\n                clearTimeout(this.hoverLeaveTimeout);\n            }\n\n            const ref = target ? this.getElementRefId(target) : null;\n            if (ref !== this.currentHoverTarget) {\n                if (this.currentHoverTarget) {\n                    $text.removeClass(this.currentHoverTarget)\n                }\n                if (ref) {\n                    const refs = [ref];\n                    if (target && hoverOnlyTarget !== true) {\n                        let parent = target;\n                        while (!parent.classList.contains('text')) {\n                            const r = this.getElementRefId(parent);\n                            const info = this.getElementInfoUsingRef(parent);\n                            const type = info && info.conceptType;\n                            const concept = type && this.concepts.byId[type];\n                            const color = concept && concept.color || '#000000';\n                            const selector = '.text.' + r + ' .' + r;\n\n                            if (parent.classList.contains('res')) {\n                                this.loadRule(color, selector, STYLE_STATES.HOVER);\n                            } else if (parent.classList.contains('jref')) {\n                                this.loadRule('#0088cc', selector, STYLE_STATES.HOVER);\n                            }\n\n                            refs.push(r);\n                            parent = parent.parentNode;\n                        }\n                    }\n                    this.currentHoverTarget = refs.join(' ');\n                    $text.addClass(this.currentHoverTarget);\n                } else {\n                    this.currentHoverTarget = null;\n                }\n            }\n        };\n\n        this.getElementRefId = function(element) {\n            return element.dataset.refId ? element.dataset.refId : element.dataset.ref;\n        };\n\n        this.getElementInfoUsingRef = function(element) {\n            let info = element.dataset.info;\n            let ref = element.dataset.ref;\n            if (!info && ref) {\n                const fullInfo = $(element).closest('.text').find(`.${ref}[data-ref-id]`)[0]\n                if (fullInfo) {\n                    info = fullInfo.dataset.info;\n                } else {\n                    console.warn(\"Text contains a data-ref that doesn't exist in document\", element);\n                }\n            }\n            let parsedInfo = info ? JSON.parse(info) : null;\n            if (parsedInfo) {\n                parsedInfo.refId = element.dataset.refId || ref;\n            }\n            return parsedInfo;\n        }\n\n        this.onTermClick = function(event) {\n            var self = this,\n                $target = $(event.target);\n\n            if ($target.is('.underneath') || $target.parents('.underneath').length) {\n                return;\n            }\n            var sel = window.getSelection();\n            if (sel && sel.rangeCount === 1 && !sel.isCollapsed) {\n                return;\n            }\n\n            const $textSection = $target.closest('.text-section');\n            const clicked = $target.parentsUntil('.text', 'span').addBack();\n            const terms = [];\n            clicked.each(function() {\n                const info = self.getElementInfoUsingRef(this);\n                if (info) {\n                    terms.push(info)\n                } else {\n                    console.warn('Mention does not contain a data-info attribute', this);\n                }\n            })\n\n            this.popover({\n                node: $target,\n                terms,\n                propertyKey: $textSection.data('key'),\n                propertyName: $textSection.data('name')\n            });\n        };\n\n        this.getOffsets = function(root, range) {\n            var rangeRelativeToText = range.cloneRange();\n            rangeRelativeToText.selectNodeContents(root);\n            rangeRelativeToText.setEnd(range.startContainer, range.startOffset);\n            var mentionStart = rangeRelativeToText.toString().length;\n            var mentionEnd = mentionStart + range.toString().length\n            return { mentionStart, mentionEnd };\n        }\n\n        this.handleSelectionChange = _.debounce(function() {\n            var sel = window.getSelection(),\n                text = sel && sel.rangeCount === 1 ? $.trim(sel.toString()) : '';\n\n            if (this.disableSelection) {\n                return;\n            }\n            if (text && text.length > 0) {\n                var anchor = $(sel.anchorNode),\n                    focus = $(sel.focusNode),\n                    is = '.detail-pane .text',\n                    $anchorText = anchor.is(is) ? anchor : anchor.parents(is),\n                    $focusText = focus.is(is) ? focus : focus.parents(is),\n                    textContainer = $anchorText[0] || $focusText[0];\n\n                // Ignore outside content text\n                if ($anchorText.length === 0 || $focusText.length === 0) {\n                    this.checkIfReloadNeeded();\n                    return;\n                }\n\n                // Ignore if too long of selection\n                var maxParagraphs = _.compact(text.replace(/(\\s*<br>\\s*)+/g, '\\n').split('\\n'));\n                if (maxParagraphs.length > CONFIG_MAX_SELECTION_PARAGRAPHS) {\n                    return requireAndCleanupActionBar();\n                }\n\n                if (sel.rangeCount === 0) {\n                    this.checkIfReloadNeeded();\n                    return;\n                }\n\n                if (Privileges.missingEDIT) {\n                    return;\n                }\n\n                // Don't show action bar if dropdown opened\n                if (this.$node.find('.text.dropdown').length) {\n                    return;\n                }\n\n                var range = sel.rangeCount && sel.getRangeAt(0);\n\n                if (!range) {\n                    return;\n                }\n\n                var self = this;\n                var $text = $(textContainer),\n                    $textSection = $text.closest('.text-section'),\n                    $textOffset = $text.closest('.nav-with-background').offset();\n\n                const anchorTo = { range: range.cloneRange() };\n                const transformed = this.transformSelection(sel);\n                const { snippet, startOffset: mentionStart, endOffset: mentionEnd } = transformed;\n                const selection = {\n                    sign: text,\n                    mentionStart,\n                    mentionEnd,\n                    snippet\n                };\n\n                const nodesFound = rangeUtils.getNodesWithinRange(range);\n                let termList = [];\n                if (nodesFound) {\n                    const terms = {};\n                    nodesFound.forEach(node => {\n                        if (node.nodeType === 3) {\n                            node = node.parentNode;\n                        }\n                        const $node = $(node);\n                        if ($node.hasClass('text')) return;\n                        const self = this;\n                        $(node).parentsUntil('.text', 'span').addBack().each(function() {\n                            const term = self.getElementInfoUsingRef(this)\n                            if (term) {\n                                terms[term.id] = term;\n                            }\n                        })\n                    })\n                    termList = Object.values(terms)\n                }\n\n                this.popover({\n                    node: textContainer,\n                    anchorTo,\n                    selection,\n                    terms: termList,\n                    propertyKey: $textSection.data('key'),\n                    propertyName: $textSection.data('name')\n                })\n            } else {\n                this.checkIfReloadNeeded();\n            }\n        }, 250);\n\n        this.popover = function({ node, ...options }) {\n            if (this.TextPopover && $(node).lookupComponent(this.TextPopover)) {\n                const previousSelectionSoClickWontTeardown = this._termPopover &&\n                    this._termPopover.selection &&\n                    options.selection;\n\n                if (!previousSelectionSoClickWontTeardown) {\n                    return;\n                }\n            }\n\n            require(['./popover/popover'], TextPopover => {\n                this.TextPopover = TextPopover;\n                if (this._termPopover) {\n                    $(this._termPopover.node).teardownComponent(TextPopover);\n                }\n\n                if (options.selection) {\n                    const { mentionStart, mentionEnd } = options.selection\n                    const validOffsets = (mentionStart + mentionEnd) >= 0 && mentionStart < mentionEnd;\n                    if (!validOffsets) {\n                        return;\n                    }\n                }\n\n                TextPopover.attachTo(node, {\n                    keepInView: true,\n                    preferredPosition: 'below',\n                    artifactId: this.model.id,\n                    ...options\n                });\n\n                this._termPopover = options;\n                this._termPopover.node = node;\n            })\n        };\n\n        this.onHoverTerm = function(event, data) {\n            const $text = $(event.target).closest('.text');\n            let el;\n            if (data) {\n                el = $text.find('.' + data.id).get(0)\n            }\n\n            this.setHoverTarget($text, el, { hoverOnlyTarget: true });\n        };\n\n        this.tearDownDropdowns = function() {\n            this.$node.find('.underneath').teardownAllComponents();\n            this.disableSelection = false;\n        };\n\n        this.transformSelection = function(selection) {\n            var $anchor = $(selection.anchorNode),\n                $focus = $(selection.focusNode),\n                textContainer = $anchor.closest('.text')[0],\n                transcriptTextContainer = $anchor.closest('dd')[0],\n                isTranscript = $anchor.closest('.av-times').length,\n                offsetsFunction = isTranscript ?\n                    'offsetsForTranscript' :\n                    'offsetsForText',\n                range = selection.getRangeAt(0),\n                rangeOffsets = this.getOffsets(isTranscript ? transcriptTextContainer : textContainer, range),\n                offsets = this[offsetsFunction]([\n                    {el: $anchor, offset: rangeOffsets.mentionStart },\n                    {el: $focus, offset: rangeOffsets.mentionEnd }\n                ], '.text', _.identity),\n                contextHighlight = rangeUtils.createSnippetFromRange(\n                    range, undefined, textContainer\n                );\n\n            return {\n                startOffset: offsets && offsets[0],\n                endOffset: offsets && offsets[1],\n                snippet: contextHighlight,\n                vertexId: this.model.id,\n                textPropertyKey: $anchor.closest('.text-section').data('key'),\n                textPropertyName: $anchor.closest('.text-section').data('name'),\n                text: selection.toString(),\n                vertexTitle: F.vertex.title(this.model)\n            };\n        };\n\n        this.offsetsForText = function(input, parentSelector, offsetTransform) {\n            return input.map(i => i.offset);\n        };\n\n        this.offsetsForTranscript = function(input) {\n            var self = this,\n                index = input[0].el.closest('dd').data('index'),\n                endIndex = input[1].el.closest('dd').data('index');\n\n            if (index !== endIndex) {\n                return console.warn('Unable to select across timestamps');\n            }\n\n            var rawOffsets = this.offsetsForText(input, 'dd', function(offset) {\n                    return F.number.offsetValues(offset).offset;\n                }),\n                bitMaskedOffset = _.map(rawOffsets, _.partial(F.number.compactOffsetValues, index));\n\n            return bitMaskedOffset;\n        };\n\n        this.updateEntityAndArtifactDraggables = function() {\n            var self = this,\n                scrollNode = this.scrollNode,\n                words = this.select('resolvedSelector'),\n                validWords = $(words);\n\n            if (!scrollNode) {\n                scrollNode = this.scrollNode = this.$node.scrollParent();\n            }\n\n            // Filter list to those in visible scroll area\n            if (scrollNode && scrollNode.length) {\n                validWords = validWords.withinScrollable(scrollNode);\n            }\n\n            if (validWords.length === 0) {\n                return;\n            }\n\n            var currentlyDragging = null;\n\n            validWords\n                .each(function() {\n                    var info = self.getElementInfoUsingRef(this),\n                        type = info && info.conceptType,\n                        concept = type && self.concepts.byId[type];\n\n                    if (concept) {\n                        const classes = this.className.split(' ').filter(className => {\n                            return !(className.indexOf('conceptId-') === 0 && className !== concept.className)\n                        });\n\n                        if (!(concept.className in classes)) {\n                            classes.push(concept.className);\n                            this.className = classes.join(' ');\n                            self.loadSelectorForConcept(concept);\n                        } else {\n                            this.className = classes.join(' ');\n                        }\n                    }\n                })\n\n            if (Privileges.canEDIT) {\n\n                words\n                    .off('dragover drop dragenter dragleave')\n                    .on('dragover', function(event) {\n                        if (event.target.classList.contains('resolved')) {\n                            event.preventDefault();\n                        }\n                    })\n                    .on('dragenter dragleave', function(event) {\n                        if (event.target.classList.contains('resolved')) {\n                            $(event.target).toggleClass('drop-hover', event.type === 'dragenter');\n                        }\n                    })\n                    .on('drop', function(event) {\n                        event.preventDefault();\n                        $(event.target).removeClass('drop-hover');\n\n                        if (event.target.classList.contains('resolved')) {\n                            const elements = dnd.getElementsFromDataTransfer(event.originalEvent.dataTransfer);\n\n                            if (elements && elements.vertexIds.length === 1) {\n                                const targetInfo = self.getElementInfoUsingRef(event.target)\n                                if (targetInfo && targetInfo.resolvedToVertexId) {\n                                    const $textSection = $(event.target).closest('.text-section');\n                                    const sourceVertexId = elements.vertexIds[0];\n                                    const targetVertexId = targetInfo.resolvedToVertexId;\n\n                                    self.popover({\n                                        node: event.target,\n                                        sourceVertexId,\n                                        targetVertexId,\n                                        propertyKey: $textSection.data('key'),\n                                        propertyName: $textSection.data('name')\n                                    })\n                                }\n                            }\n\n                        }\n                    })\n            }\n        };\n\n        this.loadSelectorForConcept = function(concept) {\n            if (!concept.color) {\n                return;\n            }\n\n            const className = concept.rawClassName || concept.className;\n            if (!className) {\n                return;\n            }\n\n            const conceptColor = colorjs(concept.color);\n            if (conceptColor.red === 0 && conceptColor.green === 0 & conceptColor.blue === 0) {\n                return;\n            }\n\n            this.loadRule(concept.color, '.highlight-underline .res.' + className, STYLE_STATES.NORMAL);\n        };\n\n        this.loadRule = function(color, selector, state) {\n            require(['detail/text/highlight-styles/underline.hbs'], tpl => {\n                const definition = function(state, template) {\n                    return (template || tpl)({\n                        ...(_.object(_.map(STYLE_STATES, (v, k) => [k.toLowerCase(), v === state]))),\n                        colors: {\n                            normal: colorjs(color).setAlpha(1.0),\n                            background: colorjs(color).setAlpha(0.1)\n                        }\n                    });\n                };\n                textStylesheet.addRule(selector, definition(state));\n            });\n        };\n\n        this.scrollToRevealSection = function($section) {\n            var scrollIfWithinPixelsFromBottom = 150,\n                y = $section.offset().top,\n                sectionScrollY = $section.offset().top - $section.offsetParent().offset().top,\n                scrollParent = $section.scrollParent(),\n                scrollTop = scrollParent.scrollTop(),\n                height = scrollParent.outerHeight(),\n                fromBottom = height - y;\n            sectionScrollY += scrollTop + scrollIfWithinPixelsFromBottom;\n            if (fromBottom < scrollIfWithinPixelsFromBottom) {\n                scrollParent.animate({\n                    scrollTop: sectionScrollY - height\n                }, 'fast');\n            }\n        };\n\n        this.scrollToMediaPreview = function($detailBody) {\n            if (!this.mediaType) {\n                this.mediaType = $detailBody.find(PREVIEW_SELECTORS.audio).parent().length > 0 ? 'audio' : 'video';\n                this.$mediaNode = this.mediaType === 'audio' ?\n                    $detailBody.find(PREVIEW_SELECTORS.audio).parent() :\n                    $detailBody.find(PREVIEW_SELECTORS.video);\n            }\n            var $scrollParent = openlumifyData.isFullscreen ? $('html, body') : $detailBody,\n                scrollTop = openlumifyData.isFullscreen ? this.$mediaNode.offset().top : this.$mediaNode.position().top;\n\n            $scrollParent.animate({\n                scrollTop: scrollTop\n            }, 'fast');\n        };\n\n        this.onAVLinkClick = function(event, data) {\n            var seekTo = data.el.dataset.millis || '';\n            var transcriptKey = $(event.target).parents('section').data().key;\n\n            if (seekTo) {\n                this.trigger(this.$node.parents('.type-content'), 'avLinkClicked', {\n                    seekTo: seekTo,\n                    autoPlay: false,\n                    transcriptKey: transcriptKey\n                });\n\n                this.scrollToMediaPreview(this.$node.parents(this.attr.detailSectionContainerSelector));\n            }\n        };\n    }\n\n    function isTextSelectable(event) {\n        return ($(event.target).closest('.opens-dropdown').length === 0 &&\n            $(event.target).closest('.underneath').length === 0 &&\n            !($(event.target).parent().hasClass('currentTranscript')) &&\n            !($(event.target).hasClass('alert alert-error')));\n    }\n\n    function requireAndCleanupActionBar() {\n        return Promise.require('util/actionbar/actionbar')\n            .then(function(ActionBar) {\n                ActionBar.teardownAll();\n                return ActionBar;\n            });\n    }\n});\n"]}