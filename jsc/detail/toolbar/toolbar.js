var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key];}}}return target;};define(['flight/lib/component','./template.hbs','configuration/plugins/registry','util/vertex/formatters','util/withDataRequest','util/acl'],function(defineComponent,template,registry,F,withDataRequest,acl){'use strict';registry.documentExtensionPoint('org.openlumify.detail.toolbar','Add Inspector toolbar items',function(e){return e.divider||'event'in e&&'title'in e;},'http://docs.openlumify.org/extension-points/front-end/detailToolbar');var DIVIDER={divider:true},ToolbarComponent=defineComponent(Toolbar,withDataRequest);ToolbarComponent.ITEMS={DIVIDER:DIVIDER,BACK:{title:'◀'},FORWARD:{title:'▶'},FULLSCREEN:{title:i18n('detail.toolbar.open.fullscreen'),cls:'hide-in-fullscreen-details',subtitle:i18n('detail.toolbar.open.fullscreen.subtitle'),event:'openFullscreen'},ADD_PROPERTY:{title:i18n('detail.toolbar.add.property'),subtitle:i18n('detail.toolbar.add.property.entity.subtitle'),cls:'requires-EDIT',event:'addNewProperty'},ADD_IMAGE:{title:i18n('detail.toolbar.add.image'),subtitle:i18n('detail.toolbar.add.image.subtitle'),cls:'requires-EDIT',event:'addImage',options:{fileSelector:true}},ADD_COMMENT:{title:i18n('detail.toolbar.add.comment'),subtitle:i18n('detail.toolbar.add.comment.entity.subtitle'),cls:'requires-COMMENT',event:'addNewComment'},AUDIT:{title:i18n('detail.toolbar.audit'),subtitle:i18n('detail.toolbar.audit.subtitle'),cls:'audits',event:'toggleAudit'},DELETE_ITEM:{title:i18n('detail.toolbar.delete'),cls:'requires-EDIT',event:'deleteItem'}};return ToolbarComponent;function Toolbar(){this.defaultAttrs({toolbarItemSelector:'li'});this.after('initialize',function(){this.on('updateModel',this.onUpdateModel);this.render();});this.render=function(){var _this=this;var model=this.attr.model;Promise.resolve(this.calculateConfigForModel(model)).then(function(items){return _this.initializeToolbar(items);});};this.onUpdateModel=function(event,data){this.attr.model=data.model;this.render();};this.initializeToolbar=function(config){var toolbarItems=config.items,objects=config.objects,toolbarExtensions=_.sortBy(registry.extensionsForPoint('org.openlumify.detail.toolbar'),'title');toolbarExtensions.forEach(function(item){if(!_.isFunction(item.canHandle)||item.canHandle(objects)){item.eventData=objects;if(item.options&&_.isFunction(item.options.insertIntoMenuItems)){item.options.insertIntoMenuItems(item,toolbarItems);}else{toolbarItems.push(item);}}});this.on('click',{toolbarItemSelector:this.onToolbarItem});if(toolbarItems.length){this.$node.html(template(config));this.$node.find('li').each(function(){var $this=$(this),shouldHide=$this.hasClass('has-submenu')?_.all($this.find('li').map(function(){return $(this).css('display')==='none';}).toArray()):$this.hasClass('no-event');if(shouldHide){$this.hide();}});}else{this.$node.hide();}};this.calculateConfigForModel=function(model){var _this2=this;var isArray=_.isArray(model),vertices=isArray?_.where(model,{type:'vertex'}):model.type==='vertex'?[model]:[],edges=isArray?_.where(model,{type:'edge'}):model.type==='edge'?[model]:[];if(isArray){return{items:[{title:i18n('detail.toolbar.open'),submenu:[ToolbarComponent.ITEMS.FULLSCREEN].concat(this.selectionHistory())},{title:i18n('detail.multiple.selected',F.number.pretty(model.length)),cls:'disabled',right:true,event:'none'}],objects:{vertices:vertices,edges:edges}};}else{return acl.getPropertyAcls(model).then(function(propertyAcls){return{items:[{title:i18n('detail.toolbar.open'),submenu:_.compact([ToolbarComponent.ITEMS.FULLSCREEN,_this2.sourceUrlToolbarItem(model),_this2.openToolbarItem(model),_this2.downloadToolbarItem(model)]).concat(_this2.selectionHistory())},{title:i18n('detail.toolbar.add'),submenu:_.compact([_this2.addPropertyToolbarItem(model,propertyAcls),_this2.addImageToolbarItem(model),_this2.addCommentToolbarItem(model,propertyAcls)])},{icon:'img/glyphicons/white/glyphicons_157_show_lines@2x.png',right:true,submenu:_.compact([_this2.deleteToolbarItem(model)])}],objects:{vertices:vertices,edges:edges}};});}};this.onToolbarItem=function(event){var self=this,$target=$(event.target).closest('li'),eventName=$target.data('event'),eventData=$target.data('eventData');if($target.length&&$target.hasClass('disabled')){event.preventDefault();event.stopPropagation();return;}if(eventName&&$(event.target).is('input[type=file]')){$(event.target).one('change',function(e){if(e.target.files&&e.target.files.length){self.trigger(eventName,$.extend({files:e.target.files},eventData));}});this.hideMenu();return;}if(eventName){event.preventDefault();event.stopPropagation();_.defer(function(){self.trigger(eventName,eventData);});this.hideMenu();}};this.hideMenu=function(){var node=this.$node.addClass('hideSubmenus'),remove=_.once(function(){node.removeClass('hideSubmenus');});$(window).one('mousemove click',remove);};this.selectionHistory=function(){if('selectedObjectsStack'in openlumifyData){var menus=[],stack=openlumifyData.selectedObjectsStack;for(var i=stack.length-1;i>=0;i--){var s=stack[i];menus.push({title:s.title,cls:'history-item',event:'selectObjects',eventData:{vertexIds:s.vertexIds,edgeIds:s.edgeIds}});}if(menus.length){menus.splice(0,0,DIVIDER,{title:i18n('detail.toolbar.open.previous'),cls:'disabled'});}return menus;}};this.openToolbarItem=function(model){var rawProps=F.vertex.props(model,'http://openlumify.org#raw');if(rawProps.length){return{title:i18n('detail.artifact.open.original'),subtitle:i18n('detail.artifact.open.original.subtitle'),event:'openOriginal'};}};this.downloadToolbarItem=function(model){var rawProps=F.vertex.props(model,'http://openlumify.org#raw');if(rawProps.length){return{title:i18n('detail.artifact.open.download.original'),subtitle:i18n('detail.artifact.open.download.original.subtitle'),event:'downloadOriginal'};}};this.sourceUrlToolbarItem=function(model){if(_.isObject(model)&&_.isArray(model.properties)){var sourceUrl=_.findWhere(model.properties,{name:'http://openlumify.org#sourceUrl'});if(sourceUrl){return{title:i18n('detail.toolbar.open.source_url'),subtitle:i18n('detail.toolbar.open.source_url.subtitle'),event:'openSourceUrl',eventData:{sourceUrl:sourceUrl.value}};}}};this.addPropertyToolbarItem=function(model,propertyAcls){var commentPropertyAcls=_.reject(propertyAcls,function(property){return property.name==='http://openlumify.org/comment#entry';}),hasAddableProperties=_.where(commentPropertyAcls,{addable:true}).length>0||openlumifyData.currentUser.privilegesHelper.ONTOLOGY_ADD,disableAdd=model.hasOwnProperty('updateable')&&!model.updateable||!hasAddableProperties;if(!disableAdd){return _extends({},ToolbarComponent.ITEMS.ADD_PROPERTY,{subtitle:model.type==='vertex'?i18n('detail.toolbar.add.property.entity.subtitle'):i18n('detail.toolbar.add.property.relationship.subtitle')});}};this.addImageToolbarItem=function(model){var displayType=F.vertex.displayType(model);var disableAddImage=model.hasOwnProperty('updateable')&&!model.updateable||model.type==='edge';if(!disableAddImage&&displayType!=='image'&&displayType!=='video'){return ToolbarComponent.ITEMS.ADD_IMAGE;}};this.addCommentToolbarItem=function(model,propertyAcls){var hasAddableCommentProperty=_.where(propertyAcls,{name:'http://openlumify.org/comment#entry',addable:true}).length>0,disableAdd=model.hasOwnProperty('updateable')&&!model.updateable||!hasAddableCommentProperty;if(!disableAdd){return _extends({},ToolbarComponent.ITEMS.ADD_COMMENT,{subtitle:model.type==='vertex'?i18n('detail.toolbar.add.comment.entity.subtitle'):i18n('detail.toolbar.add.comment.relationship.subtitle')});}};this.deleteToolbarItem=function(model){var disableDelete=model.hasOwnProperty('deleteable')&&!model.deleteable;if(!disableDelete){return _.extend(ToolbarComponent.ITEMS.DELETE_ITEM,{title:model.type==='vertex'?i18n('detail.toolbar.delete.entity'):i18n('detail.toolbar.delete.edge'),subtitle:model.type==='vertex'?i18n('detail.toolbar.delete.entity.subtitle'):i18n('detail.toolbar.delete.edge.subtitle')});}};}});
//# sourceMappingURL=toolbar.js.map
