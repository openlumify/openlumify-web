{"version":3,"sources":["../../../js/detail/video/video.js"],"names":["define","defineComponent","VideoScrubber","F","withDataRequest","config","transcriptEntryTemplate","sf","Video","attributes","model","previewSelector","currentTranscriptSelector","ignoreUpdateModelNotImplemented","after","self","on","onScrubberFrameChange","onPlayerTimeUpdate","onUpdateModel","$node","parents","onAVLinkClicked","attr","render","formatsReady","isVideoReady","_","any","videoRendered","empty","html","durationProperty","findWhere","properties","name","duration","value","attachTo","select","rawUrl","vertex","raw","posterFrameUrl","image","videoPreviewImageUrl","imageFrames","allowPlayback","transcriptRendered","renderTranscript","key","time","currentTime","transcriptProperties","where","length","transcriptKey","dataRequest","id","catch","then","artifactText","currentTranscriptKey","currentTranscript","processArtifactText","updateCurrentTranscript","event","data","formats","map","format","props","object","evt","_noDurationWarned","console","warn","frameIndex","index","numberOfFrames","entry","findTranscriptEntryForTime","timeLabel","isUndefined","start","formatTimeOffset","end","text","formatTranscript","entries","bestMatch","i","trigger","seekTo","test","json","JSON","parse","e","isEmpty","div","document","createElement","innerHTML","textContent","TimeSpan"],"mappings":"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","file":"video.js","sourcesContent":["define([\n    'flight/lib/component',\n    'util/video/scrubber',\n    'util/vertex/formatters',\n    'util/withDataRequest',\n    'util/requirejs/promise!util/service/propertiesPromise',\n    './transcriptEntry.hbs',\n    'sf'\n], function(\n    defineComponent,\n    VideoScrubber,\n    F,\n    withDataRequest,\n    config,\n    transcriptEntryTemplate,\n    sf) {\n    'use strict';\n\n    return defineComponent(Video, withDataRequest);\n\n    function Video() {\n\n        this.attributes({\n            model: null,\n            previewSelector: '.video-preview',\n            currentTranscriptSelector: '.currentTranscript',\n            ignoreUpdateModelNotImplemented: true\n        })\n\n        this.after('initialize', function() {\n            var self = this;\n\n            this.on('scrubberFrameChange', this.onScrubberFrameChange);\n            this.on('playerTimeUpdate', this.onPlayerTimeUpdate);\n            this.on('updateModel', this.onUpdateModel);\n            this.on(this.$node.parents('.type-content'), 'avLinkClicked', this.onAVLinkClicked);\n\n            this.model = this.attr.model;\n            this.render();\n        });\n\n        this.render = function() {\n            var self = this;\n\n            const formatsReady = this.isVideoReady();\n            if (!_.any(formatsReady)) {\n                this.videoRendered = false;\n                return this.$node.empty();\n            }\n            if (!this.videoRendered) {\n                this.$node.html('<div class=\"video-preview\"></div><div class=\"currentTranscript\"></div>')\n                var durationProperty = _.findWhere(this.model.properties, { name: config['ontology.intent.property.videoDuration'] });\n                if (durationProperty) {\n                    this.duration = durationProperty.value * 1000;\n                }\n                VideoScrubber.attachTo(this.select('previewSelector'), {\n                    rawUrl: F.vertex.raw(this.model),\n                    posterFrameUrl: F.vertex.image(this.model),\n                    formatsReady,\n                    videoPreviewImageUrl: F.vertex.imageFrames(this.model),\n                    duration: this.duration,\n                    allowPlayback: true\n                });\n                this.videoRendered = true;\n            }\n\n            if (this.videoRendered && !this.transcriptRendered) {\n                this.renderTranscript();\n            }\n        };\n\n        this.renderTranscript = function(key, time) {\n            var self = this,\n                currentTime = time || 0,\n                transcriptProperties = _.where(this.model.properties, { name: 'http://openlumify.org#videoTranscript' });\n\n            if (!transcriptProperties.length) return;\n\n            var transcriptKey = key ? key : transcriptProperties[0].key;\n\n            this.dataRequest('vertex', 'highlighted-text', this.model.id, transcriptKey)\n                .catch(function() {\n                    return '';\n                })\n                .then(function(artifactText) {\n                    self.currentTranscriptKey = transcriptKey;\n                    self.currentTranscript = processArtifactText(artifactText);\n                    self.updateCurrentTranscript(currentTime);\n                });\n        };\n\n        this.onUpdateModel = function(event, data) {\n            this.model = data.model;\n            this.render();\n        };\n\n        this.isVideoReady = function() {\n            const formats = ['mp4', 'webm'].map(format => [\n                format,\n                F.vertex.props(this.model, `http://openlumify.org#video-${format}`).length > 0\n            ]);\n            return _.object(formats);\n        };\n\n        this.onPlayerTimeUpdate = function(evt, data) {\n            var time = data.currentTime * 1000;\n            this.updateCurrentTranscript(time);\n        };\n\n        this.onScrubberFrameChange = function(evt, data) {\n            if (!this.duration) {\n                if (!this._noDurationWarned) {\n                    console.warn('No duration property for artifact, unable to sync transcript');\n                    this._noDurationWarned = true;\n                }\n                return;\n            }\n            var frameIndex = data.index,\n                numberOfFrames = data.numberOfFrames,\n                time = (this.duration / numberOfFrames) * frameIndex;\n\n            this.updateCurrentTranscript(time);\n        };\n\n        this.updateCurrentTranscript = function(time) {\n            var entry = this.findTranscriptEntryForTime(time),\n                html = '';\n\n            if (entry) {\n                var timeLabel = (_.isUndefined(entry.start) ? '' : formatTimeOffset(entry.start)) +\n                    ' - ' +\n                    (_.isUndefined(entry.end) ? '' : formatTimeOffset(entry.end));\n                html = transcriptEntryTemplate({\n                    time: timeLabel,\n                    text: formatTranscript(entry.text)\n                });\n            }\n            this.select('currentTranscriptSelector').html(html);\n        };\n\n        this.findTranscriptEntryForTime = function(time) {\n            if (!this.currentTranscript || !this.currentTranscript.entries) {\n                return null;\n            }\n            var bestMatch = this.currentTranscript.entries[0];\n            for (var i = 0; i < this.currentTranscript.entries.length; i++) {\n                if (this.currentTranscript.entries[i].start <= time) {\n                    bestMatch = this.currentTranscript.entries[i];\n                }\n            }\n            return bestMatch;\n        };\n\n        this.onAVLinkClicked = function(event, data) {\n            this.trigger(this.select('previewSelector'), 'seekToTime', data);\n            if (data.transcriptKey !== this.currentTranscriptKey) {\n                this.renderTranscript(data.transcriptKey, data.seekTo);\n            }\n        };\n    }\n\n    function processArtifactText(text) {\n        // Looks like JSON ?\n        if (/^\\s*{/.test(text)) {\n            var json;\n            try {\n                json = JSON.parse(text);\n            } catch(e) { /*eslint no-empty:0*/ }\n\n            if (json && !_.isEmpty(json.entries)) {\n                return json;\n            }\n        }\n        return null;\n    }\n\n    function formatTranscript(text) {\n        var div = document.createElement('div')\n        div.innerHTML = text;\n        return div.textContent;\n    }\n\n    function formatTimeOffset(time) {\n        return sf('{0:h:mm:ss}', new sf.TimeSpan(time));\n    }\n});\n"]}