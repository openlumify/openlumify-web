{"version":3,"sources":["../../../js/detail/detectedObjects/detectedObjects.js"],"names":["define","defineComponent","withDataRequest","F","Privileges","dnd","d3","require","PERCENT_CLOSE_FOR_ROUNDING","DetectedObjects","attributes","detectedObjectTagSelector","detectedObjectSelector","model","after","attr","node","classList","add","on","onUpdateModel","onCloseDropdown","onDetectedObjectClicked","root","$node","closest","onDetectedObjectEdit","onDetectedObjectDoneEditing","updateDetectedObjects","event","self","_","defer","trigger","data","find","teardownAllComponents","remove","showForm","missingEDIT","preventDefault","$target","$","target","propertyKey","property","first","vertex","props","Error","removeClass","parent","addClass","ActionBar","teardownAll","off","hasClass","unresolve","canEDIT","sandboxStatus","attachTo","alignTo","actions","extend","Open","Unresolve","vertexIds","value","resolvedVertexId","dataRequest","done","title","Resolve","TermForm","$form","show","termForm","lookupComponent","key","dataInfo","originalPropertyKey","teardownComponent","appendTo","prependTo","artifactData","restrictConcept","concept","existing","Boolean","detectedObject","wasResolved","needsLoading","detectedObjects","container","toggle","length","forEach","push","Promise","all","results","vertices","concepts","verticesById","indexBy","roundCoordinate","percentFloat","Math","round","detectedObjectKey","select","get","selectAll","call","enter","append","sort","a","b","y2","y1","x2","x1","style","classes","edgeId","text","resolvedVertex","i18n","byId","displayName","exit","onDetectedObjectHover","bind","updateDraggables","tag","badge","type","objects","children","each","i","object","vertexId","elements","dt","originalEvent","dataTransfer","setDataTransferWithElements"],"mappings":"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","file":"detectedObjects.js","sourcesContent":["define([\n    'flight/lib/component',\n    'util/withDataRequest',\n    'util/vertex/formatters',\n    'util/privileges',\n    'util/dnd',\n    'd3',\n    'require'\n], function(\n    defineComponent,\n    withDataRequest,\n    F,\n    Privileges,\n    dnd,\n    d3,\n    require) {\n    'use strict';\n\n    var PERCENT_CLOSE_FOR_ROUNDING = 5; // Used for sorting x/y coordinates of detected objects\n                                        // This is the distance (%) at which\n                                        // objects are considered positioned similarly\n\n\n    return defineComponent(DetectedObjects, withDataRequest);\n\n    function DetectedObjects() {\n\n        this.attributes({\n            detectedObjectTagSelector: '.detected-object-tag',\n            detectedObjectSelector: '.detected-object',\n            model: null\n        })\n\n        this.after('initialize', function() {\n            this.model = this.attr.model;\n\n            this.node.classList.add('org-openlumify-detectedObjects');\n            this.on('updateModel', this.onUpdateModel);\n            this.on('closeDropdown', this.onCloseDropdown);\n            this.on('click', {\n                detectedObjectSelector: this.onDetectedObjectClicked\n            });\n\n            var root = this.$node.closest('.org-openlumify-layout-root');\n            this.on(root, 'detectedObjectEdit', this.onDetectedObjectEdit);\n            this.on(root, 'detectedObjectDoneEditing', this.onDetectedObjectDoneEditing);\n            this.updateDetectedObjects();\n        });\n\n        this.onCloseDropdown = function(event) {\n            var self = this;\n            _.defer(function() {\n                self.trigger('detectedObjectDoneEditing');\n            })\n        };\n\n        this.onDetectedObjectDoneEditing = function(event, data) {\n            this.$node.find('.underneath').teardownAllComponents().remove();\n        };\n\n        this.onDetectedObjectEdit = function(event, data) {\n            if (data) {\n                this.showForm(data, this.node);\n            } else {\n                this.$node.find('.underneath').teardownAllComponents();\n            }\n        };\n\n        this.onUpdateModel = function(event, data) {\n            this.model = data.model;\n            this.updateDetectedObjects();\n        };\n\n        this.onDetectedObjectClicked = function(event) {\n            if (Privileges.missingEDIT) {\n                return;\n            }\n\n            event.preventDefault();\n\n            var self = this,\n                $target = $(event.target),\n                propertyKey = $target.closest('.label-info').attr('data-property-key'),\n                property = _.first(F.vertex.props(this.model, 'http://openlumify.org#detectedObject', propertyKey));\n\n            if (!property) {\n                throw new Error('Unable to find detected object matching key:' + propertyKey);\n            }\n            this.$node.find('.focused').removeClass('focused');\n            $target.closest('.detected-object').parent().addClass('focused');\n\n            require(['util/actionbar/actionbar'], function(ActionBar) {\n                ActionBar.teardownAll();\n                self.$node.off('.actionbar')\n\n                if ($target.hasClass('resolved')) {\n                    const unresolve = Privileges.canEDIT &&\n                        self.attr.model.sandboxStatus !== 'PUBLIC';\n\n                    ActionBar.attachTo($target, {\n                        alignTo: 'node',\n                        actions: $.extend({\n                            Open: 'open.actionbar'\n                        }, unresolve ? {\n                            Unresolve: 'unresolve.actionbar'\n                        } : {})\n                    });\n\n                    self.on('open.actionbar', function() {\n                        self.trigger('selectObjects', { vertexIds: [property.value.resolvedVertexId] });\n                    });\n                    self.on('unresolve.actionbar', function() {\n                        self.dataRequest('vertex', 'store', { vertexIds: property.value.resolvedVertexId })\n                            .done(function(vertex) {\n                                self.showForm({\n                                    property: property,\n                                    value: property.value,\n                                    title: F.vertex.title(vertex),\n                                    unresolve: true\n                                },\n                                    //$.extend({}, property.value, {\n                                        //title: F.vertex.title(vertex),\n                                        //propertyKey: property.key\n                                    //}),\n                                    $target\n                                );\n                            });\n                    });\n\n                } else if (Privileges.canEDIT) {\n\n                    ActionBar.attachTo($target, {\n                        alignTo: 'node',\n                        actions: {\n                            Resolve: 'resolve.actionbar'\n                        }\n                    });\n\n                    self.on('resolve.actionbar', function(event) {\n                        self.trigger('detectedObjectEdit', {\n                            property: property,\n                            value: property.value\n                        });\n                    })\n                }\n            });\n        };\n\n        this.showForm = function(data, $target) {\n            var self = this;\n\n            require(['../dropdowns/termForm/termForm'], function(TermForm) {\n                const $form = self.$node.show().find('.underneath');\n                const termForm = $form.lookupComponent(TermForm);\n\n                if (!termForm || (data.property && data.property.key) !== termForm.attr.dataInfo.originalPropertyKey) {\n                    $form.teardownComponent(TermForm);\n\n                    const root = $('<div class=\"underneath\">');\n\n                    if (data.property) {\n                        root.appendTo(self.node);\n                    } else {\n                        root.prependTo(self.node);\n                    }\n\n                    TermForm.attachTo(root, {\n                        artifactData: self.model,\n                        dataInfo: _.extend({}, data.property, {\n                            originalPropertyKey: data.property && data.property.key,\n                            title: data.title\n                        }, data.value),\n                        restrictConcept: data.value.concept,\n                        existing: Boolean(data.property && data.property.resolvedVertexId),\n                        detectedObject: true,\n                        unresolve: data.unresolve || false\n                    });\n                }\n            })\n        };\n\n        this.updateDetectedObjects = function() {\n            var self = this,\n                vertex = this.model,\n                wasResolved = {},\n                needsLoading = [],\n                detectedObjects = vertex && F.vertex.props(vertex, 'detectedObject') || [],\n                container = this.$node.toggle(detectedObjects.length > 0);\n\n            detectedObjects.forEach(function(detectedObject) {\n                var key = detectedObject.value.originalPropertyKey,\n                    resolvedVertexId = detectedObject.value.resolvedVertexId;\n\n                if (key) {\n                    wasResolved[key] = true;\n                }\n\n                if (resolvedVertexId) {\n                    needsLoading.push(resolvedVertexId);\n                }\n            });\n\n            Promise.all([\n                this.dataRequest('vertex', 'store', { vertexIds: needsLoading }),\n                this.dataRequest('ontology', 'concepts')\n            ]).done(function(results) {\n                var vertices = results[0],\n                    concepts = results[1],\n                    verticesById = _.indexBy(vertices, 'id'),\n                    roundCoordinate = function(percentFloat) {\n                        return PERCENT_CLOSE_FOR_ROUNDING *\n                            (Math.round(percentFloat * 100 / PERCENT_CLOSE_FOR_ROUNDING));\n                    },\n                    detectedObjectKey = _.property('key');\n\n                d3.select(container.get(0))\n                    .selectAll('.detected-object-tag')\n                    .data(detectedObjects, detectedObjectKey)\n                    .call(function() {\n                        this.enter()\n                            .append('div')\n                            .attr('class', 'detected-object-tag')\n                            .attr('data-vertex-id', function(detectedObject) {\n                                return detectedObject.value.resolvedVertexId;\n                            })\n                            .append('div');\n\n                        this\n                            .sort(function(a, b) {\n                                var sort =\n                                    roundCoordinate((a.value.y2 - a.value.y1) / 2 + a.value.y1) -\n                                    roundCoordinate((b.value.y2 - b.value.y1) / 2 + b.value.y1)\n\n                                if (sort === 0) {\n                                    sort =\n                                        roundCoordinate((a.value.x2 - a.value.x1) / 2 + a.value.x1) -\n                                        roundCoordinate((b.value.x2 - b.value.x1) / 2 + b.value.x1)\n                                }\n\n                                return sort;\n                            })\n                            .style('display', function(detectedObject) {\n                                if (wasResolved[detectedObject.key]) {\n                                    return 'none';\n                                }\n                            })\n                            .select('div')\n                                .attr('data-vertex-id', function(detectedObject) {\n                                    return detectedObject.value.resolvedVertexId;\n                                })\n                                .attr('data-property-key', function(detectedObject) {\n                                    return detectedObject.key;\n                                })\n                                .attr('class', function(detectedObject) {\n                                    var classes = 'label label-info detected-object opens-dropdown';\n                                    if (detectedObject.value.edgeId) {\n                                        return classes + ' resolved vertex'\n                                    }\n                                    return classes;\n                                })\n                                .text(function(detectedObject) {\n                                    var resolvedVertexId = detectedObject.value.resolvedVertexId,\n                                        resolvedVertex = resolvedVertexId && verticesById[resolvedVertexId];\n                                    if (resolvedVertex) {\n                                        return F.vertex.title(resolvedVertex);\n                                    } else if (resolvedVertexId) {\n                                        return i18n('detail.detected_object.vertex_not_found');\n                                    }\n                                    return concepts.byId[detectedObject.value.concept].displayName;\n                                })\n                    })\n                    .exit().remove();\n\n                    self.$node\n                        .off('.detectedObject')\n                        .on('mouseenter.detectedObject mouseleave.detectedObject',\n                            self.attr.detectedObjectTagSelector,\n                            self.onDetectedObjectHover.bind(self)\n                        );\n\n                    if (vertices.length) {\n                        self.updateDraggables();\n                    }\n                });\n        };\n\n        this.onDetectedObjectHover = function(event) {\n            var $target = $(event.target),\n                tag = $target.closest('.detected-object-tag'),\n                badge = tag.find('.label-info'),\n                propertyKey = badge.attr('data-property-key');\n\n            this.trigger(event.type === 'mouseenter' ? 'detectedObjectEnter' : 'detectedObjectLeave',\n                F.vertex.props(this.model, 'http://openlumify.org#detectedObject', propertyKey)\n            );\n        };\n\n        this.updateDraggables = function() {\n            var self = this,\n                objects = this.$node.children();\n\n            objects.each(function(i, object) {\n                $(object)\n                    .attr('draggable', true)\n                    .off('dragstart')\n                    .on('dragstart', function(event) {\n                        const vertexId = $(event.target).data('vertexId');\n                        const elements = { vertexIds: [vertexId] };\n                        const dt = event.originalEvent.dataTransfer;\n\n                        dnd.setDataTransferWithElements(dt, elements);\n                    });\n            })\n        };\n    }\n});\n"]}