{"version":3,"sources":["../../../../js/detail/dropdowns/termForm/termForm.js"],"names":["define","defineComponent","withDropdown","dropdownTemplate","alertTemplate","F","ConceptSelector","VertexSelector","withDataRequest","TermForm","defaultAttrs","entityConceptMenuSelector","actionButtonSelector","buttonDivSelector","visibilitySelector","conceptContainerSelector","vertexContainerSelector","helpSelector","addNewPropertiesSelector","after","promoted","length","demoteSpanToTextVertex","node","parentNode","normalize","deferredConcepts","$","Deferred","setupContent","registerEvents","showTypeahead","options","unresolve","select","trigger","reset","currentGraphVertexId","show","hide","onVertexSelected","event","data","vertex","sign","title","graphVertexChanged","id","newGraphVertexId","item","initial","self","info","_","isObject","properties","attr","mentionNode","enable","conceptType","isArray","findWhere","name","concept","value","restrictConcept","selectedConceptId","done","conceptId","checkValid","text","i18n","$node","find","prop","coords","teardownAllComponents","require","Visibility","attachTo","readonly","Justification","onButtonClicked","detectedObject","termModification","detectedObjectModification","$mentionNode","newObjectSign","trim","mentionStart","mentionEnd","existing","dataInfo","start","end","selectedStart","selectedEnd","parameters","propertyKey","propertyName","artifactId","visibilitySource","resolvedVertexId","edgeId","defer","buttonLoading","bind","focus","objectSign","snippet","sourceInfo","vertexId","textPropertyKey","textPropertyName","startOffset","endOffset","justification","justificationText","dataRequest","then","highlightTerm","document","teardown","catch","requestFailure","termMentionId","request","message","error","markFieldErrors","clearLoading","newSign","originalPropertyKey","graphVertexId","artifactData","x1","parseFloat","y1","x2","y2","unresolveDetectedObject","multiValueKey","key","resolveDetectedObject","onConceptSelected","onVisibilityChange","onJustificationChange","button","visibilityValid","valid","disabled","toggleClass","existingEntity","mentionVertex","addClass","hasClass","selection","promoteSelectionToSpan","resolvedToVertexId","html","classNames","buttonText","toggle","filterResultsToTitleField","defaultText","allowNew","query","startSign","conceptForConceptType","allConcepts","on","onEntityConceptSelected","loadConcepts","resolve","concepts","vertexInfo","filter","byTitle","c","userVisible","updatingEntity","removeClass","cssClasses","join","isTranscript","closest","range","el","tempTextNode","transcriptIndex","span","createElement","className","newRange","createRange","setStart","startContainer","setEnd","endContainer","r","cloneRange","dd","selectNodeContents","get","$text","l","toString","number","compactOffsetValues","test","previous","previousSibling","nodeType","textContent","createTextNode","insertBefore","next","nextSibling","appendChild","surroundContents","childNodes","remove"],"mappings":"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","file":"termForm.js","sourcesContent":["define([\n    'flight/lib/component',\n    'util/withDropdown',\n    './termForm.hbs',\n    'tpl!util/alert',\n    'util/vertex/formatters',\n    'util/ontology/conceptSelect',\n    'util/vertex/vertexSelect',\n    'util/withDataRequest'\n], function(\n    defineComponent,\n    withDropdown,\n    dropdownTemplate,\n    alertTemplate,\n    F,\n    ConceptSelector,\n    VertexSelector,\n    withDataRequest) {\n    'use strict';\n\n    return defineComponent(TermForm, withDropdown, withDataRequest);\n\n    function TermForm() {\n\n        this.defaultAttrs({\n            entityConceptMenuSelector: '.underneath .dropdown-menu a',\n            actionButtonSelector: '.btn.btn-small.btn-primary',\n            buttonDivSelector: '.buttons',\n            visibilitySelector: '.visibility',\n            conceptContainerSelector: '.concept-container',\n            vertexContainerSelector: '.vertex-container',\n            helpSelector: '.help',\n            addNewPropertiesSelector: '.none'\n        });\n\n        this.after('teardown', function() {\n            if (this.promoted && this.promoted.length) {\n                this.demoteSpanToTextVertex(this.promoted);\n            }\n\n            // Remove extra textNodes\n            if (this.node.parentNode) {\n                this.node.parentNode.normalize();\n            }\n        });\n\n        this.after('initialize', function() {\n            this.deferredConcepts = $.Deferred();\n            this.setupContent();\n            this.registerEvents();\n        });\n\n        this.showTypeahead = function(options) {\n            if (!this.unresolve) {\n                this.select('vertexContainerSelector').trigger('showTypeahead', options);\n            }\n        };\n\n        this.reset = function() {\n            this.currentGraphVertexId = null;\n            this.select('helpSelector').show();\n            this.select('visibilitySelector').hide();\n            this.select('conceptContainerSelector').hide();\n            this.select('actionButtonSelector').hide();\n        };\n\n        this.onVertexSelected = function(event, data) {\n            if (data && data.vertex) {\n                this.sign = F.vertex.title(data.vertex);\n                this.graphVertexChanged(data.vertex.id, data.vertex);\n            } else {\n                this.sign = data.sign;\n                this.graphVertexChanged(null, null);\n            }\n        };\n\n        this.graphVertexChanged = function(newGraphVertexId, item, initial) {\n            var self = this;\n\n            this.currentGraphVertexId = newGraphVertexId;\n            if (!initial || newGraphVertexId) {\n                var info = _.isObject(item) ? item.properties || item : $(this.attr.mentionNode).data('info');\n\n                this.trigger(this.select('conceptContainerSelector'), 'enableConcept', {\n                    enable: !newGraphVertexId\n                });\n\n                var conceptType = _.isArray(info) ?\n                    _.findWhere(info, { name: 'http://openlumify.org#conceptType' }) :\n                    (info && (info['http://openlumify.org#conceptType'] || info.concept));\n                conceptType = conceptType && conceptType.value || conceptType || '';\n\n                if (conceptType === '' && self.attr.restrictConcept) {\n                    conceptType = self.attr.restrictConcept;\n                }\n                this.selectedConceptId = conceptType;\n\n                this.deferredConcepts.done(function() {\n                    self.trigger(self.select('conceptContainerSelector').show(), 'selectConceptId', {\n                        conceptId: conceptType\n                    });\n                    self.checkValid()\n                });\n\n                if (this.unresolve) {\n                    this.select('actionButtonSelector')\n                        .text(i18n('detail.resolve.form.button.unresolve'))\n                        .show();\n                    this.$node.find('input,select').prop('disabled', true);\n                } else {\n                    this.select('actionButtonSelector')\n                        .text(newGraphVertexId && !initial && !this.attr.coords ?\n                              i18n('detail.resolve.form.button.resolve.existing') :\n                              i18n('detail.resolve.form.button.resolve.new'))\n                        .show();\n                }\n                this.select('helpSelector').hide();\n                this.select('visibilitySelector').show();\n\n                this.$node.find('.visibility').teardownAllComponents();\n\n                require(['util/visibility/edit'], function(Visibility) {\n                    Visibility.attachTo(self.$node.find('.visibility'), {\n                        value: '',\n                        readonly: self.unresolve\n                    });\n                });\n\n                if (!this.unresolve) {\n                    this.$node.find('.justification').teardownAllComponents();\n                    require(['detail/dropdowns/propertyForm/justification'], function(Justification) {\n                        Justification.attachTo(self.$node.find('.justification'));\n                    });\n                }\n            } else if (this.attr.restrictConcept) {\n                this.deferredConcepts.done(function() {\n                    self.trigger(self.select('conceptContainerSelector'), 'selectConceptId', {\n                        conceptId: self.attr.restrictConcept\n                    })\n                });\n            }\n        };\n\n        this.onButtonClicked = function(event) {\n            if (!this.attr.detectedObject) {\n                this.termModification(event);\n            } else {\n                this.detectedObjectModification(event);\n            }\n        };\n\n        this.termModification = function(event) {\n            var self = this,\n                $mentionNode = $(this.attr.mentionNode),\n                newObjectSign = $.trim(this.sign),\n                mentionStart,\n                mentionEnd;\n\n            if (this.attr.existing) {\n                var dataInfo = $mentionNode.data('info');\n                mentionStart = dataInfo.start;\n                mentionEnd = dataInfo.end;\n            } else {\n                mentionStart = this.selectedStart;\n                mentionEnd = this.selectedEnd;\n            }\n            var parameters = {\n                sign: newObjectSign,\n                propertyKey: this.attr.propertyKey,\n                propertyName: this.attr.propertyName,\n                conceptId: this.selectedConceptId,\n                mentionStart: mentionStart,\n                mentionEnd: mentionEnd,\n                artifactId: this.attr.artifactId,\n                visibilitySource: this.visibilitySource ? this.visibilitySource.value : ''\n            };\n\n            if (this.currentGraphVertexId) {\n                parameters.resolvedVertexId = this.currentGraphVertexId;\n                parameters.edgeId = $mentionNode.data('info') ? $mentionNode.data('info').edgeId : null;\n            }\n\n            _.defer(this.buttonLoading.bind(this));\n\n            if (!parameters.conceptId || parameters.conceptId.length === 0) {\n                this.select('conceptContainerSelector').find('select').focus();\n                return;\n            }\n\n            if (newObjectSign.length) {\n                parameters.objectSign = newObjectSign;\n                $mentionNode.attr('title', newObjectSign);\n            }\n\n            if (!this.unresolve) {\n                if (self.attr.snippet) {\n                    parameters.sourceInfo = {\n                        vertexId: parameters.artifactId,\n                        textPropertyKey: parameters.propertyKey,\n                        textPropertyName: parameters.propertyName,\n                        startOffset: parameters.mentionStart,\n                        endOffset: parameters.mentionEnd,\n                        snippet: self.attr.snippet\n                    };\n                }\n\n                if (this.justification && this.justification.justificationText) {\n                    parameters.justificationText = this.justification.justificationText;\n                }\n\n                this.dataRequest('vertex', 'resolveTerm', parameters)\n                    .then(function(data) {\n                        self.highlightTerm(data);\n                        self.trigger('termCreated', data);\n\n                        self.trigger(document, 'loadEdges');\n                        self.trigger('closeDropdown');\n\n                        _.defer(self.teardown.bind(self));\n                    })\n                    .catch(this.requestFailure.bind(this))\n            } else {\n                parameters.termMentionId = this.termMentionId;\n                this.dataRequest('vertex', 'unresolveTerm', parameters)\n                    .then(function(data) {\n                        self.highlightTerm(data);\n\n                        self.trigger(document, 'loadEdges');\n                        self.trigger('closeDropdown');\n\n                        _.defer(self.teardown.bind(self));\n                    })\n                    .catch(this.requestFailure.bind(this))\n            }\n        };\n\n        this.requestFailure = function(request, message, error) {\n            this.markFieldErrors(error);\n            _.defer(this.clearLoading.bind(this));\n        };\n\n        this.detectedObjectModification = function(event) {\n            var self = this,\n                newSign = $.trim(this.sign),\n                parameters = {\n                    title: newSign,\n                    conceptId: this.selectedConceptId,\n                    originalPropertyKey: this.attr.dataInfo.originalPropertyKey,\n                    graphVertexId: this.attr.dataInfo.resolvedVertexId ?\n                        this.attr.dataInfo.resolvedVertexId :\n                        this.currentGraphVertexId,\n                    artifactId: this.attr.artifactData.id,\n                    x1: parseFloat(this.attr.dataInfo.x1),\n                    y1: parseFloat(this.attr.dataInfo.y1),\n                    x2: parseFloat(this.attr.dataInfo.x2),\n                    y2: parseFloat(this.attr.dataInfo.y2),\n                    visibilitySource: this.visibilitySource ? this.visibilitySource.value : ''\n                };\n\n            if (!parameters.graphVertexId) {\n                delete parameters.graphVertexId;\n            }\n\n            if (this.justification && this.justification.justificationText) {\n                parameters.justificationText = this.justification.justificationText;\n            }\n\n            _.defer(this.buttonLoading.bind(this));\n            if (this.unresolve) {\n                self.unresolveDetectedObject({\n                    vertexId: this.attr.artifactData.id,\n                    multiValueKey: this.attr.dataInfo.key || this.attr.dataInfo.propertyKey\n                });\n            } else {\n                self.resolveDetectedObject(parameters);\n            }\n        };\n\n        this.resolveDetectedObject = function(parameters) {\n            var self = this;\n            this.dataRequest('vertex', 'resolveDetectedObject', parameters)\n                .then(function(data) {\n                    self.trigger('termCreated', data);\n                    self.trigger(document, 'loadEdges');\n                    self.trigger('closeDropdown');\n                    self.teardown.bind(self);\n                })\n                .catch(this.requestFailure.bind(this))\n        };\n\n        this.unresolveDetectedObject = function(parameters) {\n            var self = this;\n            this.dataRequest('vertex', 'unresolveDetectedObject', parameters)\n                .then(function(data) {\n                    self.trigger(document, 'loadEdges');\n                    self.trigger('closeDropdown');\n                    self.teardown.bind(self);\n                })\n                .catch(this.requestFailure.bind(this))\n        };\n\n        this.onConceptSelected = function(event, data) {\n            this.selectedConceptId = data && data.concept && data.concept.id || '';\n            if (this.selectedConceptId) {\n                this.select('vertexContainerSelector').trigger('setConcept', { conceptId: this.selectedConceptId });\n            } else {\n                this.select('vertexContainerSelector').trigger('setConcept');\n            }\n            this.checkValid();\n        };\n\n        this.onVisibilityChange = function(event, data) {\n            this.visibilitySource = data;\n            this.checkValid();\n        };\n\n        this.onJustificationChange = function(event, data) {\n            this.justification = data;\n            this.checkValid();\n        };\n\n        this.checkValid = function() {\n            const button = this.select('actionButtonSelector');\n            const visibilityValid = this.visibilitySource && this.visibilitySource.valid;\n            let disabled = false;\n\n            if (!this.unresolve) {\n                this.select('visibilitySelector').find('input').toggleClass('invalid', !visibilityValid);\n\n                disabled = !(\n                    this.justification\n                    && this.justification.valid\n                    && this.selectedConceptId\n                    && visibilityValid\n                    && (this.attr.existing || this.sign.trim())\n                );\n            }\n\n            button.prop('disabled', disabled);\n        };\n\n        this.setupContent = function() {\n\n            var self = this,\n                vertex = this.$node,\n                existingEntity,\n                objectSign = '',\n                data, graphVertexId, title;\n\n            if (!this.attr.detectedObject) {\n                var mentionVertex = $(this.attr.mentionNode);\n                data = mentionVertex.data('info');\n                existingEntity = this.attr.existing ? mentionVertex.addClass('focused').hasClass('resolved') : false;\n                title = $.trim(data && data.title || '');\n\n                if (this.attr.selection && !existingEntity) {\n                    this.trigger(document, 'ignoreSelectionChanges.detail');\n                    this.promoted = this.promoteSelectionToSpan();\n\n                    _.defer(function() {\n                        self.trigger(document, 'resumeSelectionChanges.detail');\n                    });\n                }\n\n                if (existingEntity && mentionVertex.hasClass('resolved')) {\n                    objectSign = title;\n                    this.unresolve = this.attr.unresolve;\n                    graphVertexId = this.unresolve && data && (data.resolvedToVertexId || data.resolvedVertexId);\n                    this.termMentionId = data && data.id;\n                } else {\n                    objectSign = this.attr.sign || mentionVertex.text();\n                }\n            } else {\n                data = this.attr.dataInfo;\n                objectSign = data && data.title;\n                existingEntity = this.attr.existing;\n                this.unresolve = this.attr.unresolve;\n                graphVertexId = this.unresolve && data && (data.resolvedToVertexId || data.resolvedVertexId);\n            }\n\n            vertex.html(dropdownTemplate({\n                classNames: `form${this.unresolve ? ' unresolve' : ''}`,\n                sign: $.trim(objectSign),\n                graphVertexId: graphVertexId || '',\n                objectSign: $.trim(objectSign) || '',\n                buttonText: existingEntity ?\n                    i18n('detail.resolve.form.button.resolve.existing') :\n                    i18n('detail.resolve.form.button.resolve.new'),\n                unresolve: this.unresolve\n            }));\n\n            ConceptSelector.attachTo(this.select('conceptContainerSelector').toggle(!!graphVertexId), {\n                restrictConcept: this.attr.restrictConcept\n            });\n\n            VertexSelector.attachTo(this.select('vertexContainerSelector'), {\n                value: objectSign || '',\n                filterResultsToTitleField: true,\n                defaultText: i18n('detail.resolve.form.entity_search.placeholder'),\n                allowNew: true\n            });\n\n            this.graphVertexChanged(graphVertexId, data, true);\n\n            if (!this.unresolve && objectSign) {\n                this.select('vertexContainerSelector').trigger('disableAndSearch', {\n                    query: objectSign\n                })\n            }\n\n            this.sign = objectSign;\n            this.startSign = objectSign;\n        };\n\n        this.conceptForConceptType = function(conceptType, allConcepts) {\n            return _.findWhere(allConcepts, { id: conceptType });\n        };\n\n        this.registerEvents = function() {\n\n            this.on('visibilitychange', this.onVisibilityChange);\n            this.on('justificationchange', this.onJustificationChange);\n\n            this.on('conceptSelected', this.onConceptSelected);\n            this.on('resetTypeahead', this.reset);\n            this.on('vertexSelected', this.onVertexSelected);\n\n            this.on('click', {\n                entityConceptMenuSelector: this.onEntityConceptSelected,\n                actionButtonSelector: this.onButtonClicked,\n                helpSelector: function() {\n                    this.showTypeahead({\n                        focus: true\n                    });\n                }\n            });\n\n            this.on('opened', function() {\n                var self = this;\n\n                this.loadConcepts()\n                    .then(function() {\n                        self.deferredConcepts.resolve(self.allConcepts);\n                    })\n            });\n        };\n\n        this.loadConcepts = function() {\n            var self = this;\n            self.allConcepts = [];\n            return this.dataRequest('ontology', 'concepts')\n                .then(function(concepts) {\n                    var vertexInfo;\n\n                    if (self.attr.detectedObject) {\n                        vertexInfo = self.attr.dataInfo;\n                    } else {\n                        var mentionVertex = $(self.attr.mentionNode);\n                        vertexInfo = mentionVertex.data('info');\n                    }\n\n                    self.allConcepts = _.filter(concepts.byTitle, function(c) {\n                        return c.userVisible !== false;\n                    });\n\n                    self.selectedConceptId = vertexInfo && (\n                        vertexInfo['http://openlumify.org#conceptType'] ||\n                        (\n                            vertexInfo.properties &&\n                            vertexInfo.properties['http://openlumify.org#conceptType'].value\n                        )\n                    ) || '';\n\n                    self.trigger(self.select('conceptContainerSelector'), 'selectConceptId', {\n                        conceptId: self.selectedConceptId\n                    });\n\n                    if (!self.selectedConceptId) {\n                        self.select('actionButtonSelector').prop('disabled', true);\n                    }\n                });\n        };\n\n        this.highlightTerm = function(data) {\n            var mentionVertex = $(this.attr.mentionNode),\n                updatingEntity = this.attr.existing;\n\n            if (updatingEntity) {\n                mentionVertex.removeClass();\n                if (data.cssClasses) {\n                    mentionVertex.addClass(data.cssClasses.join(' '));\n                }\n                mentionVertex.data('info', data.info).removeClass('focused');\n\n            } else if (this.promoted) {\n                this.promoted.data('info', data.info)\n                    .addClass((data.cssClasses && data.cssClasses.join(' ')) || '')\n                    .removeClass('focused');\n                this.promoted = null;\n            }\n        };\n\n        this.promoteSelectionToSpan = function() {\n            var isTranscript = this.$node.closest('.av-times').length,\n                range = this.attr.selection.range,\n                el,\n                tempTextNode,\n                transcriptIndex = 0,\n                span = document.createElement('span');\n\n            span.className = 'vertex focused';\n\n            var newRange = document.createRange();\n            newRange.setStart(range.startContainer, range.startOffset);\n            newRange.setEnd(range.endContainer, range.endOffset);\n\n            var r = range.cloneRange();\n\n            if (isTranscript) {\n                var dd = this.$node.closest('dd');\n                r.selectNodeContents(dd.get(0));\n                transcriptIndex = dd.data('index');\n            } else {\n                var $text = this.$node.closest('.text');\n                if ($text.length) {\n                    r.selectNodeContents($text.get(0));\n                }\n            }\n            r.setEnd(range.startContainer, range.startOffset);\n            var l = r.toString().length;\n\n            this.selectedStart = l;\n            this.selectedEnd = l + range.toString().length;\n\n            if (isTranscript) {\n                this.selectedStart = F.number.compactOffsetValues(transcriptIndex, this.selectedStart);\n                this.selectedEnd = F.number.compactOffsetValues(transcriptIndex, this.selectedEnd);\n            }\n\n            // Special case where the start/end is inside an inner span\n            // (surroundsContents will fail so expand the selection\n            if (/vertex/.test(range.startContainer.parentNode.className)) {\n                el = range.startContainer.parentNode;\n                var previous = el.previousSibling;\n\n                if (previous && previous.nodeType === 3) {\n                    newRange.setStart(previous, previous.textContent.length);\n                } else {\n                    tempTextNode = document.createTextNode('');\n                    el.parentNode.insertBefore(tempTextNode, el);\n                    newRange.setStart(tempTextNode, 0);\n                }\n            }\n            if (/vertex/.test(range.endContainer.parentNode.className)) {\n                el = range.endContainer.parentNode;\n                var next = el.nextSibling;\n\n                if (next && next.nodeType === 3) {\n                    newRange.setEnd(next, 0);\n                } else {\n                    tempTextNode = document.createTextNode('');\n                    if (next) {\n                        el.parentNode.insertBefore(tempTextNode, next);\n                    } else {\n                        el.appendChild(tempTextNode);\n                    }\n                    newRange.setEnd(tempTextNode, 0);\n                }\n            }\n            newRange.surroundContents(span);\n\n            return $(span).find('.vertex').addClass('focused').end();\n        };\n\n        this.demoteSpanToTextVertex = function(vertex) {\n\n            while (vertex[0].childNodes.length) {\n                $(vertex[0].childNodes[0]).removeClass('focused');\n                vertex[0].parentNode.insertBefore(vertex[0].childNodes[0], vertex[0]);\n            }\n            vertex.remove();\n        };\n    }\n});\n"]}