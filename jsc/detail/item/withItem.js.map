{"version":3,"sources":["../../../js/detail/item/withItem.js"],"names":["define","withElementScrolling","withCollapsibleSections","F","withDataRequest","Privileges","dnd","require","withItem","call","_","isFunction","dataRequest","attributes","propertiesSelector","relationshipsSelector","commentsSelector","deleteFormSelector","after","self","on","onOpenFullscreen","isArray","attr","model","redirectToPropertiesComponent","onAddNewProperty","onAddNewComment","onDeleteItem","onOpenSourceUrl","onMaskWithOverlay","onCommentOnSelection","onAddImage","onOpenOriginal","onDownloadOriginal","onUpdateModel","makeVertexTitlesDraggable","event","data","target","node","$","closest","length","stopPropagation","properties","select","defer","trigger","type","Error","window","open","vertex","raw","rawSrc","test","$node","find","$comments","is","filter","isEmpty","setAttribute","e","id","dataset","vertexId","elements","vertexIds","edgeIds","dt","originalEvent","dataTransfer","url","vertexUrl","openlumifyData","currentWorkspaceId","setDataTransferWithElements","$container","insertBefore","DeleteForm","appendTo","attachTo","viewing","vertices","isObject","sourceUrl","done","remove","addClass","toggleClass","loading","append","text"],"mappings":"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","file":"withItem.js","sourcesContent":["define([\n    'util/popovers/withElementScrollingPositionUpdates',\n    'util/withCollapsibleSections',\n    'util/vertex/formatters',\n    'util/withDataRequest',\n    'util/privileges',\n    'util/dnd',\n    'require'\n], function(\n    withElementScrolling,\n    withCollapsibleSections,\n    F,\n    withDataRequest,\n    Privileges,\n    dnd,\n    require) {\n    'use strict';\n\n    return withItem;\n\n    function withItem() {\n\n        withElementScrolling.call(this);\n        withCollapsibleSections.call(this);\n        if (!_.isFunction(this.dataRequest)) {\n            withDataRequest.call(this);\n        }\n\n        this.attributes({\n            propertiesSelector: '.org-openlumify-properties',\n            relationshipsSelector: '.org-openlumify-relationships',\n            commentsSelector: '.org-openlumify-comments',\n            deleteFormSelector: '.delete-form'\n        });\n\n        this.after('initialize', function() {\n            var self = this;\n\n            this.on('openFullscreen', this.onOpenFullscreen);\n            if (!_.isArray(this.attr.model)) {\n                this.on('addProperty', this.redirectToPropertiesComponent);\n                this.on('deleteProperty', this.redirectToPropertiesComponent);\n                this.on('addNewProperty', this.onAddNewProperty);\n                this.on('addNewComment', this.onAddNewComment);\n                this.on('deleteItem', this.onDeleteItem);\n                this.on('openSourceUrl', this.onOpenSourceUrl);\n                this.on('maskWithOverlay', this.onMaskWithOverlay);\n                this.on('commentOnSelection', this.onCommentOnSelection);\n                this.on('addImage', this.onAddImage);\n                this.on('openOriginal', this.onOpenOriginal);\n                this.on('downloadOriginal', this.onDownloadOriginal);\n                this.on('updateModel', this.onUpdateModel);\n\n                this.makeVertexTitlesDraggable();\n            }\n        });\n\n        this.onUpdateModel = function(event, data) {\n            if (event.target === this.node) {\n                this.attr.model = data.model;\n            }\n        };\n\n        this.redirectToPropertiesComponent = function(event, data) {\n            if ($(event.target).closest('.comments').length) {\n                return;\n            }\n\n            if ($(event.target).closest(this.attr.propertiesSelector).length === 0) {\n                event.stopPropagation();\n\n                var properties = this.select('propertiesSelector');\n                if (properties.length) {\n                    _.defer(function() {\n                        properties.trigger(event.type, data);\n                    })\n                } else {\n                    throw new Error('Unable to redirect properties request', event.type, data);\n                }\n            }\n        };\n\n        this.onOpenOriginal = function(event) {\n            window.open(F.vertex.raw(this.attr.model));\n        };\n\n        this.onDownloadOriginal = function(event) {\n            var rawSrc = F.vertex.raw(this.attr.model);\n            window.open(rawSrc + (\n                /\\?/.test(rawSrc) ? '&' : '?'\n            ) + 'download=true');\n        };\n\n        this.onAddImage = function(event, data) {\n            this.$node.find('.entity-glyphicon').trigger('setImage', data);\n        };\n\n        this.onCommentOnSelection = function(event, data) {\n            var $comments = this.select('commentsSelector');\n\n            if (!$(event.target).is($comments)) {\n                $comments.trigger(event.type, data);\n            }\n        };\n\n        this.makeVertexTitlesDraggable = function() {\n            const model = this.attr.model;\n            this.$node.find('.org-openlumify-layout-header .vertex-draggable')\n                .filter(function() {\n                    if (!_.isEmpty($(this).attr('data-vertex-id'))) {\n                        this.setAttribute('draggable', true)\n                        return true\n                    }\n                    return false\n                })\n                .on('dragstart', function(e) {\n                    const id = e.target.dataset.vertexId;\n                    const elements = { vertexIds: [id], edgeIds: [] };\n                    const dt = e.originalEvent.dataTransfer;\n\n                    if (model.id === id) {\n                        const url = F.vertexUrl.url([model], openlumifyData.currentWorkspaceId);\n                        dnd.setDataTransferWithElements(dt, { elements: [model] })\n                    } else {\n                        dnd.setDataTransferWithElements(dt, elements);\n                    }\n                })\n        };\n\n        this.onAddNewProperty = function(event) {\n            this.trigger(this.select('propertiesSelector'), 'editProperty');\n        };\n\n        this.onAddNewComment = function(event) {\n            this.trigger(this.select('commentsSelector'), 'editComment');\n        };\n\n        this.onDeleteItem = function(event) {\n            var self = this,\n                $container = this.select('deleteFormSelector');\n\n            if ($container.length === 0) {\n                $container = $('<div class=\"delete-form\"></div>').insertBefore(\n                    this.select('propertiesSelector')\n                );\n            }\n\n            require(['../dropdowns/deleteForm/deleteForm'], function(DeleteForm) {\n                var node = $('<div class=\"underneath\"></div>').appendTo($container);\n                DeleteForm.attachTo(node, {\n                    data: self.attr.model\n                });\n            });\n        };\n\n        this.onOpenFullscreen = function(event, data) {\n            event.stopPropagation();\n\n            var viewing = this.attr.model,\n                vertices = data && data.vertices ?\n                    data.vertices :\n                    _.isObject(viewing) && viewing.vertices ?\n                    viewing.vertices :\n                    viewing,\n                url = F.vertexUrl.url(\n                    _.isArray(vertices) ? vertices : [vertices],\n                    openlumifyData.currentWorkspaceId\n                );\n            window.open(url);\n        };\n\n        this.onOpenSourceUrl = function(event, data) {\n            window.open(data.sourceUrl);\n        };\n\n        this.onMaskWithOverlay = function(event, data) {\n            event.stopPropagation();\n            if (data.done) {\n                this.$node.find('.detail-overlay').remove();\n                this.trigger('selectObjects');\n            } else {\n                $('<div>')\n                    .addClass('detail-overlay')\n                    .toggleClass('detail-overlay-loading', data.loading)\n                    .append($('<h1>').text(data.text))\n                    .appendTo(this.$node);\n            }\n        };\n\n    }\n});\n"]}