{"version":3,"sources":["../../../js/detail/properties/properties.js"],"names":["define","defineComponent","PropertyForm","F","Privileges","withDataRequest","withPropertyInfo","d3","component","Properties","HIDE_PROPERTIES","VISIBILITY_NAME","SANDBOX_STATUS_NAME","NO_GROUP","GROUP","NAME","VALUE","HIDDEN_COLLAPSE","alreadyWarnedAboutMissingOntology","truncatedValueCache","getOrUpdateValue","element","propName","propKey","expanded","Error","cacheKey","id","value","elementChanged","undefined","full","vertex","prop","truncated","string","truncate","toggleable","trim","replace","isVisibility","property","name","isSandboxStatus","isJustification","defaultAttrs","propertiesInfoSelector","update","properties","self","displayProperties","transformPropertiesForUpdate","expandedSections","openlumifyData","currentUser","uiPreferences","JSON","parse","reload","bind","tableRoot","selectAll","data","call","_","partial","createPropertyGroups","ontologyProperties","showMoreExpanded","parseInt","config","model","isEdge","dependentPropertyIris","compoundPropertiesByNameToKeys","chain","filter","indexOf","streamingPropertyValue","compoundProperty","propertyIriToCompoundProperty","compoundKey","title","keys","key","ontologyProperty","byTitle","userVisible","tap","visibility","find","push","sandboxStatus","displayName","i18n","hideInfo","hideVisibility","each","compoundInfo","matching","props","first","values","metadata","sortBy","isString","toLowerCase","propertyGroup","Number","MAX_SAFE_INTEGER","sortPriority","toString","padStart","toLocaleLowerCase","groupBy","pairs","pair","after","attr","node","root","select","classList","add","append","on","onTableClick","ontologyLoaded","Promise","all","dataRequest","then","results","ontology","shift","conceptProperties","ontologyRelationships","relationships","list","forEach","p","contains","length","iri","uniq","onAddProperty","onDeleteProperty","onEditProperty","event","done","positionPopovers","throttle","trigger","scrollParent","$node","document","vertexId","closePropertyForm","catch","error","requestFailure","service","visibilitySource","isStreamingPropertyVisibilityUpdate","isUndefined","$","teardownComponent","target","evt","propertyRow","closest","popover","appendTo","insertAfter","prependTo","teardownAll","attachTo","updateJustification","justification","require","JustificationViewer","attrs","updateVisibility","VisibilityDisplay","source","saveSectionTogglePreference","sectionEl","previouslyExpanded","shouldSave","inList","without","prefValue","stringify","$target","$header","$tbody","processed","is","toggleClass","hasClass","isShowing","datum","get","showPropertyInfo","stopPropagation","preventDefault","maxItemsBeforeHidden","exit","remove","enter","insert","order","d","groupIndex","j","cls","totalPropertyCountsByName","map","hidden","slice","splice","isExpanded","flatten","propertyCount","valueCount","reduce","sum","createProperties","className","to","currentPropertyIndex","lastPropertyName","i","type","count","spacer","propertyIndex","showToggleLink","Math","max","createPropertyRow","d3element","resetUnless","selector","size","text","childElementCount","previousPropertyName","number","pretty","propertyLabel","valueLabel","join","getDisplayName","console","warn","valueSpan","$valueSpan","visibilitySpan","siblings","$infoButton","dataType","displayType","textContent","isEditable","canEDIT","updateable","deleteable","metadataPropertyNames","split","hasVisibleMetadata","hasMetadata","toggle","Boolean","searchable","teardownAllComponents","justificationData","addClass","e","textNode","contents","ele","nodeType","Node","TEXT_NODE","nodeValue","style"],"mappings":"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","file":"properties.js","sourcesContent":["\ndefine([\n    'flight/lib/component',\n    '../dropdowns/propertyForm/propForm',\n    'util/vertex/formatters',\n    'util/privileges',\n    'util/withDataRequest',\n    'util/popovers/propertyInfo/withPropertyInfo',\n    'd3'\n], function(\n    defineComponent,\n    PropertyForm,\n    F,\n    Privileges,\n    withDataRequest,\n    withPropertyInfo,\n    d3) {\n    'use strict';\n\n    var component = defineComponent(Properties, withDataRequest, withPropertyInfo),\n        HIDE_PROPERTIES = ['http://openlumify.org/comment#entry'],\n        VISIBILITY_NAME = 'http://openlumify.org#visibilityJson',\n        SANDBOX_STATUS_NAME = 'http://openlumify.org#sandboxStatus',\n        NO_GROUP = '${NO_GROUP}',\n\n        // Property td types\n        GROUP = 0, NAME = 1, VALUE = 2, HIDDEN_COLLAPSE = 3,\n\n        alreadyWarnedAboutMissingOntology = {};\n\n    const truncatedValueCache = {};\n    const getOrUpdateValue = (element, propName, propKey, expanded) => {\n        if (!element) throw new Error('Valid element must be provided')\n        if (!propName) throw new Error('Property name must be provided')\n\n        const cacheKey = `${element.id}:${(propKey || '')}:${propName}`;\n        let value = truncatedValueCache[cacheKey];\n        const elementChanged = value && value.element !== element;\n\n        if (value) {\n            if (!elementChanged && (expanded === undefined || value.expanded === expanded)) {\n                return truncatedValueCache[cacheKey]\n            } else {\n                if (elementChanged) {\n                    const full = F.vertex.prop(element, propName, propKey);\n                    const truncated = F.string.truncate(full, 20);\n\n                    value = {\n                        ...value,\n                        full,\n                        truncated,\n                        toggleable: full.trim().replace(/\\s+/g, ' ') !== truncated\n                    }\n                }\n                if (expanded !== undefined) {\n                    value.expanded = expanded;\n                }\n            }\n        } else {\n            const full = F.vertex.prop(element, propName, propKey);\n            const truncated = F.string.truncate(full, 20);\n\n            value = {\n                element,\n                expanded: expanded || false,\n                full,\n                truncated,\n                toggleable: full.trim().replace(/\\s+/g, ' ') !== truncated\n            }\n        }\n\n        truncatedValueCache[cacheKey] = value;\n        return truncatedValueCache[cacheKey]\n    }\n\n    return component;\n\n    function isVisibility(property) {\n        return property.name === VISIBILITY_NAME;\n    }\n\n    function isSandboxStatus(property) {\n        return property.name === SANDBOX_STATUS_NAME;\n    }\n\n    function isJustification(property) {\n        return (\n            property.name === 'http://openlumify.org#justification' ||\n            property.name === '_sourceMetadata'\n        );\n    }\n\n    function Properties() {\n\n        this.defaultAttrs({\n            propertiesInfoSelector: 'button.info'\n        });\n\n        this.update = function(properties) {\n            var self = this,\n                displayProperties = this.transformPropertiesForUpdate(properties),\n                expandedSections = openlumifyData.currentUser.uiPreferences['property-groups-expanded'];\n\n            if (expandedSections) {\n                expandedSections = JSON.parse(expandedSections);\n            } else {\n                expandedSections = [];\n            }\n\n            this.reload = this.update.bind(this, properties);\n\n            this.tableRoot.selectAll('tbody.property-group')\n                .data(displayProperties)\n                .call(\n                    _.partial(\n                        createPropertyGroups,\n                        self.data,\n                        self.ontologyProperties,\n                        self.showMoreExpanded,\n                        parseInt(self.config['properties.multivalue.defaultVisibleCount'], 10),\n                        expandedSections,\n                        self.config\n                    )\n                );\n        };\n\n        this.transformPropertiesForUpdate = function(properties) {\n            var self = this,\n                model = self.data,\n                isEdge = F.vertex.isEdge(model),\n                dependentPropertyIris = this.dependentPropertyIris,\n                compoundPropertiesByNameToKeys = {},\n                displayProperties = _.chain(properties)\n                    .filter(function(property) {\n                        if (isJustification(property)) {\n                            return false;\n                        }\n\n                        if (isVisibility(property)) {\n                            return true;\n                        }\n\n                        if (~HIDE_PROPERTIES.indexOf(property.name)) {\n                            return false;\n                        }\n\n                        if (property.streamingPropertyValue) {\n                            return false;\n                        }\n\n                        // Remove dependent properties from list since they\n                        // rollup into compound properties\n                        if (~dependentPropertyIris.indexOf(property.name)) {\n                            var compoundProperty = self.propertyIriToCompoundProperty[property.name],\n                                compoundKey = compoundProperty.title;\n\n                            if (!compoundPropertiesByNameToKeys[compoundKey]) {\n                                compoundPropertiesByNameToKeys[compoundKey] = {\n                                    property: compoundProperty,\n                                    keys: {}\n                                };\n                            }\n                            compoundPropertiesByNameToKeys[compoundKey].keys[property.key] = true;\n                            return false;\n                        }\n\n                        var ontologyProperty = self.ontologyProperties.byTitle[property.name];\n                        return ontologyProperty && ontologyProperty.userVisible;\n                    })\n                    .tap(function(properties) {\n                        var visibility = _.find(properties, isVisibility);\n                        if (!visibility) {\n                            properties.push({\n                                name: VISIBILITY_NAME,\n                                value: self.data[VISIBILITY_NAME]\n                            });\n                        }\n\n                        var sandboxStatus = F.vertex.sandboxStatus(self.data);\n                        if (sandboxStatus) {\n                            properties.push({\n                                name: SANDBOX_STATUS_NAME,\n                                displayName: i18n('detail.entity.sandboxStatus'),\n                                value: sandboxStatus,\n                                hideInfo: true,\n                                hideVisibility: true\n                            });\n                        }\n\n                        // Add compound properties (multi-value if there\n                        // dependent properties have multiple keys\n                        _.each(compoundPropertiesByNameToKeys, function(compoundInfo, compoundKey) {\n                            _.each(compoundInfo.keys, function(value, key) {\n                                var matching = F.vertex.props(self.data, compoundInfo.property.title, key),\n                                    first = matching && _.first(matching),\n                                    property = {\n                                        compoundProperty: true,\n                                        name: compoundInfo.property.title,\n                                        key: key,\n                                        values: matching || []\n                                    };\n\n                                if (first) {\n                                    property.metadata = first.metadata;\n                                }\n\n                                properties.push(property);\n                            });\n                        });\n                    })\n                    .sortBy(function(property) {\n                        var value = F.vertex.prop(model, property.name, property.key);\n                        if (_.isString(value)) {\n                            return value.toLowerCase();\n                        }\n                        return 0;\n                    })\n                    .sortBy(function(property) {\n                        if (property.metadata && ('http://openlumify.org#confidence' in property.metadata)) {\n                            return property.metadata['http://openlumify.org#confidence'] * -1;\n                        }\n                        return 0;\n                    })\n                    .sortBy(function(property) {\n                        if (isVisibility(property)) {\n                            return '0';\n                        }\n\n                        if (isSandboxStatus(property)) {\n                            return '1';\n                        }\n\n                        if (isEdge && isJustification(property)) {\n                            return '3';\n                        }\n\n                        var ontologyProperty = self.ontologyProperties.byTitle[property.name];\n                        if (ontologyProperty) {\n                            return (ontologyProperty.propertyGroup ? '4' + ontologyProperty.propertyGroup.toLowerCase() : '2') +\n                                (Number.MAX_SAFE_INTEGER - (ontologyProperty.sortPriority || 0)).toString(16).padStart(8, '0') +\n                                (ontologyProperty.displayName ? ontologyProperty.displayName.toLocaleLowerCase() : property.name.toLocaleLowerCase());\n                        }\n                        return '3' + property.name.toLocaleLowerCase();\n                    })\n                    .groupBy('name')\n                    .pairs()\n                    .groupBy(function(pair) {\n                        var ontologyProperty = self.ontologyProperties.byTitle[pair[0]];\n                        if (ontologyProperty && ontologyProperty.propertyGroup) {\n                            return ontologyProperty.propertyGroup;\n                        }\n\n                        return NO_GROUP;\n                    })\n                    .pairs()\n                    .value();\n\n            return displayProperties;\n        };\n\n        this.after('initialize', function() {\n            this.data = this.attr.data;\n\n            var self = this,\n                properties = this.data.properties,\n                node = this.node,\n                root = d3.select(node);\n\n            node.classList.add('org-openlumify-properties');\n\n            this.showMoreExpanded = {};\n            this.tableRoot = root\n                .append('table')\n                .attr('class', 'table')\n                .on('click', onTableClick.bind(this));\n\n            var ontologyLoaded = Promise.all([\n                this.dataRequest('ontology', 'ontology'),\n                this.dataRequest('ontology', 'propertiesByConceptId', F.vertex.prop(self.data, 'conceptType')),\n                this.dataRequest('config', 'properties')\n            ]).then(function(results) {\n                var ontology = results.shift(),\n                    conceptProperties = _.keys(results.shift().byTitle),\n                    config = results.shift(),\n                    ontologyRelationships = ontology.relationships,\n                    ontologyProperties = ontology.properties;\n\n                self.config = config;\n                self.ontologyProperties = ontologyProperties;\n\n                self.dependentPropertyIris = [];\n                self.propertyIriToCompoundProperty = {};\n\n                self.ontologyProperties.list.forEach(function(p) {\n                    if (p.dependentPropertyIris &&\n                        _.contains(conceptProperties || [], p.title) &&\n                        p.dependentPropertyIris.length) {\n                        p.dependentPropertyIris.forEach(function(iri) {\n                            self.propertyIriToCompoundProperty[iri] = p;\n                            self.dependentPropertyIris.push(iri);\n                        })\n                    }\n                });\n                self.dependentPropertyIris = _.uniq(self.dependentPropertyIris);\n\n                self.ontologyRelationships = ontologyRelationships;\n                self.update(properties);\n            });\n\n            this.on('addProperty', this.onAddProperty);\n            this.on('deleteProperty', this.onDeleteProperty);\n            this.on('editProperty', this.onEditProperty);\n            this.on('updateModel', function(event, data) {\n                self.data = data.model;\n                ontologyLoaded.done(function() {\n                    self.update(data.model.properties)\n                })\n            });\n\n            var positionPopovers = _.throttle(function() {\n                    self.trigger('positionPropertyInfo');\n                }, 1000 / 60),\n                scrollParent = this.$node.scrollParent();\n\n            this.on(document, 'graphPaddingUpdated', positionPopovers);\n            if (scrollParent.length) {\n                this.on(scrollParent, 'scroll', positionPopovers);\n            }\n        });\n\n        this.onDeleteProperty = function(event, data) {\n            var self = this,\n                vertexId = data.vertexId || this.data.id;\n\n            this.dataRequest(\n                    F.vertex.isEdge(this.data) ? 'edge' : 'vertex',\n                    'deleteProperty',\n                    vertexId, data.property\n                ).then(this.closePropertyForm.bind(this, data.node))\n                 .catch(function(error) { self.requestFailure.call(self, error, data.node) })\n        };\n\n        this.onAddProperty = function(event, data) {\n            var self = this,\n                vertexId = data.vertexId || this.data.id,\n                service = data.isEdge ? 'edge' : 'vertex';\n\n            if (data.property.name === 'http://openlumify.org#visibilityJson') {\n                var visibilitySource = data.property.visibilitySource || '';\n                this.dataRequest(service, 'setVisibility', vertexId, visibilitySource)\n                    .then(this.closePropertyForm.bind(this, data.node))\n                    .catch(function(error) { self.requestFailure.call(self, error, data.node) })\n            } else if (this.isStreamingPropertyVisibilityUpdate(data)) {\n                this.dataRequest(service, 'setPropertyVisibility', vertexId, data.property)\n                    .then(this.closePropertyForm.bind(this, data.node))\n                    .catch(function(error) { self.requestFailure.call(self, error, data.node) });\n            } else {\n                this.dataRequest(service, 'setProperty', vertexId, data.property)\n                    .then(this.closePropertyForm.bind(this, data.node))\n                    .catch(function(error) { self.requestFailure.call(self, error, data.node) });\n            }\n        };\n\n        this.isStreamingPropertyVisibilityUpdate = function(data) {\n            if (!_.isUndefined(data.property.key)) {\n                var prop = _.first(F.vertex.props(this.data, data.property.name, data.property.key));\n                return prop && prop.streamingPropertyValue;\n            }\n            return false;\n        };\n\n        this.closePropertyForm = function(node) {\n            $(node).teardownComponent(PropertyForm);\n        };\n\n        this.requestFailure = function(error, node) {\n            var target = $(node);\n            this.trigger(target, 'propertyerror', { error: error });\n        };\n\n        this.onEditProperty = function(evt, data) {\n            var root = $('<div class=\"underneath\">'),\n                property = data && data.property,\n                propertyRow = property && $(evt.target).closest('tr')\n\n            this.$node.find('button.info').popover('hide');\n\n            if (propertyRow && propertyRow.length) {\n                root.appendTo(\n                    $('<tr><td colspan=3></td></tr>')\n                        .insertAfter(propertyRow)\n                        .find('td')\n                );\n            } else {\n                $('<tr><td colspan=\"3\"></td></tr>').prependTo(this.$node.find('table')).find('td').append(root);\n            }\n\n            PropertyForm.teardownAll();\n            PropertyForm.attachTo(root, {\n                data: this.data,\n                property: property\n            });\n        };\n\n        this.updateJustification = function() {\n            this.$node.find('.justification').each(function() {\n                var justification = $(this),\n                    property = justification.data('property');\n\n                require(['util/vertex/justification/viewer'], function(JustificationViewer) {\n                    var attrs = {};\n                    attrs[property.name] = property.value;\n                    JustificationViewer.attachTo(justification, attrs);\n                });\n            });\n        }\n\n        this.updateVisibility = function() {\n            var self = this;\n\n            require([\n                'util/visibility/view'\n            ], function(VisibilityDisplay) {\n                self.$node.find('.visibility').each(function() {\n                    var visibility = $(this).data('visibility');\n                    VisibilityDisplay.attachTo(this, {\n                        value: visibility && visibility.source\n                    })\n                });\n            });\n        };\n\n        this.saveSectionTogglePreference = function(sectionEl, expanded) {\n            var name = $(sectionEl).data('sectionName'),\n                previouslyExpanded = openlumifyData.currentUser.uiPreferences['property-groups-expanded'],\n                shouldSave = false;\n\n            if (previouslyExpanded) {\n                previouslyExpanded = JSON.parse(previouslyExpanded);\n            } else {\n                previouslyExpanded = [];\n            }\n\n            var inList = previouslyExpanded.indexOf(name) >= 0;\n\n            if (expanded && !inList) {\n                previouslyExpanded.push(name);\n                shouldSave = true;\n            } else if (!expanded && inList) {\n                previouslyExpanded = _.without(previouslyExpanded, name);\n                shouldSave = true;\n            }\n\n            if (shouldSave) {\n                var prefValue = JSON.stringify(previouslyExpanded);\n                openlumifyData.currentUser.uiPreferences['property-groups-expanded'] = prefValue;\n                this.dataRequest('user', 'preference', 'property-groups-expanded', prefValue);\n            }\n        };\n    }\n\n    function onTableClick() {\n        var $target = $(d3.event.target),\n            $header = $target.closest('.property-group-header'),\n            $tbody = $header.closest('.property-group'),\n            processed = true;\n\n        if ($header.is('.property-group-header')) {\n            $tbody.toggleClass('collapsed expanded');\n            this.saveSectionTogglePreference($tbody[0], !$tbody.hasClass('collapsed'));\n        } else if ($target.is('.show-more')) {\n            var isShowing = $target.data('showing');\n            $target.data('showing', !isShowing);\n            if (isShowing) {\n                delete this.showMoreExpanded[$target.data('propertyName')];\n            } else {\n                this.showMoreExpanded[$target.data('propertyName')] = true;\n            }\n            this.reload();\n        } else if ($target.is('.info')) {\n            var datum = d3.select($target.closest('.property-value').get(0)).datum();\n            this.showPropertyInfo($target, this.data, datum.property);\n        } else {\n            processed = false;\n        }\n\n        if (processed) {\n            d3.event.stopPropagation();\n            d3.event.preventDefault();\n        }\n    }\n\n    function createPropertyGroups(vertex, ontologyProperties, showMoreExpanded, maxItemsBeforeHidden, expandedSections,\n                                  config) {\n        this.exit().remove();\n        this.enter().insert('tbody', '.buttons-row');\n        this.order();\n\n        this.attr('class', function(d, groupIndex, j) {\n            var cls = 'property-group collapsible';\n            if (groupIndex === 0) {\n                return cls + ' expanded';\n            }\n\n            return cls + ' ' + (\n                _.contains(expandedSections, d[0]) ?\n                    'expanded' : 'collapsed'\n            );\n        });\n\n        this.attr('data-section-name', function(d) {\n            return d[0];\n        })\n\n        var totalPropertyCountsByName = {};\n\n        this.selectAll('tr.property-group-header, tr.property-row, tr.property-hidden')\n            .data(function(pair) {\n                return _.chain(pair[1])\n                    .map(function(p) {\n                        var hidden = p[1].length - maxItemsBeforeHidden;\n                        totalPropertyCountsByName[p[0]] = hidden;\n                        if (p[0] in showMoreExpanded) {\n                            var expanded = p[1].slice(0);\n                            expanded.splice(maxItemsBeforeHidden, 0, { name: p[0], hidden: hidden, isExpanded: true });\n                            return expanded;\n                        }\n                        var truncated = p[1].slice(0, maxItemsBeforeHidden);\n                        if (hidden > 0) {\n                            truncated.push({ name: p[0], hidden: hidden, isExpanded: false });\n                        }\n                        return truncated;\n                    })\n                    .flatten()\n                    .tap(function(list) {\n                        if (pair[0] !== NO_GROUP) {\n                            list.splice(0, 0, [pair[0], {\n                                propertyCount: pair[1].length,\n                                valueCount: _.reduce(pair[1], function(sum, p) {\n                                    return sum + p[1].length;\n                                }, 0)\n                            }]);\n                        }\n                    })\n                    .value();\n            })\n            .call(\n                _.partial(createProperties,\n                          vertex,\n                          ontologyProperties,\n                          totalPropertyCountsByName,\n                          maxItemsBeforeHidden,\n                          showMoreExpanded,\n                          config\n                )\n            )\n    }\n\n    function createProperties(vertex,\n                              ontologyProperties,\n                              totalPropertyCountsByName,\n                              maxItemsBeforeHidden,\n                              showMoreExpanded,\n                              config) {\n\n\n        this.exit().remove();\n        this.enter().append('tr')\n        this.order();\n\n        this.attr('class', function(datum) {\n            if (_.isString(datum[0])) {\n                return 'property-group-header';\n            }\n            if ('hidden' in datum) {\n                return 'property-hidden';\n            }\n            return 'property-row property-row-' + F.className.to(datum.name + datum.key);\n        });\n\n        var currentPropertyIndex = 0,\n            lastPropertyName = '';\n\n        this.selectAll('td')\n            .data(function(datum, i, j) {\n                if (_.isString(datum[0])) {\n                    return [{\n                        type: GROUP,\n                        name: datum[0],\n                        count: datum[1]\n                    }];\n                }\n                if ('hidden' in datum) {\n                    return [\n                        { type: HIDDEN_COLLAPSE, spacer: true },\n                        { type: HIDDEN_COLLAPSE, name: datum.name, hidden: datum.hidden, isExpanded: datum.isExpanded }\n                    ];\n                }\n\n                if (datum.name === lastPropertyName) {\n                    currentPropertyIndex++;\n                } else {\n                    currentPropertyIndex = 0;\n                    lastPropertyName = datum.name;\n                }\n\n                return [\n                    {\n                        type: NAME,\n                        name: datum.name,\n                        property: datum\n                    },\n                    {\n                        type: VALUE,\n                        property: datum,\n                        propertyIndex: currentPropertyIndex,\n                        showToggleLink: currentPropertyIndex === (maxItemsBeforeHidden - 1),\n                        isExpanded: datum.name in showMoreExpanded,\n                        hidden: Math.max(0, totalPropertyCountsByName[datum.name])\n                    }\n                ];\n            })\n            .call(_.partial(createPropertyRow, vertex, ontologyProperties, maxItemsBeforeHidden, config));\n    }\n\n    function createPropertyRow(vertex, ontologyProperties, maxItemsBeforeHidden, config) {\n        this.exit().remove();\n        this.each(function(datum) {\n            var d3element = d3.select(this),\n                resetUnless = function(selector) {\n                    if (d3element.select(selector).size() === 0) {\n                        d3element.text('');\n                    }\n                };\n            switch (datum.type) {\n                case HIDDEN_COLLAPSE: resetUnless('a.show-more'); break;\n                case GROUP: resetUnless('.collapsible-header'); break;\n                case NAME: resetUnless('strong'); break;\n                case VALUE: resetUnless('.value-container'); break;\n            }\n        })\n        this.enter().append('td')\n        this.each(function(datum) {\n            if (this.childElementCount > 0) return;\n            var d3element = d3.select(this);\n            switch (datum.type) {\n                case HIDDEN_COLLAPSE:\n                    if (!datum.spacer) {\n                        d3element.append('a').attr('class', 'show-more');\n                    }\n                    break;\n                case GROUP:\n                    d3element.append('h1')\n                        .attr('class', 'collapsible-header')\n                        .call(function() {\n                            this.append('span').attr('class', 'badge');\n                            this.append('strong');\n                        });\n                        break;\n                case NAME: d3element.append('strong'); break;\n                case VALUE:\n                    d3element.append('div').attr('class', 'value-container')\n                        .call(function() {\n                            this.append('span').attr('class', 'value');\n                            this.append('button').attr('class', 'info');\n                            this.append('span').attr('class', 'visibility');\n                        })\n                    break;\n            }\n        });\n\n        this.order();\n\n        this.attr('class', function(datum) {\n                if (datum.type === NAME) {\n                    return 'property-name';\n                } else if (datum.type === VALUE) {\n                    return 'property-value';\n                } else if (datum.type === HIDDEN_COLLAPSE && !datum.spacer) {\n                    return 'property-hidden-toggle'\n                }\n            })\n            .attr('colspan', function(datum) {\n                if (datum.type === GROUP) {\n                    return '3';\n                } else if (datum.type === VALUE || (datum.type === HIDDEN_COLLAPSE && !datum.spacer)) {\n                    return '2';\n                }\n                return '1';\n            })\n            .call(function() {\n                var previousPropertyName = '';\n\n                this.select('h1.collapsible-header strong').text(_.property('name'))\n                this.select('h1.collapsible-header .badge')\n                    .text(function(d) {\n                        return F.number.pretty(d.count.valueCount)\n                    })\n                    .attr('title', function(d) {\n                        var propertyLabel = 'properties.groups.count.hover.property',\n                            valueLabel = 'properties.groups.count.hover.value';\n\n                        if (d.count.propertyCount > 1) {\n                            propertyLabel += '.plural';\n                        }\n                        if (d.count.valueCount > 1) {\n                            valueLabel += '.plural';\n                        }\n\n                        return [\n                            F.number.pretty(d.count.propertyCount),\n                            i18n(propertyLabel),\n                            F.number.pretty(d.count.valueCount),\n                            i18n(valueLabel)\n                        ].join(' ')\n                    });\n\n                this.select('.property-name strong')\n                    .attr('title', getDisplayName)\n                    .text((p) => {\n                        if (previousPropertyName === p.name) {\n                            return '';\n                        } else {\n                            previousPropertyName = p.name;\n                            return getDisplayName(p)\n                        }\n                    });\n\n                function getDisplayName(property) {\n                    if (isVisibility(property)) {\n                        return i18n('visibility.label');\n                    }\n\n                    if (property.property.displayName) {\n                        return property.property.displayName;\n                    }\n\n                    var ontologyProperty = ontologyProperties.byTitle[property.name];\n                    if (ontologyProperty) {\n                        return ontologyProperty.displayName;\n                    }\n\n                    console.warn('No ontology definition for ', property.name);\n                    return property.name;\n                }\n\n                this.select('.property-value .value')\n                    .each(function() {\n                        var d3element = d3.select(this),\n                            property = d3element.datum().property,\n                            valueSpan = d3element.node(),\n                            $valueSpan = $(valueSpan),\n                            visibilitySpan = $valueSpan.siblings('.visibility')[0],\n                            $infoButton = $valueSpan.siblings('.info'),\n                            visibility = isVisibility(property),\n                            ontologyProperty = ontologyProperties.byTitle[property.name],\n                            dataType = ontologyProperty && ontologyProperty.dataType,\n                            displayType = ontologyProperty && ontologyProperty.displayType;\n\n                        valueSpan.textContent = '';\n                        visibilitySpan.textContent = '';\n\n                        if (visibility) {\n                            dataType = 'visibility';\n                        } else if (config['showVisibilityInDetailsPane'] !== 'false' && property.hideVisibility !== true) {\n                            F.vertex.properties.visibility(\n                                visibilitySpan,\n                                { value: property.metadata && property.metadata[VISIBILITY_NAME] },\n                                vertex);\n                        }\n\n                        var isEditable = (\n                                Privileges.canEDIT &&\n                                (property.updateable !== false || property.deleteable !== false)\n                            ),\n                            metadataPropertyNames = (config['properties.metadata.propertyNames'] || '').split(','),\n                            hasVisibleMetadata = F.vertex.hasMetadata(property, metadataPropertyNames);\n\n                        $infoButton.toggle(Boolean(\n                            !property.hideInfo && (\n                                isEditable ||\n                                ontologyProperty.searchable ||\n                                hasVisibleMetadata ||\n                                visibility)\n                        ));\n\n                        if (displayType && F.vertex.properties[displayType]) {\n                            F.vertex.properties[displayType](valueSpan, property, vertex);\n                        } else if (dataType && F.vertex.properties[dataType]) {\n                            F.vertex.properties[dataType](valueSpan, property, vertex);\n                        } else if (isJustification(property)) {\n                            require(['util/vertex/justification/viewer'], function(JustificationViewer) {\n                                $(valueSpan).teardownAllComponents();\n                                JustificationViewer.attachTo(valueSpan, property.justificationData);\n                            });\n                        } else if (isSandboxStatus(property)) {\n                            valueSpan.textContent = property.value;\n                        } else {\n                            const { full, truncated, expanded, toggleable } = getOrUpdateValue(vertex, property.name, property.key);\n\n                            valueSpan.textContent = expanded ? full : truncated;\n\n                            if (toggleable) {\n                                $('<span/>').addClass('value-expand')\n                                    .data('expanded', expanded)\n                                    .text(expanded ? i18n('properties.value.collapse') : i18n('properties.value.expand'))\n                                    .on('click', function(e) {\n                                        const expanded = !$(this).data('expanded');\n                                        $(this).data('expanded', expanded);\n\n                                        const { full, truncated } = getOrUpdateValue(vertex, property.name, property.key, expanded);\n                                        const textNode = $valueSpan.contents().filter((i, ele) => ele.nodeType === Node.TEXT_NODE)[0];\n\n                                        textNode.nodeValue = expanded ? full : truncated;\n                                        $(this).text(expanded ? i18n('properties.value.collapse') : i18n('properties.value.expand'))\n                                    })\n                                    .appendTo($valueSpan);\n                            }\n                        }\n                    });\n\n                this.select('.show-more')\n                    .attr('data-property-name', function(d) {\n                        return d.name;\n                    })\n                    .text(function(d) {\n                        return i18n(\n                            'properties.button.' + (d.isExpanded ? 'hide_more' : 'show_more'),\n                            F.number.pretty(d.hidden),\n                            ontologyProperties.byTitle[d.name].displayName\n                        );\n                    })\n                    .style('display', function(d) {\n                        if (d.hidden > 0) {\n                            return 'block';\n                        }\n\n                        return 'none';\n                    });\n            })\n    }\n\n});\n"]}