{"version":3,"sources":["../../../js/dashboard/reportRenderers/withMapTiles.js"],"names":["define","ol","mapConfig","colorjs","Escape","NORMAL","HEATMAP","dataProjection","featureProjection","withMapTiles","updateSize","map","render","d3","node","data","d3tip","$node","$","empty","geoJson","predicate","layerConfig","html","vectorSource","clear","setTarget","_","defer","viewportListeners","addFeatures","getFeatures","fit","source","Vector","features","vectorLayer","getLayer","sourceOptions","Map","target","layers","layer","Tile","controls","view","View","center","proj","transform","zoom","throttle","bind","viewport","getViewport","setAttribute","on","window","event","keyCode","blur","pixel","originalEvent","getFeaturesAtPixel","length","propertyId","values","uniq","compact","f","getProperties","field","name","handleClick","filters","setInteractions","getView","getExtent","activate","interactionMouseWheel","getInteractions","getArray","filter","i","interaction","MouseWheelZoom","isEmpty","forEach","getActive","setActive","i18n","reader","format","GeoJSON","readFeatures","display","min","max","newMin","opacityRange","weight","feature","amount","calc","set","styleCache","colors","step","scale","linear","domain","range","opacity","colorScale","interpolate","interpolateHcl","c","l","style","w","index","color","colorWithAlpha","setAlpha","toCSS","colorDarkened","darkenByAmount","Style","fill","Fill","stroke","Stroke","width","Heatmap","Error"],"mappings":"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","file":"withMapTiles.js","sourcesContent":["define([\n    'openlayers',\n    'util/mapConfig',\n    'colorjs'\n], function(ol, mapConfig, colorjs) {\n\n    const Escape = 27;\n    const NORMAL = 'normal';\n    const HEATMAP = 'heatmap';\n    const dataProjection = 'EPSG:4326';\n    const featureProjection = 'EPSG:3857';\n\n    return withMapTiles;\n\n    function withMapTiles() {\n\n        this.updateSize = function() {\n            this.map.updateSize();\n        };\n\n        this.render = function(d3, node, data, d3tip) {\n            var $node = $(node);\n            if (!data) {\n                $node.empty();\n                return;\n            }\n\n            const { geoJson, predicate, ...layerConfig } = data;\n\n            if (this.map) {\n                if ($node.html()) {\n                    this.updateSize();\n                } else {\n                    this.vectorSource.clear();\n                    this.map.setTarget(null)\n                    _.defer(() => {\n                        this.map.setTarget(node)\n                        this.viewportListeners();\n                        this.vectorSource.addFeatures(this.getFeatures(geoJson));\n                        this.fit();\n                    })\n                }\n                return;\n            }\n\n            const vectorSource = new ol.source.Vector({ features: this.getFeatures(geoJson) })\n            const vectorLayer = this.getLayer(d3, layerConfig, vectorSource);\n\n            const { source, sourceOptions } = mapConfig();\n            const map = new ol.Map({\n                target: node,\n                layers: [\n                    new ol.layer.Tile({ source: new ol.source[source](sourceOptions) }),\n                    vectorLayer\n                ],\n                controls: [],\n                view: new ol.View({\n                    center: ol.proj.transform([0, 0], dataProjection, featureProjection),\n                    zoom: 1\n                })\n            });\n\n            this.updateSize = _.throttle(this.updateSize.bind(this), 500);\n            this.map = map;\n            this.vectorSource = vectorSource;\n            this.vectorLayer = vectorLayer;\n\n            this.fit();\n\n            const viewport = map.getViewport();\n            viewport.setAttribute('tabindex', '-1');\n            viewport.setAttribute('data-allow-focus', true);\n            this.viewportListeners();\n\n            this.on(window, 'keyup', event => {\n                if (event.keyCode === Escape) {\n                    viewport.blur();\n                }\n            });\n\n            this.map.on('click', event => {\n                const { pixel, originalEvent } = event;\n                const features = this.map.getFeaturesAtPixel(pixel)\n                if (features) {\n                    if (features.length) {\n                        let propertyId;\n                        const values = _.uniq(_.compact(features.map(f => {\n                            const { field, name } = f.getProperties();\n                            if (!propertyId) {\n                                propertyId = field;\n                            }\n                            if (field === propertyId) {\n                                return name;\n                            }\n                        })))\n                        // Ignore geohash/within for now\n                        if (predicate === 'equal' && propertyId && values.length) {\n                            this.handleClick({\n                                filters: [{ propertyId, predicate, values }]\n                            }, originalEvent.target)\n                        }\n                    }\n                }\n            })\n            this.setInteractions(false);\n        };\n\n        this.fit = function() {\n            this.map.getView().fit(this.vectorSource.getExtent());\n        };\n\n        this.viewportListeners = function() {\n            const viewport = this.map.getViewport();\n            this.on(viewport, 'focus', () => { this.setInteractions(true); });\n            this.on(viewport, 'blur', () => { this.setInteractions(false); });\n        };\n\n        this.setInteractions = function(activate) {\n            if (!this.interactionMouseWheel) {\n                this.interactionMouseWheel = this.map.getInteractions().getArray().filter(i => {\n                    return i instanceof ol.interaction.MouseWheelZoom;\n                })\n            }\n\n            if (!_.isEmpty(this.interactionMouseWheel)) {\n                this.interactionMouseWheel.forEach(i => {\n                    if (i.getActive() !== activate) {\n                        i.setActive(activate);\n                    }\n                })\n                this.map.getViewport().setAttribute(\n                    'title',\n                    activate ? '' : i18n('dashboard.map.mousezoom.disabled')\n                )\n            }\n        };\n\n        this.getFeatures = function(geoJson) {\n            const reader = new ol.format.GeoJSON();\n            const features = reader.readFeatures(geoJson, { dataProjection, featureProjection })\n            return features;\n        };\n\n        this.getLayer = function(d3, { display = NORMAL, min, max }, source) {\n            const newMin = 0.4;\n            const opacityRange = [0.4, 0.5];\n            const weight = feature => {\n                const { amount, weight } = feature.getProperties()\n                if (weight) {\n                    return weight;\n                }\n                const calc = (min === max ?\n                    0.5 :\n                    ((amount - min) / (max - min))\n                ) * (1 - newMin) + newMin;\n                feature.set('weight', calc, true);\n                return calc;\n            };\n            const styleCache = {};\n            const colors = ['#FFFF00', '#FFAB00', '#FF0000'];\n            const step = d3.scale.linear().domain([1, colors.length]).range([newMin, 1]);\n            const opacity = d3.scale.linear()\n                .domain([newMin, 1])\n                .range(opacityRange)\n            const colorScale = d3.scale.linear()\n                .interpolate(d3.interpolateHcl)\n                .domain(colors.map((c, i, l) => {\n                    if (i === 0) return newMin\n                    if (i === l.length - 1) return 1;\n                    return step(i + 1)\n                }))\n                .range(colors);\n            const style = feature => {\n                const w = weight(feature);\n                const index = (255 * w) | 0;\n                let style = styleCache[index];\n                if (!style) {\n                    const color = colorjs(colorScale(w));\n                    const colorWithAlpha = color.setAlpha(opacity(w)).toCSS();\n                    const colorDarkened = color.darkenByAmount(0.1).toCSS();\n                    style = [\n                        new ol.style.Style({\n                            fill: new ol.style.Fill({ color: colorWithAlpha }),\n                            stroke: new ol.style.Stroke({ color: colorDarkened, width: 1 })\n                        })\n                    ];\n                    styleCache[index] = style;\n                }\n                return style;\n            }\n\n            switch (display) {\n                case NORMAL:\n                    return new ol.layer.Vector({ source, style })\n\n                case HEATMAP:\n                    return new ol.layer.Heatmap({ source, weight })\n\n                default:\n                    throw new Error('No display of type ' + display + ' found.')\n            }\n        }\n\n    }\n});\n"]}