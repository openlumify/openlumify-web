function _objectWithoutProperties(obj,keys){var target={};for(var i in obj){if(keys.indexOf(i)>=0)continue;if(!Object.prototype.hasOwnProperty.call(obj,i))continue;target[i]=obj[i];}return target;}define(['openlayers','util/mapConfig','colorjs'],function(ol,mapConfig,colorjs){var Escape=27;var NORMAL='normal';var HEATMAP='heatmap';var dataProjection='EPSG:4326';var featureProjection='EPSG:3857';return withMapTiles;function withMapTiles(){this.updateSize=function(){this.map.updateSize();};this.render=function(d3,node,data,d3tip){var _this=this;var $node=$(node);if(!data){$node.empty();return;}var geoJson=data.geoJson,predicate=data.predicate,layerConfig=_objectWithoutProperties(data,['geoJson','predicate']);if(this.map){if($node.html()){this.updateSize();}else{this.vectorSource.clear();this.map.setTarget(null);_.defer(function(){_this.map.setTarget(node);_this.viewportListeners();_this.vectorSource.addFeatures(_this.getFeatures(geoJson));_this.fit();});}return;}var vectorSource=new ol.source.Vector({features:this.getFeatures(geoJson)});var vectorLayer=this.getLayer(d3,layerConfig,vectorSource);var _mapConfig=mapConfig(),source=_mapConfig.source,sourceOptions=_mapConfig.sourceOptions;var map=new ol.Map({target:node,layers:[new ol.layer.Tile({source:new ol.source[source](sourceOptions)}),vectorLayer],controls:[],view:new ol.View({center:ol.proj.transform([0,0],dataProjection,featureProjection),zoom:1})});this.updateSize=_.throttle(this.updateSize.bind(this),500);this.map=map;this.vectorSource=vectorSource;this.vectorLayer=vectorLayer;this.fit();var viewport=map.getViewport();viewport.setAttribute('tabindex','-1');viewport.setAttribute('data-allow-focus',true);this.viewportListeners();this.on(window,'keyup',function(event){if(event.keyCode===Escape){viewport.blur();}});this.map.on('click',function(event){var pixel=event.pixel,originalEvent=event.originalEvent;var features=_this.map.getFeaturesAtPixel(pixel);if(features){if(features.length){var propertyId=void 0;var values=_.uniq(_.compact(features.map(function(f){var _f$getProperties=f.getProperties(),field=_f$getProperties.field,name=_f$getProperties.name;if(!propertyId){propertyId=field;}if(field===propertyId){return name;}})));if(predicate==='equal'&&propertyId&&values.length){_this.handleClick({filters:[{propertyId:propertyId,predicate:predicate,values:values}]},originalEvent.target);}}}});this.setInteractions(false);};this.fit=function(){this.map.getView().fit(this.vectorSource.getExtent());};this.viewportListeners=function(){var _this2=this;var viewport=this.map.getViewport();this.on(viewport,'focus',function(){_this2.setInteractions(true);});this.on(viewport,'blur',function(){_this2.setInteractions(false);});};this.setInteractions=function(activate){if(!this.interactionMouseWheel){this.interactionMouseWheel=this.map.getInteractions().getArray().filter(function(i){return i instanceof ol.interaction.MouseWheelZoom;});}if(!_.isEmpty(this.interactionMouseWheel)){this.interactionMouseWheel.forEach(function(i){if(i.getActive()!==activate){i.setActive(activate);}});this.map.getViewport().setAttribute('title',activate?'':i18n('dashboard.map.mousezoom.disabled'));}};this.getFeatures=function(geoJson){var reader=new ol.format.GeoJSON();var features=reader.readFeatures(geoJson,{dataProjection:dataProjection,featureProjection:featureProjection});return features;};this.getLayer=function(d3,_ref,source){var _ref$display=_ref.display,display=_ref$display===undefined?NORMAL:_ref$display,min=_ref.min,max=_ref.max;var newMin=0.4;var opacityRange=[0.4,0.5];var weight=function weight(feature){var _feature$getPropertie=feature.getProperties(),amount=_feature$getPropertie.amount,weight=_feature$getPropertie.weight;if(weight){return weight;}var calc=(min===max?0.5:(amount-min)/(max-min))*(1-newMin)+newMin;feature.set('weight',calc,true);return calc;};var styleCache={};var colors=['#FFFF00','#FFAB00','#FF0000'];var step=d3.scale.linear().domain([1,colors.length]).range([newMin,1]);var opacity=d3.scale.linear().domain([newMin,1]).range(opacityRange);var colorScale=d3.scale.linear().interpolate(d3.interpolateHcl).domain(colors.map(function(c,i,l){if(i===0)return newMin;if(i===l.length-1)return 1;return step(i+1);})).range(colors);var style=function style(feature){var w=weight(feature);var index=255*w|0;var style=styleCache[index];if(!style){var color=colorjs(colorScale(w));var colorWithAlpha=color.setAlpha(opacity(w)).toCSS();var colorDarkened=color.darkenByAmount(0.1).toCSS();style=[new ol.style.Style({fill:new ol.style.Fill({color:colorWithAlpha}),stroke:new ol.style.Stroke({color:colorDarkened,width:1})})];styleCache[index]=style;}return style;};switch(display){case NORMAL:return new ol.layer.Vector({source:source,style:style});case HEATMAP:return new ol.layer.Heatmap({source:source,weight:weight});default:throw new Error('No display of type '+display+' found.');}};}});
//# sourceMappingURL=withMapTiles.js.map
