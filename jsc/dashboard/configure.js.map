{"version":3,"sources":["../../js/dashboard/configure.js"],"names":["define","defineComponent","registry","withPopover","Attacher","reportConfigurationPath","reportRenderers","extensionsForPoint","extensions","ConfigPopover","before","components","forEach","attacher","teardown","$node","closest","removeClass","node","config","template","paths","configurationPaths","extension","_","findWhere","identifier","item","extensionId","report","configuration","addDefaultConfiguration","options","preventDefaultConfig","configurationPath","push","splice","empty","length","after","self","attr","addClass","on","popover","event","data","find","trigger","name","onConfigurationChanged","renderConfigurations","changed","reportAdded","reportRemoved","teardownConfigPath","then","updateComponents","params","attach","teardownOptions","react","path","chain","map","remove","compact","value","root","Promise","$","appendTo","behavior","configurationChanged","positionDialog"],"mappings":"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","file":"configure.js","sourcesContent":["define([\n    'flight/lib/component',\n    'configuration/plugins/registry',\n    'util/popovers/withPopover',\n    'util/component/attacher'\n], function(\n    defineComponent,\n    registry,\n    withPopover,\n    Attacher) {\n    'use strict';\n\n    const reportConfigurationPath = 'dashboard/configs/report';\n\n    var reportRenderers = registry.extensionsForPoint('org.openlumify.dashboard.reportrenderer'),\n        extensions = registry.extensionsForPoint('org.openlumify.dashboard.item');\n\n    return defineComponent(ConfigPopover, withPopover);\n\n    function ConfigPopover() {\n\n        this.before('teardown', function() {\n            this.components.forEach(attacher => { attacher.teardown() });\n            this.$node.closest('.card-toolbar').removeClass('active');\n        })\n\n        this.before('initialize', function(node, config) {\n            config.template = '/dashboard/configureTpl.hbs';\n            var paths = config.configurationPaths || [],\n                extension = _.findWhere(extensions, { identifier: config.item.extensionId }),\n                report = config.item.configuration.report || extension.report,\n                addDefaultConfiguration = !extension.options ||\n                    extension.options.preventDefaultConfig !== true;\n\n            this.extension = extension;\n            this.components = [];\n\n            if (extension.configurationPath) {\n                /**\n                 * FlightJS or React component that renders card configuration\n                 * content.\n                 *\n                 * For Flight, `trigger` an event with the name of the\n                 * function instead of invoking directly.\n                 *\n                 * @typedef org.openlumify.dashboard.item~ConfigComponent\n                 * @property {object} extension\n                 * @property {object} item\n                 * @property {object} [report]\n                 * @property {org.openlumify.dashboard.item~configurationChanged} configurationChanged Change the configuration\n                 */\n                paths.push(extension.configurationPath);\n            }\n\n            if (report) {\n                paths.push(reportConfigurationPath);\n            }\n\n            if (addDefaultConfiguration) {\n                paths.splice(0, 0, 'dashboard/configs/default');\n            }\n\n            config.empty = paths.length === 0;\n\n            this.after('setupWithTemplate', function() {\n                var self = this,\n                    item = this.attr.item;\n\n                this.$node.closest('.card-toolbar').addClass('active');\n                this.on(this.popover, 'redirectEventToItem', function(event, data) {\n                    this.$node.closest('.grid-stack-item').find('.item-content').trigger(data.name, data.data);\n                });\n                this.on(this.$node.closest('.grid-stack-item').find('.item-content'), 'redirectEventToConfiguration', function(event, data) {\n                    this.popover.find('.popover-content > div').trigger(data.name, data.data);\n                })\n                this.on(this.popover, 'configurationChanged', this.onConfigurationChanged);\n                this.renderConfigurations(paths);\n            });\n        });\n\n        this.onConfigurationChanged = function(event, data) {\n            this.trigger('configurationChanged', data);\n\n            if (data.options && data.options.changed === 'item.title') return;\n\n            var extension = this.extension,\n                reportAdded = data.item.configuration.report || extension.report,\n                reportRemoved = !data.item.configuration.report && !extension.report;\n\n            this.attr.item = data.item;\n\n            if (reportAdded) {\n                this.teardownConfigPath(reportConfigurationPath)\n                this.renderConfigurations([reportConfigurationPath]).then(() => this.updateComponents(data));\n            } else if (reportRemoved) {\n                this.teardownConfigPath(reportConfigurationPath)\n                this.updateComponents(data);\n            } else {\n                this.updateComponents(data);\n            }\n        };\n\n        this.updateComponents = function(data) {\n            this.components.forEach((attacher) => {\n                attacher.params(data).attach({\n                   teardown: true,\n                   teardownOptions: {\n                      react: false\n                   }\n                });\n            });\n        };\n\n        this.teardownConfigPath = function(path) {\n            this.components = _.chain(this.components)\n                .map((attacher) => {\n                    if (attacher.path() === path) {\n                        attacher.teardown();\n                        attacher.node().remove()\n                        return null;\n                    } else {\n                        return attacher;\n                    }\n                })\n                .compact()\n                .value();\n        }\n\n        this.renderConfigurations = function(paths) {\n            const item = this.attr.item;\n            const root = this.popover.find('.popover-content');\n\n            return Promise.map(paths, (path) => {\n                const node = $('<div>').data('path', path).appendTo(root);\n\n                return Attacher().node(node)\n                    .path(path)\n                    .params({\n                        extension: this.extension,\n                        report: item.configuration.report || this.extension.report,\n                        item: item\n                    })\n                    .behavior({\n                        configurationChanged: (attacher, data) => {\n                            this.onConfigurationChanged(null, data);\n                        }\n                    })\n                    .attach();\n            }).then((components) => {\n               this.components.push(...components);\n               this.positionDialog();\n            });\n        };\n\n    }\n});\n\n"]}