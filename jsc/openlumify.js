require(['jquery','flight/lib/compose','flight/lib/registry','flight/lib/advice','flight/lib/logger','flight/lib/debug','underscore','underscore.inflection','util/visibility','util/privileges','util/jquery.flight','util/jquery.removePrefixedClasses','util/jquery/plugins','util/promise'],function(jQuery,compose,registry,advice,withLogging,debug,_,_inflection,Visibility,Privileges){'use strict';$.ui={keyCode:{ENTER:13}};jQuery.fn.size=function(){console.warn('$.size is deprecated');return this.length;};jQuery.fn.andSelf=function(){console.warn('$.andSelf is deprecated, use $.addBack');return jQuery.fn.addBack.apply(this,arguments);};lockDownUnderscore(_);window.requestIdleCallback=typeof window==='undefined'?function(){}:window.requestIdleCallback||function(callback){return setTimeout(callback,1000/60);};window.cancelIdleCallback=typeof window==='undefined'?function(){}:window.cancelIdleCallback||function(handle){clearTimeout(handle,1000/60);};window.requestAnimationFrame=typeof window==='undefined'?function(){}:window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame||function(callback){return setTimeout(callback,1000/60);};window.TRANSITION_END='transitionend webkitTransitionEnd MSTransitionEnd oTransitionEnd otransitionend';window.ANIMATION_END='animationend webkitAnimationEnd MSAnimationEnd oAnimationEnd oanimationend';window.VISALLO_MIMETYPES=_.mapObject({_PREFIX:'application/x-openlumify.',_FORMAT:'+json',_DataTransferHasOpenLumify:function _DataTransferHasOpenLumify(dataTransfer,specificType){return _.any(dataTransfer.types,function(type){if(specificType)return type===specificType;return type.indexOf(VISALLO_MIMETYPES._PREFIX)===0;});},ELEMENTS:'elements',RESOLVED_INFO:'resolvedInfo'},function(str,key,obj){if(key.substring(0,1)!=='_'){return obj._PREFIX+str+obj._FORMAT;}return str;});var progress=0,progressBar=null,progressBarText=null,TOTAL_PROGRESS=4,MAX_RESIZE_TRIGGER_INTERVAL=250,App,FullScreenApp,F,withDataRequest,previousUrl=window.location.href;$(function(){require(['cli']);require(['data/data'],configureApplication);require(['urlPolyfill']);function configureApplication(Data){try{debug.enable(false);DEBUG.events.logNone();}catch(e){console.warn('Error enabling DEBUG mode for flight'+', probably because Safari Private Browsing enabled',e);}_.templateSettings.escape=/\{([\s\S]+?)\}/g;_.templateSettings.evaluate=/<%([\s\S]+?)%>/g;_.templateSettings.interpolate=/\{-([\s\S]+?)\}/g;Data.attachTo(document);Visibility.attachTo(document);Privileges.attachTo(document);$(window).on('hashchange',loadApplicationTypeBasedOnUrlHash).on('resize',_.throttle(function(event){if(event.target!==window){return;}$(document).trigger('windowResize');},MAX_RESIZE_TRIGGER_INTERVAL));Promise.require('util/messages').then(function(_i18n){window.i18n=_i18n;updateOpenLumifyLoadingProgress('dependencies');require(['react','util/vertex/urlFormatters','util/withDataRequest','util/handlebars/before_auth_helpers'],function(React,_F,_withDataRequest){window.React=React;define('React',[],React);define('ReactDOM',['react-dom'],_.identity);F=_F;withDataRequest=_withDataRequest;loadApplicationTypeBasedOnUrlHash();});});}});function userHasValidPrivileges(me){return me.privileges&&me.privileges.length>0;}function loadApplicationTypeBasedOnUrlHash(e){var toOpen=F.vertexUrl.parametersInUrl(location.href),vertexIds=toOpen&&toOpen.vertexIds,edgeIds=toOpen&&toOpen.edgeIds,toOpenIds=vertexIds&&vertexIds.length||edgeIds&&edgeIds.length,workspaceId=toOpen&&toOpen.workspaceId,redirectUrl=toOpen&&toOpen.redirectUrl,popoutDetails=!!(toOpen&&toOpen.type==='FULLSCREEN'&&toOpenIds),event=e&&e.originalEvent,mainApp=!popoutDetails,newUrl=window.location.href;if(event&&(isAddUrl(previousUrl)||isRedirectUrl(previousUrl))&&isMainApp(newUrl)){previousUrl=newUrl;return;}if(event&&isPopoutUrl(previousUrl)&&isPopoutUrl(newUrl)){previousUrl=newUrl;return $('#app').trigger('vertexUrlChanged',{vertexIds:vertexIds,edgeIds:edgeIds,workspaceId:workspaceId,redirectUrl:redirectUrl});}previousUrl=newUrl;Promise.all(openlumifyPluginResources.beforeAuth.map(Promise.require)).then(loadUser).then(function(me){if(!userHasValidPrivileges(me)){throw new Error('missing privileges');}attachApplication(false,null,null,me);}).catch(function(){attachApplication(true,'',{});});function attachApplication(loginRequired,message,options,user){if(!event){$('html').toggleClass('fullscreenApp',mainApp).toggleClass('fullscreenDetails',popoutDetails);window.isFullscreenDetails=popoutDetails;}openlumifyData.isFullscreen=false;if(loginRequired){TOTAL_PROGRESS--;updateOpenLumifyLoadingProgress('userinterface');$(document).one('loginSuccess',function(){loadUser().then(function(user){Promise.all(openlumifyPluginResources.afterAuth.map(Promise.require)).catch(function(error){$('#login').trigger('showErrorMessage',{message:i18n('openlumify.loading.progress.pluginerror')});throw error;}).then(function(){loginSuccess({animate:true,user:user});});});});require(['login'],function(Login){removeOpenLumifyLoading().then(function(){Login.teardownAll();Login.attachTo('#login',{errorMessage:message,errorMessageOptions:options,toOpen:toOpen});});});}else{updateOpenLumifyLoadingProgress('extensions',0);var len=openlumifyPluginResources.afterAuth.length,i=0,pluginTimes=[];Promise.all(openlumifyPluginResources.afterAuth.map(function(path){var t0=new Date().getTime();return Promise.require(path).then(function(){var t1=new Date().getTime();pluginTimes.push({path:path,'duration (ms)':t1-t0});updateOpenLumifyLoadingProgress('extensions',++i/len);});})).catch(function(error){removeOpenLumifyLoading('pluginerror');throw error;}).then(function(){updateOpenLumifyLoadingProgress('userinterface');loginSuccess({user:user});}).finally(function(){if(window.console){if('groupCollapsed'in console&&'table'in console){console.groupCollapsed('Plugin Load Metrics');console.log('Later plugins will be slower due to network concurrency limits');console.table(pluginTimes);console.groupEnd();}}});}}function loadUser(){return withDataRequest.dataRequest('user','me');}function loginSuccess(_ref){var _ref$animate=_ref.animate,animate=_ref$animate===undefined?false:_ref$animate,user=_ref.user;if(animate&&/^#?[a-z]+=/i.test(location.hash)){window.location.reload();}else{Promise.resolve(user||loadUser()).then(function(me){if(!userHasValidPrivileges(me)){$('#login .authentication').html('<span style="color: #D42B34;">'+i18n('openlumify.login.missingPrivileges')+'<p/><a class="logout" href="">'+i18n('openlumify.login.logout')+'</a>'+'</span>');return;}require(['util/requirejs/promise!util/service/propertiesPromise','util/formatters','util/jquery/bootstrapTypeaheadScrollFix','bootstrap','easing','jquery-scrollstop','bootstrap-datepicker','bootstrap-timepicker','util/visibility/util','util/handlebars/after_auth_helpers'],function(config,F,bootstrapTypeaheadScrollFix){configureDateFormats(config,F);bootstrapTypeaheadScrollFix();if(popoutDetails){openlumifyData.isFullscreen=true;$('#login').remove();require(['appFullscreenDetails'],function(comp){removeOpenLumifyLoading().then(function(){if(event){location.reload();}else{if(App){App.teardownAll();}FullScreenApp=comp;FullScreenApp.teardownAll();FullScreenApp.attachTo('#app',{vertexIds:vertexIds,edgeIds:edgeIds,workspaceId:workspaceId});}});});}else{if(!animate){$('#login').remove();}require(['app'],function(comp){removeOpenLumifyLoading().then(function(){App=comp;if(event){location.reload();}else{if(FullScreenApp){FullScreenApp.teardownAll();}App.teardownAll();var appOptions={};if(toOpen&&toOpen.type==='ADD'&&vertexIds.length){appOptions.addVertexIds=toOpen;}if(toOpen&&toOpen.type==='ADMIN'&&toOpen.section&&toOpen.name){appOptions.openAdminTool=_.pick(toOpen,'section','name');}if(toOpen&&toOpen.type==='REDIRECT'&&toOpen.redirectUrl){window.location.href=toOpen.redirectUrl;return;}if(toOpen&&toOpen.type==='TOOLS'&&!_.isEmpty(toOpen.tools)){appOptions.openMenubarTools=toOpen.tools;}if(animate){$('#login .authentication button.loading').removeClass('loading');appOptions.animateFromLogin=true;}App.attachTo('#app',appOptions);_.defer(function(){require(['login']);});if(animate){$('#login .logo').one(TRANSITION_END,function(){$('#login').find('.authentication').teardownAllComponents().end().teardownAllComponents();});}}});});}});});}}}function configureDateFormats(config,F){var dateDisplay=config['formats.date.dateDisplay'];var timeDisplay=config['formats.date.timeDisplay'];var showTz=config['formats.date.showTimezone']!=='false';F.date.setDateFormat(dateDisplay);F.date.setTimeFormat(timeDisplay,showTz);$.fn.datepicker.defaults.format=F.date.datepickerFormat();$.fn.datepicker.defaults.autoclose=true;var showMeridian=/(h|a|A)/.test(timeDisplay);$.fn.timepicker.defaults.showMeridian=showMeridian;$.fn.timepicker.defaults.maxHours=showMeridian?12:24;}function updateOpenLumifyLoadingProgress(string,percentInProgress){if(!progressBar){progressBar=$('#openlumify-loading-static .bar')[0];progressBarText=$('#openlumify-loading-static span')[0];}if(progressBar.dataset.finished)return;var translatedString=i18n('openlumify.loading.progress.'+string);if(arguments.length===2&&percentInProgress<1.0){var segment=1/TOTAL_PROGRESS,inc=segment*percentInProgress;progressBarText.textContent=translatedString;progressBar.style.width=Math.round((progress/TOTAL_PROGRESS+inc)*100)+'%';}else{progress++;progressBarText.textContent=translatedString;progressBar.style.width=Math.round(progress/TOTAL_PROGRESS*100)+'%';}}function removeOpenLumifyLoading(error){if(error){progressBar.dataset.finished=true;progressBarText.textContent=i18n('openlumify.loading.progress.'+error);progressBarText.style.color='#D42B34';}else{updateOpenLumifyLoadingProgress('starting');return new Promise(function(fulfill){_.delay(function(){$('#openlumify-loading-static').remove();fulfill();},500);});}}function isPopoutUrl(url){return F.vertexUrl.isFullscreenUrl(url);}function isAddUrl(url){return /#add=/.test(url);}function isRedirectUrl(url){return /#redirect=/.test(url);}function isMainApp(url){return /#\s*$/.test(url)||url.indexOf('#')===-1;}function lockDownUnderscore(_){Object.defineProperty(window,'_',{value:_,writable:false});}});
//# sourceMappingURL=openlumify.js.map
