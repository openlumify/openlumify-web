{"version":3,"sources":["../../../../js/comments/dropdowns/commentForm/commentForm.js"],"names":["define","defineComponent","withDropdown","commentTemplate","alertTemplate","F","withDataRequest","CommentForm","defaultAttrs","inputSelector","primarySelector","visibilityInputSelector","before","n","c","manualOpen","after","self","on","onChange","onSave","onVisibilityChange","$node","html","graphVertexId","attr","data","id","commentText","comment","value","select","focus","require","Visibility","attachTo","find","metadata","source","checkValid","event","visibilitySource","visibilityJson","params","name","key","getValue","path","sourceInfo","oldVisibilitySource","buttonLoading","dataRequest","type","then","teardown","catch","error","markFieldErrors","clearLoading","$","trim","val","visibilityValid","valid","length","prop","toggleClass"],"mappings":"AAAAA,OAAO,CACH,sBADG,CAEH,mBAFG,CAGH,mBAHG,CAIH,gBAJG,CAKH,wBALG,CAMH,sBANG,CAAP,CAOG,SACCC,eADD,CAECC,YAFD,CAGCC,eAHD,CAICC,aAJD,CAKCC,CALD,CAMCC,eAND,CAMkB,CACjB,aAEA,MAAOL,iBAAgBM,WAAhB,CAA6BL,YAA7B,CAA2CI,eAA3C,CAAP,CAEA,QAASC,YAAT,EAAuB,CAEnB,KAAKC,YAAL,CAAkB,CACdC,cAAe,UADD,CAEdC,gBAAiB,cAFH,CAGdC,wBAAyB,mBAHX,CAAlB,EAMA,KAAKC,MAAL,CAAY,YAAZ,CAA0B,SAASC,CAAT,CAAYC,CAAZ,CAAe,CACrCA,EAAEC,UAAF,CAAe,IAAf,CACH,CAFD,EAIA,KAAKC,KAAL,CAAW,YAAX,CAAyB,UAAW,CAChC,GAAIC,MAAO,IAAX,CAEA,KAAKC,EAAL,CAAQ,oBAAR,CAA8B,CAC1BT,cAAe,KAAKU,QADM,CAA9B,EAGA,KAAKD,EAAL,CAAQ,OAAR,CAAiB,CACbR,gBAAiB,KAAKU,MADT,CAAjB,EAGA,KAAKF,EAAL,CAAQ,kBAAR,CAA4B,KAAKG,kBAAjC,EAEA,KAAKC,KAAL,CAAWC,IAAX,CAAgBpB,gBAAgB,CAC5BqB,cAAe,KAAKC,IAAL,CAAUC,IAAV,CAAeC,EAAf,EAAqB,EADR,CAE5BC,YAAa,KAAKH,IAAL,CAAUI,OAAV,EAAqB,KAAKJ,IAAL,CAAUI,OAAV,CAAkBC,KAAvC,EAAgD,EAFjC,CAAhB,CAAhB,EAKA,KAAKZ,EAAL,CAAQ,QAAR,CAAkB,UAAW,CACzB,KAAKa,MAAL,CAAY,eAAZ,EAA6BC,KAA7B,GACH,CAFD,EAIAC,QAAQ,CACJ,sBADI,CAAR,CAEG,SAASC,UAAT,CAAqB,CACpBA,WAAWC,QAAX,CAAoBlB,KAAKK,KAAL,CAAWc,IAAX,CAAgB,aAAhB,CAApB,CAAoD,CAChDN,MAAOb,KAAKQ,IAAL,CAAUI,OAAV,EACHZ,KAAKQ,IAAL,CAAUI,OAAV,CAAkBQ,QADf,EAEHpB,KAAKQ,IAAL,CAAUI,OAAV,CAAkBQ,QAAlB,CAA2B,sCAA3B,CAFG,EAGHpB,KAAKQ,IAAL,CAAUI,OAAV,CAAkBQ,QAAlB,CAA2B,sCAA3B,EAAmEC,MAJvB,CAApD,EAMArB,KAAKF,UAAL,GACH,CAVD,EAYA,KAAKwB,UAAL,GACH,CAjCD,EAmCA,KAAKpB,QAAL,CAAgB,SAASqB,KAAT,CAAgB,CAC5B,KAAKD,UAAL,GACH,CAFD,CAIA,KAAKlB,kBAAL,CAA0B,SAASmB,KAAT,CAAgBd,IAAhB,CAAsB,CAC5C,KAAKe,gBAAL,CAAwBf,IAAxB,CACA,KAAKa,UAAL,GACH,CAHD,CAKA,KAAKnB,MAAL,CAAc,SAASoB,KAAT,CAAgB,CAC1B,GAAIvB,MAAO,IAAX,CACIY,QAAU,KAAKJ,IAAL,CAAUI,OADxB,CAEIQ,SAAWR,SAAWA,QAAQQ,QAFlC,CAGIK,eAAiBL,UAAYA,SAAS,sCAAT,CAHjC,CAIIM,OAAS,CACLC,KAAM,qCADD,CAELC,IAAKhB,SAAWA,QAAQgB,GAFnB,CAGLf,MAAO,KAAKgB,QAAL,EAHF,CAILT,SAAU,KAAKZ,IAAL,CAAUsB,IAAV,EAAkB,CACxB,qCAAsC,KAAKtB,IAAL,CAAUsB,IADxB,CAJvB,CAOLN,iBAAkB,KAAKA,gBAAL,EAAyB,KAAKA,gBAAL,CAAsBX,KAA/C,EAAwD,EAPrE,CAQLkB,WAAY,KAAKvB,IAAL,CAAUuB,UARjB,CAJb,CAeA,GAAIN,cAAJ,CAAoB,CAChBC,OAAOM,mBAAP,CAA6BP,eAAeJ,MAA5C,CACH,CAED,KAAKY,aAAL,GAEA,KAAKC,WAAL,CAAiB,KAAK1B,IAAL,CAAU2B,IAA3B,CAAiC,aAAjC,CAAgD,KAAK3B,IAAL,CAAUC,IAAV,CAAeC,EAA/D,CAAmEgB,MAAnE,EACKU,IADL,CACU,UAAW,CACbpC,KAAKqC,QAAL,GACH,CAHL,EAIKC,KAJL,CAIW,SAASC,KAAT,CAAgB,CACnBvC,KAAKwC,eAAL,CAAqBD,KAArB,EACAvC,KAAKyC,YAAL,GACH,CAPL,EAQH,CA9BD,CAgCA,KAAKZ,QAAL,CAAgB,UAAW,CACvB,MAAOa,GAAEC,IAAF,CAAO,KAAK7B,MAAL,CAAY,eAAZ,EAA6B8B,GAA7B,EAAP,CAAP,CACH,CAFD,CAIA,KAAKtB,UAAL,CAAkB,UAAW,CACzB,GAAIsB,KAAM,KAAKf,QAAL,EAAV,CACA,GAAIgB,iBAAkB,KAAKrB,gBAAL,EAAyB,KAAKA,gBAAL,CAAsBsB,KAArE,CAEA,GAAIF,IAAIG,MAAJ,EAAcF,eAAlB,CAAmC,CAC/B,KAAK/B,MAAL,CAAY,iBAAZ,EAA+BkC,IAA/B,CAAoC,UAApC,CAAgD,KAAhD,EACH,CAFD,IAEO,CACH,KAAKlC,MAAL,CAAY,iBAAZ,EAA+BkC,IAA/B,CAAoC,UAApC,CAAgD,IAAhD,EACH,CAED,KAAKlC,MAAL,CAAY,yBAAZ,EAAuCmC,WAAvC,CAAmD,SAAnD,CAA8D,CAACJ,eAA/D,EACH,CAXD,CAYH,CACJ,CA3HD","file":"commentForm.js","sourcesContent":["define([\n    'flight/lib/component',\n    'util/withDropdown',\n    './commentForm.hbs',\n    'tpl!util/alert',\n    'util/vertex/formatters',\n    'util/withDataRequest'\n], function(\n    defineComponent,\n    withDropdown,\n    commentTemplate,\n    alertTemplate,\n    F,\n    withDataRequest) {\n    'use strict';\n\n    return defineComponent(CommentForm, withDropdown, withDataRequest);\n\n    function CommentForm() {\n\n        this.defaultAttrs({\n            inputSelector: 'textarea',\n            primarySelector: '.btn-primary',\n            visibilityInputSelector: '.visibility input'\n        });\n\n        this.before('initialize', function(n, c) {\n            c.manualOpen = true;\n        })\n\n        this.after('initialize', function() {\n            var self = this;\n\n            this.on('change keyup paste', {\n                inputSelector: this.onChange\n            });\n            this.on('click', {\n                primarySelector: this.onSave\n            });\n            this.on('visibilitychange', this.onVisibilityChange);\n\n            this.$node.html(commentTemplate({\n                graphVertexId: this.attr.data.id || '',\n                commentText: this.attr.comment && this.attr.comment.value || ''\n            }));\n\n            this.on('opened', function() {\n                this.select('inputSelector').focus();\n            });\n\n            require([\n                'util/visibility/edit'\n            ], function(Visibility) {\n                Visibility.attachTo(self.$node.find('.visibility'), {\n                    value: self.attr.comment &&\n                        self.attr.comment.metadata &&\n                        self.attr.comment.metadata['http://openlumify.org#visibilityJson'] &&\n                        self.attr.comment.metadata['http://openlumify.org#visibilityJson'].source\n                });\n                self.manualOpen();\n            });\n\n            this.checkValid();\n        });\n\n        this.onChange = function(event) {\n            this.checkValid();\n        };\n\n        this.onVisibilityChange = function(event, data) {\n            this.visibilitySource = data;\n            this.checkValid();\n        };\n\n        this.onSave = function(event) {\n            var self = this,\n                comment = this.attr.comment,\n                metadata = comment && comment.metadata,\n                visibilityJson = metadata && metadata['http://openlumify.org#visibilityJson'],\n                params = {\n                    name: 'http://openlumify.org/comment#entry',\n                    key: comment && comment.key,\n                    value: this.getValue(),\n                    metadata: this.attr.path && {\n                        'http://openlumify.org/comment#path': this.attr.path\n                    },\n                    visibilitySource: this.visibilitySource && this.visibilitySource.value || '',\n                    sourceInfo: this.attr.sourceInfo\n                };\n\n            if (visibilityJson) {\n                params.oldVisibilitySource = visibilityJson.source;\n            }\n\n            this.buttonLoading();\n\n            this.dataRequest(this.attr.type, 'setProperty', this.attr.data.id, params)\n                .then(function() {\n                    self.teardown();\n                })\n                .catch(function(error) {\n                    self.markFieldErrors(error);\n                    self.clearLoading();\n                })\n        };\n\n        this.getValue = function() {\n            return $.trim(this.select('inputSelector').val());\n        };\n\n        this.checkValid = function() {\n            var val = this.getValue();\n            var visibilityValid = this.visibilitySource && this.visibilitySource.valid;\n\n            if (val.length && visibilityValid) {\n                this.select('primarySelector').prop('disabled', false);\n            } else {\n                this.select('primarySelector').prop('disabled', true);\n            }\n\n            this.select('visibilityInputSelector').toggleClass('invalid', !visibilityValid)\n        }\n    }\n});\n"]}