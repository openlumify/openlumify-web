{"version":3,"sources":["../../js/comments/comments.js"],"names":["define","defineComponent","template","CommentForm","withCollapsibleSections","F","withDataRequest","config","withPropertyInfo","d3","VISIBILITY_NAME","Comments","toCommentTree","properties","comments","_","chain","where","name","sortBy","p","key","value","maxDepth","total","length","userIds","unique","map","c","metadata","commentsByKey","indexBy","a","rootComments","filter","roots","forEach","comment","path","components","split","Math","max","i","redacted","push","getCreated","isLegacyKeyInServerTimezone","test","date","time","Date","getTime","isNaN","undefined","utc","local","millis","isEdited","created","modified","equalTolerance","attributes","data","ignoreUpdateModelNotImplemented","after","dataRequest","then","showVisibility","on","onEditComment","type","vertex","isEdge","attr","document","onVerticesUpdated","onEdgesUpdated","onCommentOnSelection","onEditProperty","onDeleteProperty","$node","html","update","event","trigger","sourceInfo","vertices","findWhere","id","edge","edges","renderCommentLevel","level","selection","self","enter","append","call","order","select","classed","each","datum","$","i18n","escape","replace","textContent","hide","visibility","$this","currentUserId","newUserId","currentText","text","loading","dateDisplay","relativeString","relativeToNow","dateTimeString","modifiedStr","createdStr","relativeModifiedStr","relativeCreatedStr","closest","children","hasClass","string","plural","property","toggleClass","showPropertyInfo","exit","teardownAllComponents","remove","nextLevel","subselection","selectAll","commentsTreeResponse","commentsTree","find","get","done","users","usersById","object","number","pretty","toggle","hidePropertyInfo","target","root","commentRow","insertBefore","removeClass","appendTo","addClass","teardownAll","attachTo"],"mappings":"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","file":"comments.js","sourcesContent":["define([\n    'flight/lib/component',\n    './template.hbs',\n    './dropdowns/commentForm/commentForm',\n    'util/withCollapsibleSections',\n    'util/vertex/formatters',\n    'util/withDataRequest',\n    'util/requirejs/promise!util/service/propertiesPromise',\n    'util/popovers/propertyInfo/withPropertyInfo',\n    'd3'\n], function(\n    defineComponent,\n    template,\n    CommentForm,\n    withCollapsibleSections,\n    F,\n    withDataRequest,\n    config,\n    withPropertyInfo,\n    d3) {\n    'use strict';\n\n    var VISIBILITY_NAME = 'http://openlumify.org#visibilityJson';\n\n    return defineComponent(Comments, withCollapsibleSections, withDataRequest, withPropertyInfo);\n\n    function toCommentTree(properties) {\n        var comments = _.chain(properties)\n                .where({ name: 'http://openlumify.org/comment#entry' })\n                .sortBy(function(p) {\n                    return p.key;\n                })\n                .value(),\n            maxDepth = 1,\n            total = comments.length,\n            userIds = _.unique(_.map(comments, function(c) {\n                return c.metadata['http://openlumify.org#modifiedBy'];\n            })),\n            commentsByKey = _.indexBy(_.map(comments, function(c) {\n                return [c, []];\n            }), function(a) {\n                return a[0].key;\n            }),\n            rootComments = _.filter(comments, function(p) {\n                return !p.metadata['http://openlumify.org/comment#path'];\n            }),\n            roots = [];\n\n        comments.forEach(function(comment) {\n            var path = comment.metadata['http://openlumify.org/comment#path'];\n            if (path) {\n                var components = path.split('/');\n                maxDepth = Math.max(maxDepth, components.length + 1);\n                components.forEach(function(key, i, components) {\n                    var value = commentsByKey[key];\n                    if (!value) {\n                        total++;\n                        value = commentsByKey[key] = [{\n                            key: key,\n                            redacted: true,\n                            metadata: {\n                                'http://openlumify.org#modifiedDate': ''\n                            }\n                        }, []];\n                        if (i === 0) {\n                            roots.push(value);\n                        } else {\n                            commentsByKey[components[i - 1]][1].push(value);\n                        }\n                    }\n                    if (i === (components.length - 1)) {\n                        value[1].push(commentsByKey[comment.key]);\n                    }\n                });\n            } else {\n                roots.push(commentsByKey[comment.key])\n            }\n        });\n\n        return {\n            roots: roots,\n            userIds: userIds,\n            maxDepth: maxDepth,\n            total: total\n        };\n    }\n\n    function getCreated(p) {\n        // setProperty would set key in servers timezone instead of UTC\n        var isLegacyKeyInServerTimezone = !(/Z$/).test(p.key),\n            date = null;\n        if (isLegacyKeyInServerTimezone) {\n            var time = new Date(p.key + 'Z').getTime();\n            if (isNaN(time)) {\n                return undefined;\n            }\n            date = F.date.utc(time);\n        } else {\n            date = F.date.local(p.key);\n        }\n        var millis = date && date.getTime();\n        if (millis && !isNaN(millis)) {\n            return millis;\n        }\n        return undefined;\n    }\n\n    function isEdited(created, modified) {\n        var equalTolerance = 1000;\n        return (modified - created) > equalTolerance\n    }\n\n    function Comments() {\n\n        this.attributes({\n            data: null,\n            ignoreUpdateModelNotImplemented: true\n        });\n\n        this.after('initialize', function() {\n            this.dataRequest('config', 'properties').then((config) => {\n                this.showVisibility = config['showVisibilityInDetailsPane'];\n                this.on('editComment', this.onEditComment);\n\n                this.type = F.vertex.isEdge(this.attr.data) ? 'edge' : 'vertex';\n                if (this.type === 'vertex') {\n                    this.on(document, 'verticesUpdated', this.onVerticesUpdated);\n                } else if (this.type === 'edge') {\n                    this.on(document, 'edgesUpdated', this.onEdgesUpdated);\n                }\n\n                this.on('commentOnSelection', this.onCommentOnSelection);\n                this.on('editProperty', this.onEditProperty);\n                this.on('deleteProperty', this.onDeleteProperty);\n\n                this.$node.html(template({}));\n                this.update();\n            });\n        });\n\n        this.onCommentOnSelection = function(event, data) {\n            this.trigger('editComment', {\n                sourceInfo: data\n            });\n        };\n\n        this.onVerticesUpdated = function(event, data) {\n            var vertex = data && data.vertices && _.findWhere(data.vertices, { id: this.attr.data.id });\n            if (vertex) {\n                this.attr.data = vertex;\n                this.update();\n            }\n        };\n\n        this.onEdgesUpdated = function(event, data) {\n            var edge = data && data.edges && _.findWhere(data.edges, { id: this.attr.data.id });\n            if (edge) {\n                this.attr.data = edge;\n                this.update();\n            }\n        };\n\n        this.renderCommentLevel = function(maxDepth, level, selection) {\n            var self = this;\n\n            if (level > maxDepth) {\n                return;\n            }\n\n            selection.enter()\n                .append('li').attr('class', 'comment comment-' + level)\n                .call(function() {\n                    this.append('div').attr('class', 'wrap')\n                        .call(function() {\n                            this.append('div').attr('class', 'comment-text');\n                            if (self.showVisibility !== 'false') {\n                                this.append('span').attr('class', 'visibility');\n                            }\n                            this.append('span').attr('class', 'user');\n                            this.append('span').attr('class', 'date');\n                            this.append('button').attr('class', 'info');\n                            this.append('button').attr('class', 'replies btn-link btn');\n                        });\n                    this.append('ul').attr('class', 'collapsed');\n                });\n\n            selection.order();\n            selection.select('.comment-text')\n                .classed('redacted', function(p) {\n                    return p[0].redacted || false;\n                })\n                .each(function() {\n                    var p = d3.select(this).datum();\n                    if (p[0].redacted) {\n                        $(this).html(\n                            i18n('detail.comments.missing') +\n                            '<p>' +\n                            i18n('detail.comments.missing.explanation') +\n                            '</p>'\n                        );\n                    } else {\n                        $(this).html(_.escape('\\n' + p[0].value).replace(/\\r?\\n+/g, '<p>'));\n                    }\n                });\n            if (self.showVisibility !== 'false') {\n                selection.select('.visibility').each(function(p) {\n                    this.textContent = '';\n                    if (p[0].redacted) {\n                        $(this).hide();\n                        return;\n                    }\n                    F.vertex.properties.visibility(\n                        this,\n                        {value: p[0].metadata && p[0].metadata[VISIBILITY_NAME]},\n                        self.attr.data.id\n                    );\n                });\n            }\n            selection.select('.user').each(function(p, i) {\n                var $this = $(this);\n                if (p[0].redacted) {\n                    $this.hide();\n                } else {\n                    var currentUserId = $this.data('userId'),\n                        newUserId = p[0].metadata['http://openlumify.org#modifiedBy'],\n                        currentText = $this.text(),\n                        loading = i18n('detail.comments.user.loading');\n                    if ((!currentUserId || currentUserId === newUserId) &&\n                        (!currentText || currentText === loading)) {\n                        $this.data('userId', newUserId).text(loading);\n                    }\n                }\n            });\n            var dateDisplay = config['date.default.display'];\n\n            selection.select('.date')\n                .attr('style', function(p) {\n                    return p[0].redacted ? 'display:none' : undefined;\n                })\n                .text(function(p) {\n                    if (p[0].redacted) {\n                        return '';\n                    }\n                    var modified = p[0].metadata['http://openlumify.org#modifiedDate'],\n                        created = getCreated(p[0]) || modified,\n                        relativeString = modified && F.date.relativeToNow(F.date.utc(modified)),\n                        dateTimeString = modified && F.date.dateTimeString(modified);\n\n                    if (dateDisplay === 'exact' && dateTimeString) {\n                        if (isEdited(created, modified)) {\n                            return i18n('detail.comments.date.edited', dateTimeString);\n                        }\n                        return dateTimeString;\n                    } else if (relativeString) {\n                        if (isEdited(created, modified)) {\n                            return i18n('detail.comments.date.edited', relativeString);\n                        }\n                        return relativeString;\n                    }\n                    return '';\n                })\n                .attr('title', function(p) {\n                    if (p[0].redacted) {\n                        return '';\n                    }\n                    var modified = p[0].metadata['http://openlumify.org#modifiedDate'],\n                        created = getCreated(p[0]) || modified,\n                        modifiedStr = modified && F.date.dateTimeString(modified) || '',\n                        createdStr = created && F.date.dateTimeString(created) || '',\n                        relativeModifiedStr = modified && F.date.relativeToNow(F.date.utc(modified)) || '',\n                        relativeCreatedStr = created && F.date.relativeToNow(F.date.utc(created)) || '';\n\n                    if (isEdited(created, modified)) {\n                        if (dateDisplay === 'exact') {\n                            return i18n('detail.comments.date.hover.edited', relativeCreatedStr, relativeModifiedStr);\n                        } else {\n                            return i18n('detail.comments.date.hover.edited', createdStr, modifiedStr);\n                        }\n                    }\n                    return dateDisplay === 'exact' ? relativeModifiedStr : modifiedStr;\n                });\n            selection.select('.replies')\n                .attr('style', function(p) {\n                    if (p[1].length === 0) {\n                        return 'display:none';\n                    }\n                })\n                .classed('open', function() {\n                    return !$(this).closest('li').children('ul').hasClass('collapsed');\n                })\n                .text(function(p) {\n                    return F.string.plural(p[1].length, 'reply', 'replies');\n                })\n                .on('click', function(property) {\n                    $(this).toggleClass('open')\n                        .closest('li').children('ul').toggleClass('collapsed')\n                });\n            selection.select('.info')\n                .attr('style', function(p) {\n                    return p[0].redacted ? 'display:none' : undefined;\n                })\n                .on('click', function(property) {\n                    if (property[0].redacted) {\n                        return;\n                    }\n                    self.showPropertyInfo(this, self.attr.data, property[0]);\n                });\n            selection.exit()\n                .call(function() {\n                    this.select('.info').each(function() {\n                        $(this).teardownAllComponents();\n                    })\n                })\n                .remove();\n\n            var nextLevel = level + 1,\n                subselection = selection\n                    .select(function() {\n                        return $(this).children('ul')[0];\n                    })\n                    .selectAll('.comment-' + nextLevel)\n                    .data(function(p) {\n                        return p[1] || [];\n                    });\n\n            this.renderCommentLevel(maxDepth, nextLevel, subselection);\n        };\n\n        this.update = function() {\n            var commentsTreeResponse = toCommentTree(this.attr.data.properties),\n                commentsTree = commentsTreeResponse.roots,\n                selection = d3.select(this.$node.find('.comment-content ul').get(0))\n                    .selectAll('.comment-0')\n                    .data(commentsTree);\n\n            this.renderCommentLevel(commentsTreeResponse.maxDepth, 0, selection);\n            this.dataRequest('user', 'getUserNames', commentsTreeResponse.userIds)\n                .done((users) => {\n                    var usersById = _.object(commentsTreeResponse.userIds, users);\n                    this.$node.find('.user').each(function() {\n                        $(this).text(usersById[$(this).data('userId')]);\n                    })\n                });\n\n            this.$node.find('.badge').text(\n                F.number.pretty(commentsTreeResponse.total)\n            );\n            this.$node.find('.collapsible-header').toggle(commentsTreeResponse.total > 0);\n        };\n\n        this.onEditProperty = function(event, data) {\n            this.onEditComment(event, { path: data.path, comment: data.property });\n        };\n\n        this.onDeleteProperty = function(event, data) {\n            var self = this;\n            this.dataRequest(this.type, 'deleteProperty',\n                this.attr.data.id, data.property\n            ).then(function() {\n                self.hidePropertyInfo($(event.target));\n            });\n        };\n\n        this.onEditComment = function(event, data) {\n            var root = $('<div class=\"underneath\">'),\n                comment = data && data.comment,\n                path = data && data.path,\n                sourceInfo = data && data.sourceInfo,\n                commentRow = (comment || path) && $(event.target).closest('li').children('ul');\n\n            if (commentRow && commentRow.length) {\n                root.insertBefore(commentRow)\n                if (path) {\n                    commentRow.removeClass('collapsed')\n                }\n            } else {\n                root.appendTo(this.$node.find('.comment-content'));\n            }\n\n            this.$node.find('.collapsible').addClass('expanded');\n\n            CommentForm.teardownAll();\n            CommentForm.attachTo(root, {\n                data: this.attr.data,\n                type: this.type,\n                path: path,\n                sourceInfo: sourceInfo,\n                comment: comment\n            });\n        };\n\n    }\n});\n"]}