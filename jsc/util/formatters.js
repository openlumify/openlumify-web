define(['sf','chrono','jstz','duration-js','util/messages','util/requirejs/promise!util/service/propertiesPromise','util/parsers','moment','moment-timezone','jquery','underscore'],function(sf,chrono,jstz,Duration,i18n,configProperties,P,moment){'use strict';var language='en';try{var languagePref=localStorage.getItem('language');if(languagePref){language=languagePref;}}catch(langerror){}moment.locale(language);var BITS_FOR_INDEX=12,BITS_FOR_OFFSET=32-BITS_FOR_INDEX,SERVER_DATE='YYYY-MM-DD',SERVER_TIME='HH:mm',MOMENT_FORMAT=SERVER_DATE+' '+SERVER_TIME,MOMENT_FORMAT_TZ=MOMENT_FORMAT+' Z',dateFormat,timeFormat,showTz,_datepickerFormat,classNameIndex=0,toClassNameMap={},fromClassNameMap={},isMac=checkIfMac(),isFirefox=~navigator.userAgent.indexOf('Firefox'),keyboardMappings={metaIcons:{shift:isMac?'⇧':i18n('keyboard.shift'),meta:isMac?'⌘':i18n('keyboard.ctrl'),ctrl:isMac?'⌃':i18n('keyboard.ctrl'),alt:isMac?'⌥':i18n('keyboard.alt')},charIcons:{esc:isMac?'⎋':null,escape:isMac?'⎋':i18n('keyboard.escape'),'delete':isMac?'⌫':null,backspace:isMac?'⌦':null,up:'↑',down:'↓',left:'←',right:'→'}};function checkIfMac(){return~navigator.userAgent.indexOf('Mac OS X');}function convertToDatePickerFormat(){return dateFormat.replace(/M+/g,function(v){return['m','mm','M','MM'][v.length-1];}).replace(/D+/g,function(v){return['d','dd'][v.length-1];}).replace(/d{3,4}/g,function(v){return['D','DD'][v.length-3];}).replace(/Y{2,}/g,function(v){return v.length===2?'yy':'yyyy';});}function checkDateTimeFormat(format,type){try{var output=moment().format(format);if(!output||!output.length||output===format){throw new Error('Date format invalid');}if(type==='date'&&!/^(M+|D+|d{3,4}|YY|YYYY|[^a-zA-Z\d])+$/.test(format)){throw new Error('Date format includes unsupported characters',format);}else if(type==='time'&&!/^(H+|h+|m+|a|A|[^a-zA-Z\d])+$/.test(format)){throw new Error('Time format includes unsupported characters',format);}}catch(e){console.error('Date Format is invalid: '+format+'. Check configuration parameter: web.ui.format.date.'+type+'Display');return false;}return true;}function codeForCharacter(character){var special={backspace:8,tab:9,clear:12,enter:13,'return':13,esc:27,escape:27,space:32,left:37,up:38,right:39,down:40,del:46,'delete':46,home:36,end:35,pageup:33,pagedown:34,',':188,'.':190,'/':191,'`':192,'-':189,'=':187,';':186,'\'':222,'[':219,']':221,'\\':220};if(isMac){special.del=special.delete=special.backspace;}return special[character.toLowerCase()]||character.toUpperCase().charCodeAt(0);}function decimalAdjust(type,value,exp){if(typeof exp==='undefined'||parseFloat(exp)===0){return Math[type](value);}value=parseFloat(value);exp=parseFloat(exp);if(isNaN(value)||!(typeof exp==='number'&&exp%1===0)){return NaN;}value=value.toString().split('e');value=Math[type](parseFloat(value[0]+'e'+(value[1]?parseFloat(value[1])-exp:-exp)));value=value.toString().split('e');return parseFloat(value[0]+'e'+(value[1]?parseFloat(value[1])+exp:exp));}var FORMATTERS={number:{pretty:function pretty(number){if(_.isString(number)){number=parseFloat(number);}if(_.isNumber(number)){return sf('{0:#.##}',number).split('').reverse().join('').replace(/(\d{3}(?=\d))/g,'$1,').split('').reverse().join('');}return'';},prettyApproximate:function prettyApproximate(number){var isNegative=number<0.0,abs=Math.abs(number),result;if(abs>=1000000000000){result=decimalAdjust('round',abs/1000000000000,-1)+i18n('numbers.trillion_suffix');}else if(abs>=1000000000){result=decimalAdjust('round',abs/1000000000,-1)+i18n('numbers.billion_suffix');}else if(abs>=1000000){result=decimalAdjust('round',abs/1000000,-1)+i18n('numbers.million_suffix');}else if(abs>=1000){result=decimalAdjust('round',abs/1000,-1)+i18n('numbers.thousand_suffix');}else result=FORMATTERS.number.pretty(abs);return(isNegative?'-':'')+result;},percent:function percent(number){if(_.isString(number)){number=parseFloat(number);}return Math.round(number*100)+'%';},offsetValues:function offsetValues(value){var offsetMask=(1<<BITS_FOR_INDEX)-1;return{index:value>>BITS_FOR_OFFSET,offset:value&offsetMask};},compactOffsetValues:function compactOffsetValues(index,offset){return index<<BITS_FOR_OFFSET|offset;},heading:function heading(value){if(_.isUndefined(value)){return;}var inRange=value%360;return i18n('field.heading.'+['north','northeast','east','southeast','south','southwest','west','northwest'][Math.round(inRange/45)%8])+' '+FORMATTERS.number.pretty(inRange)+'°';},duration:function duration(value){if(!_.isNumber(value)&&!$.trim(value).length){return'';}else if(value===0){return'0s';}else{if(_.isNumber(value)){value=Math.floor(value);}return new Duration(value+'s').toString().replace(/(ms|[wdhms])/g,'$1 ').trim();}}},boolean:{pretty:function pretty(bool){if(_.isUndefined(bool)||_.isString(bool)&&_.isEmpty(bool))return'';if(bool==='T')bool=true;if(bool==='F')bool=false;return bool&&bool!=='false'?i18n('boolean.true'):i18n('boolean.false');}},bytes:{pretty:function pretty(bytes,precision){var k=1024,m=k*1024,g=m*1024,t=g*1024;precision=_.isUndefined(precision)?1:precision;if(bytes>=0&&bytes<k){return bytes+' '+i18n('bytes.suffix');}else if(bytes>=k&&bytes<m){return(bytes/k).toFixed(precision)+' '+i18n('bytes.kilo');}else if(bytes>=m&&bytes<g){return(bytes/m).toFixed(precision)+' '+i18n('bytes.mega');}else if(bytes>=g&&bytes<t){return(bytes/g).toFixed(precision)+' '+i18n('bytes.giga');}else if(bytes>=t){return(bytes/t).toFixed(precision)+' '+i18n('bytes.tera');}else{return bytes+' '+i18n('bytes.suffix');}}},className:{from:function from(className){var original=fromClassNameMap[className];if(!original){console.error('Never created a class for ',original);}return original;},to:function to(string){var className=toClassNameMap[string];if(!className){className=toClassNameMap[string]='id'+classNameIndex++;}fromClassNameMap[className]=string;return className;}},directoryEntity:{pretty:function pretty(directoryEntity){if(directoryEntity&&directoryEntity.type){var prettyType=directoryEntity.type==='group'?i18n('field.directory.group'):i18n('field.directory.person');return directoryEntity.displayName+' ('+prettyType+')';}else{return'';}},requestPretty:function requestPretty(id){if(!id){return Promise.resolve(null);}return Promise.require('util/withDataRequest').then(function(dr){return dr.dataRequest('directory','getById',id);}).then(function(value){return FORMATTERS.directoryEntity.pretty(value);});}},geoLocation:{parse:function parse(str){var m=str&&str.match(/\s*point(?:\[|\()(.*?),(.*?)(?:\]|\))\s*/i);if(m){var latitude=m[1],longitude=m[2];return{latitude:latitude,longitude:longitude};}},pretty:function pretty(geo,withholdDescription){if(_.isString(geo)){var parsed=FORMATTERS.geoLocation.parse(geo);if(parsed){return FORMATTERS.geoLocation.pretty(parsed);}else{return geo;}}if(geo&&'latitude'in geo&&'longitude'in geo){var latlon=(_.isNumber(geo.latitude)?geo.latitude:parseFloat(geo.latitude)).toFixed(3)+', '+(_.isNumber(geo.longitude)?geo.longitude:parseFloat(geo.longitude)).toFixed(3);if(withholdDescription!==true&&geo.description){return geo.description+' '+latlon;}return latlon;}}},object:{shortcut:function shortcut(key){var normalized=key.replace(/\+/g,'-').toUpperCase();if(normalized==='UNDO'){normalized='META-Z';}else if(normalized==='REDO'){normalized=isMac?'SHIFT-META-Z':'META-Y';}var forLookup=normalized;var parts=normalized!=='-'?normalized.split('-'):['-'];var shortcut={normalized:normalized,forEventLookup:normalized};if(parts.length===1){shortcut.keyCode=codeForCharacter(parts[0]);shortcut.character=parts[0];shortcut.forEventLookup=shortcut.keyCode;}else if(parts.length===2){shortcut.keyCode=codeForCharacter(parts[1]);shortcut.character=parts[1];shortcut[parts[0].toLowerCase()+'Key']=true;shortcut.forEventLookup=parts[0]+'-'+shortcut.keyCode;}else if(parts.length===3){shortcut.keyCode=codeForCharacter(parts[2]);shortcut.character=parts[2];shortcut[parts[0].toLowerCase()+'Key']=true;shortcut[parts[1].toLowerCase()+'Key']=true;shortcut.forEventLookup=parts[0]+'-'+parts[1]+'-'+shortcut.keyCode;}else return console.warn('Unable to add shortcut ',key);return shortcut;}},string:{normalizeAccents:function normalizeAccents(str){return str.replace(/[áàãâä]/gi,'a').replace(/[éè¨ê]/gi,'e').replace(/[íìïî]/gi,'i').replace(/[óòöôõ]/gi,'o').replace(/[úùüû]/gi,'u').replace(/[ç]/gi,'c').replace(/[ñ]/gi,'n');},shortcut:function shortcut(character,metaKeys){if(!metaKeys){metaKeys=FORMATTERS.object.shortcut(character);character=metaKeys.character;}var result='';character=keyboardMappings.charIcons[character.toLowerCase()]||(character.length>1?character.toLowerCase():character);if(metaKeys.metaKey){result+=keyboardMappings.metaIcons.meta+(isMac?'':'+');}if(metaKeys.ctrlKey){result+=keyboardMappings.metaIcons.ctrl+(isMac?'':'+');}if(metaKeys.altKey){result+=keyboardMappings.metaIcons.alt+(isMac?'':'+');}if(metaKeys.shiftKey){result+=keyboardMappings.metaIcons.shift+(isMac?'':'+');}result+=character;return result;},plural:function plural(count,singular,_plural){_plural=_plural||singular+'s';switch(count){case 0:return'No '+_plural;case 1:return'1 '+singular;default:return FORMATTERS.number.pretty(count)+' '+_plural;}},truncate:function truncate(str,words){var maxChars=7*words,string=$.trim(str),wordsArray=string.split(/\s+/),truncated=wordsArray.slice(0,words).join(' '),ellipsis='…',replacePunctuation=function replacePunctuation(str){return str.replace(/[,;:?.!]+$/,'');};if(truncated.length>maxChars){truncated=replacePunctuation(string.substring(0,maxChars))+ellipsis;}else if(truncated!==string.replace(/\s+/g,' ')){truncated=replacePunctuation(truncated)+ellipsis;}return truncated;},phoneNumber:function phoneNumber(str){str=(_.isNumber(str)?''+str:str)||'';var match=str.match(/^([0-9]{3})?[-. ]?([0-9]{3})?[-. ]?([0-9]{4})$/);if(match){match.shift();return _.compact(match).join('-');}return str;},ssn:function ssn(str){str=(_.isNumber(str)?''+str:str)||'';var match=str.match(/^([0-9]{3})?[-. ]?([0-9]{2})?[-. ]?([0-9]{4})$/);if(match){match.shift();return _.compact(match).join('-');}return str;},uppercase:function uppercase(str){return(str||'').toUpperCase();},lowercase:function lowercase(str){return(str||'').toLowerCase();},prettyPrint:function prettyPrint(str){return(str||'').replace(/\w[^-\s]*/g,function(txt){return txt.charAt(0).toUpperCase()+txt.substr(1).toLowerCase();});}},date:{resetToDefaultDateFormat:function resetToDefaultDateFormat(){dateFormat=SERVER_DATE;_datepickerFormat=null;timeFormat=SERVER_TIME;showTz=true;},datepickerFormat:function datepickerFormat(){if(!_datepickerFormat){_datepickerFormat=convertToDatePickerFormat();}return _datepickerFormat;},setDateFormat:function setDateFormat(format){if(format&&checkDateTimeFormat(format,'date')){dateFormat=format;_datepickerFormat=null;return true;}},setTimeFormat:function setTimeFormat(format,_showTz){if(format&&checkDateTimeFormat(format,'time')){timeFormat=format;showTz=_.isUndefined(_showTz)?true:Boolean(_showTz);return true;}},looslyParseDate:function looslyParseDate(str){str=$.trim(str);var date=chrono.parseDate(str),match=null,fixYear=function fixYear(str){if(str.length===4)return str;if(str.length===2){var year=parseInt(str,10);return year<59?'20'+year:'19'+year;}};if(!date){str=str.replace(/^([^\d\w]|_)*/,'');str=str.replace(/([^\d\w]|_)*$/,'');if(/^\d{4}$/.test(str)){return chrono.parseDate('jan 1 '+str);}if(/^\d{2}$/.test(str)){return chrono.parseDate('jan 1 '+fixYear(str));}match=str.match(/^([^\d]+)\s*(\d{2,4})$/);if(match){if(match[2].length===2){match[2]=fixYear(match[2]);}return chrono.parseDate(match[1]+' 1 '+match[2]);}match=str.match(/^(\d{2,4})\s*([^\d]+)$/);if(match){if(match[1].length===2){match[1]=fixYear(match[1]);}return chrono.parseDate(match[2]+' 1 '+match[1]);}}return date;},local:function local(str){if(_.isUndefined(str))return'';var tz=FORMATTERS.timezone.currentTimezone();var numberOrString=_.isString(str)&&!isNaN(Number(str))?Number(str):str,dateInLocale;if(_.isDate(numberOrString)){dateInLocale=numberOrString;}else if(_.isNumber(numberOrString)){dateInLocale=new Date(numberOrString);}else{var parsed=moment(numberOrString,MOMENT_FORMAT_TZ);dateInLocale=parsed.tz(tz.name).toDate();if(isNaN(dateInLocale.getTime())){console.warn('Unable to parse date: '+str);return'';}}return dateInLocale;},utc:function utc(str){if(_.isUndefined(str))return'';var dateInLocale=FORMATTERS.date.local(str);if(!dateInLocale)return'';var millisInMinutes=1000*60,millisFromLocaleToUTC=dateInLocale.getTimezoneOffset()*millisInMinutes,dateInUTC=new Date(dateInLocale.getTime()+millisFromLocaleToUTC);return dateInUTC;},dateString:function dateString(millisStr){if(_.isUndefined(millisStr))return'';return moment(FORMATTERS.date.local(millisStr)).format(dateFormat);},dateTimeString:function dateTimeString(millisStr,overrideTzInfo){if(_.isUndefined(millisStr))return'';var timezoneAbbreviation=overrideTzInfo;if(!timezoneAbbreviation){var tzInfo=FORMATTERS.timezone.currentTimezone(FORMATTERS.date.local(millisStr));if(tzInfo){timezoneAbbreviation=tzInfo.tzAbbr;}}return moment(FORMATTERS.date.local(millisStr)).format(dateFormat+' '+timeFormat)+(showTz&&timezoneAbbreviation?' '+timezoneAbbreviation:'');},dateStringServer:function dateStringServer(millisStr){if(_.isUndefined(millisStr))return'';return moment(FORMATTERS.date.utc(millisStr)).format(SERVER_DATE);},timeStringServer:function timeStringServer(millisStr){if(_.isUndefined(millisStr))return'';return moment(FORMATTERS.date.utc(millisStr)).format(SERVER_TIME);},dateStringUtc:function dateStringUtc(millisStr){if(_.isUndefined(millisStr))return'';return FORMATTERS.date.dateString(FORMATTERS.date.utc(millisStr));},dateTimeStringUtc:function dateTimeStringUtc(millisStr){if(_.isUndefined(millisStr))return'';return FORMATTERS.date.dateTimeString(FORMATTERS.date.utc(millisStr),'UTC');},timeString:function timeString(millisStr){if(_.isUndefined(millisStr))return'';return moment(FORMATTERS.date.local(millisStr)).format(timeFormat);},timeStringUtc:function timeStringUtc(millisStr){if(_.isUndefined(millisStr))return'';return FORMATTERS.date.timeString(FORMATTERS.date.utc(millisStr));},relativeToNow:function relativeToNow(date){return FORMATTERS.date.relativeToDate(date,FORMATTERS.date.utc(Date.now()))+' '+i18n('time.ago');},relativeToDate:function relativeToDate(date,fromDate){if(_.isUndefined(date))return'';var span=new sf.TimeSpan(fromDate-date),time='';if(span.years>1){time=sf("{0:^y '"+i18n('time.years')+"'}",span);}else if(span.years===1){time=i18n('time.year');}else if(span.months>1){time=sf("{0:^M '"+i18n('time.months')+"'}",span);}else if(span.months===1){time=i18n('time.month');}else if(span.days>1){time=sf("{0:^d '"+i18n('time.days')+"'}",span);}else if(span.days===1){time=i18n('time.day');}else if(span.hours>1){time=sf("{0:^h '"+i18n('time.hours')+"'}",span);}else if(span.hours===1){time=i18n('time.hour');}else if(span.minutes>1){time=sf("{0:^m '"+i18n('time.minutes')+"'}",span);}else if(span.minutes===1){time=i18n('time.minute');}else{time=i18n('time.moments');}return time;},addDaysToDate:function addDaysToDate(date,numDays){var newDate=new Date(date.valueOf());newDate.setDate(newDate.getDate()+numDays);return newDate;},dateToDateString:function dateToDateString(date){return date.toISOString().replace(/T.*$/,'');},addDaysToDateString:function addDaysToDateString(dateString,numDays){return FORMATTERS.date.dateToDateString(FORMATTERS.date.addDaysToDate(new Date(dateString),numDays));}},timezone:{dateTimeStringToTimezone:function dateTimeStringToTimezone(dateStr,srcTimezone,destTimezone){var dateTz=FORMATTERS.timezone.date(dateStr,srcTimezone);return dateTz.tz(destTimezone).format(dateFormat+' '+timeFormat);},dateTimeStringToUtc:function dateTimeStringToUtc(dateStr,timezone){return FORMATTERS.timezone.dateTimeStringToTimezone(dateStr,timezone,'Etc/UTC');},dateTimeStringServer:function dateTimeStringServer(dateStr,timezone){var dateTz=FORMATTERS.timezone.date(dateStr,timezone||FORMATTERS.timezone.currentTimezone().name);return dateTz.tz('Etc/UTC').format(SERVER_DATE+' '+SERVER_TIME+' [UTC]');},dateInServerFormat:function dateInServerFormat(dateStr,timezone){if(/^\s*$/.test(dateStr)){return dateStr;}var parsed=void 0;if(_.isNumber(dateStr)){parsed=moment(new Date(dateStr));}else{parsed=moment(dateStr,MOMENT_FORMAT);}return parsed?parsed.tz(timezone):parsed;},date:function date(dateStr,timezone){if(/^\s*$/.test(dateStr)){return dateStr;}return _.isNumber(dateStr)?moment.tz(dateStr,timezone):moment.tz(dateStr,dateFormat+' '+timeFormat,timezone);},offsetDisplay:function offsetDisplay(offsetMinutes){var negative=offsetMinutes<0,offsetMinutesAbs=Math.abs(offsetMinutes),hours=Math.floor(offsetMinutesAbs/60),minutes=Math.floor(offsetMinutesAbs%60);if((''+hours).length===1){hours='0'+hours;}if((''+minutes).length===1){minutes='0'+minutes;}return(negative?'-':'+')+hours+':'+minutes;},list:function list(){return _.chain(jstz.olson.timezones).map(function(name,key){var components=key.split(','),offsetMinutes=parseInt(components[0],10),dst=components.length>1&&components[1]==='1';return[name,{offset:offsetMinutes,offsetDisplay:FORMATTERS.timezone.offsetDisplay(offsetMinutes),name:name,dst:dst}];}).object().value();},lookupTimezone:function lookupTimezone(name,withOffsetForDate){var list=FORMATTERS.timezone.list(),tz=list[name];if(withOffsetForDate&&withOffsetForDate.getTime){withOffsetForDate=withOffsetForDate.getTime();}if(!withOffsetForDate||isNaN(withOffsetForDate)){withOffsetForDate=Date.now();}var momentZone=moment.tz.zone(name);if(!momentZone){throw new Error('Could not find timezone "'+name+'"');}var offset=momentZone.utcOffset(withOffsetForDate)*-1,tzInfo={tzOffset:offset,tzAbbr:momentZone.abbr(withOffsetForDate),tzOffsetDisplay:FORMATTERS.timezone.offsetDisplay(offset)};return $.extend({},tz,tzInfo);},currentTimezone:function currentTimezone(){if(!FORMATTERS.timezone._currentTimezone){var prefs=FORMATTERS.timezone.getPreferences();if(prefs.detect){FORMATTERS.timezone._currentTimezone=FORMATTERS.timezone.lookupTimezone(jstz.determine().name());}else{FORMATTERS.timezone._currentTimezone=FORMATTERS.timezone.lookupTimezone(prefs.timeZone);}}return FORMATTERS.timezone._currentTimezone;},setCurrentTimezone:function setCurrentTimezone(tz){FORMATTERS.timezone._currentTimezone=tz;},getPreferences:function getPreferences(){if(openlumifyData&&openlumifyData.currentUser&&openlumifyData.currentUser.uiPreferences&&'org.openlumify.timezone'in openlumifyData.currentUser.uiPreferences){try{return JSON.parse(openlumifyData.currentUser.uiPreferences['org.openlumify.timezone']);}catch(e){console.error('could not parse timezone preferences',e);}}var detect='timezone.defaults.detect'in configProperties?P.bool.parse(configProperties['timezone.defaults.detect']):true;return{detect:detect,timeZone:detect?jstz.determine().name():configProperties['timezone.defaults.timezone']||'UTC'};}}};FORMATTERS.string.palantirPrettyPrint=FORMATTERS.string.prettyPrint;FORMATTERS.date.resetToDefaultDateFormat();return FORMATTERS;});
//# sourceMappingURL=formatters.js.map
