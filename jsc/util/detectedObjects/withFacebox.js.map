{"version":3,"sources":["../../../js/util/detectedObjects/withFacebox.js"],"names":["define","tpl","withFacebox","attributes","boxSelector","boxEditingSelector","initializeFacebox","container","root","$node","closest","append","setupEditingFacebox","on","onHover","onHoverLeave","onDetectedObjectEdit","onDoneEditing","self","debouncedTrigger","_","debounce","convertToPercentageAndTrigger","event","preventClick","$target","$","target","length","select","hide","currentlyEditing","facebox","position","width","height","css","top","left","document","evt","off","element","stopPropagation","preventDefault","box","offsetParent","offset","offsetParentWidth","offsetParentHeight","startPosition","Math","min","max","pageX","pageY","currentPosition","abs","show","resizable","containment","handles","minWidth","minHeight","stop","draggable","cursor","ui","el","helper","t","l","w","h","trigger","id","x1","toFixed","x2","y1","y2","showFacebox","property","opts","options","extend","editing","viewing","value","not","x","y","defer","is","showFaceboxForEdit","showFaceboxForView","data","toHide","resolvedVertexId","key"],"mappings":"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","file":"withFacebox.js","sourcesContent":["define(['./withFaceboxTpl.hbs'], function(tpl) {\n    'use strict';\n\n    return withFacebox;\n\n    function withFacebox() {\n\n        this.attributes({\n            boxSelector: '.facebox',\n            boxEditingSelector: '.facebox.editing'\n        })\n\n        this.initializeFacebox = function(container) {\n            var root = this.$node.closest('.org-openlumify-layout-root');\n\n            this.container = container.append(tpl({}));\n            this.setupEditingFacebox();\n\n            this.on(root, 'detectedObjectEnter', this.onHover);\n            this.on(root, 'detectedObjectLeave', this.onHoverLeave);\n            this.on(root, 'detectedObjectEdit', this.onDetectedObjectEdit);\n            this.on(root, 'detectedObjectDoneEditing', this.onDoneEditing);\n        }\n\n        this.setupEditingFacebox = function() {\n            var self = this,\n                debouncedTrigger = _.debounce(convertToPercentageAndTrigger, 250);\n\n            this.on('click', function(event) {\n                if (self.preventClick) {\n                    self.preventClick = false;\n                    return;\n                }\n                var $target = $(event.target);\n                if ($target.closest('.facebox').length) return;\n                this.select('boxSelector').hide();\n                this.currentlyEditing = null;\n            });\n            this.on('mousedown', function(event) {\n                var $target = $(event.target),\n                    facebox = $target.closest('.facebox')\n\n                if (facebox.length) {\n                    var position = facebox.position(),\n                        width = facebox.width(),\n                        height = facebox.height();\n\n                    facebox.css({\n                        top: position.top + 'px',\n                        left: position.left + 'px',\n                        width: width + 'px',\n                        height: height + 'px'\n                    });\n                    $(document).on('mouseup.facebox', function(evt) {\n                        $(document).off('.facebox');\n                        debouncedTrigger(evt, { element: facebox });\n                    });\n\n                    return;\n                }\n\n                event.stopPropagation();\n                event.preventDefault();\n\n                var box = this.select('boxEditingSelector'),\n                    offsetParent = this.container.offset(),\n                    offsetParentWidth = this.container.width(),\n                    offsetParentHeight = this.container.height(),\n                    startPosition = {\n                        left: Math.min(\n                            offsetParentWidth,\n                            Math.max(0, event.pageX - offsetParent.left)\n                        ),\n                        top: event.pageY - offsetParent.top,\n                        width: 1,\n                        height: 1\n                    };\n\n                $(document).on('mousemove.facebox', function(evt) {\n                        var currentPosition = {\n                                left: Math.min(\n                                    offsetParentWidth,\n                                    Math.max(0, evt.pageX - offsetParent.left)\n                                ),\n                                top: Math.min(offsetParentHeight, Math.max(0, evt.pageY - offsetParent.top))\n                            },\n                            width = Math.min(offsetParentWidth, Math.abs(startPosition.left - currentPosition.left)),\n                            height = Math.min(offsetParentWidth, Math.abs(startPosition.top - currentPosition.top));\n\n                        if (width >= 5 && height >= 5) {\n                            box.css({\n                                left: Math.min(startPosition.left, currentPosition.left),\n                                top: Math.min(startPosition.top, currentPosition.top),\n                                width: width,\n                                height: height\n                            }).show();\n                        } else {\n                            box.hide();\n                        }\n                    })\n                    .on('mouseup.facebox', function(evt) {\n                        $(document).off('mouseup.facebox mousemove.facebox');\n                        self.currentlyEditing = 'NEW';\n                        self.preventClick = true;\n                        debouncedTrigger(evt, { element: box });\n                    });\n\n                box.css(startPosition).hide();\n            });\n\n            this.select('boxEditingSelector')\n                .resizable({\n                    containment: 'parent',\n                    handles: 'all',\n                    minWidth: 5,\n                    minHeight: 5,\n                    stop: debouncedTrigger\n                }).draggable({\n                    containment: 'parent',\n                    cursor: 'move',\n                    stop: debouncedTrigger\n                });\n\n            function convertToPercentageAndTrigger(event, ui) {\n                // Make percentages for fluid\n                var el = ui.element || ui.helper,\n                    position = el.position(),\n                    offsetParent = el.offsetParent(),\n                    width = offsetParent.width(),\n                    height = offsetParent.height(),\n                    t = position.top / height,\n                    l = position.left / width,\n                    w = el.width() / width,\n                    h = el.height() / height;\n\n                el.css({\n                    top: t * 100 + '%',\n                    left: l * 100 + '%',\n                    width: w * 100 + '%',\n                    height: h * 100 + '%'\n                });\n\n                self.trigger('detectedObjectCoordsChange', {\n                    id: self.currentlyEditing,\n                    x1: l.toFixed(2) + '',\n                    x2: (l + w).toFixed(2) + '',\n                    y1: t.toFixed(2) + '',\n                    y2: (t + h).toFixed(2) + ''\n                });\n            }\n        };\n\n        this.showFacebox = function(property, opts) {\n            var self = this,\n                options = $.extend({ editing: false, viewing: false }, opts || {}),\n                value = property.value,\n                box = (options.editing || options.viewing) ?\n                    self.select('boxEditingSelector') :\n                    self.select('boxSelector').not('.editing'),\n                w = (value.x2 - value.x1) * 100,\n                h = (value.y2 - value.y1) * 100,\n                x = value.x1 * 100,\n                y = value.y1 * 100;\n\n            this.select('boxSelector').not('.editing').hide();\n            box.show();\n            _.defer(function() {\n                if (options.viewing) {\n                    if (box.is('.ui-resizable')) {\n                        box.resizable('disable').draggable('disable')\n                    }\n                } else if (options.editing) {\n                    if (box.is('.ui-resizable')) {\n                        box.resizable('enable').draggable('enable')\n                    }\n                }\n                box.css({\n                    width: w + '%',\n                    height: h + '%',\n                    left: x + '%',\n                    top: y + '%'\n                })\n            })\n        };\n\n        this.showFaceboxForEdit = function(property) {\n            this.showFacebox(property, { editing: true });\n        };\n\n        this.showFaceboxForView = function(property) {\n            this.showFacebox(property, { viewing: true });\n        };\n\n        this.onHover = function(event, data) {\n            this.showFacebox(data);\n        };\n\n        this.onHoverLeave = function(event, data) {\n            var toHide = this.select('boxSelector');\n\n            if (this.currentlyEditing) {\n                toHide = toHide.not('.editing');\n            }\n\n            toHide.hide();\n        };\n\n        this.onDetectedObjectEdit = function(event, data) {\n            if (!data) {\n                return this.trigger('detectedObjectDoneEditing');\n            }\n\n            this.select('boxSelector').show();\n\n            if (data.property && data.property.resolvedVertexId) {\n                this.currentlyEditing = data.property.resolvedVertexId;\n                this.showFaceboxForView(data);\n            } else if (data.property) {\n                this.currentlyEditing = data.property.key;\n                this.showFaceboxForEdit(data);\n            } else {\n                this.currentlyEditing = 'NEW';\n                this.showFaceboxForEdit(data);\n            }\n        };\n\n        this.onDoneEditing = function(event) {\n            this.currentlyEditing = null;\n            this.select('boxSelector').hide();\n        };\n\n    }\n});\n"]}