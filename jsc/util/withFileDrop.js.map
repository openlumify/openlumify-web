{"version":3,"sources":["../../js/util/withFileDrop.js"],"names":["define","Privileges","FoldersNotSupported","prototype","Object","create","Error","withFileDrop","after","self","handleFilesDropped","console","warn","attr","canEdit","node","ondragover","e","canEDIT","dataTransfer","dropEffect","$","addClass","trigger","message","i18n","position","pageX","pageY","ondragenter","preventDefault","ondragleave","ondrop","files","stopPropagation","$node","hasClass","length","items","dt","folderCheck","Promise","all","_","toArray","map","file","fulfill","reject","reader","FileReader","slice","onload","onerror","readAsText","resolve","VISALLO_MIMETYPES","_DataTransferHasOpenLumify","then","isFunction","handleItemsDropped","catch","error"],"mappings":"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","file":"withFileDrop.js","sourcesContent":["define([\n    'util/privileges'\n], function(Privileges) {\n    'use strict';\n\n    FoldersNotSupported.prototype = Object.create(Error.prototype);\n\n    return withFileDrop;\n\n    function FoldersNotSupported() {}\n\n    function withFileDrop() {\n\n        this.after('initialize', function() {\n            var self = this;\n\n            if (!this.handleFilesDropped) {\n                return console.warn('Implement handleFilesDropped');\n            }\n\n            if (this.attr.canEdit === false) {\n                return;\n            }\n\n            this.node.ondragover = function(e) {\n                if (Privileges.canEDIT) {\n                    e.dataTransfer.dropEffect = 'copy';\n                    $(this).addClass('file-hover');\n                } else {\n                    e.dataTransfer.dropEffect = 'none';\n                    self.trigger('displayInformation', {\n                        message: i18n('graph.workspace.readonly'),\n                        position: [e.pageX, e.pageY]\n                    });\n                }\n                return false;\n            };\n            this.node.ondragenter = function(e) {\n                e.preventDefault();\n                return false;\n            };\n            this.node.ondragleave = function(e) {\n                if (!Privileges.canEDIT) {\n                    self.trigger('hideInformation');\n                }\n                return false;\n            };\n            this.node.ondrop = function(e) {\n                if (e.dataTransfer &&\n                    e.dataTransfer.files) {\n\n                    e.preventDefault();\n                    e.stopPropagation();\n\n                    if (self.$node.hasClass('uploading')) return;\n                    if (e.dataTransfer.files.length === 0 &&\n                        (!e.dataTransfer.items ||\n                          e.dataTransfer.items.length === 0)) {\n                        return;\n                    }\n\n                    if (Privileges.canEDIT) {\n                        var dt = e.dataTransfer,\n                            files = dt.files,\n                            items = dt.items,\n                            folderCheck = (files.length) ?\n                                Promise.all(_.toArray(e.dataTransfer.files).map(function(file) {\n                                    return new Promise(function(fulfill, reject) {\n                                        var reader = new FileReader(),\n                                            slice = file.slice(0, 1000);\n\n                                        reader.onload = fulfill;\n                                        reader.onerror = function() {\n                                            reject(new FoldersNotSupported());\n                                        };\n                                        reader.readAsText(slice);\n                                    })\n                                })) :\n                                Promise.resolve();\n\n                        if (VISALLO_MIMETYPES._DataTransferHasOpenLumify(dt)) {\n                            dt.dropEffect = 'none';\n                            return\n                        }\n\n                        folderCheck\n                            .then(function() {\n                                if (files.length) {\n                                    self.handleFilesDropped(files, e);\n                                } else if (items.length && _.isFunction(self.handleItemsDropped)) {\n                                    self.handleItemsDropped(items, e);\n                                }\n                            })\n                            .catch(FoldersNotSupported, function(error) {\n                                self.trigger('displayInformation', {\n                                    message: i18n('popovers.file_import.folder.error'),\n                                    position: [e.pageX, e.pageY]\n                                });\n                            })\n                            .catch(function(error) {\n                                console.error(error);\n\n                                self.trigger('displayInformation', {\n                                    message: i18n('popovers.file_import.general.error'),\n                                    position: [e.pageX, e.pageY]\n                                });\n                            })\n                    } else {\n                        self.trigger('hideInformation');\n                    }\n                }\n            };\n        });\n    }\n});\n"]}