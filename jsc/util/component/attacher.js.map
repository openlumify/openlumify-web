{"version":3,"sources":["../../../js/util/component/attacher.js"],"names":["define","ReactDOM","React","ErrorBoundary","Promise","Provider","API_VERSIONS","self","cachedApiVersions","componentOrDefault","c","default","Attacher","options","forEach","createSetter","prototype","node","arguments","length","_node","_","isFunction","get","_verifyState","_options","preferDirectReactChildren","isElement","Error","isString","_path","_component","_params","isObject","isArray","teardown","hasInstance","_flightComponent","_reactElement","flight","react","unmountComponentAtNode","$","teardownComponent","teardownAllComponents","attach","params","extend","try","bind","then","all","require","loadApiVersions","openlumifyData","storePromise","spread","Component","api","store","openlumifyApi","isFlight","teardownOptions","empty","emptyFlight","emptyReact","textContent","eventNode","legacyFlightEventsNode","addedEvents","addLegacyListeners","attachTo","removeLegacyListenersOnTeardown","boundaryProps","onError","FallbackComponent","reactElement","createElement","wrapBehavior","errorBoundaryWrapper","provider","render","trigger","inst","mapping","_legacyMapping","each","_behavior","callback","name","event","data","stopPropagation","on","mapObject","fn","apply","concat","toArray","comp","lookupComponent","before","$node","handler","off","map","version","connect","asyncApi","baseApi","omit","apis","object","value","key"],"mappings":"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","file":"attacher.js","sourcesContent":["(function() {\n    'use strict';\ndefine([\n    'react-dom',\n    'react',\n    'react-redux',\n    'components/ErrorBoundary',\n    'util/promise'\n], function(\n    ReactDOM,\n    React,\n    { Provider },\n    ErrorBoundary,\n    Promise) {\n\n    var API_VERSIONS = ['v1'],\n        self = this,\n        cachedApiVersions = null;\n\n    function componentOrDefault(c) {\n        return 'default' in c ? c.default : c;\n    }\n\n    /**\n     * Abstracts the attachment of flight and react nodes\n     */\n    function Attacher(options = {}) {\n        return (this === self ? new Attacher() : this).options(options)\n    }\n\n    ['path', 'component', 'params', 'behavior', 'legacyMapping', 'options'].forEach(createSetter);\n\n    Attacher.prototype.node = function(node) {\n        if (arguments.length === 0) return this._node;\n        this._node = _.isFunction(node.get) ? node.get(0) : node;\n        return this;\n    };\n\n    Attacher.prototype._verifyState = function() {\n        if (!this._options.preferDirectReactChildren && !_.isElement(this._node)) {\n            throw new Error('Node is not an Element')\n        }\n        if (!_.isString(this._path) && !this._component) {\n            throw new Error('Valid component or path is required')\n        }\n        if (this._params) {\n            if ('openlumifyApi' in this._params) {\n                throw new Error('Refrain from setting openlumifyApi key in params to avoid collisions');\n            }\n            if (!_.isObject(this._params) || _.isArray(this._params) || _.isFunction(this._params)) {\n                throw new Error('Params must be an object')\n            }\n        }\n    };\n\n    Attacher.prototype.teardown = function(options = {}) {\n        const hasInstance = this._flightComponent || this._reactElement;\n        const {\n            flight = hasInstance ? this._flightComponent : true,\n            react = hasInstance ? this._reactElement : true } = options;\n\n        if (!this._node) throw new Error('No node specified');\n        if (!this._options.preferDirectReactChildren) {\n            if (react) ReactDOM.unmountComponentAtNode(this._node);\n        }\n        if (flight) {\n            if (this._flightComponent) {\n                $(this._node).teardownComponent(this._flightComponent);\n            } else {\n                $(this._node).teardownAllComponents();\n            }\n        }\n        this._reactElement = null;\n        this._flightComponent = null;\n        return this;\n    };\n\n    Attacher.prototype.attach = function(options = {}) {\n        var self = this,\n            params = _.extend({}, this._params) || {};\n\n        return Promise.try(this._verifyState.bind(this))\n            .then(function() {\n                return Promise.all([\n                    self._component || Promise.require(self._path).then(componentOrDefault),\n                    cachedApiVersions || (cachedApiVersions = loadApiVersions()),\n                    openlumifyData.storePromise\n                ]);\n            })\n            .spread(function(Component, api, store) {\n                params.openlumifyApi = api;\n                const flight = isFlight(Component);\n\n                if (options.teardown) {\n                    self.teardown(options.teardownOptions || {});\n                }\n                if (options.empty || (flight && options.emptyFlight) || (!flight && options.emptyReact)) {\n                    self._node.textContent = '';\n                }\n\n                if (flight) {\n                    var eventNode = options && options.legacyFlightEventsNode,\n                        addedEvents = addLegacyListeners(self, eventNode);\n                    Component.attachTo(self._node, params);\n                    removeLegacyListenersOnTeardown(self, eventNode || self._node, Component, addedEvents)\n                    self._flightComponent = Component;\n                } else {\n                    const boundaryProps = { onError: params.onError, FallbackComponent: params.FallbackComponent };\n                    const reactElement = React.createElement(Component, _.extend(params, wrapBehavior(self)));\n                    const errorBoundaryWrapper = React.createElement(ErrorBoundary, boundaryProps, reactElement);\n\n                    if (self._options.preferDirectReactChildren) {\n                        self._reactElement = errorBoundaryWrapper;\n                    } else {\n                        const provider = React.createElement(Provider, { store }, errorBoundaryWrapper);\n                        ReactDOM.render(provider, self._node);\n                        self._reactElement = provider;\n                    }\n                }\n\n                $(self._node).trigger('rendered');\n\n                return self;\n            })\n    };\n\n    return Attacher;\n\n    function addLegacyListeners(inst, node) {\n        var mapping = inst._legacyMapping || {},\n            addedEvents = {};\n        _.each(inst._behavior, function(callback, name) {\n            if (name in mapping) {\n                name = mapping[name];\n            }\n            if (!(name in addedEvents)) {\n                addedEvents[name] = function(event, data) {\n                    event.stopPropagation();\n                    callback(inst, data);\n                };\n                $(node || inst._node).on(name, addedEvents[name]);\n            }\n        })\n        return addedEvents;\n    }\n\n    function wrapBehavior(inst) {\n        return _.mapObject(inst._behavior, function(fn) {\n            return function(data) {\n                return fn.apply(this, [inst].concat(_.toArray(arguments)));\n            }\n        })\n    }\n\n    function removeLegacyListenersOnTeardown(inst, eventNode, Component, addedEvents) {\n        var comp = $(inst._node).lookupComponent(Component)\n        if (comp) {\n            comp.before('teardown', function() {\n                var $node = this.$node;\n                _.each(addedEvents, function(handler, name) {\n                    $(eventNode).off(name, handler);\n                })\n            })\n        }\n    }\n\n    function loadApiVersions() {\n        return Promise.map(API_VERSIONS, function(version) {\n                return Promise.require('public/' + version + '/api')\n                    .then(function(api) {\n                        return api.connect()\n                            .then(function(asyncApi) {\n                                var baseApi = _.omit(api, 'connect');\n                                return [version, _.extend(baseApi, asyncApi)];\n                            });\n                    })\n            })\n            .then(function(apis) {\n                return _.object(apis);\n            })\n    }\n\n    function isFlight(Component) {\n        return _.isFunction(Component.attachTo);\n    }\n\n    function createSetter(name) {\n        Attacher.prototype[name] = function(value) {\n            var key = `_${name}`;\n            if (arguments.length === 0) {\n                return this[key];\n            }\n            this[key] = value;\n            return this;\n        }\n    }\n});\n})();\n"]}