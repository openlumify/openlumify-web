{"version":3,"sources":["../../../../js/util/popovers/mapSearch/mapSearch.js"],"names":["define","defineComponent","withPopover","ol","FeatureMoveInteraction","mapConfig","productSelectors","MODE_REGION_SELECTION_MODE_POINT","MODE_REGION_SELECTION_MODE_RADIUS","MODE_REGION_SELECTION_MODE_RADIUS_DRAGGING","MapSearchPopover","defaultAttrs","mapSelector","closeSelector","before","node","config","template","after","self","positionDialog","mode","setInfo","openlumifyData","storePromise","then","setupMap","store","onToggle","e","stopPropagation","teardown","state","getState","currentValue","attr","latitude","longitude","radius","existing","_","isUndefined","center","proj","transform","zoom","viewport","getViewport","isArray","pan","source","sourceOptions","map","Map","target","popover","find","layers","layer","Tile","controls","control","Zoom","view","View","on","onMapClicked","event","createCircleInteraction","fit","fromLonLat","blockDoubleTimer","clearTimeout","delay","onMapClickedBlockDoubleClicks","coordinate","update","moveInteraction","getRegion","lonlat","toLonLat","region","trigger","$info","text","i18n","toFixed","options","newRadius","newCenter","addInteraction"],"mappings":"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","file":"mapSearch.js","sourcesContent":["define([\n    'flight/lib/component',\n    '../withPopover',\n    'openlayers',\n    './featureMoveInteraction',\n    'util/mapConfig',\n    'data/web-worker/store/product/selectors'\n], function(\n    defineComponent,\n    withPopover,\n    ol,\n    FeatureMoveInteraction,\n    mapConfig,\n    productSelectors) {\n    'use strict';\n\n    var MODE_REGION_SELECTION_MODE_POINT = 1,\n        MODE_REGION_SELECTION_MODE_RADIUS = 2,\n        MODE_REGION_SELECTION_MODE_RADIUS_DRAGGING = 3;\n\n    return defineComponent(MapSearchPopover, withPopover);\n\n    function MapSearchPopover() {\n\n        this.defaultAttrs({\n            mapSelector: '.map',\n            closeSelector: '.close'\n        });\n\n        this.before('initialize', function(node, config) {\n            config.template = 'mapSearch/template';\n\n            this.after('setupWithTemplate', function() {\n                var self = this;\n\n                this.positionDialog();\n                this.mode = MODE_REGION_SELECTION_MODE_POINT;\n                this.setInfo();\n                openlumifyData.storePromise.then(store => {\n                    this.setupMap(store);\n                })\n            });\n        });\n\n        this.onToggle = function(e) {\n            e.stopPropagation();\n            this.teardown();\n        };\n\n        this.setupMap = function(store) {\n            const state = store.getState();\n\n            var currentValue = this.attr.currentValue;\n            var { latitude, longitude, radius } = currentValue;\n            var existing = true;\n            if (_.isUndefined(latitude)) {\n                existing = false;\n                latitude = 0;\n            }\n            if (_.isUndefined(longitude)) {\n                existing = false;\n                longitude = 0;\n            }\n\n            let center = ol.proj.transform(\n                [longitude, latitude], 'EPSG:4326', 'EPSG:3857'\n            );\n            let zoom = 1;\n            if (!existing) {\n                let viewport = productSelectors.getViewport(state);\n                if (viewport && _.isArray(viewport.pan)) {\n                    center = viewport.pan;\n                    zoom = viewport.zoom;\n                }\n            }\n\n            var { source, sourceOptions } = mapConfig();\n            var map = new ol.Map({\n                target: this.popover.find(this.attr.mapSelector)[0],\n                layers: [\n                    new ol.layer.Tile({ source: new ol.source[source](sourceOptions) })\n                ],\n                controls: [new ol.control.Zoom()],\n                view: new ol.View({ center, zoom })\n            });\n            this.map = map;\n\n            map.on('click', event => this.onMapClicked(event))\n            this.on(this.popover, 'click', {\n                closeSelector: this.teardown\n            })\n\n            if (existing) {\n                this.mode = MODE_REGION_SELECTION_MODE_RADIUS;\n                this.setInfo();\n                this.createCircleInteraction({\n                    fit: true,\n                    center: ol.proj.fromLonLat([longitude, latitude]),\n                    radius: (radius || 100) * 1000\n                })\n            }\n        };\n\n        this.onMapClicked = function(event, map) {\n            if (this.blockDoubleTimer) {\n                clearTimeout(this.blockDoubleTimer);\n                this.blockDoubleTimer = null;\n            } else {\n                this.blockDoubleTimer = _.delay(() => {\n                    this.blockDoubleTimer = null;\n                    this.onMapClickedBlockDoubleClicks(event)\n                }, 250);\n            }\n        };\n\n        this.onMapClickedBlockDoubleClicks = function(event) {\n            var map = this.map;\n\n            switch (this.mode) {\n\n                case MODE_REGION_SELECTION_MODE_POINT:\n                    this.mode = MODE_REGION_SELECTION_MODE_RADIUS;\n                    this.createCircleInteraction({ center: event.coordinate, fit: false });\n                    break;\n\n            }\n\n            this.setInfo();\n        };\n\n        this.update = function() {\n            var { center, radius } = this.moveInteraction.getRegion(),\n                lonlat = ol.proj.toLonLat(center),\n                region = {\n                    radius: radius,\n                    longitude: lonlat[0],\n                    latitude: lonlat[1]\n                };\n            this.trigger('mapSearchRegionUpdated', { region });\n            this.setInfo();\n        };\n\n        this.setInfo = function() {\n            var $info = this.popover.find('.info');\n            switch (this.mode) {\n                case MODE_REGION_SELECTION_MODE_POINT:\n                    return $info.text(i18n('field.geolocation.radius.search.selectpoint'));\n                case MODE_REGION_SELECTION_MODE_RADIUS:\n                    return $info.text(i18n('field.geolocation.radius.search.selectradius'));\n                case MODE_REGION_SELECTION_MODE_RADIUS_DRAGGING:\n                    return $info.text(i18n('field.geolocation.radius.search.dragging',\n                        this.radius.toFixed(2),\n                        (this.radius * 0.62137).toFixed(2)\n                    ));\n            }\n        };\n\n        this.createCircleInteraction = function(options) {\n            this.moveInteraction = new FeatureMoveInteraction(options);\n            this.moveInteraction.on('radiusChanged', event => {\n                this.mode = MODE_REGION_SELECTION_MODE_RADIUS_DRAGGING;\n                this.radius = event.newRadius;\n                this.update();\n            })\n            this.moveInteraction.on('centerChanged', event => {\n                this.center = event.newCenter;\n                this.update();\n            })\n            this.map.addInteraction(this.moveInteraction);\n            this.update();\n        };\n    }\n});\n"]}