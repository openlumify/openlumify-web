{"version":3,"sources":["../../../../js/util/popovers/addRelated/addRelated.js"],"names":["define","defineComponent","ConceptSelector","RelationshipSelector","withFormFieldErrors","withDataRequest","F","withPopover","AddRelatedPopover","defaultAttrs","addButtonSelector","searchButtonSelector","cancelButtonSelector","promptAddButtonSelector","before","node","config","vertex","multiple","length","title","i18n","console","warn","template","after","self","on","popover","onConceptSelected","onRelationshipSelected","onAdd","onCancel","onSearch","onPromptAdd","enterShouldSubmit","limitParentConceptId","prop","_","isArray","attr","attachTo","find","creatable","focus","defaultText","limitRelatedToConceptId","positionDialog","event","data","relationshipId","relationship","checkValid","conceptId","concept","id","trigger","searchButton","hide","promptAdd","cancelButton","show","addButton","relatedRequest","cancel","clearFieldErrors","document","vertexIds","relatedToVertexIds","teardown","addVertices","promptAddVertices","button","$","target","addClass","Promise","all","dataRequest","limitEdgeLabel","finally","removeClass","then","results","shift","related","count","vertices","elements","forceSearch","promptBeforeAdding","markFieldErrors","text","defer","catch"],"mappings":"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","file":"addRelated.js","sourcesContent":["define([\n    'flight/lib/component',\n    'util/ontology/conceptSelect',\n    'util/ontology/relationshipSelect',\n    'util/withFormFieldErrors',\n    'util/withDataRequest',\n    'util/vertex/formatters',\n    '../withPopover'\n], function(\n    defineComponent,\n    ConceptSelector,\n    RelationshipSelector,\n    withFormFieldErrors,\n    withDataRequest,\n    F,\n    withPopover) {\n    'use strict';\n\n    return defineComponent(AddRelatedPopover, withPopover, withFormFieldErrors, withDataRequest);\n\n    function AddRelatedPopover() {\n\n        this.defaultAttrs({\n            addButtonSelector: '.add',\n            searchButtonSelector: '.search',\n            cancelButtonSelector: '.cancel',\n            promptAddButtonSelector: '.prompt-add'\n        });\n\n        this.before('initialize', function(node, config) {\n            if (config.vertex) {\n                config.multiple = config.vertex.length > 1;\n                if (config.multiple) {\n                    config.title = i18n('popovers.add_related.title_multiple', config.vertex.length);\n                } else {\n                    config.title = '\"' + F.vertex.title(config.vertex[0]) + '\"';\n                }\n            } else {\n                console.warn('vertex attribute required');\n                config.title = i18n('popovers.add_related.title_unknown');\n            }\n            config.template = 'addRelated/template';\n        });\n\n        this.after('initialize', function() {\n            var self = this;\n\n            this.after('setupWithTemplate', function() {\n                this.on(this.popover, 'conceptSelected', this.onConceptSelected);\n                this.on(this.popover, 'relationshipSelected', this.onRelationshipSelected);\n                this.on(this.popover, 'click', {\n                    addButtonSelector: this.onAdd,\n                    cancelButtonSelector: this.onCancel,\n                    searchButtonSelector: this.onSearch,\n                    promptAddButtonSelector: this.onPromptAdd\n                });\n\n                this.enterShouldSubmit = 'addButtonSelector';\n\n                this.limitParentConceptId = F.vertex.prop(\n                    _.isArray(this.attr.vertex) ? this.attr.vertex[0] : this.attr.vertex,\n                    'conceptType'\n                );\n                ConceptSelector.attachTo(self.popover.find('.concept'), {\n                    creatable: false,\n                    focus: true,\n                    defaultText: i18n('popovers.add_related.concept.default_text'),\n                    limitRelatedToConceptId: this.limitParentConceptId\n                });\n\n                RelationshipSelector.attachTo(self.popover.find('.relationship'), {\n                    creatable: false,\n                    defaultText: i18n('popovers.add_related.relationship.default_text'),\n                    limitParentConceptId: this.limitParentConceptId\n                });\n\n                this.positionDialog();\n            });\n        });\n\n        this.onRelationshipSelected = function(event, data) {\n            this.relationshipId = data.relationship && data.relationship.title;\n            this.checkValid();\n        };\n\n        this.onConceptSelected = function(event, data) {\n            this.conceptId = data.concept && data.concept.id;\n            this.checkValid();\n            this.trigger(this.popover.find('.relationship'), 'limitParentConceptId', {\n                conceptId: this.conceptId\n            });\n        };\n\n        this.checkValid = function() {\n            var searchButton = this.popover.find('.search').hide(),\n                promptAdd = this.popover.find('.prompt-add').hide(),\n                cancelButton = this.popover.find('.cancel').show(),\n                addButton = this.popover.find('.add');\n\n            if (this.relatedRequest && this.relatedRequest.cancel) {\n                this.relatedRequest.cancel();\n            }\n            this.clearFieldErrors(this.popover);\n            searchButton.hide();\n            promptAdd.hide();\n            cancelButton.hide();\n            addButton.show();\n        };\n\n        this.onSearch = function(event) {\n            this.trigger(document, 'searchByRelatedEntity', {\n                vertexIds: this.attr.relatedToVertexIds,\n                conceptId: this.conceptId,\n                relationshipId: this.relationshipId\n            });\n            this.teardown();\n        };\n\n        this.onPromptAdd = function(event) {\n            var self = this;\n\n            this.trigger('addRelatedDoAdd', {\n                addVertices: this.promptAddVertices,\n                relatedToVertexIds: self.attr.relatedToVertexIds\n            })\n\n            this.teardown();\n        };\n\n        this.onCancel = function() {\n            if (this.relatedRequest) {\n                this.relatedRequest.cancel();\n            }\n        };\n\n        this.onAdd = function(event) {\n            var self = this,\n                searchButton = this.popover.find('.search').hide(),\n                promptAdd = this.popover.find('.prompt-add').hide(),\n                cancelButton = this.popover.find('.cancel').show(),\n                button = $(event.target).addClass('loading').prop('disabled', true);\n\n            Promise.all([\n                this.dataRequest('config', 'properties'),\n                (\n                    this.relatedRequest = this.dataRequest('vertex', 'related', this.attr.relatedToVertexIds, {\n                        limitEdgeLabel: this.relationshipId,\n                        limitParentConceptId: this.conceptId\n                    })\n                )\n            ])\n                .finally(function() {\n                    button.removeClass('loading').prop('disabled', false);\n                    searchButton.hide();\n                    promptAdd.hide();\n                    cancelButton.hide();\n                    self.clearFieldErrors(self.popover);\n                })\n                .then(function(results) {\n                    var config = results.shift(),\n                        related = results.shift(),\n                        count = related.count,\n                        vertices = related.elements,\n                        forceSearch = count > config['vertex.loadRelatedMaxForceSearch'],\n                        promptBeforeAdding = count > config['vertex.loadRelatedMaxBeforePrompt'];\n\n                    if (count === 0) {\n                        self.markFieldErrors(i18n('popovers.add_related.no_vertices'), self.popover);\n                    } else if (forceSearch) {\n                        self.markFieldErrors(i18n('popovers.add_related.too_many'), self.popover);\n                        button.hide();\n                        searchButton.show();\n                    } else if (promptBeforeAdding) {\n                        button.hide();\n                        searchButton.show();\n                        self.promptAddVertices = vertices;\n                        promptAdd.text(i18n('popovers.add_related.button.prompt_add', count)).show();\n                    } else {\n                        _.defer(function() {\n                            self.trigger('addRelatedDoAdd', {\n                                addVertices: vertices,\n                                relatedToVertexIds: self.attr.relatedToVertexIds\n                            })\n                        });\n                        self.teardown();\n                    }\n\n                })\n                .catch(function() {\n                    self.markFieldErrors(i18n('popovers.add_related.error'));\n                })\n        };\n    }\n});\n"]}