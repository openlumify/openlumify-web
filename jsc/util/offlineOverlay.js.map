{"version":3,"sources":["../../js/util/offlineOverlay.js"],"names":["define","defineComponent","template","F","Overlay","after","overlay","remove","require","$","document","teardownComponent","SessionOverlay","self","appendTo","body","$lastCheck","find","setInterval","updateLastCheck","bind","poll","lastCheck","text","i18n","date","relativeToNow","show","hide","checkNumber","utc","Date","getTime","ajax","url","cache","done","window","location","reload","fail","waitTimeSeconds","Math","min","pow","setTimeout"],"mappings":"AAAAA,OAAO,CACH,sBADG,CAEH,yBAFG,CAGH,iBAHG,CAAP,CAIG,SACCC,eADD,CAECC,QAFD,CAGCC,CAHD,CAGI,CACH,aAEA,MAAOF,iBAAgBG,OAAhB,CAAP,CAEA,QAASA,QAAT,EAAmB,CAEf,KAAKC,KAAL,CAAW,UAAX,CAAuB,UAAW,CAC9B,KAAKC,OAAL,CAAaC,MAAb,GACH,CAFD,EAIA,KAAKF,KAAL,CAAW,YAAX,CAAyB,UAAW,CAChCG,QAAQ,CAAC,+BAAD,CAAR,CAA2C,wBAAkB,CAEzDC,EAAEC,QAAF,EAAYC,iBAAZ,CAA8BC,cAA9B,EACH,CAHD,EAKA,GAAIC,MAAO,IAAX,CACAJ,EAAE,UAAW,CACTI,KAAKP,OAAL,CAAeG,EAAEP,UAAF,EACVY,QADU,CACDJ,SAASK,IADR,CAAf,CAGAF,KAAKG,UAAL,CAAkBH,KAAKP,OAAL,CAAaW,IAAb,CAAkB,eAAlB,CAAlB,CACAC,YAAYL,KAAKM,eAAL,CAAqBC,IAArB,CAA0BP,IAA1B,CAAZ,CAA6C,KAA7C,EACAA,KAAKQ,IAAL,CAAU,CAAV,EACAR,KAAKM,eAAL,GAEH,CATD,EAUH,CAjBD,EAmBA,KAAKA,eAAL,CAAuB,UAAW,CAC9B,GAAI,KAAKG,SAAT,CAAoB,CAChB,KAAKN,UAAL,CAAgBO,IAAhB,CACIC,KAAK,uCAAL,CAA8CrB,EAAEsB,IAAF,CAAOC,aAAP,CAAqB,KAAKJ,SAA1B,CAA9C,CADJ,EAEEK,IAFF,GAGH,CAJD,IAIO,CACH,KAAKX,UAAL,CAAgBY,IAAhB,GACH,CACJ,CARD,CAUA,KAAKP,IAAL,CAAY,SAASQ,WAAT,CAAsB,CAC9B,GAAIhB,MAAO,IAAX,CAEA,KAAKS,SAAL,CAAiBnB,EAAEsB,IAAF,CAAOK,GAAP,CAAW,GAAIC,KAAJ,EAAX,EAAuBC,OAAvB,EAAjB,CACAvB,EAAEwB,IAAF,CAAO,CAAEC,IAAK,WAAP,CAAoBC,MAAO,KAA3B,CAAP,EACKC,IADL,CACU,UAAW,CACbC,OAAOC,QAAP,CAAgBC,MAAhB,GACH,CAHL,EAIKC,IAJL,CAIU,UAAW,CACb,GAAIC,iBAAkBC,KAAKC,GAAL,CAAS,GAAT,CAAcD,KAAKE,GAAL,CAAS,CAAT,CAAYf,WAAZ,EAA2B,CAAzC,CAAtB,CACAgB,WAAWhC,KAAKQ,IAAL,CAAUD,IAAV,CAAeP,IAAf,CAAqBgB,YAAc,GAAnC,CAAX,CAAoDY,gBAAkB,IAAtE,EACH,CAPL,EAQH,CAZD,CAcH,CACJ,CA9DD","file":"offlineOverlay.js","sourcesContent":["define([\n    'flight/lib/component',\n    './offlineOverlayTpl.hbs',\n    'util/formatters'\n], function(\n    defineComponent,\n    template,\n    F) {\n    'use strict';\n\n    return defineComponent(Overlay);\n\n    function Overlay() {\n\n        this.after('teardown', function() {\n            this.overlay.remove();\n        });\n\n        this.after('initialize', function() {\n            require(['util/sessionExpirationOverlay'], SessionOverlay => {\n                // Offline overrides session timeout overlay\n                $(document).teardownComponent(SessionOverlay);\n            });\n\n            var self = this;\n            $(function() {\n                self.overlay = $(template())\n                    .appendTo(document.body);\n\n                self.$lastCheck = self.overlay.find('.last-checked');\n                setInterval(self.updateLastCheck.bind(self), 30000)\n                self.poll(1);\n                self.updateLastCheck();\n\n            });\n        });\n\n        this.updateLastCheck = function() {\n            if (this.lastCheck) {\n                this.$lastCheck.text(\n                    i18n('openlumify.offline_overlay.last_check', F.date.relativeToNow(this.lastCheck))\n                ).show();\n            } else {\n                this.$lastCheck.hide();\n            }\n        };\n\n        this.poll = function(checkNumber) {\n            var self = this;\n\n            this.lastCheck = F.date.utc(new Date()).getTime();\n            $.ajax({ url: 'ping.html', cache: false })\n                .done(function() {\n                    window.location.reload();\n                })\n                .fail(function() {\n                    var waitTimeSeconds = Math.min(120, Math.pow(2, checkNumber) - 1);\n                    setTimeout(self.poll.bind(self, checkNumber + 0.5), waitTimeSeconds * 1000);\n                });\n        }\n\n    }\n});\n"]}