{"version":3,"sources":["../../js/util/keyboard.js"],"names":["define","defineComponent","Keyboard","shouldFilter","e","$","target","is","eventParts","_","pick","after","document","removeEventListener","onDocumentMouseDown","shortcutsByScope","shortcuts","shortcutsEnabled","focusElementStack","window","openlumifyKeyboard","lastMousePositionX","mousePageX","width","lastMousePositionY","mousePageY","height","fireEventMetas","fireEvent","fireEventUp","debounce","bind","on","onKeyDown","onKeyUp","onClick","onMouseMove","onFocusLostByClipboard","onFocus","onRequestKeyboardShortcuts","onRegisterKeyboardShortcuts","event","data","isUndefined","enable","onToggleShortcutsByScope","onToggleKeyboardShortcut","addEventListener","fullscreenElement","msFullscreenElement","mozFullScreenElement","webkitFullscreenElement","trigger","self","scopes","scope","isArray","require","F","forEach","Object","keys","key","shortcut","object","enabled","forEventLookup","normalized","pushToStackIfNotLast","$target","closest","length","shortcutForEvent","w","which","preventDefault","fire","type","currentMetaKeyState","metaKey","ctrlKey","altKey","shiftKey","lastEventParts","f","test","call","parts","isEqual","lastEventTimestamp","timeStamp","pageX","pageY","el","push","getTriggerElement","triggerElement","lastElement","last","isVisible","pop","$node","name","te","s","console","warn","toUpperCase","registeredShortcut","scopedShortcut"],"mappings":"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","file":"keyboard.js","sourcesContent":["\ndefine([\n    'flight/lib/component'\n], function(defineComponent) {\n    'use strict';\n\n    return defineComponent(Keyboard);\n\n    function shouldFilter(e) {\n        return $(e.target).is('input,select,textarea:not(.clipboardManager),.openlumify-allow-focus,.openlumify-allow-focus *');\n    }\n\n    function eventParts(e) {\n        return _.pick(e, 'which', 'shiftKey', 'metaKey', 'ctrlKey', 'altKey');\n    }\n\n    function Keyboard() {\n        this.after('teardown', function() {\n            document.removeEventListener('mousedown', this.onDocumentMouseDown);\n        });\n\n        this.after('initialize', function() {\n            this.shortcutsByScope = {};\n            this.shortcuts = {};\n            this.shortcutsEnabled = true;\n            this.focusElementStack = [];\n\n            window.openlumifyKeyboard = {};\n            window.lastMousePositionX = this.mousePageX = $(window).width() / 2;\n            window.lastMousePositionY = this.mousePageY = $(window).height() / 2;\n\n            this.fireEventMetas = this.fireEvent;\n\n            this.fireEventUp = _.debounce(this.fireEvent.bind(this), 100);\n            this.fireEvent = _.debounce(this.fireEvent.bind(this), 100, true);\n\n            this.on('keydown', this.onKeyDown);\n            this.on('keyup', this.onKeyUp);\n            this.on('click', this.onClick);\n            this.on('mousemove', this.onMouseMove);\n            this.on('focusLostByClipboard', this.onFocusLostByClipboard);\n            this.on('focusComponent', this.onFocus);\n\n            this.on(document, 'requestKeyboardShortcuts', this.onRequestKeyboardShortcuts);\n            this.on(document, 'registerKeyboardShortcuts', this.onRegisterKeyboardShortcuts);\n            this.on(document, 'toggleAllShortcuts', function(event, data) {\n                this.shortcutsEnabled = (data && !_.isUndefined(data.enable)) ? data.enable : !this.shortcutsEnabled;\n            });\n            this.on(document, 'toggleShortcutsByScope', this.onToggleShortcutsByScope);\n            this.on(document, 'toggleKeyboardShortcut', this.onToggleKeyboardShortcut);\n\n            this.onDocumentMouseDown = this.onDocumentMouseDown.bind(this);\n            document.addEventListener('mousedown', this.onDocumentMouseDown, true);\n\n            this.on(document, 'fullscreenchange MSFullscreenChange webkitfullscreenchange mozfullscreenchange', function(e) {\n                var fullscreenElement = document.fullscreenElement || document.msFullscreenElement || document.mozFullScreenElement || document.webkitFullscreenElement;\n                this.shortcutsEnabled = !fullscreenElement;\n            });\n        });\n\n        this.onDocumentMouseDown = function(event) {\n            window.openlumifyKeyboard = _.pick(event, 'shiftKey', 'altKey', 'metaKey', 'ctrlKey');\n        };\n\n        this.onRequestKeyboardShortcuts = function() {\n            this.trigger('keyboardShortcutsRegistered', this.shortcutsByScope);\n        };\n\n        this.onRegisterKeyboardShortcuts = function(e, data) {\n            var self = this,\n                scopes = ['Global'],\n                shortcuts = this.shortcuts,\n                shortcutsByScope = this.shortcutsByScope;\n\n            if (data.scope) {\n                if (_.isArray(data.scope)) {\n                    scopes = data.scope;\n                } else scopes = [data.scope];\n            }\n\n            require(['util/formatters'], function(F) {\n                scopes.forEach(function(scope) {\n                    Object.keys(data.shortcuts).forEach(function(key) {\n                        const shortcut = {\n                            ...data.shortcuts[key],\n                            ...F.object.shortcut(key),\n                            enabled: true\n                        };\n\n                        if (!shortcutsByScope[scope]) shortcutsByScope[scope] = {};\n                        shortcuts[shortcut.forEventLookup] = shortcutsByScope[scope][shortcut.normalized] = shortcut;\n                    });\n                });\n            })\n        };\n\n        this.onFocus = function(e) {\n            this.pushToStackIfNotLast(e.target);\n        };\n\n        this.onClick = function(e) {\n            this.pushToStackIfNotLast(e.target);\n        };\n\n        this.onFocusLostByClipboard = function(e) {\n            var $target = $(e.target);\n\n            if ($target.is('.clipboardManager')) return;\n            if ($target.closest('.menubar-pane').length) return;\n\n            this.pushToStackIfNotLast(e.target);\n        };\n\n        this.shortcutForEvent = function(event) {\n            var w = event.which,\n                keys = {\n                    16: 'shiftKey',\n                    17: 'controlKey',\n                    18: 'altKey',\n                    38: 'up',\n                    40: 'down',\n                    91: 'metaKey',\n                    93: 'metaKey'\n                };\n\n            if (keys[w]) {\n                return { preventDefault: false, fire: keys[w], enabled: true };\n            }\n            if (event.type === 'keydown') {\n                this.currentMetaKeyState = _.pick(event, 'metaKey', 'ctrlKey', 'shiftKey', 'altKey');\n            }\n            if (this.currentMetaKeyState) {\n                if ((this.currentMetaKeyState.metaKey || this.currentMetaKeyState.ctrlKey) && this.currentMetaKeyState.altKey) {\n                    return this.shortcuts['CTRL-ALT-' + w] || this.shortcuts['META-ALT-' + w];\n                }\n                if (this.currentMetaKeyState.metaKey && this.currentMetaKeyState.shiftKey) {\n                    return this.shortcuts['SHIFT-META-' + w];\n                }\n                if (this.currentMetaKeyState.metaKey || this.currentMetaKeyState.ctrlKey) {\n                    return this.shortcuts['CTRL-' + w] || this.shortcuts['META-' + w];\n                }\n                if (this.currentMetaKeyState.altKey) {\n                    return this.shortcuts['ALT-' + w];\n                }\n                if (this.currentMetaKeyState.shiftKey) {\n                    return this.shortcuts['SHIFT-' + w];\n                }\n            }\n\n            if (event.type === 'keyup') {\n                this.currentMetaKeyState = null;\n            }\n\n            return this.shortcuts[w];\n        };\n\n        this.onKeyUp = function(e) {\n            if (shouldFilter(e)) return;\n\n            var shortcut = this.shortcutForEvent(e);\n\n            this.lastEventParts = null;\n\n            if (shortcut && shortcut.enabled && this.shortcutsEnabled) {\n                var f = this.fireEventUp;\n                if (shortcut.preventDefault !== false) {\n                    e.preventDefault();\n                    f = this.fireEventMetas;\n                }\n\n                if (!(/META-/.test(shortcut.normalized))) {\n                    f.call(this, shortcut.fire, _.pick(e, 'metaKey', 'ctrlKey', 'shiftKey', 'altKey'));\n                }\n                f.call(this, shortcut.fire + 'Up', _.pick(e, 'metaKey', 'ctrlKey', 'shiftKey', 'altKey'));\n            }\n        };\n\n        this.onKeyDown = function(e) {\n            if (shouldFilter(e)) return;\n\n            var parts = eventParts(e);\n            if (this.lastEventParts &&\n                _.isEqual(parts, this.lastEventParts) &&\n                this.lastEventTimestamp > (e.timeStamp - 1000)) {\n                return;\n            }\n\n            this.lastEventParts = parts;\n            this.lastEventTimestamp = e.timeStamp;\n\n            var shortcut = this.shortcutForEvent(e);\n\n            if (shortcut) {\n                var f = this.fireEvent;\n                if (shortcut.preventDefault !== false) {\n                    e.preventDefault();\n                    f = this.fireEventMetas;\n                }\n\n                // Ctrl keys don't get keyup events so trigger here\n                if (/META-/.test(shortcut.normalized)) {\n                    f.call(this, shortcut.fire, _.pick(e, 'metaKey', 'ctrlKey', 'shiftKey', 'altKey'));\n                }\n            }\n        }\n\n        this.onMouseMove = function(e) {\n            window.lastMousePositionX = this.mousePageX = e.pageX || 0;\n            window.lastMousePositionY = this.mousePageY = e.pageY || 0;\n        }\n\n        this.pushToStackIfNotLast = function(el) {\n            if (!this.focusElementStack.length || this.focusElementStack[this.focusElementStack.length - 1] !== el) {\n                this.focusElementStack.push(el);\n            }\n        };\n\n        this.getTriggerElement = function() {\n            var triggerElement;\n\n            while (this.focusElementStack.length && !triggerElement) {\n                var lastElement = _.last(this.focusElementStack),\n                isVisible = $(lastElement).is(':visible');\n\n                if (isVisible) {\n                    triggerElement = lastElement;\n                } else {\n                    this.focusElementStack.pop();\n                }\n            }\n\n            return triggerElement || this.$node;\n        };\n\n        this.fireEvent = function(name, data) {\n            var te = this.getTriggerElement();\n            data.pageX = this.mousePageX;\n            data.pageY = this.mousePageY;\n            this.trigger(te, name, data);\n        };\n\n        this.onToggleShortcutsByScope = function(event, data) {\n            var self = this;\n\n            Object.keys(data).forEach(function(s) {\n                var scope = self.shortcutsByScope[s];\n\n                if (scope) {\n                    Object.keys(scope).forEach(function(shortcut) {\n                        scope[shortcut].enabled = data[s];\n                    });\n                } else {\n                    console.warn('Could not toggle shortcuts. Scope \\'' + s + '\\' not found');\n                }\n            });\n        };\n\n        this.onToggleKeyboardShortcut = function(event, data) {\n            var self = this;\n            var shortcut = data.shortcut.toUpperCase();\n\n            if (data.scopes) {\n                data.scopes.forEach(function(scope) {\n                    var registeredShortcut = self.shortcutsByScope[scope][shortcut];\n                    if (registeredShortcut) {\n                        registeredShortcut.enabled = !_.isUndefined(data.enabled) ? data.enabled : !registeredShortcut.enabled;\n                    }\n                });\n            } else {\n                if (this.shortcuts[shortcut]) {\n                    this.shortcuts[shortcut].enabled = !_.isUndefined(data.enabled) ? data.enabled : !this.shortcuts[shortcut].enabled;\n                }\n\n                Object.keys(this.shortcutsByScope).forEach(function(scope) {\n                    var scopedShortcut = self.shortcutsByScope[scope][shortcut];\n                    if (scopedShortcut) {\n                        scopedShortcut.enabled = !_.isUndefined(data.enabled) ? data.enabled : !scopedShortcut.enabled;\n                    }\n                });\n            }\n        };\n    }\n});\n"]}