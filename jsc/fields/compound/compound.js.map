{"version":3,"sources":["../../../js/fields/compound/compound.js"],"names":["define","require","defineComponent","withDataRequest","F","CompoundField","before","node","config","asyncRender","after","self","compoundValues","on","onDependentPropertyChange","onDependentPropertyInvalid","dataRequest","done","ontologyProperties","render","triggerFieldUpdated","isValid","trigger","propertyId","attr","property","title","values","getValues","event","data","$","target","is","$node","stopPropagation","value","_","chain","dependentPropertyIris","map","iri","result","isArray","isUndefined","vertex","propValid","any","v","length","fields","names","indexBy","Promise","all","propertyIri","i","ontologyProperty","byTitle","fieldContainer","addClass","previousValue","possibleValues","dataType","then","PropertyField","attachTo","newProperty","tooltip","displayName","placement","vertexProperty","predicates","composite","focus","add","empty","append"],"mappings":"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","file":"compound.js","sourcesContent":["define([\n    'require',\n    'flight/lib/component',\n    'util/withDataRequest',\n    'util/vertex/formatters'\n], function(require, defineComponent, withDataRequest, F) {\n    'use strict';\n\n    return defineComponent(CompoundField, withDataRequest);\n\n    function CompoundField() {\n\n        this.before('initialize', function(node, config) {\n            config.asyncRender = true;\n        });\n\n        this.after('initialize', function() {\n            var self = this;\n\n            this.compoundValues = {};\n\n            this.on('propertychange', this.onDependentPropertyChange);\n            this.on('propertyinvalid', this.onDependentPropertyInvalid);\n\n            this.dataRequest('ontology', 'properties')\n                .done(function(ontologyProperties) {\n                    self.ontologyProperties = ontologyProperties;\n                    self.render();\n                });\n        });\n\n        this.triggerFieldUpdated = function() {\n            if (this.isValid()) {\n                this.trigger('propertychange', {\n                    propertyId: this.attr.property.title,\n                    values: this.getValues()\n                });\n            } else {\n                this.trigger('propertyinvalid', {\n                    propertyId: this.attr.property.title\n                });\n            }\n        }\n\n        this.onDependentPropertyChange = function(event, data) {\n            if ($(event.target).is(this.$node)) {\n                return;\n            }\n\n            event.stopPropagation();\n\n            this.compoundValues[data.propertyId] = data.value;\n\n            this.triggerFieldUpdated();\n        };\n\n        this.onDependentPropertyInvalid = function(event, data) {\n            if ($(event.target).is(this.$node)) {\n                return;\n            }\n\n            event.stopPropagation();\n            this.compoundValues[data.propertyId] = data.value;\n            this.triggerFieldUpdated();\n        };\n\n        this.getValues = function() {\n            var self = this;\n            return _.chain(this.attr.property.dependentPropertyIris)\n                .map(function(iri) {\n                    var result = self.compoundValues[iri];\n                    if (_.isArray(result)) {\n                        return result;\n                    } else if (_.isUndefined(result)) {\n                        return [''];\n                    }\n                    return [result];\n                })\n                .value()\n        };\n\n        this.isValid = function() {\n            var values = this.getValues();\n\n            if (this.attr.vertex) {\n                // TODO: should pass key?\n                return F.vertex.propValid(this.attr.vertex, values, this.attr.property.title);\n            }\n\n            return _.any(values, function(v) {\n                return v && v.length;\n            })\n        };\n\n        this.render = function() {\n            var self = this,\n                fields = $(),\n                names = _.indexBy(this.attr.values, 'name');\n\n            Promise.all(this.attr.property.dependentPropertyIris.map(function(propertyIri, i) {\n                var ontologyProperty = self.ontologyProperties.byTitle[propertyIri],\n                    fieldContainer = $('<div>').addClass('compound-field'),\n                    property = names[propertyIri],\n                    previousValue = property ? property.value : '';\n\n                self.compoundValues[propertyIri] = previousValue;\n\n                return Promise.require(\n                    ontologyProperty.possibleValues ?\n                        'fields/restrictValues' :\n                        'fields/' + ontologyProperty.dataType\n                ).then(function(PropertyField) {\n                    PropertyField.attachTo(fieldContainer, {\n                        property: ontologyProperty,\n                        newProperty: !property,\n                        tooltip: {\n                            title: ontologyProperty.displayName,\n                            placement: 'left',\n                            trigger: 'focus'\n                        },\n                        vertexProperty: property,\n                        value: previousValue,\n                        predicates: self.attr.predicates,\n                        composite: true,\n                        focus: i === 0\n                    });\n                    fields = fields.add(fieldContainer);\n                })\n            })).done(function() {\n                self.$node.empty().append(fields);\n                self.trigger('fieldRendered');\n            })\n        };\n    }\n});\n"]}