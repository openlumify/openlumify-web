{"version":3,"sources":["../../js/fields/withPropertyField.js"],"names":["define","withTeardown","Promise","ENTER","call","defaultAttrs","inputSelector","value","composite","newProperty","after","inputs","select","tooltip","$node","empty","before","node","config","placeholder","onlySearchable","i18n","property","dataType","displayType","displayName","self","attr","preventChangeHandler","on","event","type","which","triggerFieldUpdated","onInput","_","defer","eq","focus","isFunction","getValue","Error","setValue","handler","off","rendered","stopPropagation","asyncRender","trigger","inputsNoSelects","not","find","each","$this","$","data","length","disableTooltip","delayedShow","debounce","delayedTimer","hide","clearTimeout","tip","is","extend","container","addClass","one","document","scrollParent","isEmpty","undefined","Object","resolve","then","fieldUpdated","fromEvent","options","result","isValid","handle","_markedInvalid","_previousValue","isEqual","propertyId","title","metadata","getMetadata","removeClass"],"mappings":"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","file":"withPropertyField.js","sourcesContent":["\ndefine([\n    'util/withTeardown',\n    'util/promise'\n], function(withTeardown, Promise) {\n    'use strict';\n\n    var ENTER = 13;\n\n    return function() {\n\n        withTeardown.call(this);\n\n        this.defaultAttrs({\n            inputSelector: 'input,textarea,select',\n            value: '',\n            composite: false,\n            newProperty: false\n        });\n\n        this.after('teardown', function() {\n            var inputs = this.select('visibleInputsSelector');\n            inputs.tooltip('destroy');\n            this.$node.empty();\n        });\n\n\n        this.before('initialize', function(node, config) {\n            config.placeholder = config.onlySearchable ? (\n                    i18n(true, 'field.' + config.property.dataType + '.displaytype.' + config.property.displayType + '.placeholder') ||\n                    i18n(true, 'field.' + config.property.dataType + '.placeholder') ||\n                    config.property.displayName\n                ) : config.property.displayName;\n        });\n\n        this.after('initialize', function() {\n            var self = this;\n\n            if (this.attr.preventChangeHandler !== true) {\n                this.on('change keyup', {\n                    inputSelector: function(event) {\n                        if (event.type === 'change' || event.which === ENTER) {\n                            this.triggerFieldUpdated();\n                        }\n                    }\n                });\n            }\n\n            this.on('input', this.onInput);\n            this.on('focusPropertyField', function() {\n                _.defer(function() {\n                    self.select('inputSelector').eq(0).focus().select();\n                })\n            });\n\n            if (!_.isFunction(this.getValue)) {\n                throw new Error('getValue is required function for fields');\n            }\n\n            if (!_.isFunction(this.setValue)) {\n                throw new Error('setValue is required function for fields');\n            }\n\n            this.on('fieldRendered', function handler() {\n                this.off('fieldRendered', handler);\n                rendered();\n            });\n\n            this.on('setValue', function(event, value) {\n                event.stopPropagation();\n                this.setValue(value);\n            });\n\n            if (this.attr.asyncRender !== true) {\n                this.trigger('fieldRendered');\n            }\n\n            function rendered() {\n                var inputs = self.select('inputSelector'),\n                    inputsNoSelects = inputs.not('select');\n\n                self.$node.find('input:not([type=checkbox])').each(function() {\n                    var $this = $(this);\n                    if ($this.data('optional') !== true && self.attr.composite !== true) {\n                        $this.attr('required', true)\n                    }\n                });\n\n                if (inputsNoSelects.length && self.attr.tooltip && self.attr.disableTooltip !== true) {\n                    var delayedShow = _.debounce(function() {\n                            inputsNoSelects.eq(0).tooltip('show');\n                        }, 1000),\n                        delayedTimer,\n                        hide = function() {\n                            clearTimeout(delayedTimer);\n                            var tooltip = inputsNoSelects.eq(0).data('tooltip');\n                            if (tooltip) {\n                                if (tooltip.tip().is(':visible')) {\n                                    tooltip.hide();\n                                    delayedTimer = delayedShow();\n                                }\n                            }\n                        };\n\n                    inputsNoSelects.eq(0)\n                        .tooltip($.extend({ container: 'body' }, self.attr.tooltip))\n                        .data('tooltip').tip().addClass('field-tooltip');\n                    inputsNoSelects.eq(0).one('shown', function() {\n                        self.on(document, 'graphPaddingUpdated', hide);\n                        $(this).scrollParent().on('scroll', hide);\n                    })\n                }\n\n                if (self.attr.focus !== false) {\n                    _.defer(function() {\n                        inputs.eq(0).focus().select();\n                    })\n                }\n\n                const isEmpty = self.attr.value === null\n                    || self.attr.value === ''\n                    || self.attr.value === undefined\n                    || (self.attr.value instanceof Object && _.isEmpty(self.attr.value));\n\n                if (!isEmpty) {\n                    Promise.resolve(self.setValue(self.attr.value))\n                        .then(function () {\n                            self.triggerFieldUpdated();\n                        });\n                }\n            }\n        });\n\n        this.onInput = function(event, data) {\n            this.fieldUpdated(this.getValue(), { fromEvent: 'input' });\n        };\n\n        this.triggerFieldUpdated = function() {\n            this.fieldUpdated(this.getValue());\n        };\n\n        this.fieldUpdated = function(value, options) {\n            var self = this,\n                result;\n\n            if (!_.isFunction(this.isValid) || (result = this.isValid(value))) {\n                if (_.isFunction(result.then)) {\n                    result.then(handle);\n                } else {\n                    handle(true);\n                }\n            } else if (result === false || (this._markedInvalid === undefined && self._previousValue)) {\n                handle(false);\n            } else {\n                handle(true);\n            }\n\n            function handle(isValid) {\n                var inputs = self.select('inputSelector');\n                if (isValid) {\n                    if (!self._previousValue || (self._previousValue && !_.isEqual(self._previousValue, value))) {\n                        self.trigger('propertychange', {\n                            propertyId: self.attr.property.title,\n                            value: value,\n                            metadata: _.isFunction(self.getMetadata) && self.getMetadata() || {},\n                            options: options\n                        });\n                        if (!options || options.fromEvent !== 'input') {\n                            self.setValue(value);\n                        }\n                    }\n                    inputs.removeClass('invalid');\n                    self._previousValue = value;\n                    self._markedInvalid = false;\n                } else {\n                    self._markedInvalid = true;\n                    self.trigger('propertyinvalid', {\n                        propertyId: self.attr.property.title\n                    });\n                    if (inputs.length === 1 && !self.attr.composite) {\n                        inputs.addClass('invalid');\n                    }\n                    self._previousValue = null;\n                }\n            }\n        };\n    };\n});\n"]}