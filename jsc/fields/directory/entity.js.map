{"version":3,"sources":["../../../js/fields/directory/entity.js"],"names":["define","defineComponent","template","withPropertyField","TypeAheadUtil","withDataRequest","F","DirectoryEntityField","self","after","$node","html","_","extend","attr","inputField","select","vertexProperty","loadingSpan","$","text","i18n","append","hide","typeahead","source","directorySearch","items","minLength","matcher","displayName","toLowerCase","indexOf","query","updater","onSelectionFieldSelected","map","on","val","adjustDropdownPosition","clearIfNoMatch","directoryEntity","pretty","data","id","isValid","value","setValue","isString","loadDirectoryEntity","dataRequest","then","directoryEntry","type","remove","show","getValue","search","process","results","entities","entity","str","trigger","personOrGroup"],"mappings":"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","file":"entity.js","sourcesContent":["\ndefine([\n    'flight/lib/component',\n    './entityTpl.hbs',\n    '../withPropertyField',\n    'util/jquery/typeAheadUtil',\n    'util/withDataRequest',\n    'util/formatters'\n], function(defineComponent, template, withPropertyField, TypeAheadUtil, withDataRequest, F) {\n    'use strict';\n\n    return defineComponent(DirectoryEntityField, withPropertyField, withDataRequest);\n\n    function DirectoryEntityField() {\n        var self = this;\n\n        this.after('initialize', function() {\n            this.$node.html(template(_.extend({}, this.attr)));\n            self.inputField = this.select('inputSelector');\n            if (this.attr.vertexProperty) {\n                self.loadingSpan = $('<span>').text(i18n('field.directory.form.display_name.loading'));\n                this.$node.append(self.loadingSpan);\n                self.inputField.hide();\n            }\n\n            self.inputField.typeahead({\n                source: directorySearch,\n                items: 25,\n                minLength: 1,\n                matcher: function(displayName) {\n                    return displayName.toLowerCase().indexOf(this.query.toLowerCase()) > -1;\n                },\n                updater: function(displayName) {\n                    onSelectionFieldSelected(self.map[displayName]);\n                    return displayName;\n                }\n            }).on('click', function() {\n                if (self.inputField.val()) {\n                    self.inputField.typeahead('lookup').select();\n                } else {\n                    self.inputField.typeahead('lookup');\n                }\n                TypeAheadUtil.adjustDropdownPosition(self.inputField);\n            }).on('blur', function() {\n                TypeAheadUtil.clearIfNoMatch(self.inputField, 'selection', F.directoryEntity.pretty);\n                var directoryEntity = self.inputField.data('selection');\n                self.inputField.data('value', directoryEntity ? directoryEntity.id : null);\n            });\n        });\n\n        this.isValid = function(value) {\n            return !!value;\n        };\n\n        this.setValue = function(value) {\n            if (_.isString(value)) {\n                if (!value) {\n                    return loadDirectoryEntity(null);\n                }\n                return self.dataRequest('directory', 'getById', value)\n                    .then(loadDirectoryEntity);\n            } else {\n                self.inputField.val(F.directoryEntity.pretty(value));\n                onSelectionFieldSelected(value);\n            }\n\n            function loadDirectoryEntity(directoryEntry) {\n                if (directoryEntry && directoryEntry.id && directoryEntry.type) {\n                    self.setValue(directoryEntry);\n                    if (self.loadingSpan) {\n                        self.loadingSpan.remove();\n                    }\n                    self.inputField.show();\n                }\n            }\n        };\n\n        this.getValue = function() {\n            var directoryEntity = self.inputField.data('selection');\n            return directoryEntity ? directoryEntity.id : null;\n        };\n\n        function directorySearch(search, process) {\n            self.map = {};\n\n            self.dataRequest('directory', 'search', search)\n              .then(function(results) {\n                  var entities = _.map(results.entities, function(entity) {\n                      var str = F.directoryEntity.pretty(entity);\n                      self.map[str] = entity;\n                      return str;\n                  });\n                  process(entities);\n                  TypeAheadUtil.adjustDropdownPosition(self.inputField);\n              });\n        }\n\n        function onSelectionFieldSelected(directoryEntity) {\n            self.inputField\n              .data('selection', directoryEntity)\n              .data('value', directoryEntity.id)\n              .trigger('directorySelectionFieldSelected', { personOrGroup: directoryEntity });\n        }\n    }\n});\n"]}