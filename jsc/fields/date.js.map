{"version":3,"sources":["../../js/fields/date.js"],"names":["define","defineComponent","template","timezoneTemplate","F","withPropertyField","withHistogram","withPositionUpdates","DateField","defaultAttrs","timeFieldSelector","timezoneSelector","preventChangeHandler","before","node","config","focus","after","self","dateString","timeString","displayTime","attr","property","displayType","$node","html","today","date","Date","todayTime","updateTimezone","select","timepicker","showInputs","showSeconds","minuteStep","defaultTime","disableMousewheel","on","onTimezoneOpen","onSelectTimezone","input","eq","value","val","dateStringUtc","datepicker","triggerFieldUpdated","getValue","dateStr","timeField","next","timeVal","timezone","dateTimeStringServer","currentTimezone","name","dateStringServer","getMetadata","currentTimezoneMetadata","setValue","millis","_","isNumber","undefined","isUndefined","isString","length","test","parseInt","looksLikeCorrectFormat","parsed","dateInServerFormat","toDate","looslyParseDate","getTime","isNaN","fromZoneName","toZoneName","dateTimeStringToTimezone","toUpperCase","isValid","local","event","data","tz","dateStringValue","lookupTimezone","offset","tzOffset","replaceWith","$target","$","target","closest","preventDefault","Timezone","require","lookupComponent","attachTo","scrollSelector","sourceTimezone","vertexProperty"],"mappings":"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","file":"date.js","sourcesContent":["\ndefine([\n    'flight/lib/component',\n    './dateTpl.hbs',\n    './dateTimezone.hbs',\n    'util/vertex/formatters',\n    './withPropertyField',\n    './withHistogram',\n    'util/popovers/withElementScrollingPositionUpdates'\n], function(\n    defineComponent,\n    template,\n    timezoneTemplate,\n    F,\n    withPropertyField,\n    withHistogram,\n    withPositionUpdates) {\n    'use strict';\n\n    return defineComponent(DateField, withPropertyField, withHistogram, withPositionUpdates);\n\n    function DateField() {\n\n        this.defaultAttrs({\n            timeFieldSelector: '.timepicker',\n            timezoneSelector: '.timezone',\n            preventChangeHandler: true\n        });\n\n        this.before('initialize', function(node, config) {\n            config.focus = false;\n        });\n\n        this.after('initialize', function() {\n            var self = this,\n                dateString = '',\n                timeString = '';\n\n            this.displayTime = this.attr.property.displayType !== 'dateOnly';\n\n            this.$node.html(template({\n                dateString: dateString,\n                timeString: timeString,\n                today: F.date.dateString(new Date()),\n                todayTime: F.date.timeString(new Date()),\n                displayTime: this.displayTime\n            }));\n\n            this.updateTimezone();\n\n            this.select('timeFieldSelector').timepicker({\n                template: false,\n                showInputs: false,\n                showSeconds: false,\n                minuteStep: 15,\n                defaultTime: timeString || false,\n                disableMousewheel: true\n            })\n\n            this.on('click', {\n                timezoneSelector: this.onTimezoneOpen\n            });\n            this.on('selectTimezone', this.onSelectTimezone);\n            this.updateTimezone();\n\n            const input = this.select('inputSelector').eq(0)\n\n            // Set this value once here so the datepicker can open\n            // to selected month and highlight the day\n            if (this.attr.value) {\n                if (this.displayTime) {\n                    input.val(F.date.dateString(this.attr.value))\n                } else {\n                    input.val(F.date.dateStringUtc(this.attr.value))\n                }\n            }\n\n            input.datepicker().on('changeDate', () => {\n                this.triggerFieldUpdated();\n            })\n        });\n\n        this.getValue = function() {\n            const input = this.select('inputSelector').eq(0);\n            const dateStr = input.val();\n\n            if (this.displayTime) {\n                var timeField = input.next('input.timepicker'),\n                    timeVal = timeField.val();\n\n                if (dateStr && timeVal) {\n                    return F.timezone.dateTimeStringServer(dateStr + ' ' + timeVal, this.currentTimezone.name);\n                }\n            } else if (dateStr) {\n                return F.date.dateStringServer(dateStr);\n            }\n        };\n\n        this.getMetadata = function() {\n            return this.currentTimezoneMetadata;\n        }\n\n        this.setValue = function(value) {\n            let dateString, timeString;\n\n            if (value) {\n                var millis = _.isNumber(value) ? value : undefined,\n                    date;\n\n                if (_.isUndefined(millis) && _.isString(value) && value.length) {\n                    if ((/^-?[0-9]+$/).test(value)) {\n                        millis = parseInt(value, 10);\n                    } else {\n                        var looksLikeCorrectFormat = (/^\\d+-\\d+-\\d+ \\d+:\\d+$/).test(value);\n                        if (looksLikeCorrectFormat) {\n                            var parsed = F.timezone.dateInServerFormat(value, 'Etc/UTC');\n                            if (parsed) {\n                                date = parsed.toDate();\n                            }\n                        } else {\n                            date = F.date.looslyParseDate(value);\n                        }\n                        if (date) {\n                            millis = date.getTime();\n                        }\n                    }\n                } else if (value instanceof Date) {\n                    dateString = F.date.dateString(value.getTime());\n                } else if (isNaN(new Date(millis).getTime())) {\n                    millis = null;\n                }\n\n                if (millis) {\n                    if (this.displayTime) {\n                        var fromZoneName = F.timezone.currentTimezone().name,\n                            toZoneName = this.currentTimezone ?\n                                this.currentTimezone.name :\n                                fromZoneName;\n\n                        if (fromZoneName !== toZoneName) {\n                            millis = F.timezone.dateTimeStringToTimezone(millis, fromZoneName, toZoneName);\n                        }\n                        dateString = F.date.dateString(millis);\n                        timeString = F.date.timeString(millis);\n                    } else {\n                        dateString = F.date.dateStringUtc(millis);\n                    }\n                }\n\n            }\n            this.select('inputSelector').eq(0).val(dateString);\n            if (this.displayTime) {\n                if (timeString) {\n                    // Unable to change how am/pm is shown in timepicker\n                    // so uppercase to match\n                    timeString = timeString.toUpperCase()\n                }\n                this.select('timeFieldSelector').val(timeString);\n            }\n        };\n\n        this.isValid = function(value) {\n            return _.isString(value) && value.length && F.date.local(value);\n        };\n\n        this.onSelectTimezone = function(event, data) {\n            if (data.name) {\n                this.updateTimezone(data);\n                this.triggerFieldUpdated();\n            }\n        };\n\n        this.updateTimezone = function(tz) {\n            if (this.displayTime) {\n\n                var dateStringValue = this.getValue(),\n                    date = dateStringValue && new Date(dateStringValue);\n\n                if (tz) {\n                    if (!_.isString(tz)) {\n                        tz = tz.name;\n                    }\n                    this.currentTimezone = F.timezone.lookupTimezone(tz, date);\n                } else {\n                    if (!this.currentTimezone) {\n                        this.currentTimezone = F.timezone.currentTimezone();\n                    } else {\n                        this.currentTimezone = F.timezone.lookupTimezone(this.currentTimezone.name, date);\n                    }\n                }\n\n                this.currentTimezoneMetadata = {\n                    'http://openlumify.org#sourceTimezone': this.currentTimezone.name,\n                    'http://openlumify.org#sourceTimezoneOffset': this.currentTimezone.offset,\n                    'http://openlumify.org#sourceTimezoneOffsetDst': this.currentTimezone.tzOffset\n                };\n\n                this.select('timezoneSelector').replaceWith(\n                    timezoneTemplate(this.currentTimezone)\n                );\n\n            }\n        };\n\n        this.onTimezoneOpen = function(event) {\n            var self = this,\n                $target = $(event.target).closest('.timezone');\n\n            event.preventDefault();\n\n            if (!this.Timezone) {\n                require(['util/popovers/timezone/timezone'], function(Timezone) {\n                    self.Timezone = Timezone;\n                    self.onTimezoneOpen(event);\n                });\n                return;\n            }\n\n            if ($target.lookupComponent(this.Timezone)) {\n                return;\n            }\n\n            this.Timezone.attachTo($target, {\n                scrollSelector: '.content',\n                timezone: this.currentTimezone.name,\n                sourceTimezone: this.attr.vertexProperty &&\n                    this.attr.vertexProperty['http://openlumify.org#sourceTimezone']\n            });\n        };\n    }\n});\n"]}