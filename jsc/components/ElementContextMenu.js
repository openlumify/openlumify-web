var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key];}}}return target;};define(['create-react-class','prop-types','configuration/plugins/registry','util/vertex/formatters','util/withDataRequest'],function(createReactClass,PropTypes,registry,F,withDataRequest){'use strict';var DIVIDER='DIVIDER';var MENU_ITEM_SHAPE=PropTypes.shape({shouldDisable:PropTypes.func,canHandle:PropTypes.func,label:PropTypes.string.isRequired,submenu:PropTypes.arrayOf(PropTypes.any),cls:PropTypes.string,shortcut:PropTypes.string,subtitle:PropTypes.string,options:PropTypes.shape({insertIntoMenuItems:PropTypes.func})});var ElementContextMenuList=createReactClass({displayName:'ElementContextMenuList',propTypes:{element:PropTypes.any,elementTitle:PropTypes.string.isRequired,items:PropTypes.arrayOf(PropTypes.oneOfType([MENU_ITEM_SHAPE,PropTypes.string])).isRequired,domElement:PropTypes.any.isRequired,onMenuItemClick:PropTypes.func.isRequired},handleMenuItemClick:function handleMenuItemClick(item){this.props.onMenuItemClick(item);},render:function render(){var _this=this;var _props=this.props,items=_props.items,element=_props.element,elementTitle=_props.elementTitle,domElement=_props.domElement,onMenuItemClick=_props.onMenuItemClick;return React.createElement('ul',{className:'dropdown-menu',role:'menu'},this.props.items.map(function(item,itemIndex){if(item===DIVIDER){return React.createElement('li',{key:itemIndex,className:'divider'});}else{return React.createElement(ElementContextMenuItem,{key:itemIndex,elementTitle:elementTitle,item:item,domElement:domElement,element:element,onClick:_this.handleMenuItemClick.bind(_this,item),onMenuItemClick:onMenuItemClick});}}));}});var ElementContextMenuItem=createReactClass({displayName:'ElementContextMenuItem',propTypes:{element:PropTypes.any,elementTitle:PropTypes.string.isRequired,item:MENU_ITEM_SHAPE,domElement:PropTypes.any.isRequired,onClick:PropTypes.func.isRequired,onMenuItemClick:PropTypes.func.isRequired},getInitialState:function getInitialState(){return{disabled:true};},componentWillMount:function componentWillMount(){var _props2=this.props,element=_props2.element,domElement=_props2.domElement,item=_props2.item;var currentSelection=openlumifyData.selectedObjects.vertexIds;var disabled=_.isFunction(item.shouldDisable)?this.props.item.shouldDisable(currentSelection,element.id,domElement,element):false;this.setState({disabled:disabled});},handleClick:function handleClick(event){event.preventDefault();if(!this.state.disabled){this.props.onClick();}},getLabel:function getLabel(){return _.template(this.props.item.label)({title:this.props.elementTitle});},hasSubmenu:function hasSubmenu(){return this.props.item.submenu&&this.props.item.submenu.length;},getClassName:function getClassName(){return(this.props.item.cls||'')+(this.hasSubmenu()?' dropdown-submenu':'')+(this.state.disabled?' disabled':'');},getLinkClassName:function getLinkClassName(){return(this.props.item.shortcut?'has-shortcut':'')+(this.props.item.subtitle?' has-subtitle':'')+(this.hasSubmenu()?' has-submenu':'');},renderShortcut:function renderShortcut(){var label=this.props.item.shortcut?F.string.shortcut(this.props.item.shortcut):null;if(label){return React.createElement('span',{className:'shortcut'},label);}return null;},renderSubtitle:function renderSubtitle(){if(this.props.item.subtitle){return React.createElement('span',{className:'subtitle'},this.props.item.subtitle);}},renderSubmenu:function renderSubmenu(){if(this.hasSubmenu()){return React.createElement(ElementContextMenuList,{items:this.props.item.submenu,elementTitle:this.props.elementTitle,domElement:this.props.domElement,element:this.props.element,onMenuItemClick:this.props.onMenuItemClick});}return null;},render:function render(){return React.createElement('li',{className:this.getClassName()},React.createElement('a',{className:this.getLinkClassName(),tabIndex:'-1',href:'#',onClick:this.handleClick},this.getLabel(),this.hasSubmenu()?'â€¦':'',this.renderShortcut(),this.renderSubtitle()),this.renderSubmenu());}});var ElementContextMenu=createReactClass({displayName:'ElementContextMenu',propTypes:{vertexId:PropTypes.string,edgeIds:PropTypes.arrayOf(PropTypes.string),collapsedItemId:PropTypes.string,position:PropTypes.shape({x:PropTypes.number,y:PropTypes.number}).isRequired,domElement:PropTypes.any.isRequired},getInitialState:function getInitialState(){return{items:[],title:'Loading...'};},getElement:function getElement(){if(this.props.collapsedItemId){return Promise.resolve({collapsedItemId:this.props.collapsedItemId});}else if(this.props.vertexId){return withDataRequest.dataRequest('vertex','store',{vertexIds:this.props.vertexId});}else{return withDataRequest.dataRequest('edge','store',{edgeIds:this.props.edgeIds});}},componentWillMount:function componentWillMount(){var _this2=this;var isCollapsedItem=!!this.props.collapsedItemId;var isVertex=!!this.props.vertexId;this.getElement().then(function(elements){if(!isCollapsedItem&&(!elements||elements.length===0)){throw new Error('Could not find element: '+(_this2.props.vertexId||_this2.props.edgeIds));}var items=isCollapsedItem?_this2.createCollapsedItemMenuItems():isVertex?_this2.createVertexMenuItems():_this2.createEdgeMenuItems();var firstElement=_.isArray(elements)?elements[0]:elements;var currentSelection=isVertex?openlumifyData.selectedObjects.vertexIds:openlumifyData.selectedObjects.edgeIds;registry.extensionsForPoint('org.openlumify.'+(isCollapsedItem?'collapsedItem':isVertex?'vertex':'edge')+'.menu').filter(function(item){if(item.selection){var amount=firstElement.id in currentSelection?Object.keys(currentSelection).length:_.isArray(elements)?elements.length:1;return item.selection===amount;}else{return true;}}).forEach(function(item){var canHandle=_.isFunction(item.canHandle)?item.canHandle(currentSelection,elements):true;if(!canHandle){return;}if(item.options&&_.isFunction(item.options.insertIntoMenuItems)){item.options.insertIntoMenuItems(item,items);}else{items.push(item);}});var title=isCollapsedItem?i18n('vertex.contextmenu.collapsed'):elements.length>1?i18n('vertex.contextmenu.multiple'):isVertex?F.string.truncate(F.vertex.title(firstElement),3):F.string.truncate(F.edge.title(firstElement),3);_this2.setState({domElement:_this2.props.domElement,element:firstElement,title:title,items:items});}).catch(function(err){console.error('Could not get menu items',err);_this2.setState({domElement:_this2.props.domElement,element:null,title:'Error',items:[]});});},handleMenuItemClick:function handleMenuItemClick(item){$(this.state.domElement).trigger(item.event,_extends({},item.args,{collapsedNodeId:this.props.collapsedItemId,vertexId:this.props.vertexId,edgeIds:this.props.edgeIds}));},positionMenu:function positionMenu(position){if(!this.refs.menuDiv){return;}var padding=10;var windowSize={x:$(window).width(),y:$(window).height()};var menu=$(this.refs.menuDiv).children('.dropdown-menu');var menuSize={x:menu.outerWidth(true),y:menu.outerHeight(true)};var submenu=menu.find('li.dropdown-submenu ul');var submenuSize=menuSize;var placement={left:Math.min(position.x,windowSize.x-menuSize.x-padding),top:Math.min(position.y,windowSize.y-menuSize.y-padding)};var submenuPlacement={left:'100%',right:'auto',top:0,bottom:'auto'};if(placement.left+menuSize.x+submenuSize.x+padding>windowSize.x){submenuPlacement=$.extend(submenuPlacement,{right:'100%',left:'auto'});}if(placement.top+menuSize.y+submenu.children('li').length*26+padding>windowSize.y){submenuPlacement=$.extend(submenuPlacement,{top:'auto',bottom:'0'});}menu.parent('div').addClass('open').css($.extend({position:'absolute'},placement));submenu.css(submenuPlacement);},componentDidMount:function componentDidMount(){this.positionMenu(this.props.position);},componentDidUpdate:function componentDidUpdate(){this.positionMenu(this.props.position);},render:function render(){var _state=this.state,items=_state.items,title=_state.title,element=_state.element;return items.length?React.createElement('div',{className:'vertex-menu',ref:'menuDiv'},React.createElement(ElementContextMenuList,{items:items,elementTitle:title,domElement:this.props.domElement,element:element,onMenuItemClick:this.handleMenuItemClick})):null;},createCollapsedItemMenuItems:function createCollapsedItemMenuItems(){var items=[{label:i18n('vertex.contextmenu.collapsed-node.rename'),event:'editCollapsedNode',canHandle:function canHandle(){return openlumifyData.currentWorkspaceEditable;}},{label:i18n('vertex.contextmenu.collapsed-node.select.contents'),submenu:[{label:i18n('vertex.contextmenu.collapsed-node.select.all'),event:'selectCollapsedNodeContents',args:{select:'all'}},{label:i18n('vertex.contextmenu.collapsed-node.select.none'),event:'selectCollapsedNodeContents',args:{select:'none'}},{label:i18n('vertex.contextmenu.collapsed-node.select.vertices'),event:'selectCollapsedNodeContents',args:{select:'vertices'}},{label:i18n('vertex.contextmenu.collapsed-node.select.edges'),event:'selectCollapsedNodeContents',args:{select:'edges'}}]},DIVIDER,{label:i18n('vertex.contextmenu.collapsed-node.uncollapse'),event:'uncollapse',canHandle:function canHandle(){return openlumifyData.currentWorkspaceEditable;}}];return items.filter(function(item){return _.isFunction(item.canHandle)?item.canHandle():true;});},createEdgeMenuItems:function createEdgeMenuItems(){return[{label:i18n('vertex.contextmenu.open'),submenu:[{label:i18n('vertex.contextmenu.open.fullscreen'),subtitle:i18n('vertex.contextmenu.open.fullscreen.subtitle'),event:'openFullscreen'}]}];},createVertexMenuItems:function createVertexMenuItems(){return[{label:i18n('vertex.contextmenu.open'),submenu:[{label:i18n('vertex.contextmenu.open.fullscreen'),subtitle:i18n('vertex.contextmenu.open.fullscreen.subtitle'),event:'openFullscreen'}]},{label:i18n('vertex.contextmenu.select'),submenu:[{label:i18n('vertex.contextmenu.select.connected'),subtitle:i18n('vertex.contextmenu.select.connected.subtitle'),shortcut:'meta-e',event:'selectConnected'}]},{label:i18n('vertex.contextmenu.search'),submenu:[{label:'{ title }',shortcut:'alt+t',event:'searchTitle',selection:1},{label:i18n('graph.contextmenu.search.related'),subtitle:i18n('graph.contextmenu.search.related.subtitle'),shortcut:'alt+s',event:'searchRelated',selection:1}]},DIVIDER,{label:i18n('vertex.contextmenu.remove'),shortcut:'delete',subtitle:i18n('vertex.contextmenu.remove.subtitle'),event:'deleteSelected',shouldDisable:function shouldDisable(selection,vertexId,target){return!openlumifyData.currentWorkspaceEditable||false;}}];}});return ElementContextMenu;});
//# sourceMappingURL=ElementContextMenu.js.map
