var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key];}}}return target;};function _objectWithoutProperties(obj,keys){var target={};for(var i in obj){if(keys.indexOf(i)>=0)continue;if(!Object.prototype.hasOwnProperty.call(obj,i))continue;target[i]=obj[i];}return target;}define(['create-react-class','prop-types','react-virtualized-select','util/vertex/formatters'],function(createReactClass,PropTypes,_ref,F){var VirtualizedSelect=_ref.default;var splitUpString=function splitUpString(str){return _.compact(F.string.normalizeAccents(str.toLowerCase()).replace(/[^a-zA-Z0-9]/g,' ').split(/\s+/));};var ElementSelector=createReactClass({displayName:'ElementSelector',propTypes:{onElementSelected:PropTypes.func,onCreateNewElement:PropTypes.func,searchOptions:PropTypes.object},getDefaultProps:function getDefaultProps(){return{searchOptions:{}};},getInitialState:function getInitialState(){return{options:[],isLoading:false};},componentDidMount:function componentDidMount(){this.onInputChange=_.debounce(this.onInputChange,250);var value=this.props.value;if(value){this.searchForElements(value,true);}},componentWillUnmount:function componentWillUnmount(){if(this.request){this.request.cancel();}},render:function render(){var _props=this.props,initialValue=_props.value,creatable=_props.creatable,rest=_objectWithoutProperties(_props,['value','creatable']);var _state=this.state,value=_state.value,options=_state.options,isLoading=_state.isLoading;var startIndex=creatable?1:0;return React.createElement(VirtualizedSelect,_extends({clearable:true,onChange:this.onChange,onInputChange:this.onInputChange,optionRenderer:ElementOptionRenderer,valueRenderer:this.elementValueRenderer,optionHeight:28,labelKey:'id',valueKey:'id',placeholder:i18n('openlumify.search'),isLoading:isLoading,filterOption:function filterOption(){return true;},options:options,value:value||''},rest));},searchForElements:function searchForElements(input){var _this=this;var autoSelect=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;var _props2=this.props,searchOptions=_props2.searchOptions,filterResultsToTitleField=_props2.filterResultsToTitleField;var query=input+'*';if(!input.length)return;this.setState({isLoading:true});return Promise.require('util/withDataRequest').then(function(_ref2){var dataRequest=_ref2.dataRequest;_this.request=dataRequest('vertex','search',_extends({matchType:'element',paging:{offset:0,size:25},query:query},searchOptions,{disableResultCache:true}));return _this.request;}).then(function(_ref3){var elements=_ref3.elements;var options=elements;if(filterResultsToTitleField){var queryParts=splitUpString(query);options=_.reject(options,function(v){var queryPartsMissingFromTitle=_.difference(queryParts,splitUpString(F.vertex.title(v))).length;return queryPartsMissingFromTitle;});}var _props3=_this.props,creatable=_props3.creatable,createNewRenderer=_props3.createNewRenderer,createNewLabel=_props3.createNewLabel;if(creatable){options.splice(0,0,{id:'-1',input:input,creatable:true,label:createNewRenderer?createNewRenderer(input):createNewLabel||i18n('element.selector.create',input)});}_this.setState({options:options,isLoading:false});if(autoSelect){var startIndex=creatable?1:0;var toSelect=void 0;if(options.length>startIndex){toSelect=options[startIndex];}else if(creatable){toSelect=options[0];}if(toSelect){_this.onChange(toSelect);}}}).catch(function(error){console.error(error);_this.setState({isLoading:false});});},onInputChange:function onInputChange(input){this.searchForElements(input);},onChange:function onChange(option){if(option){this.setState({value:option.id});}else{this.setState({value:''});}if(option&&option.id==='-1'){if(this.props.onCreateNewElement){this.props.onCreateNewElement(option.input);}}else{if(this.props.onElementSelected){if(_.isEmpty(option)){this.props.onElementSelected();}else{this.props.onElementSelected(option);}}}},elementValueRenderer:function elementValueRenderer(option){var creatable=option.creatable,input=option.input;if(creatable){var _props4=this.props,createNewValueRenderer=_props4.createNewValueRenderer,createNewValueLabel=_props4.createNewValueLabel;return createNewValueRenderer?createNewValueRenderer(input):createNewValueLabel||input;}return F.vertex.title(option);}});return ElementSelector;function ElementOptionRenderer(_ref4){var focusedOption=_ref4.focusedOption,focusedOptionIndex=_ref4.focusedOptionIndex,focusOption=_ref4.focusOption,key=_ref4.key,labelKey=_ref4.labelKey,option=_ref4.option,optionIndex=_ref4.optionIndex,options=_ref4.options,selectValue=_ref4.selectValue,style=_ref4.style,valueArray=_ref4.valueArray;var className=['VirtualizedSelectOption'];if(option.className){className.push(option.className);}if(option===focusedOption){className.push('VirtualizedSelectFocusedOption');}if(option.disabled){className.push('VirtualizedSelectDisabledOption');}if(option.header){className.push('VirtualizedSelectHeader');}if(valueArray&&valueArray.indexOf(option)>=0){className.push('VirtualizedSelectSelectedOption');}var events=option.disabled?{}:{onClick:function onClick(){return selectValue(option);},onMouseOver:function onMouseOver(){return focusOption(option);}};return React.createElement('div',_extends({className:className.join(' '),key:key,style:_extends({},style),title:option[labelKey]},events),option.creatable?option.label:F.vertex.title(option));}});
//# sourceMappingURL=ElementSelector.js.map
