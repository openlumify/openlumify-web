{"version":3,"sources":["../../../js/components/element/ElementSelector.jsx"],"names":["define","createReactClass","PropTypes","F","VirtualizedSelect","default","splitUpString","_","compact","string","normalizeAccents","str","toLowerCase","replace","split","ElementSelector","propTypes","onElementSelected","func","onCreateNewElement","searchOptions","object","getDefaultProps","getInitialState","options","isLoading","componentDidMount","onInputChange","debounce","value","props","searchForElements","componentWillUnmount","request","cancel","render","initialValue","creatable","rest","state","startIndex","onChange","ElementOptionRenderer","elementValueRenderer","i18n","input","autoSelect","filterResultsToTitleField","query","length","setState","Promise","require","then","dataRequest","matchType","paging","offset","size","disableResultCache","elements","queryParts","reject","v","queryPartsMissingFromTitle","difference","vertex","title","createNewRenderer","createNewLabel","splice","id","label","toSelect","catch","console","error","option","isEmpty","createNewValueRenderer","createNewValueLabel","focusedOption","focusedOptionIndex","focusOption","key","labelKey","optionIndex","selectValue","style","valueArray","className","push","disabled","header","indexOf","events","onClick","onMouseOver","join"],"mappings":"qaAAAA,OAAO,CACH,oBADG,CAEH,YAFG,CAGH,0BAHG,CAIH,wBAJG,CAAP,CAKG,SACCC,gBADD,CAECC,SAFD,MAICC,CAJD,CAII,IADQC,kBACR,MADDC,OACC,CAEH,GAAMC,eAAgB,QAAhBA,cAAgB,YAClBC,GAAEC,OAAF,CAAUL,EAAEM,MAAF,CAASC,gBAAT,CAA0BC,IAAIC,WAAJ,EAA1B,EACLC,OADK,CACG,eADH,CACoB,GADpB,EAELC,KAFK,CAEC,KAFD,CAAV,CADkB,EAAtB,CAMA,GAAMC,iBAAkBd,iBAAiB,+BACrCe,UAAW,CACPC,kBAAmBf,UAAUgB,IADtB,CAEPC,mBAAoBjB,UAAUgB,IAFvB,CAGPE,cAAelB,UAAUmB,MAHlB,CAD0B,CAOrCC,eAPqC,2BAOnB,CACd,MAAO,CAAEF,cAAe,EAAjB,CAAP,CACH,CAToC,CAWrCG,eAXqC,2BAWnB,CACd,MAAO,CAAEC,QAAS,EAAX,CAAeC,UAAW,KAA1B,CAAP,CACH,CAboC,CAerCC,iBAfqC,6BAejB,CAChB,KAAKC,aAAL,CAAqBpB,EAAEqB,QAAF,CAAW,KAAKD,aAAhB,CAA+B,GAA/B,CAArB,CADgB,GAERE,MAFQ,CAEE,KAAKC,KAFP,CAERD,KAFQ,CAGhB,GAAIA,KAAJ,CAAW,CACP,KAAKE,iBAAL,CAAuBF,KAAvB,CAA8B,IAA9B,EACH,CACJ,CArBoC,CAuBrCG,oBAvBqC,gCAuBd,CACnB,GAAI,KAAKC,OAAT,CAAkB,CACd,KAAKA,OAAL,CAAaC,MAAb,GACH,CACJ,CA3BoC,CA6BrCC,MA7BqC,kBA6B5B,YAC+C,KAAKL,KADpD,CACUM,YADV,QACGP,KADH,CACwBQ,SADxB,QACwBA,SADxB,CACsCC,IADtC,mEAEiC,KAAKC,KAFtC,CAEGV,KAFH,QAEGA,KAFH,CAEUL,OAFV,QAEUA,OAFV,CAEmBC,SAFnB,QAEmBA,SAFnB,CAGL,GAAMe,YAAaH,UAAY,CAAZ,CAAgB,CAAnC,CAEA,MACI,qBAAC,iBAAD,WACI,cADJ,CAEI,SAAU,KAAKI,QAFnB,CAGI,cAAe,KAAKd,aAHxB,CAII,eAAgBe,qBAJpB,CAKI,cAAe,KAAKC,oBALxB,CAMI,aAAc,EANlB,CAOI,SAAS,IAPb,CAQI,SAAS,IARb,CASI,YAAaC,KAAK,mBAAL,CATjB,CAUI,UAAWnB,SAVf,CAWI,aAAc,8BAAM,KAAN,EAXlB,CAYI,QAASD,OAZb,CAaI,MAAOK,OAAS,EAbpB,EAcQS,IAdR,EADJ,CAkBH,CApDoC,CAsDrCP,iBAtDqC,4BAsDnBc,KAtDmB,CAsDQ,mBAApBC,WAAoB,2DAAP,KAAO,aACY,KAAKhB,KADjB,CACjCV,aADiC,SACjCA,aADiC,CAClB2B,yBADkB,SAClBA,yBADkB,CAEzC,GAAMC,OAAWH,KAAX,IAAN,CAEA,GAAI,CAACA,MAAMI,MAAX,CAAmB,OAEnB,KAAKC,QAAL,CAAc,CAAEzB,UAAW,IAAb,CAAd,EACA,MAAO0B,SAAQC,OAAR,CAAgB,sBAAhB,EACFC,IADE,CACG,eAAqB,IAAlBC,YAAkB,OAAlBA,WAAkB,CACvB,MAAKrB,OAAL,CAAeqB,YAAY,QAAZ,CAAsB,QAAtB,WACXC,UAAW,SADA,CAEXC,OAAQ,CACJC,OAAQ,CADJ,CAEJC,KAAM,EAFF,CAFG,CAMXV,WANW,EAOR5B,aAPQ,EAQXuC,mBAAoB,IART,GAAf,CAUA,MAAO,OAAK1B,OAAZ,CACH,CAbE,EAcFoB,IAdE,CAcG,eAAkB,IAAfO,SAAe,OAAfA,QAAe,CACpB,GAAIpC,SAAUoC,QAAd,CAEA,GAAIb,yBAAJ,CAA+B,CAC3B,GAAMc,YAAavD,cAAc0C,KAAd,CAAnB,CACAxB,QAAUjB,EAAEuD,MAAF,CAAStC,OAAT,CAAkB,SAASuC,CAAT,CAAY,CACpC,GAAIC,4BAA6BzD,EAAE0D,UAAF,CAC7BJ,UAD6B,CAE7BvD,cAAcH,EAAE+D,MAAF,CAASC,KAAT,CAAeJ,CAAf,CAAd,CAF6B,EAG/Bd,MAHF,CAIA,MAAOe,2BAAP,CACH,CANS,CAAV,CAOH,CAZmB,YAaqC,MAAKlC,KAb1C,CAaZO,SAbY,SAaZA,SAbY,CAaD+B,iBAbC,SAaDA,iBAbC,CAakBC,cAblB,SAakBA,cAblB,CAcpB,GAAIhC,SAAJ,CAAe,CACXb,QAAQ8C,MAAR,CAAe,CAAf,CAAkB,CAAlB,CAAqB,CACjBC,GAAI,IADa,CAEjB1B,WAFiB,CAGjBR,UAAW,IAHM,CAIjBmC,MAAOJ,kBACHA,kBAAkBvB,KAAlB,CADG,CAEFwB,gBAAkBzB,KAAK,yBAAL,CAAgCC,KAAhC,CANN,CAArB,EAQH,CAED,MAAKK,QAAL,CAAc,CAAE1B,eAAF,CAAWC,UAAW,KAAtB,CAAd,EAEA,GAAIqB,UAAJ,CAAgB,CACZ,GAAMN,YAAaH,UAAY,CAAZ,CAAgB,CAAnC,CACA,GAAIoC,gBAAJ,CAEA,GAAIjD,QAAQyB,MAAR,CAAiBT,UAArB,CAAiC,CAC7BiC,SAAWjD,QAAQgB,UAAR,CAAX,CACH,CAFD,IAEO,IAAIH,SAAJ,CAAe,CAClBoC,SAAWjD,QAAQ,CAAR,CAAX,CACH,CAED,GAAIiD,QAAJ,CAAc,CACV,MAAKhC,QAAL,CAAcgC,QAAd,EACH,CACJ,CACJ,CAvDE,EAwDFC,KAxDE,CAwDI,eAAS,CACZC,QAAQC,KAAR,CAAcA,KAAd,EACA,MAAK1B,QAAL,CAAc,CAAEzB,UAAW,KAAb,CAAd,EACH,CA3DE,CAAP,CA4DH,CAzHoC,CA2HrCE,aA3HqC,wBA2HvBkB,KA3HuB,CA2HhB,CACjB,KAAKd,iBAAL,CAAuBc,KAAvB,EACH,CA7HoC,CA+HrCJ,QA/HqC,mBA+H5BoC,MA/H4B,CA+HpB,CACb,GAAIA,MAAJ,CAAY,CACR,KAAK3B,QAAL,CAAc,CAAErB,MAAOgD,OAAON,EAAhB,CAAd,EACH,CAFD,IAEO,CACH,KAAKrB,QAAL,CAAc,CAAErB,MAAO,EAAT,CAAd,EACH,CACD,GAAIgD,QAAUA,OAAON,EAAP,GAAc,IAA5B,CAAkC,CAC9B,GAAI,KAAKzC,KAAL,CAAWX,kBAAf,CAAmC,CAC/B,KAAKW,KAAL,CAAWX,kBAAX,CAA8B0D,OAAOhC,KAArC,EACH,CACJ,CAJD,IAIO,CACH,GAAI,KAAKf,KAAL,CAAWb,iBAAf,CAAkC,CAC9B,GAAIV,EAAEuE,OAAF,CAAUD,MAAV,CAAJ,CAAuB,CACnB,KAAK/C,KAAL,CAAWb,iBAAX,GACH,CAFD,IAEO,CACH,KAAKa,KAAL,CAAWb,iBAAX,CAA6B4D,MAA7B,EACH,CACJ,CACJ,CACJ,CAlJoC,CAoJrClC,oBApJqC,+BAoJhBkC,MApJgB,CAoJR,IACjBxC,UADiB,CACIwC,MADJ,CACjBxC,SADiB,CACNQ,KADM,CACIgC,MADJ,CACNhC,KADM,CAEzB,GAAIR,SAAJ,CAAe,aAC6C,KAAKP,KADlD,CACHiD,sBADG,SACHA,sBADG,CACqBC,mBADrB,SACqBA,mBADrB,CAEX,MAAOD,wBACHA,uBAAuBlC,KAAvB,CADG,CAEFmC,qBAAuBnC,KAF5B,CAGH,CACD,MAAO1C,GAAE+D,MAAF,CAASC,KAAT,CAAeU,MAAf,CAAP,CACH,CA7JoC,CAAjB,CAAxB,CAgKA,MAAO9D,gBAAP,CAEA,QAAS2B,sBAAT,OAOG,IANCuC,cAMD,OANCA,aAMD,CANgBC,kBAMhB,OANgBA,kBAMhB,CANoCC,WAMpC,OANoCA,WAMpC,CALCC,GAKD,OALCA,GAKD,CALMC,QAKN,OALMA,QAKN,CAJCR,MAID,OAJCA,MAID,CAJSS,WAIT,OAJSA,WAIT,CAJsB9D,OAItB,OAJsBA,OAItB,CAHC+D,WAGD,OAHCA,WAGD,CAFCC,KAED,OAFCA,KAED,CADCC,UACD,OADCA,UACD,CACC,GAAMC,WAAY,CAAC,yBAAD,CAAlB,CACA,GAAIb,OAAOa,SAAX,CAAsB,CAClBA,UAAUC,IAAV,CAAed,OAAOa,SAAtB,EACH,CACD,GAAIb,SAAWI,aAAf,CAA8B,CAC1BS,UAAUC,IAAV,CAAe,gCAAf,EACH,CACD,GAAId,OAAOe,QAAX,CAAqB,CACjBF,UAAUC,IAAV,CAAe,iCAAf,EACH,CACD,GAAId,OAAOgB,MAAX,CAAmB,CACfH,UAAUC,IAAV,CAAe,yBAAf,EACH,CACD,GAAIF,YAAcA,WAAWK,OAAX,CAAmBjB,MAAnB,GAA8B,CAAhD,CAAmD,CAC/Ca,UAAUC,IAAV,CAAe,iCAAf,EACH,CACD,GAAMI,QAASlB,OAAOe,QAAP,CAAkB,EAAlB,CAAuB,CAClCI,QAAS,yBAAMT,aAAYV,MAAZ,CAAN,EADyB,CAElCoB,YAAa,6BAAMd,aAAYN,MAAZ,CAAN,EAFqB,CAAtC,CAKA,MACI,qCACI,UAAWa,UAAUQ,IAAV,CAAe,GAAf,CADf,CAEI,IAAKd,GAFT,CAGI,kBAAYI,KAAZ,CAHJ,CAII,MAAOX,OAAOQ,QAAP,CAJX,EAKQU,MALR,EAKiBlB,OAAOxC,SAAP,CAAmBwC,OAAOL,KAA1B,CAAkCrE,EAAE+D,MAAF,CAASC,KAAT,CAAeU,MAAf,CALnD,CADJ,CAQH,CACJ,CAzND","file":"ElementSelector.js","sourcesContent":["define([\n    'create-react-class',\n    'prop-types',\n    'react-virtualized-select',\n    'util/vertex/formatters'\n], function(\n    createReactClass,\n    PropTypes,\n    { default: VirtualizedSelect },\n    F) {\n\n    const splitUpString = str =>\n        _.compact(F.string.normalizeAccents(str.toLowerCase())\n            .replace(/[^a-zA-Z0-9]/g, ' ')\n            .split(/\\s+/)\n        );\n\n    const ElementSelector = createReactClass({\n        propTypes: {\n            onElementSelected: PropTypes.func,\n            onCreateNewElement: PropTypes.func,\n            searchOptions: PropTypes.object\n        },\n\n        getDefaultProps() {\n            return { searchOptions: {} };\n        },\n\n        getInitialState() {\n            return { options: [], isLoading: false };\n        },\n\n        componentDidMount() {\n            this.onInputChange = _.debounce(this.onInputChange, 250);\n            const { value } = this.props;\n            if (value) {\n                this.searchForElements(value, true)\n            }\n        },\n\n        componentWillUnmount() {\n            if (this.request) {\n                this.request.cancel();\n            }\n        },\n\n        render() {\n            const { value: initialValue, creatable, ...rest } = this.props;\n            const { value, options, isLoading } = this.state;\n            const startIndex = creatable ? 1 : 0;\n\n            return (\n                <VirtualizedSelect\n                    clearable\n                    onChange={this.onChange}\n                    onInputChange={this.onInputChange}\n                    optionRenderer={ElementOptionRenderer}\n                    valueRenderer={this.elementValueRenderer}\n                    optionHeight={28}\n                    labelKey=\"id\"\n                    valueKey=\"id\"\n                    placeholder={i18n('openlumify.search')}\n                    isLoading={isLoading}\n                    filterOption={() => true}\n                    options={options}\n                    value={value || ''}\n                    {...rest}\n                />\n            )\n        },\n\n        searchForElements(input, autoSelect = false) {\n            const { searchOptions, filterResultsToTitleField } = this.props;\n            const query = `${input}*`;\n\n            if (!input.length) return;\n\n            this.setState({ isLoading: true })\n            return Promise.require('util/withDataRequest')\n                .then(({ dataRequest }) => {\n                    this.request = dataRequest('vertex', 'search', {\n                        matchType: 'element',\n                        paging: {\n                            offset: 0,\n                            size: 25\n                        },\n                        query,\n                        ...searchOptions,\n                        disableResultCache: true\n                    });\n                    return this.request;\n                })\n                .then(({ elements }) => {\n                    let options = elements;\n\n                    if (filterResultsToTitleField) {\n                        const queryParts = splitUpString(query);\n                        options = _.reject(options, function(v) {\n                            var queryPartsMissingFromTitle = _.difference(\n                                queryParts,\n                                splitUpString(F.vertex.title(v))\n                            ).length;\n                            return queryPartsMissingFromTitle;\n                        });\n                    }\n                    const { creatable, createNewRenderer, createNewLabel } = this.props;\n                    if (creatable) {\n                        options.splice(0, 0, {\n                            id: '-1',\n                            input,\n                            creatable: true,\n                            label: createNewRenderer ?\n                                createNewRenderer(input) :\n                                (createNewLabel || i18n('element.selector.create', input))\n                        });\n                    }\n\n                    this.setState({ options, isLoading: false });\n\n                    if (autoSelect) {\n                        const startIndex = creatable ? 1 : 0;\n                        let toSelect;\n\n                        if (options.length > startIndex) {\n                            toSelect = options[startIndex];\n                        } else if (creatable) {\n                            toSelect = options[0];\n                        }\n\n                        if (toSelect) {\n                            this.onChange(toSelect);\n                        }\n                    }\n                })\n                .catch(error => {\n                    console.error(error);\n                    this.setState({ isLoading: false })\n                })\n        },\n\n        onInputChange(input) {\n            this.searchForElements(input)\n        },\n\n        onChange(option) {\n            if (option) {\n                this.setState({ value: option.id })\n            } else {\n                this.setState({ value: '' })\n            }\n            if (option && option.id === '-1') {\n                if (this.props.onCreateNewElement) {\n                    this.props.onCreateNewElement(option.input);\n                }\n            } else {\n                if (this.props.onElementSelected) {\n                    if (_.isEmpty(option)) {\n                        this.props.onElementSelected()\n                    } else {\n                        this.props.onElementSelected(option)\n                    }\n                }\n            }\n        },\n\n        elementValueRenderer(option) {\n            const { creatable, input } = option;\n            if (creatable) {\n                const { createNewValueRenderer, createNewValueLabel } = this.props;\n                return createNewValueRenderer ?\n                    createNewValueRenderer(input) :\n                    (createNewValueLabel || input);\n            }\n            return F.vertex.title(option);\n        }\n    });\n\n    return ElementSelector;\n\n    function ElementOptionRenderer({\n        focusedOption, focusedOptionIndex, focusOption,\n        key, labelKey,\n        option, optionIndex, options,\n        selectValue,\n        style,\n        valueArray\n    }) {\n        const className = ['VirtualizedSelectOption']\n        if (option.className) {\n            className.push(option.className);\n        }\n        if (option === focusedOption) {\n            className.push('VirtualizedSelectFocusedOption')\n        }\n        if (option.disabled) {\n            className.push('VirtualizedSelectDisabledOption')\n        }\n        if (option.header) {\n            className.push('VirtualizedSelectHeader');\n        }\n        if (valueArray && valueArray.indexOf(option) >= 0) {\n            className.push('VirtualizedSelectSelectedOption')\n        }\n        const events = option.disabled ? {} : {\n            onClick: () => selectValue(option),\n            onMouseOver: () => focusOption(option)\n        };\n\n        return (\n            <div\n                className={className.join(' ')}\n                key={key}\n                style={{ ...style }}\n                title={option[labelKey]}\n                {...events}>{option.creatable ? option.label : F.vertex.title(option)}</div>\n        );\n    }\n});\n"]}